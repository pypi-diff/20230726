# Comparing `tmp/bdq-0.0.5.tar.gz` & `tmp/bdq-0.1.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "bdq-0.0.5.tar", last modified: Mon Jul 10 06:29:06 2023, max compression
+gzip compressed data, was "bdq-0.1.0.tar", last modified: Wed Jul 26 05:50:01 2023, max compression
```

## Comparing `bdq-0.0.5.tar` & `bdq-0.1.0.tar`

### file list

```diff
@@ -1,19 +1,20 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-10 06:29:06.286850 bdq-0.0.5/
--rw-r--r--   0 runner    (1001) docker     (123)    11357 2023-07-10 06:28:56.000000 bdq-0.0.5/LICENSE
--rw-r--r--   0 runner    (1001) docker     (123)    22082 2023-07-10 06:29:06.286850 bdq-0.0.5/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)    21475 2023-07-10 06:28:56.000000 bdq-0.0.5/README.md
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-10 06:29:06.286850 bdq-0.0.5/bdq/
--rw-r--r--   0 runner    (1001) docker     (123)      380 2023-07-10 06:28:56.000000 bdq-0.0.5/bdq/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     6449 2023-07-10 06:28:56.000000 bdq-0.0.5/bdq/dag.py
--rw-r--r--   0 runner    (1001) docker     (123)     7479 2023-07-10 06:28:56.000000 bdq-0.0.5/bdq/dataframe.py
--rw-r--r--   0 runner    (1001) docker     (123)      865 2023-07-10 06:28:56.000000 bdq-0.0.5/bdq/functions.py
--rw-r--r--   0 runner    (1001) docker     (123)     2906 2023-07-10 06:28:56.000000 bdq-0.0.5/bdq/schema.py
--rw-r--r--   0 runner    (1001) docker     (123)     3301 2023-07-10 06:28:56.000000 bdq-0.0.5/bdq/spark_pipeline.py
--rw-r--r--   0 runner    (1001) docker     (123)     1140 2023-07-10 06:28:56.000000 bdq-0.0.5/bdq/spark_ui_logger.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-10 06:29:06.286850 bdq-0.0.5/bdq.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)    22082 2023-07-10 06:29:06.000000 bdq-0.0.5/bdq.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)      260 2023-07-10 06:29:06.000000 bdq-0.0.5/bdq.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-07-10 06:29:06.000000 bdq-0.0.5/bdq.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)        4 2023-07-10 06:29:06.000000 bdq-0.0.5/bdq.egg-info/top_level.txt
--rw-r--r--   0 runner    (1001) docker     (123)      739 2023-07-10 06:28:56.000000 bdq-0.0.5/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)       38 2023-07-10 06:29:06.286850 bdq-0.0.5/setup.cfg
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-26 05:50:01.632620 bdq-0.1.0/
+-rw-r--r--   0 runner    (1001) docker     (123)    11357 2023-07-26 05:49:48.000000 bdq-0.1.0/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (123)    23940 2023-07-26 05:50:01.632620 bdq-0.1.0/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)    23333 2023-07-26 05:49:48.000000 bdq-0.1.0/README.md
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-26 05:50:01.632620 bdq-0.1.0/bdq/
+-rw-r--r--   0 runner    (1001) docker     (123)      409 2023-07-26 05:49:48.000000 bdq-0.1.0/bdq/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8222 2023-07-26 05:49:48.000000 bdq-0.1.0/bdq/dag.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7503 2023-07-26 05:49:48.000000 bdq-0.1.0/bdq/dataframe.py
+-rw-r--r--   0 runner    (1001) docker     (123)      865 2023-07-26 05:49:48.000000 bdq-0.1.0/bdq/functions.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2906 2023-07-26 05:49:48.000000 bdq-0.1.0/bdq/schema.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22173 2023-07-26 05:49:48.000000 bdq-0.1.0/bdq/spark_pipeline.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1908 2023-07-26 05:49:48.000000 bdq-0.1.0/bdq/spark_ui_logger.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3574 2023-07-26 05:49:48.000000 bdq-0.1.0/bdq/statestore.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-26 05:50:01.632620 bdq-0.1.0/bdq.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)    23940 2023-07-26 05:50:01.000000 bdq-0.1.0/bdq.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)      278 2023-07-26 05:50:01.000000 bdq-0.1.0/bdq.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-07-26 05:50:01.000000 bdq-0.1.0/bdq.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        4 2023-07-26 05:50:01.000000 bdq-0.1.0/bdq.egg-info/top_level.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      739 2023-07-26 05:49:48.000000 bdq-0.1.0/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)       38 2023-07-26 05:50:01.632620 bdq-0.1.0/setup.cfg
```

### Comparing `bdq-0.0.5/LICENSE` & `bdq-0.1.0/LICENSE`

 * *Files identical despite different names*

### Comparing `bdq-0.0.5/PKG-INFO` & `bdq-0.1.0/README.md`

 * *Files 3% similar despite different names*

```diff
@@ -1,1381 +1,1459 @@
-00000000: 4d65 7461 6461 7461 2d56 6572 7369 6f6e  Metadata-Version
-00000010: 3a20 322e 310a 4e61 6d65 3a20 6264 710a  : 2.1.Name: bdq.
-00000020: 5665 7273 696f 6e3a 2030 2e30 2e35 0a53  Version: 0.0.5.S
-00000030: 756d 6d61 7279 3a20 4269 6720 4461 7461  ummary: Big Data
-00000040: 2051 7561 6c69 7479 2c20 6120 7365 7420   Quality, a set 
-00000050: 6f66 2074 6f6f 6c73 2f66 756e 6374 696f  of tools/functio
-00000060: 6e20 7468 6174 2068 656c 7020 796f 7520  n that help you 
-00000070: 6576 6572 7920 6461 7920 6173 7365 7274  every day assert
-00000080: 2071 7561 6c69 7479 206f 6620 6461 7461   quality of data
-00000090: 7365 7473 2079 6f75 2068 6176 6520 7072  sets you have pr
-000000a0: 6f63 6573 7365 6420 6f72 2069 6e67 6573  ocessed or inges
-000000b0: 7465 640a 4175 7468 6f72 2d65 6d61 696c  ted.Author-email
-000000c0: 3a20 4772 7a65 676f 727a 2052 7573 696e  : Grzegorz Rusin
-000000d0: 203c 6772 7a65 676f 727a 2e72 7573 696e   <grzegorz.rusin
-000000e0: 4064 6174 6162 7269 636b 732e 636f 6d3e  @databricks.com>
-000000f0: 0a50 726f 6a65 6374 2d55 524c 3a20 486f  .Project-URL: Ho
-00000100: 6d65 7061 6765 2c20 6874 7470 733a 2f2f  mepage, https://
-00000110: 6769 7468 7562 2e63 6f6d 2f67 7275 7369  github.com/grusi
-00000120: 6e2d 6462 2f62 6471 0a50 726f 6a65 6374  n-db/bdq.Project
-00000130: 2d55 524c 3a20 4275 6720 5472 6163 6b65  -URL: Bug Tracke
-00000140: 722c 2068 7474 7073 3a2f 2f67 6974 6875  r, https://githu
-00000150: 622e 636f 6d2f 6772 7573 696e 2d64 622f  b.com/grusin-db/
-00000160: 6264 712f 6973 7375 6573 0a43 6c61 7373  bdq/issues.Class
-00000170: 6966 6965 723a 2050 726f 6772 616d 6d69  ifier: Programmi
-00000180: 6e67 204c 616e 6775 6167 6520 3a3a 2050  ng Language :: P
-00000190: 7974 686f 6e20 3a3a 2033 0a43 6c61 7373  ython :: 3.Class
-000001a0: 6966 6965 723a 204c 6963 656e 7365 203a  ifier: License :
-000001b0: 3a20 4f53 4920 4170 7072 6f76 6564 203a  : OSI Approved :
-000001c0: 3a20 4170 6163 6865 2053 6f66 7477 6172  : Apache Softwar
-000001d0: 6520 4c69 6365 6e73 650a 436c 6173 7369  e License.Classi
-000001e0: 6669 6572 3a20 4f70 6572 6174 696e 6720  fier: Operating 
-000001f0: 5379 7374 656d 203a 3a20 4f53 2049 6e64  System :: OS Ind
-00000200: 6570 656e 6465 6e74 0a52 6571 7569 7265  ependent.Require
-00000210: 732d 5079 7468 6f6e 3a20 3e3d 332e 380a  s-Python: >=3.8.
-00000220: 4465 7363 7269 7074 696f 6e2d 436f 6e74  Description-Cont
-00000230: 656e 742d 5479 7065 3a20 7465 7874 2f6d  ent-Type: text/m
-00000240: 6172 6b64 6f77 6e0a 4c69 6365 6e73 652d  arkdown.License-
-00000250: 4669 6c65 3a20 4c49 4345 4e53 450a 0a23  File: LICENSE..#
-00000260: 2057 6861 7420 6973 2062 6471 3f0a 4244   What is bdq?.BD
-00000270: 5120 7374 616e 6473 2066 6f72 2042 6967  Q stands for Big
-00000280: 2044 6174 6120 5175 616c 6974 792c 2061   Data Quality, a
-00000290: 2073 6574 206f 6620 746f 6f6c 732f 6675   set of tools/fu
-000002a0: 6e63 7469 6f6e 2074 6861 7420 6865 6c70  nction that help
-000002b0: 2079 6f75 2065 7665 7279 2064 6179 2061   you every day a
-000002c0: 7373 6572 7420 7175 616c 6974 7920 6f66  ssert quality of
-000002d0: 2064 6174 6173 6574 7320 796f 7520 6861   datasets you ha
-000002e0: 7665 2070 726f 6365 7373 6564 206f 7220  ve processed or 
-000002f0: 696e 6765 7374 6564 2e20 4c69 6272 6172  ingested. Librar
-00000300: 7920 6c65 7665 7261 6765 7320 706f 7765  y leverages powe
-00000310: 7220 6f66 2073 7061 726b 2c20 6865 6e63  r of spark, henc
-00000320: 6520 6974 2070 726f 6365 7373 6573 2079  e it processes y
-00000330: 6f75 7220 7175 616c 6974 7920 6368 6563  our quality chec
-00000340: 6b73 2061 7420 7363 616c 6520 6f66 6665  ks at scale offe
-00000350: 7265 6420 6279 2073 7061 726b 2061 6e64  red by spark and
-00000360: 2064 6174 6162 7269 636b 732e 0a0a 2323   databricks...##
-00000370: 2043 6f6d 7061 7269 6e67 2064 6174 6166   Comparing dataf
-00000380: 7261 6d65 2073 6368 656d 6173 0a60 6060  rame schemas.```
-00000390: 7079 7468 6f6e 0a69 6d70 6f72 7420 6264  python.import bd
-000003a0: 710a 6672 6f6d 2064 6174 6574 696d 6520  q.from datetime 
-000003b0: 696d 706f 7274 2064 6174 6574 696d 650a  import datetime.
-000003c0: 696d 706f 7274 2070 7973 7061 726b 2e73  import pyspark.s
-000003d0: 716c 2e66 756e 6374 696f 6e73 2061 7320  ql.functions as 
-000003e0: 460a 0a64 6632 203d 2073 7061 726b 2e63  F..df2 = spark.c
-000003f0: 7265 6174 6544 6174 6146 7261 6d65 285b  reateDataFrame([
-00000400: 0a5b 2031 2c20 312c 2022 4772 7a65 676f  .[ 1, 1, "Grzego
-00000410: 727a 222c 2064 6174 6574 696d 6528 3230  rz", datetime(20
-00000420: 3138 2c20 312c 2031 292c 2064 6174 6574  18, 1, 1), datet
-00000430: 696d 6528 3230 3138 2c20 312c 2031 2c20  ime(2018, 1, 1, 
-00000440: 3132 2c20 3334 2c20 3536 292c 2032 362e  12, 34, 56), 26.
-00000450: 392c 2031 3233 3233 3432 3334 3334 352c  9, 123234234345,
-00000460: 2054 7275 655d 2c0a 5b20 332c 2031 2c20   True],.[ 3, 1, 
-00000470: 224d 696b 6522 2c20 2020 2020 6461 7465  "Mike",     date
-00000480: 7469 6d65 2832 3031 392c 2031 2c20 3129  time(2019, 1, 1)
-00000490: 2c20 6461 7465 7469 6d65 2832 3031 382c  , datetime(2018,
-000004a0: 2033 2c20 312c 2031 322c 2033 342c 2035   3, 1, 12, 34, 5
-000004b0: 3629 2c20 3436 2e37 2c20 3536 3637 3838  6), 46.7, 566788
-000004c0: 3839 3839 2c20 4661 6c73 655d 2c0a 5b20  8989, False],.[ 
-000004d0: 322c 2032 2c20 2254 696d 6d79 222c 2020  2, 2, "Timmy",  
-000004e0: 2020 6461 7465 7469 6d65 2832 3031 382c    datetime(2018,
-000004f0: 2031 2c20 3129 2c20 6461 7465 7469 6d65   1, 1), datetime
-00000500: 2832 3031 382c 2032 2c20 312c 2031 322c  (2018, 2, 1, 12,
-00000510: 2033 342c 2035 3629 2c20 3336 2e37 2c20   34, 56), 36.7, 
-00000520: 3837 3534 3835 3738 3435 2c20 5472 7565  8754857845, True
-00000530: 5d0a 5d2c 2073 6368 656d 6129 0a0a 6466  ].], schema)..df
-00000540: 325f 6368 616e 6765 6420 3d20 6466 3220  2_changed = df2 
-00000550: 5c0a 2020 2e64 726f 7028 2766 6972 7374  \.  .drop('first
-00000560: 5f6c 6f67 696e 5f64 7427 2920 5c0a 2020  _login_dt') \.  
-00000570: 2e77 6974 6843 6f6c 756d 6e28 276e 6577  .withColumn('new
-00000580: 5f64 6174 6127 2c20 462e 6c69 7428 4e6f  _data', F.lit(No
-00000590: 6e65 292e 6361 7374 2827 6461 7465 2729  ne).cast('date')
-000005a0: 2920 5c0a 2020 2e77 6974 6843 6f6c 756d  ) \.  .withColum
-000005b0: 6e28 276c 696b 6573 272c 2046 2e63 6f6c  n('likes', F.col
-000005c0: 2827 6c69 6b65 7327 292e 6361 7374 2827  ('likes').cast('
-000005d0: 696e 7427 2929 0a0a 6173 7365 7274 2062  int'))..assert b
-000005e0: 6471 2e63 6f6d 7061 7265 5f73 6368 656d  dq.compare_schem
-000005f0: 6173 2864 6632 2e73 6368 656d 612c 2064  as(df2.schema, d
-00000600: 6632 5f63 6861 6e67 6564 2e73 6368 656d  f2_changed.schem
-00000610: 6129 203d 3d20 7b0a 2020 2761 6464 6564  a) == {.  'added
-00000620: 273a 207b 2766 6972 7374 5f6c 6f67 696e  ': {'first_login
-00000630: 5f64 7427 7d2c 200a 2020 2772 656d 6f76  _dt'}, .  'remov
-00000640: 6564 273a 207b 276e 6577 5f64 6174 6127  ed': {'new_data'
-00000650: 7d2c 200a 2020 2763 6861 6e67 6564 273a  }, .  'changed':
-00000660: 207b 0a20 2020 2027 6c69 6b65 7327 3a20   {.    'likes': 
-00000670: 7b27 6265 666f 7265 273a 2027 6269 6769  {'before': 'bigi
-00000680: 6e74 272c 2027 6166 7465 7227 3a20 2769  nt', 'after': 'i
-00000690: 6e74 277d 0a20 207d 2c0a 2020 276e 6f74  nt'}.  },.  'not
-000006a0: 5f63 6861 6e67 6564 273a 207b 0a20 2020  _changed': {.   
-000006b0: 2027 6e61 6d65 272c 2027 6964 3127 2c20   'name', 'id1', 
-000006c0: 276c 6173 745f 6c6f 6769 6e5f 7473 272c  'last_login_ts',
-000006d0: 2027 6964 3227 2c20 2763 7265 6469 7473   'id2', 'credits
-000006e0: 272c 2027 6163 7469 7665 270a 2020 7d0a  ', 'active'.  }.
-000006f0: 7d0a 6060 600a 0a23 2320 436f 6d70 6172  }.```..## Compar
-00000700: 696e 6720 6461 7461 6672 616d 6527 7320  ing dataframe's 
-00000710: 6461 7461 0a0a 6060 6070 7974 686f 6e0a  data..```python.
-00000720: 696d 706f 7274 2062 6471 0a0a 6466 3120  import bdq..df1 
-00000730: 3d20 7370 6172 6b2e 6372 6561 7465 4461  = spark.createDa
-00000740: 7461 4672 616d 6528 5b0a 5b20 312c 2031  taFrame([.[ 1, 1
-00000750: 2c20 2247 727a 6567 6f72 7a22 2c20 6461  , "Grzegorz", da
-00000760: 7465 7469 6d65 2832 3031 372c 2031 2c20  tetime(2017, 1, 
-00000770: 3129 2c20 6461 7465 7469 6d65 2832 3031  1), datetime(201
-00000780: 382c 2031 2c20 312c 2031 322c 2033 342c  8, 1, 1, 12, 34,
-00000790: 2035 3629 2c20 3236 2e37 2c20 3132 3332   56), 26.7, 1232
-000007a0: 3334 3233 3433 3435 2c20 5472 7565 5d2c  34234345, True],
-000007b0: 0a5b 2032 2c20 312c 2022 5469 6d22 2c20  .[ 2, 1, "Tim", 
-000007c0: 2020 2020 2064 6174 6574 696d 6528 3230       datetime(20
-000007d0: 3138 2c20 312c 2031 292c 2064 6174 6574  18, 1, 1), datet
-000007e0: 696d 6528 3230 3138 2c20 322c 2031 2c20  ime(2018, 2, 1, 
-000007f0: 3132 2c20 3334 2c20 3536 292c 2033 362e  12, 34, 56), 36.
-00000800: 372c 2035 3435 3435 2c20 2020 2020 2054  7, 54545,      T
-00000810: 7275 655d 2c0a 5b20 332c 2031 2c20 224d  rue],.[ 3, 1, "M
-00000820: 696b 6522 2c20 2020 2020 6461 7465 7469  ike",     dateti
-00000830: 6d65 2832 3031 392c 2031 2c20 3129 2c20  me(2019, 1, 1), 
-00000840: 6461 7465 7469 6d65 2832 3031 382c 2033  datetime(2018, 3
-00000850: 2c20 312c 2031 322c 2033 342c 2035 3629  , 1, 12, 34, 56)
-00000860: 2c20 3436 2e37 2c20 3536 3637 3838 3839  , 46.7, 56678889
-00000870: 3839 2c20 4661 6c73 655d 0a5d 2c20 7363  89, False].], sc
-00000880: 6865 6d61 290a 0a64 6632 203d 2073 7061  hema)..df2 = spa
-00000890: 726b 2e63 7265 6174 6544 6174 6146 7261  rk.createDataFra
-000008a0: 6d65 285b 0a5b 2031 2c20 312c 2022 4772  me([.[ 1, 1, "Gr
-000008b0: 7a65 676f 727a 222c 2064 6174 6574 696d  zegorz", datetim
-000008c0: 6528 3230 3138 2c20 312c 2031 292c 2064  e(2018, 1, 1), d
-000008d0: 6174 6574 696d 6528 3230 3138 2c20 312c  atetime(2018, 1,
-000008e0: 2031 2c20 3132 2c20 3334 2c20 3536 292c   1, 12, 34, 56),
-000008f0: 2032 362e 392c 2031 3233 3233 3432 3334   26.9, 123234234
-00000900: 3334 352c 2054 7275 655d 2c0a 5b20 332c  345, True],.[ 3,
-00000910: 2031 2c20 224d 696b 6522 2c20 2020 2020   1, "Mike",     
-00000920: 6461 7465 7469 6d65 2832 3031 392c 2031  datetime(2019, 1
-00000930: 2c20 3129 2c20 6461 7465 7469 6d65 2832  , 1), datetime(2
-00000940: 3031 382c 2033 2c20 312c 2031 322c 2033  018, 3, 1, 12, 3
-00000950: 342c 2035 3629 2c20 3436 2e37 2c20 3536  4, 56), 46.7, 56
-00000960: 3637 3838 3839 3839 2c20 4661 6c73 655d  67888989, False]
-00000970: 2c0a 5b20 322c 2032 2c20 2254 696d 6d79  ,.[ 2, 2, "Timmy
-00000980: 222c 2020 2020 6461 7465 7469 6d65 2832  ",    datetime(2
-00000990: 3031 382c 2031 2c20 3129 2c20 6461 7465  018, 1, 1), date
-000009a0: 7469 6d65 2832 3031 382c 2032 2c20 312c  time(2018, 2, 1,
-000009b0: 2031 322c 2033 342c 2035 3629 2c20 3336   12, 34, 56), 36
-000009c0: 2e37 2c20 3837 3534 3835 3738 3435 2c20  .7, 8754857845, 
-000009d0: 5472 7565 5d0a 5d2c 2073 6368 656d 6129  True].], schema)
-000009e0: 0a0a 2372 6574 7572 6e73 2064 6963 7473  ..#returns dicts
-000009f0: 2077 6974 6820 6164 6465 642c 2072 656d   with added, rem
-00000a00: 6f76 6564 2c20 6368 616e 6765 6420 616e  oved, changed an
-00000a10: 6420 6e6f 7420 6368 616e 6765 6420 6461  d not changed da
-00000a20: 7461 6672 616d 6573 2c20 616e 6420 7265  taframes, and re
-00000a30: 636f 7264 2063 6f75 6e74 730a 6466 5f64  cord counts.df_d
-00000a40: 6966 6620 3d20 6264 712e 636f 6d70 6172  iff = bdq.compar
-00000a50: 655f 6461 7461 6672 616d 6573 2864 6631  e_dataframes(df1
-00000a60: 2c20 6466 322c 205b 2769 6431 272c 2027  , df2, ['id1', '
-00000a70: 6964 3227 5d2c 2054 7275 6529 0a0a 2373  id2'], True)..#s
-00000a80: 686f 7720 616c 6c20 696e 666f 2061 626f  how all info abo
-00000a90: 7574 2063 6f6d 7061 7265 2072 6573 756c  ut compare resul
-00000aa0: 7473 0a62 6471 2e64 6973 706c 6179 5f63  ts.bdq.display_c
-00000ab0: 6f6d 7061 7265 5f64 6174 6166 7261 6d65  ompare_dataframe
-00000ac0: 735f 7265 7375 6c74 7328 6466 5f64 6966  s_results(df_dif
-00000ad0: 6629 0a0a 3e3e 2041 6464 6564 2072 6563  f)..>> Added rec
-00000ae0: 6f72 6473 2063 6f75 6e74 3a20 310a 3e3e  ords count: 1.>>
-00000af0: 202b 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2d2b   +---+---+-----+
-00000b00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
-00000b10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000b20: 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  --+-------+-----
-00000b30: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e  -----+------+.>>
-00000b40: 207c 6964 317c 6964 327c 6e61 6d65 207c   |id1|id2|name |
-00000b50: 6669 7273 745f 6c6f 6769 6e5f 6474 7c6c  first_login_dt|l
-00000b60: 6173 745f 6c6f 6769 6e5f 7473 2020 2020  ast_login_ts    
-00000b70: 2020 7c63 7265 6469 7473 7c6c 696b 6573    |credits|likes
-00000b80: 2020 2020 207c 6163 7469 7665 7c0a 3e3e       |active|.>>
-00000b90: 202b 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2d2b   +---+---+-----+
-00000ba0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
-00000bb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000bc0: 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  --+-------+-----
-00000bd0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e  -----+------+.>>
-00000be0: 207c 3220 207c 3220 207c 5469 6d6d 797c   |2  |2  |Timmy|
-00000bf0: 3230 3138 2d30 312d 3031 2020 2020 7c32  2018-01-01    |2
-00000c00: 3031 382d 3032 2d30 3120 3132 3a33 343a  018-02-01 12:34:
-00000c10: 3536 7c33 362e 3720 2020 7c38 3735 3438  56|36.7   |87548
-00000c20: 3537 3834 357c 7472 7565 2020 7c0a 3e3e  57845|true  |.>>
-00000c30: 202b 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2d2b   +---+---+-----+
-00000c40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
-00000c50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000c60: 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  --+-------+-----
-00000c70: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e  -----+------+.>>
-00000c80: 200a 3e3e 2052 656d 6f76 6564 2072 6563   .>> Removed rec
-00000c90: 6f72 6473 2063 6f75 6e74 3a20 310a 3e3e  ords count: 1.>>
-00000ca0: 202b 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2b2d   +---+---+----+-
-00000cb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
-00000cc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000cd0: 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2b  -+-------+-----+
-00000ce0: 2d2d 2d2d 2d2d 2b0a 3e3e 207c 6964 317c  ------+.>> |id1|
-00000cf0: 6964 327c 6e61 6d65 7c66 6972 7374 5f6c  id2|name|first_l
-00000d00: 6f67 696e 5f64 747c 6c61 7374 5f6c 6f67  ogin_dt|last_log
-00000d10: 696e 5f74 7320 2020 2020 207c 6372 6564  in_ts      |cred
-00000d20: 6974 737c 6c69 6b65 737c 6163 7469 7665  its|likes|active
-00000d30: 7c0a 3e3e 202b 2d2d 2d2b 2d2d 2d2b 2d2d  |.>> +---+---+--
-00000d40: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
-00000d50: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
-00000d60: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d  -----+-------+--
-00000d70: 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e 207c  ---+------+.>> |
-00000d80: 3220 207c 3120 207c 5469 6d20 7c32 3031  2  |1  |Tim |201
-00000d90: 382d 3031 2d30 3120 2020 207c 3230 3138  8-01-01    |2018
-00000da0: 2d30 322d 3031 2031 323a 3334 3a35 367c  -02-01 12:34:56|
-00000db0: 3336 2e37 2020 207c 3534 3534 357c 7472  36.7   |54545|tr
-00000dc0: 7565 2020 7c0a 3e3e 202b 2d2d 2d2b 2d2d  ue  |.>> +---+--
-00000dd0: 2d2b 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  -+----+---------
-00000de0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
-00000df0: 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  ---------+------
-00000e00: 2d2b 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a  -+-----+------+.
-00000e10: 3e3e 200a 3e3e 2043 6861 6e67 6564 2072  >> .>> Changed r
-00000e20: 6563 6f72 6473 2063 6f75 6e74 3a20 310a  ecords count: 1.
-00000e30: 3e3e 202b 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d  >> +---+---+----
-00000e40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000e50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000e60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000e70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000e80: 2d2b 0a3e 3e20 7c69 6431 7c69 6432 7c63  -+.>> |id1|id2|c
-00000e90: 6861 6e67 6564 2020 2020 2020 2020 2020  hanged          
-00000ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000ed0: 2020 2020 7c0a 3e3e 202b 2d2d 2d2b 2d2d      |.>> +---+--
-00000ee0: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
-00000ef0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000f00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000f10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000f20: 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c31 2020  -------+.>> |1  
-00000f30: 7c31 2020 7c7b 6669 7273 745f 6c6f 6769  |1  |{first_logi
-00000f40: 6e5f 6474 202d 3e20 7b32 3031 372d 3031  n_dt -> {2017-01
-00000f50: 2d30 312c 2032 3031 382d 3031 2d30 317d  -01, 2018-01-01}
-00000f60: 2c20 6372 6564 6974 7320 2d3e 207b 3236  , credits -> {26
-00000f70: 2e37 2c20 3236 2e39 7d7d 7c0a 3e3e 202b  .7, 26.9}}|.>> +
-00000f80: 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  ---+---+--------
-00000f90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000fa0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000fb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000fc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a0a  -------------+..
-00000fd0: 4e6f 7420 6368 616e 6765 6420 7265 636f  Not changed reco
-00000fe0: 7264 7320 636f 756e 743a 2031 0a60 6060  rds count: 1.```
-00000ff0: 0a0a 2323 2053 7572 726f 6761 7465 206b  ..## Surrogate k
-00001000: 6579 2067 656e 6572 6174 696f 6e0a 7769  ey generation.wi
-00001010: 7468 2073 7570 706f 7274 206f 6620 6f70  th support of op
-00001020: 7469 6f6e 616c 2075 7070 6572 6361 7369  tional uppercasi
-00001030: 6e67 2061 6e64 2074 7269 6d6d 696e 6720  ng and trimming 
-00001040: 6f66 206b 6579 2063 6f6c 756d 6e73 0a0a  of key columns..
-00001050: 6060 6070 7974 686f 6e0a 6672 6f6d 2064  ```python.from d
-00001060: 6174 6574 696d 6520 696d 706f 7274 2064  atetime import d
-00001070: 6174 6574 696d 650a 6672 6f6d 2062 6471  atetime.from bdq
-00001080: 2e66 756e 6374 696f 6e73 2069 6d70 6f72  .functions impor
-00001090: 7420 7375 7272 6f67 6174 655f 6b65 795f  t surrogate_key_
-000010a0: 6861 7368 2c20 7375 7272 6f67 6174 655f  hash, surrogate_
-000010b0: 6b65 795f 7374 7269 6e67 0a0a 7363 6865  key_string..sche
-000010c0: 6d61 203d 2022 6964 313a 6c6f 6e67 2c69  ma = "id1:long,i
-000010d0: 6432 3a6c 6f6e 672c 6e61 6d65 3a73 7472  d2:long,name:str
-000010e0: 696e 672c 6c69 6b65 733a 696e 7422 0a0a  ing,likes:int"..
-000010f0: 6466 3120 3d20 7370 6172 6b2e 6372 6561  df1 = spark.crea
-00001100: 7465 4461 7461 4672 616d 6528 5b0a 2020  teDataFrame([.  
-00001110: 5b20 312c 2031 2c20 2247 727a 6547 6f72  [ 1, 1, "GrzeGor
-00001120: 7a22 2c20 3120 5d2c 0a20 205b 2031 2c20  z", 1 ],.  [ 1, 
-00001130: 312c 2022 4772 7a65 676f 727a 222c 2020  1, "Grzegorz",  
-00001140: 3120 5d2c 0a20 205b 2031 2c20 312c 2022  1 ],.  [ 1, 1, "
-00001150: 4772 7a65 676f 727a 2020 2020 2020 222c  Grzegorz      ",
-00001160: 2020 3120 5d2c 0a20 205b 2031 2c20 4e6f    1 ],.  [ 1, No
-00001170: 6e65 2c20 2247 727a 6567 6f72 7a22 2c20  ne, "Grzegorz", 
-00001180: 315d 2c0a 2020 5b20 312c 204e 6f6e 652c  1],.  [ 1, None,
-00001190: 204e 6f6e 652c 2031 5d2c 0a20 205b 2032   None, 1],.  [ 2
-000011a0: 2c20 312c 2022 5469 6d22 2c20 3120 5d2c  , 1, "Tim", 1 ],
-000011b0: 0a20 205b 2033 2c20 312c 2022 4d69 6b65  .  [ 3, 1, "Mike
-000011c0: 222c 2031 205d 0a5d 2c20 7363 6865 6d61  ", 1 ].], schema
-000011d0: 290a 0a73 6b5f 6466 203d 2064 6631 2e73  )..sk_df = df1.s
-000011e0: 656c 6563 7428 0a20 2027 2a27 2c20 0a20  elect(.  '*', . 
-000011f0: 2073 7572 726f 6761 7465 5f6b 6579 5f68   surrogate_key_h
-00001200: 6173 6828 5b27 6964 3127 2c20 2769 6432  ash(['id1', 'id2
-00001210: 272c 2027 6e61 6d65 275d 2c20 7274 7269  ', 'name'], rtri
-00001220: 6d3d 5472 7565 292e 616c 6961 7328 2768  m=True).alias('h
-00001230: 6173 6827 292c 0a20 2073 7572 726f 6761  ash'),.  surroga
-00001240: 7465 5f6b 6579 5f73 7472 696e 6728 5b27  te_key_string(['
-00001250: 6964 3127 2c20 2769 6432 272c 2027 6e61  id1', 'id2', 'na
-00001260: 6d65 275d 2c20 7274 7269 6d3d 5472 7565  me'], rtrim=True
-00001270: 292e 616c 6961 7328 2768 6173 685f 696e  ).alias('hash_in
-00001280: 7075 7427 290a 290a 0a3e 3e20 2b2d 2d2d  put').)..>> +---
-00001290: 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  +----+----------
-000012a0: 2d2d 2d2d 2b2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----+-----+-----
-000012b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000012c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000012d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000012e0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
-000012f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001300: 2d2d 2d2d 2b0a 3e3e 207c 6964 317c 6964  ----+.>> |id1|id
-00001310: 3220 7c6e 616d 6520 2020 2020 2020 2020  2 |name         
-00001320: 207c 6c69 6b65 737c 6861 7368 2020 2020   |likes|hash    
-00001330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001360: 2020 2020 207c 6861 7368 5f69 6e70 7574       |hash_input
-00001370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001380: 207c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2b   |.>> +---+----+
-00001390: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
-000013a0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
-000013b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000013c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000013d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000013e0: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
-000013f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a  --------------+.
-00001400: 3e3e 207c 3120 207c 3120 2020 7c47 727a  >> |1  |1   |Grz
-00001410: 6547 6f72 7a20 2020 2020 207c 3120 2020  eGorz      |1   
-00001420: 207c 5b36 4620 3231 2039 3920 3939 2034   |[6F 21 99 99 4
-00001430: 4320 4632 2039 3320 3536 2032 4520 3743  C F2 93 56 2E 7C
-00001440: 2043 3320 3239 2046 3920 3641 2034 3220   C3 29 F9 6A 42 
-00001450: 3246 2036 4420 3632 2045 4320 3442 5d7c  2F 6D 62 EC 4B]|
-00001460: 5b31 2c20 312c 2047 525a 4547 4f52 5a5d  [1, 1, GRZEGORZ]
-00001470: 2020 2020 2020 2020 2020 207c 0a3e 3e20             |.>> 
-00001480: 7c31 2020 7c31 2020 207c 4772 7a65 676f  |1  |1   |Grzego
-00001490: 727a 2020 2020 2020 7c31 2020 2020 7c5b  rz      |1    |[
-000014a0: 3646 2032 3120 3939 2039 3920 3443 2046  6F 21 99 99 4C F
-000014b0: 3220 3933 2035 3620 3245 2037 4320 4333  2 93 56 2E 7C C3
-000014c0: 2032 3920 4639 2036 4120 3432 2032 4620   29 F9 6A 42 2F 
-000014d0: 3644 2036 3220 4543 2034 425d 7c5b 312c  6D 62 EC 4B]|[1,
-000014e0: 2031 2c20 4752 5a45 474f 525a 5d20 2020   1, GRZEGORZ]   
-000014f0: 2020 2020 2020 2020 7c0a 3e3e 207c 3120          |.>> |1 
-00001500: 207c 3120 2020 7c47 727a 6567 6f72 7a20   |1   |Grzegorz 
-00001510: 2020 2020 207c 3120 2020 207c 5b36 4620       |1    |[6F 
-00001520: 3231 2039 3920 3939 2034 4320 4632 2039  21 99 99 4C F2 9
-00001530: 3320 3536 2032 4520 3743 2043 3320 3239  3 56 2E 7C C3 29
-00001540: 2046 3920 3641 2034 3220 3246 2036 4420   F9 6A 42 2F 6D 
-00001550: 3632 2045 4320 3442 5d7c 5b31 2c20 312c  62 EC 4B]|[1, 1,
-00001560: 2047 525a 4547 4f52 5a5d 2020 2020 2020   GRZEGORZ]      
-00001570: 2020 2020 207c 0a3e 3e20 7c31 2020 7c6e       |.>> |1  |n
-00001580: 756c 6c7c 4772 7a65 676f 727a 2020 2020  ull|Grzegorz    
-00001590: 2020 7c31 2020 2020 7c5b 3445 2039 4520    |1    |[4E 9E 
-000015a0: 3341 2032 4220 4338 2033 3720 3930 2041  3A 2B C8 37 90 A
-000015b0: 3020 3641 2032 3620 3941 2046 4520 3741  0 6A 26 9A FE 7A
-000015c0: 2037 3820 3842 2043 4120 3939 2033 3420   78 8B CA 99 34 
-000015d0: 3638 2031 435d 7c5b 312c 2040 7e3c 6e75  68 1C]|[1, @~<nu
-000015e0: 6c6c 3e7e 402c 2047 525a 4547 4f52 5a5d  ll>~@, GRZEGORZ]
-000015f0: 2020 7c0a 3e3e 207c 3120 207c 6e75 6c6c    |.>> |1  |null
-00001600: 7c6e 756c 6c20 2020 2020 2020 2020 207c  |null          |
-00001610: 3120 2020 207c 5b34 3420 4646 2038 3820  1    |[44 FF 88 
-00001620: 3245 2032 4120 3238 2033 4220 4545 2045  2E 2A 28 3B EE E
-00001630: 4520 3533 2043 3820 3744 2030 4620 3932  E 53 C8 7D 0F 92
-00001640: 2044 3120 3638 2033 4520 4132 2046 3220   D1 68 3E A2 F2 
-00001650: 4535 5d7c 5b31 2c20 407e 3c6e 756c 6c3e  E5]|[1, @~<null>
-00001660: 7e40 2c20 407e 3c6e 756c 6c3e 7e40 5d7c  ~@, @~<null>~@]|
-00001670: 0a3e 3e20 7c32 2020 7c31 2020 207c 5469  .>> |2  |1   |Ti
-00001680: 6d20 2020 2020 2020 2020 2020 7c31 2020  m           |1  
-00001690: 2020 7c5b 4138 2037 4120 4230 2032 3920    |[A8 7A B0 29 
-000016a0: 3934 2039 4620 3543 2044 3120 3738 2044  94 9F 5C D1 78 D
-000016b0: 3420 3238 2038 3920 3842 2046 3120 3735  4 28 89 8B F1 75
-000016c0: 2043 4420 4143 2037 3020 4236 2036 315d   CD AC 70 B6 61]
-000016d0: 7c5b 322c 2031 2c20 5449 4d5d 2020 2020  |[2, 1, TIM]    
-000016e0: 2020 2020 2020 2020 2020 2020 7c0a 3e3e              |.>>
-000016f0: 207c 3320 207c 3120 2020 7c4d 696b 6520   |3  |1   |Mike 
-00001700: 2020 2020 2020 2020 207c 3120 2020 207c           |1    |
-00001710: 5b39 4420 3643 2037 3620 4335 2031 3720  [9D 6C 76 C5 17 
-00001720: 4430 2034 3420 3436 2034 3720 3141 2037  D0 44 46 47 1A 7
-00001730: 3120 4544 2034 4120 3038 2037 3520 3834  1 ED 4A 08 75 84
-00001740: 2031 4420 3543 2034 3520 3039 5d7c 5b33   1D 5C 45 09]|[3
-00001750: 2c20 312c 204d 494b 455d 2020 2020 2020  , 1, MIKE]      
-00001760: 2020 2020 2020 2020 207c 0a3e 3e20 2b2d           |.>> +-
-00001770: 2d2d 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  --+----+--------
-00001780: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2b2d 2d2d  ------+-----+---
-00001790: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000017a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000017b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000017c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
-000017d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000017e0: 2d2d 2d2d 2d2d 2b0a 6060 600a 0a23 2320  ------+.```..## 
-000017f0: 504b 2026 2046 4b20 696e 7465 7267 7269  PK & FK intergri
-00001800: 7479 2063 6865 636b 730a 7769 7468 2073  ty checks.with s
-00001810: 7570 706f 7274 206f 6620 7368 6f77 696e  upport of showin
-00001820: 6720 7361 6d70 6c65 2064 6174 6120 6672  g sample data fr
-00001830: 6f6d 2066 6163 7420 7461 626c 6520 7468  om fact table th
-00001840: 6174 2064 6964 206e 6f74 2073 6174 6973  at did not satis
-00001850: 6679 2069 6e74 6567 7269 7479 0a0a 6060  fy integrity..``
-00001860: 6070 7974 686f 6e0a 6672 6f6d 2062 6471  `python.from bdq
-00001870: 2069 6d70 6f72 7420 6661 6374 5f64 696d   import fact_dim
-00001880: 5f62 726f 6b65 6e5f 7265 6c61 7469 6f6e  _broken_relation
-00001890: 7368 6970 0a66 726f 6d20 6264 712e 6675  ship.from bdq.fu
-000018a0: 6e63 7469 6f6e 7320 696d 706f 7274 2073  nctions import s
-000018b0: 7572 726f 6761 7465 5f6b 6579 5f68 6173  urrogate_key_has
-000018c0: 682c 2073 7572 726f 6761 7465 5f6b 6579  h, surrogate_key
-000018d0: 5f73 7472 696e 670a 0a66 6163 745f 6466  _string..fact_df
-000018e0: 203d 2073 7061 726b 2e63 7265 6174 6544   = spark.createD
-000018f0: 6174 6146 7261 6d65 285b 0a20 2020 205b  ataFrame([.    [
-00001900: 2022 4772 7a65 676f 727a 222c 2022 4954   "Grzegorz", "IT
-00001910: 222c 2022 4555 2220 5d2c 0a20 2020 205b  ", "EU" ],.    [
-00001920: 2022 4d61 726b 222c 2022 4954 222c 2022   "Mark", "IT", "
-00001930: 4555 2220 5d2c 0a20 2020 205b 2022 4a75  EU" ],.    [ "Ju
-00001940: 7374 696e 222c 2022 4954 2020 222c 2022  stin", "IT  ", "
-00001950: 4555 2020 2020 2220 5d2c 0a20 2020 205b  EU    " ],.    [
-00001960: 2022 416c 6963 6531 222c 2022 4954 222c   "Alice1", "IT",
-00001970: 2022 5553 4122 205d 2c0a 2020 2020 5b20   "USA" ],.    [ 
-00001980: 2241 6c69 6365 3222 2c20 2249 5422 2c20  "Alice2", "IT", 
-00001990: 2255 5341 2220 5d2c 0a20 2020 205b 2022  "USA" ],.    [ "
-000019a0: 416c 6963 6533 222c 2022 4954 222c 2022  Alice3", "IT", "
-000019b0: 5553 4122 205d 2c0a 2020 2020 5b20 2241  USA" ],.    [ "A
-000019c0: 6c69 6365 3422 2c20 2249 5422 2c20 2255  lice4", "IT", "U
-000019d0: 5341 2220 5d2c 0a20 2020 205b 2022 416c  SA" ],.    [ "Al
-000019e0: 6963 6535 222c 2022 4954 222c 2022 5553  ice5", "IT", "US
-000019f0: 4122 205d 2c0a 2020 2020 5b20 2242 6f62  A" ],.    [ "Bob
-00001a00: 222c 2022 5361 6c65 7322 2c20 2255 5341  ", "Sales", "USA
-00001a10: 2220 5d2c 0a20 2020 205b 2022 426f 6232  " ],.    [ "Bob2
-00001a20: 222c 2022 5361 6c65 7322 2c20 2255 5341  ", "Sales", "USA
-00001a30: 2220 5d2c 0a20 2020 205b 2022 426f 6233  " ],.    [ "Bob3
-00001a40: 222c 2022 5361 6c65 7322 2c20 2255 5341  ", "Sales", "USA
-00001a50: 2220 5d0a 2020 5d2c 2022 4e61 6d65 3a73  " ].  ], "Name:s
-00001a60: 7472 696e 672c 4465 7074 3a73 7472 696e  tring,Dept:strin
-00001a70: 672c 436f 756e 7472 793a 7374 7269 6e67  g,Country:string
-00001a80: 2229 205c 0a20 202e 7769 7468 436f 6c75  ") \.  .withColu
-00001a90: 6d6e 2822 6465 7074 5f66 6b22 2c20 7375  mn("dept_fk", su
-00001aa0: 7272 6f67 6174 655f 6b65 795f 6861 7368  rrogate_key_hash
-00001ab0: 285b 2244 6570 7422 2c20 2243 6f75 6e74  (["Dept", "Count
-00001ac0: 7279 225d 2c20 7274 7269 6d3d 5472 7565  ry"], rtrim=True
-00001ad0: 2929 0a0a 6469 6d5f 6466 203d 2073 7061  ))..dim_df = spa
-00001ae0: 726b 2e63 7265 6174 6544 6174 6146 7261  rk.createDataFra
-00001af0: 6d65 285b 0a20 2020 205b 2249 5422 2c20  me([.    ["IT", 
-00001b00: 2245 5522 2c20 2245 7572 6f70 6561 6e20  "EU", "European 
-00001b10: 4954 2064 6570 6172 746d 656e 7422 5d2c  IT department"],
-00001b20: 0a20 2020 205b 2253 616c 6573 222c 2022  .    ["Sales", "
-00001b30: 5553 4122 2c20 2255 5341 2053 616c 6573  USA", "USA Sales
-00001b40: 2064 6570 742e 225d 0a20 205d 2c20 2264   dept."].  ], "d
-00001b50: 6570 6172 746d 656e 743a 7374 7269 6e67  epartment:string
-00001b60: 2c63 6e74 7279 3a73 7472 696e 672c 636f  ,cntry:string,co
-00001b70: 6d6d 656e 743a 7374 7269 6e67 2229 205c  mment:string") \
-00001b80: 0a20 202e 7769 7468 436f 6c75 6d6e 2822  .  .withColumn("
-00001b90: 6465 7074 5f70 6b22 2c20 7375 7272 6f67  dept_pk", surrog
-00001ba0: 6174 655f 6b65 795f 6861 7368 285b 2264  ate_key_hash(["d
-00001bb0: 6570 6172 746d 656e 7422 2c20 2263 6e74  epartment", "cnt
-00001bc0: 7279 225d 2c20 7274 7269 6d3d 5472 7565  ry"], rtrim=True
-00001bd0: 2929 0a0a 2364 6972 6563 7420 636f 6c75  ))..#direct colu
-00001be0: 6d6e 2063 6f6d 7061 7269 736f 6e2c 2068  mn comparison, h
-00001bf0: 656e 6365 2075 7070 6572 2c20 6c6f 7765  ence upper, lowe
-00001c00: 722c 2065 7874 7261 2073 7061 6365 7320  r, extra spaces 
-00001c10: 6166 6665 6374 2074 6865 2072 6573 756c  affect the resul
-00001c20: 7473 0a62 726f 6b65 6e5f 6466 203d 2066  ts.broken_df = f
-00001c30: 6163 745f 6469 6d5f 6272 6f6b 656e 5f72  act_dim_broken_r
-00001c40: 656c 6174 696f 6e73 6869 7028 0a20 2066  elationship(.  f
-00001c50: 6163 745f 6466 3d66 6163 745f 6466 2c0a  act_df=fact_df,.
-00001c60: 2020 666b 5f63 6f6c 756d 6e73 3d5b 2244    fk_columns=["D
-00001c70: 6570 7422 2c20 2243 6f75 6e74 7279 225d  ept", "Country"]
-00001c80: 2c0a 2020 6469 6d5f 6466 3d64 696d 5f64  ,.  dim_df=dim_d
-00001c90: 662c 0a20 2070 6b5f 636f 6c75 6d6e 733d  f,.  pk_columns=
-00001ca0: 5b22 6465 7061 7274 6d65 6e74 222c 2022  ["department", "
-00001cb0: 636e 7472 7922 5d2c 0a20 2073 616d 706c  cntry"],.  sampl
-00001cc0: 655f 6272 6f6b 656e 5f72 6563 6f72 6473  e_broken_records
-00001cd0: 3d32 0a29 0a0a 3e3e 202b 2d2d 2d2d 2b2d  =2.)..>> +----+-
-00001ce0: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  ------+---------
-00001cf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001d00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001d10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001d20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001d30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e 3e20  -----------+.>> 
-00001d40: 7c44 6570 747c 436f 756e 7472 797c 7361  |Dept|Country|sa
-00001d50: 6d70 6c65 5f72 6563 6f72 6473 2020 2020  mple_records    
-00001d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001da0: 2020 7c0a 3e3e 202b 2d2d 2d2d 2b2d 2d2d    |.>> +----+---
-00001db0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
-00001dc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001dd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001de0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001df0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001e00: 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c49  ---------+.>> |I
-00001e10: 5420 207c 5553 4120 2020 207c 5b7b 4954  T  |USA    |[{IT
-00001e20: 2c20 5553 412c 2041 6c69 6365 312c 20ef  , USA, Alice1, .
-00001e30: bfbd efbf bd78 7a34 7110 5fef bfbd efbf  .....xz4q._.....
-00001e40: bd11 5c72 61ef bfbd 2def bfbd 16ef bfbd  ..\ra...-.......
-00001e50: 567a 7d2c 207b 4954 2c20 5553 412c 2041  Vz}, {IT, USA, A
-00001e60: 6c69 6365 322c 20ef bfbd efbf bd78 7a34  lice2, ......xz4
-00001e70: 7110 5fef bfbd efbf bd11 5c72 61ef bfbd  q._.......\ra...
-00001e80: 2def bfbd 16ef bfbd 567a 7d5d 7c0a 3e3e  -.......Vz}]|.>>
-00001e90: 207c 4954 2020 7c45 5520 2020 2020 7c5b   |IT  |EU     |[
-00001ea0: 7b49 5420 202c 2045 5520 2020 202c 204a  {IT  , EU    , J
-00001eb0: 7573 7469 6e2c 20ef bfbd efbf bd48 2756  ustin, ......H'V
-00001ec0: 34ef bfbd 5c72 592c 67ef bfbd 49ef bfbd  4...\rY,g...I...
-00001ed0: efbf bd12 efbf bdef bfbd efbf bd7d 5d20  .............}] 
-00001ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001f00: 2020 2020 207c 0a3e 3e20 2b2d 2d2d 2d2b       |.>> +----+
-00001f10: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  -------+--------
-00001f20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001f30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001f40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001f50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001f60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 0a23  ------------+..#
-00001f70: 2075 7369 6e67 2073 7572 726f 6761 7465   using surrogate
-00001f80: 206b 6579 7320 7769 6c6c 2079 6965 6c64   keys will yield
-00001f90: 2062 6574 7465 7220 7265 7375 6c74 732c   better results,
-00001fa0: 2062 6563 6175 7365 2065 7874 7261 2073   because extra s
-00001fb0: 7061 6365 7320 6172 6520 7472 696d 6d65  paces are trimme
-00001fc0: 640a 6272 6f6b 656e 5f73 6b5f 6466 203d  d.broken_sk_df =
-00001fd0: 2066 6163 745f 6469 6d5f 6272 6f6b 656e   fact_dim_broken
-00001fe0: 5f72 656c 6174 696f 6e73 6869 7028 0a20  _relationship(. 
-00001ff0: 2066 6163 745f 6466 2c20 5b22 6465 7074   fact_df, ["dept
-00002000: 5f66 6b22 5d2c 0a20 2064 696d 5f64 662c  _fk"],.  dim_df,
-00002010: 205b 2264 6570 745f 706b 225d 2c0a 2020   ["dept_pk"],.  
-00002020: 7361 6d70 6c65 5f62 726f 6b65 6e5f 7265  sample_broken_re
-00002030: 636f 7264 733d 320a 290a 0a3e 3e20 2b2d  cords=2.)..>> +-
-00002040: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  ---+-------+----
-00002050: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002060: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00000000: 2320 5768 6174 2069 7320 6264 713f 0a0a  # What is bdq?..
+00000010: 4244 5120 7374 616e 6473 2066 6f72 2042  BDQ stands for B
+00000020: 6967 2044 6174 6120 5175 616c 6974 792c  ig Data Quality,
+00000030: 2061 2073 6574 206f 6620 746f 6f6c 732f   a set of tools/
+00000040: 6675 6e63 7469 6f6e 2074 6861 7420 6865  function that he
+00000050: 6c70 2079 6f75 2065 7665 7279 2064 6179  lp you every day
+00000060: 2061 7373 6572 7420 7175 616c 6974 7920   assert quality 
+00000070: 6f66 2064 6174 6173 6574 7320 796f 7520  of datasets you 
+00000080: 6861 7665 2070 726f 6365 7373 6564 206f  have processed o
+00000090: 7220 696e 6765 7374 6564 2e20 4c69 6272  r ingested. Libr
+000000a0: 6172 7920 6c65 7665 7261 6765 7320 706f  ary leverages po
+000000b0: 7765 7220 6f66 2073 7061 726b 2c20 6865  wer of spark, he
+000000c0: 6e63 6520 6974 2070 726f 6365 7373 6573  nce it processes
+000000d0: 2079 6f75 7220 7175 616c 6974 7920 6368   your quality ch
+000000e0: 6563 6b73 2061 7420 7363 616c 6520 6f66  ecks at scale of
+000000f0: 6665 7265 6420 6279 2073 7061 726b 2061  fered by spark a
+00000100: 6e64 2064 6174 6162 7269 636b 732e 0a0a  nd databricks...
+00000110: 4c69 6272 6172 7920 6f76 6572 2074 696d  Library over tim
+00000120: 6520 6576 6f6c 7665 6420 696e 746f 2044  e evolved into D
+00000130: 4147 2065 7865 6375 746f 7220 6f66 2061  AG executor of a
+00000140: 7262 6974 7261 7279 2070 7974 686f 6e2f  rbitrary python/
+00000150: 7079 7370 6172 6b20 6675 6e63 7469 6f6e  pyspark function
+00000160: 732e 2054 6869 7320 616c 6c6f 7773 2074  s. This allows t
+00000170: 6f20 7363 616c 6520 6578 6563 7574 696f  o scale executio
+00000180: 6e20 7769 7468 2064 6570 656e 6465 6e63  n with dependenc
+00000190: 7920 7472 6163 6b69 6e67 2074 6f20 6e65  y tracking to ne
+000001a0: 7874 206c 6576 656c 2e0a 0a23 2320 486f  xt level...## Ho
+000001b0: 7720 746f 2069 6e73 7461 6c6c 3f0a 0a4f  w to install?..O
+000001c0: 6e20 6461 7461 6272 6963 6b73 2072 756e  n databricks run
+000001d0: 2060 2570 6970 2069 6e73 7461 6c6c 2062   `%pip install b
+000001e0: 6471 3d3d 782e 792e 7a60 2e20 4d61 6b65  dq==x.y.z`. Make
+000001f0: 2073 7572 6520 796f 7520 7461 6720 7665   sure you tag ve
+00000200: 7273 696f 6e20 6e75 6d62 6572 2079 6f75  rsion number you
+00000210: 2061 7265 2063 6f6e 666f 7274 6162 6c65   are confortable
+00000220: 2077 6974 6820 746f 2065 6e73 7572 6520   with to ensure 
+00000230: 4150 4920 7374 6162 696c 6974 792e 0a0a  API stability...
+00000240: 5468 6973 2070 6163 6b61 6765 2069 7320  This package is 
+00000250: 6375 7272 656e 746c 7920 696e 2045 5850  currently in EXP
+00000260: 4552 494d 454e 5441 4c20 7374 6167 6520  ERIMENTAL stage 
+00000270: 616e 6420 6e65 7765 7220 7265 6c65 7365  and newer relese
+00000280: 7320 6d69 6768 7420 6368 616e 6765 2041  s might change A
+00000290: 5049 7320 2866 756e 6374 696f 6e20 6e61  PIs (function na
+000002a0: 6d65 732c 2070 6172 616d 6574 6572 732c  mes, parameters,
+000002b0: 2065 7463 2e2e 292e 0a0a 2323 2053 7570   etc..)...## Sup
+000002c0: 706f 7274 6564 2073 7061 726b 2f64 6174  ported spark/dat
+000002d0: 6162 7269 636b 7320 7665 7273 696f 6e73  abricks versions
+000002e0: 0a0a 4465 7665 6c6f 706d 656e 7420 616e  ..Development an
+000002f0: 6420 7465 7374 696e 6720 6861 7320 6265  d testing has be
+00000300: 656e 2070 6572 666f 726d 6564 206f 6e20  en performed on 
+00000310: 3132 2e32 204c 5453 2064 6174 6162 7269  12.2 LTS databri
+00000320: 636b 7320 7275 6e74 696d 652e 2044 6174  cks runtime. Dat
+00000330: 6162 7269 636b 7320 7275 6e74 696d 6520  abricks runtime 
+00000340: 3130 2e34 204c 5453 2073 686f 756c 6420  10.4 LTS should 
+00000350: 616c 736f 2077 6f72 6b20 7769 7468 2065  also work with e
+00000360: 7863 6570 7469 6f6e 206f 6620 6053 7061  xception of `Spa
+00000370: 726b 5069 7065 6c69 6e65 2e73 7465 705f  rkPipeline.step_
+00000380: 7370 6172 6b5f 666f 725f 6561 6368 5f62  spark_for_each_b
+00000390: 6174 6368 6020 616e 6420 6053 7061 726b  atch` and `Spark
+000003a0: 5069 7065 6c69 6e65 2e73 7061 726b 5f6d  Pipeline.spark_m
+000003b0: 6574 7269 6360 2077 6869 6368 2072 6571  etric` which req
+000003c0: 7569 7265 2031 322e 3220 4c54 5320 7275  uire 12.2 LTS ru
+000003d0: 6e74 696d 6520 746f 2077 6f72 6b2e 0a0a  ntime to work...
+000003e0: 2323 2056 6572 626f 7365 206f 7574 7075  ## Verbose outpu
+000003f0: 740a 0a62 6471 2075 7469 6c69 7a65 7320  t..bdq utilizes 
+00000400: 7079 7468 6f6e 2060 6c6f 6767 696e 6760  python `logging`
+00000410: 206d 6f64 756c 652c 2068 656e 6365 2066   module, hence f
+00000420: 6f72 2074 6865 2062 6573 7420 6c6f 6767  or the best logg
+00000430: 696e 6720 6578 7065 7269 656e 6365 2063  ing experience c
+00000440: 6f6e 6669 6775 7265 206c 6f67 6765 722c  onfigure logger,
+00000450: 2065 7861 6d70 6c65 2073 6574 7570 3a0a   example setup:.
+00000460: 0a60 6060 7079 7468 6f6e 0a69 6d70 6f72  .```python.impor
+00000470: 7420 6c6f 6767 696e 670a 696d 706f 7274  t logging.import
+00000480: 2073 7973 0a0a 2320 7079 346a 2069 7320   sys..# py4j is 
+00000490: 7665 7279 2063 6861 7474 792c 206e 6f20  very chatty, no 
+000004a0: 6e65 6564 2074 6f20 6465 616c 2077 6974  need to deal wit
+000004b0: 6820 6974 2075 6e6c 6573 7320 6974 2773  h it unless it's
+000004c0: 2063 7269 7469 6361 6c0a 6c6f 6767 696e   critical.loggin
+000004d0: 672e 6765 744c 6f67 6765 7228 2770 7934  g.getLogger('py4
+000004e0: 6a27 292e 7365 744c 6576 656c 286c 6f67  j').setLevel(log
+000004f0: 6769 6e67 2e43 5249 5449 4341 4c29 0a0a  ging.CRITICAL)..
+00000500: 2320 7275 6e20 6576 6572 7974 6869 6e67  # run everything
+00000510: 2065 6c73 6520 6f6e 2044 4542 5547 2062   else on DEBUG b
+00000520: 7920 6465 6661 756c 740a 2320 4445 4255  y default.# DEBU
+00000530: 4720 7072 696e 7473 2061 206c 6f74 206f  G prints a lot o
+00000540: 6620 7573 6566 756c 6c20 696e 666f 2c20  f usefull info, 
+00000550: 494e 464f 2069 7320 676f 6f64 2069 6e20  INFO is good in 
+00000560: 6765 6e65 7261 6c20 7573 6520 6361 7365  general use case
+00000570: 730a 6c6f 6767 696e 672e 6261 7369 6343  s.logging.basicC
+00000580: 6f6e 6669 6728 0a20 2073 7472 6561 6d3d  onfig(.  stream=
+00000590: 7379 732e 7374 6465 7272 2c0a 2020 6c65  sys.stderr,.  le
+000005a0: 7665 6c3d 6c6f 6767 696e 672e 4445 4255  vel=logging.DEBU
+000005b0: 472c 200a 2020 666f 726d 6174 3d27 2528  G, .  format='%(
+000005c0: 6173 6374 696d 6529 7320 2528 6c65 7665  asctime)s %(leve
+000005d0: 6c6e 616d 6529 7320 2528 7468 7265 6164  lname)s %(thread
+000005e0: 4e61 6d65 2973 205b 2528 6e61 6d65 2973  Name)s [%(name)s
+000005f0: 5d20 2528 6d65 7373 6167 6529 7327 0a29  ] %(message)s'.)
+00000600: 0a60 6060 0a0a 2323 2320 4578 616d 706c  .```..### Exampl
+00000610: 6573 0a0a 5365 6520 6578 616d 706c 6573  es..See examples
+00000620: 2062 656c 6c6f 7720 666f 7220 7368 6f72   bellow for shor
+00000630: 7420 6c69 7374 696e 6720 6f66 206d 616a  t listing of maj
+00000640: 6f72 2066 756e 6374 696f 6e61 6c69 7469  or functionaliti
+00000650: 6573 2e20 5365 6520 6074 6573 7473 6020  es. See `tests` 
+00000660: 666f 6c64 6572 2066 6f72 2064 6574 6169  folder for detai
+00000670: 6c65 6420 6578 616d 706c 6573 2e20 5465  led examples. Te
+00000680: 7374 7320 6172 6520 6d65 616e 7420 746f  sts are meant to
+00000690: 2064 6f75 626c 6520 6173 2072 6561 6c20   double as real 
+000006a0: 7573 6520 6361 7365 7320 6865 6e63 6520  use cases hence 
+000006b0: 7468 6579 2073 6572 7665 2061 7320 646f  they serve as do
+000006c0: 6375 6d65 6e74 6174 696f 6e20 6f66 2065  cumentation of e
+000006d0: 7861 6d70 6c65 7320 666f 7220 6e6f 772e  xamples for now.
+000006e0: 0a0a 2323 2043 6f6d 7061 7269 6e67 2064  ..## Comparing d
+000006f0: 6174 6166 7261 6d65 2073 6368 656d 6173  ataframe schemas
+00000700: 0a0a 6060 6070 7974 686f 6e0a 696d 706f  ..```python.impo
+00000710: 7274 2062 6471 0a66 726f 6d20 6461 7465  rt bdq.from date
+00000720: 7469 6d65 2069 6d70 6f72 7420 6461 7465  time import date
+00000730: 7469 6d65 0a69 6d70 6f72 7420 7079 7370  time.import pysp
+00000740: 6172 6b2e 7371 6c2e 6675 6e63 7469 6f6e  ark.sql.function
+00000750: 7320 6173 2046 0a0a 6466 3220 3d20 7370  s as F..df2 = sp
+00000760: 6172 6b2e 6372 6561 7465 4461 7461 4672  ark.createDataFr
+00000770: 616d 6528 5b0a 5b20 312c 2031 2c20 2247  ame([.[ 1, 1, "G
+00000780: 727a 6567 6f72 7a22 2c20 6461 7465 7469  rzegorz", dateti
+00000790: 6d65 2832 3031 382c 2031 2c20 3129 2c20  me(2018, 1, 1), 
+000007a0: 6461 7465 7469 6d65 2832 3031 382c 2031  datetime(2018, 1
+000007b0: 2c20 312c 2031 322c 2033 342c 2035 3629  , 1, 12, 34, 56)
+000007c0: 2c20 3236 2e39 2c20 3132 3332 3334 3233  , 26.9, 12323423
+000007d0: 3433 3435 2c20 5472 7565 5d2c 0a5b 2033  4345, True],.[ 3
+000007e0: 2c20 312c 2022 4d69 6b65 222c 2020 2020  , 1, "Mike",    
+000007f0: 2064 6174 6574 696d 6528 3230 3139 2c20   datetime(2019, 
+00000800: 312c 2031 292c 2064 6174 6574 696d 6528  1, 1), datetime(
+00000810: 3230 3138 2c20 332c 2031 2c20 3132 2c20  2018, 3, 1, 12, 
+00000820: 3334 2c20 3536 292c 2034 362e 372c 2035  34, 56), 46.7, 5
+00000830: 3636 3738 3838 3938 392c 2046 616c 7365  667888989, False
+00000840: 5d2c 0a5b 2032 2c20 322c 2022 5469 6d6d  ],.[ 2, 2, "Timm
+00000850: 7922 2c20 2020 2064 6174 6574 696d 6528  y",    datetime(
+00000860: 3230 3138 2c20 312c 2031 292c 2064 6174  2018, 1, 1), dat
+00000870: 6574 696d 6528 3230 3138 2c20 322c 2031  etime(2018, 2, 1
+00000880: 2c20 3132 2c20 3334 2c20 3536 292c 2033  , 12, 34, 56), 3
+00000890: 362e 372c 2038 3735 3438 3537 3834 352c  6.7, 8754857845,
+000008a0: 2054 7275 655d 0a5d 2c20 7363 6865 6d61   True].], schema
+000008b0: 290a 0a64 6632 5f63 6861 6e67 6564 203d  )..df2_changed =
+000008c0: 2064 6632 205c 0a20 202e 6472 6f70 2827   df2 \.  .drop('
+000008d0: 6669 7273 745f 6c6f 6769 6e5f 6474 2729  first_login_dt')
+000008e0: 205c 0a20 202e 7769 7468 436f 6c75 6d6e   \.  .withColumn
+000008f0: 2827 6e65 775f 6461 7461 272c 2046 2e6c  ('new_data', F.l
+00000900: 6974 284e 6f6e 6529 2e63 6173 7428 2764  it(None).cast('d
+00000910: 6174 6527 2929 205c 0a20 202e 7769 7468  ate')) \.  .with
+00000920: 436f 6c75 6d6e 2827 6c69 6b65 7327 2c20  Column('likes', 
+00000930: 462e 636f 6c28 276c 696b 6573 2729 2e63  F.col('likes').c
+00000940: 6173 7428 2769 6e74 2729 290a 0a61 7373  ast('int'))..ass
+00000950: 6572 7420 6264 712e 636f 6d70 6172 655f  ert bdq.compare_
+00000960: 7363 6865 6d61 7328 6466 322e 7363 6865  schemas(df2.sche
+00000970: 6d61 2c20 6466 325f 6368 616e 6765 642e  ma, df2_changed.
+00000980: 7363 6865 6d61 2920 3d3d 207b 0a20 2027  schema) == {.  '
+00000990: 6164 6465 6427 3a20 7b27 6669 7273 745f  added': {'first_
+000009a0: 6c6f 6769 6e5f 6474 277d 2c20 0a20 2027  login_dt'}, .  '
+000009b0: 7265 6d6f 7665 6427 3a20 7b27 6e65 775f  removed': {'new_
+000009c0: 6461 7461 277d 2c20 0a20 2027 6368 616e  data'}, .  'chan
+000009d0: 6765 6427 3a20 7b0a 2020 2020 276c 696b  ged': {.    'lik
+000009e0: 6573 273a 207b 2762 6566 6f72 6527 3a20  es': {'before': 
+000009f0: 2762 6967 696e 7427 2c20 2761 6674 6572  'bigint', 'after
+00000a00: 273a 2027 696e 7427 7d0a 2020 7d2c 0a20  ': 'int'}.  },. 
+00000a10: 2027 6e6f 745f 6368 616e 6765 6427 3a20   'not_changed': 
+00000a20: 7b0a 2020 2020 276e 616d 6527 2c20 2769  {.    'name', 'i
+00000a30: 6431 272c 2027 6c61 7374 5f6c 6f67 696e  d1', 'last_login
+00000a40: 5f74 7327 2c20 2769 6432 272c 2027 6372  _ts', 'id2', 'cr
+00000a50: 6564 6974 7327 2c20 2761 6374 6976 6527  edits', 'active'
+00000a60: 0a20 207d 0a7d 0a60 6060 0a0a 2323 2320  .  }.}.```..### 
+00000a70: 436f 6d70 6172 696e 6720 6461 7461 6672  Comparing datafr
+00000a80: 616d 6527 7320 6461 7461 0a0a 6060 6070  ame's data..```p
+00000a90: 7974 686f 6e0a 696d 706f 7274 2062 6471  ython.import bdq
+00000aa0: 0a0a 6466 3120 3d20 7370 6172 6b2e 6372  ..df1 = spark.cr
+00000ab0: 6561 7465 4461 7461 4672 616d 6528 5b0a  eateDataFrame([.
+00000ac0: 5b20 312c 2031 2c20 2247 727a 6567 6f72  [ 1, 1, "Grzegor
+00000ad0: 7a22 2c20 6461 7465 7469 6d65 2832 3031  z", datetime(201
+00000ae0: 372c 2031 2c20 3129 2c20 6461 7465 7469  7, 1, 1), dateti
+00000af0: 6d65 2832 3031 382c 2031 2c20 312c 2031  me(2018, 1, 1, 1
+00000b00: 322c 2033 342c 2035 3629 2c20 3236 2e37  2, 34, 56), 26.7
+00000b10: 2c20 3132 3332 3334 3233 3433 3435 2c20  , 123234234345, 
+00000b20: 5472 7565 5d2c 0a5b 2032 2c20 312c 2022  True],.[ 2, 1, "
+00000b30: 5469 6d22 2c20 2020 2020 2064 6174 6574  Tim",      datet
+00000b40: 696d 6528 3230 3138 2c20 312c 2031 292c  ime(2018, 1, 1),
+00000b50: 2064 6174 6574 696d 6528 3230 3138 2c20   datetime(2018, 
+00000b60: 322c 2031 2c20 3132 2c20 3334 2c20 3536  2, 1, 12, 34, 56
+00000b70: 292c 2033 362e 372c 2035 3435 3435 2c20  ), 36.7, 54545, 
+00000b80: 2020 2020 2054 7275 655d 2c0a 5b20 332c       True],.[ 3,
+00000b90: 2031 2c20 224d 696b 6522 2c20 2020 2020   1, "Mike",     
+00000ba0: 6461 7465 7469 6d65 2832 3031 392c 2031  datetime(2019, 1
+00000bb0: 2c20 3129 2c20 6461 7465 7469 6d65 2832  , 1), datetime(2
+00000bc0: 3031 382c 2033 2c20 312c 2031 322c 2033  018, 3, 1, 12, 3
+00000bd0: 342c 2035 3629 2c20 3436 2e37 2c20 3536  4, 56), 46.7, 56
+00000be0: 3637 3838 3839 3839 2c20 4661 6c73 655d  67888989, False]
+00000bf0: 0a5d 2c20 7363 6865 6d61 290a 0a64 6632  .], schema)..df2
+00000c00: 203d 2073 7061 726b 2e63 7265 6174 6544   = spark.createD
+00000c10: 6174 6146 7261 6d65 285b 0a5b 2031 2c20  ataFrame([.[ 1, 
+00000c20: 312c 2022 4772 7a65 676f 727a 222c 2064  1, "Grzegorz", d
+00000c30: 6174 6574 696d 6528 3230 3138 2c20 312c  atetime(2018, 1,
+00000c40: 2031 292c 2064 6174 6574 696d 6528 3230   1), datetime(20
+00000c50: 3138 2c20 312c 2031 2c20 3132 2c20 3334  18, 1, 1, 12, 34
+00000c60: 2c20 3536 292c 2032 362e 392c 2031 3233  , 56), 26.9, 123
+00000c70: 3233 3432 3334 3334 352c 2054 7275 655d  234234345, True]
+00000c80: 2c0a 5b20 332c 2031 2c20 224d 696b 6522  ,.[ 3, 1, "Mike"
+00000c90: 2c20 2020 2020 6461 7465 7469 6d65 2832  ,     datetime(2
+00000ca0: 3031 392c 2031 2c20 3129 2c20 6461 7465  019, 1, 1), date
+00000cb0: 7469 6d65 2832 3031 382c 2033 2c20 312c  time(2018, 3, 1,
+00000cc0: 2031 322c 2033 342c 2035 3629 2c20 3436   12, 34, 56), 46
+00000cd0: 2e37 2c20 3536 3637 3838 3839 3839 2c20  .7, 5667888989, 
+00000ce0: 4661 6c73 655d 2c0a 5b20 322c 2032 2c20  False],.[ 2, 2, 
+00000cf0: 2254 696d 6d79 222c 2020 2020 6461 7465  "Timmy",    date
+00000d00: 7469 6d65 2832 3031 382c 2031 2c20 3129  time(2018, 1, 1)
+00000d10: 2c20 6461 7465 7469 6d65 2832 3031 382c  , datetime(2018,
+00000d20: 2032 2c20 312c 2031 322c 2033 342c 2035   2, 1, 12, 34, 5
+00000d30: 3629 2c20 3336 2e37 2c20 3837 3534 3835  6), 36.7, 875485
+00000d40: 3738 3435 2c20 5472 7565 5d0a 5d2c 2073  7845, True].], s
+00000d50: 6368 656d 6129 0a0a 2372 6574 7572 6e73  chema)..#returns
+00000d60: 2064 6963 7473 2077 6974 6820 6164 6465   dicts with adde
+00000d70: 642c 2072 656d 6f76 6564 2c20 6368 616e  d, removed, chan
+00000d80: 6765 6420 616e 6420 6e6f 7420 6368 616e  ged and not chan
+00000d90: 6765 6420 6461 7461 6672 616d 6573 2c20  ged dataframes, 
+00000da0: 616e 6420 7265 636f 7264 2063 6f75 6e74  and record count
+00000db0: 730a 6466 5f64 6966 6620 3d20 6264 712e  s.df_diff = bdq.
+00000dc0: 636f 6d70 6172 655f 6461 7461 6672 616d  compare_datafram
+00000dd0: 6573 2864 6631 2c20 6466 322c 205b 2769  es(df1, df2, ['i
+00000de0: 6431 272c 2027 6964 3227 5d2c 2054 7275  d1', 'id2'], Tru
+00000df0: 6529 0a0a 2373 686f 7720 616c 6c20 696e  e)..#show all in
+00000e00: 666f 2061 626f 7574 2063 6f6d 7061 7265  fo about compare
+00000e10: 2072 6573 756c 7473 0a62 6471 2e64 6973   results.bdq.dis
+00000e20: 706c 6179 5f63 6f6d 7061 7265 5f64 6174  play_compare_dat
+00000e30: 6166 7261 6d65 735f 7265 7375 6c74 7328  aframes_results(
+00000e40: 6466 5f64 6966 6629 0a0a 3e3e 2041 6464  df_diff)..>> Add
+00000e50: 6564 2072 6563 6f72 6473 2063 6f75 6e74  ed records count
+00000e60: 3a20 310a 3e3e 202b 2d2d 2d2b 2d2d 2d2b  : 1.>> +---+---+
+00000e70: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00000e80: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+00000e90: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00000ea0: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  +----------+----
+00000eb0: 2d2d 2b0a 3e3e 207c 6964 317c 6964 327c  --+.>> |id1|id2|
+00000ec0: 6e61 6d65 207c 6669 7273 745f 6c6f 6769  name |first_logi
+00000ed0: 6e5f 6474 7c6c 6173 745f 6c6f 6769 6e5f  n_dt|last_login_
+00000ee0: 7473 2020 2020 2020 7c63 7265 6469 7473  ts      |credits
+00000ef0: 7c6c 696b 6573 2020 2020 207c 6163 7469  |likes     |acti
+00000f00: 7665 7c0a 3e3e 202b 2d2d 2d2b 2d2d 2d2b  ve|.>> +---+---+
+00000f10: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00000f20: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+00000f30: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00000f40: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  +----------+----
+00000f50: 2d2d 2b0a 3e3e 207c 3220 207c 3220 207c  --+.>> |2  |2  |
+00000f60: 5469 6d6d 797c 3230 3138 2d30 312d 3031  Timmy|2018-01-01
+00000f70: 2020 2020 7c32 3031 382d 3032 2d30 3120      |2018-02-01 
+00000f80: 3132 3a33 343a 3536 7c33 362e 3720 2020  12:34:56|36.7   
+00000f90: 7c38 3735 3438 3537 3834 357c 7472 7565  |8754857845|true
+00000fa0: 2020 7c0a 3e3e 202b 2d2d 2d2b 2d2d 2d2b    |.>> +---+---+
+00000fb0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00000fc0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+00000fd0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00000fe0: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  +----------+----
+00000ff0: 2d2d 2b0a 3e3e 200a 3e3e 2052 656d 6f76  --+.>> .>> Remov
+00001000: 6564 2072 6563 6f72 6473 2063 6f75 6e74  ed records count
+00001010: 3a20 310a 3e3e 202b 2d2d 2d2b 2d2d 2d2b  : 1.>> +---+---+
+00001020: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+00001030: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+00001040: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b  -------+-------+
+00001050: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e  -----+------+.>>
+00001060: 207c 6964 317c 6964 327c 6e61 6d65 7c66   |id1|id2|name|f
+00001070: 6972 7374 5f6c 6f67 696e 5f64 747c 6c61  irst_login_dt|la
+00001080: 7374 5f6c 6f67 696e 5f74 7320 2020 2020  st_login_ts     
+00001090: 207c 6372 6564 6974 737c 6c69 6b65 737c   |credits|likes|
+000010a0: 6163 7469 7665 7c0a 3e3e 202b 2d2d 2d2b  active|.>> +---+
+000010b0: 2d2d 2d2b 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  ---+----+-------
+000010c0: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  -------+--------
+000010d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+000010e0: 2d2d 2d2b 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  ---+-----+------
+000010f0: 2b0a 3e3e 207c 3220 207c 3120 207c 5469  +.>> |2  |1  |Ti
+00001100: 6d20 7c32 3031 382d 3031 2d30 3120 2020  m |2018-01-01   
+00001110: 207c 3230 3138 2d30 322d 3031 2031 323a   |2018-02-01 12:
+00001120: 3334 3a35 367c 3336 2e37 2020 207c 3534  34:56|36.7   |54
+00001130: 3534 357c 7472 7565 2020 7c0a 3e3e 202b  545|true  |.>> +
+00001140: 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2b2d 2d2d  ---+---+----+---
+00001150: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00001160: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00001170: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2b 2d2d  -------+-----+--
+00001180: 2d2d 2d2d 2b0a 3e3e 200a 3e3e 2043 6861  ----+.>> .>> Cha
+00001190: 6e67 6564 2072 6563 6f72 6473 2063 6f75  nged records cou
+000011a0: 6e74 3a20 310a 3e3e 202b 2d2d 2d2b 2d2d  nt: 1.>> +---+--
+000011b0: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
+000011c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000011d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000011e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000011f0: 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c69 6431  -------+.>> |id1
+00001200: 7c69 6432 7c63 6861 6e67 6564 2020 2020  |id2|changed    
+00001210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001240: 2020 2020 2020 2020 2020 7c0a 3e3e 202b            |.>> +
+00001250: 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  ---+---+--------
+00001260: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001270: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001280: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001290: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e  -------------+.>
+000012a0: 3e20 7c31 2020 7c31 2020 7c7b 6669 7273  > |1  |1  |{firs
+000012b0: 745f 6c6f 6769 6e5f 6474 202d 3e20 7b32  t_login_dt -> {2
+000012c0: 3031 372d 3031 2d30 312c 2032 3031 382d  017-01-01, 2018-
+000012d0: 3031 2d30 317d 2c20 6372 6564 6974 7320  01-01}, credits 
+000012e0: 2d3e 207b 3236 2e37 2c20 3236 2e39 7d7d  -> {26.7, 26.9}}
+000012f0: 7c0a 3e3e 202b 2d2d 2d2b 2d2d 2d2b 2d2d  |.>> +---+---+--
+00001300: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001310: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001320: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001330: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001340: 2d2d 2d2b 0a0a 4e6f 7420 6368 616e 6765  ---+..Not change
+00001350: 6420 7265 636f 7264 7320 636f 756e 743a  d records count:
+00001360: 2031 0a60 6060 0a0a 2323 2320 5375 7272   1.```..### Surr
+00001370: 6f67 6174 6520 6b65 7920 6765 6e65 7261  ogate key genera
+00001380: 7469 6f6e 0a0a 7769 7468 2073 7570 706f  tion..with suppo
+00001390: 7274 206f 6620 6f70 7469 6f6e 616c 2075  rt of optional u
+000013a0: 7070 6572 6361 7369 6e67 2061 6e64 2074  ppercasing and t
+000013b0: 7269 6d6d 696e 6720 6f66 206b 6579 2063  rimming of key c
+000013c0: 6f6c 756d 6e73 0a0a 6060 6070 7974 686f  olumns..```pytho
+000013d0: 6e0a 6672 6f6d 2064 6174 6574 696d 6520  n.from datetime 
+000013e0: 696d 706f 7274 2064 6174 6574 696d 650a  import datetime.
+000013f0: 6672 6f6d 2062 6471 2e66 756e 6374 696f  from bdq.functio
+00001400: 6e73 2069 6d70 6f72 7420 7375 7272 6f67  ns import surrog
+00001410: 6174 655f 6b65 795f 6861 7368 2c20 7375  ate_key_hash, su
+00001420: 7272 6f67 6174 655f 6b65 795f 7374 7269  rrogate_key_stri
+00001430: 6e67 0a0a 7363 6865 6d61 203d 2022 6964  ng..schema = "id
+00001440: 313a 6c6f 6e67 2c69 6432 3a6c 6f6e 672c  1:long,id2:long,
+00001450: 6e61 6d65 3a73 7472 696e 672c 6c69 6b65  name:string,like
+00001460: 733a 696e 7422 0a0a 6466 3120 3d20 7370  s:int"..df1 = sp
+00001470: 6172 6b2e 6372 6561 7465 4461 7461 4672  ark.createDataFr
+00001480: 616d 6528 5b0a 2020 5b20 312c 2031 2c20  ame([.  [ 1, 1, 
+00001490: 2247 727a 6547 6f72 7a22 2c20 3120 5d2c  "GrzeGorz", 1 ],
+000014a0: 0a20 205b 2031 2c20 312c 2022 4772 7a65  .  [ 1, 1, "Grze
+000014b0: 676f 727a 222c 2020 3120 5d2c 0a20 205b  gorz",  1 ],.  [
+000014c0: 2031 2c20 312c 2022 4772 7a65 676f 727a   1, 1, "Grzegorz
+000014d0: 2020 2020 2020 222c 2020 3120 5d2c 0a20        ",  1 ],. 
+000014e0: 205b 2031 2c20 4e6f 6e65 2c20 2247 727a   [ 1, None, "Grz
+000014f0: 6567 6f72 7a22 2c20 315d 2c0a 2020 5b20  egorz", 1],.  [ 
+00001500: 312c 204e 6f6e 652c 204e 6f6e 652c 2031  1, None, None, 1
+00001510: 5d2c 0a20 205b 2032 2c20 312c 2022 5469  ],.  [ 2, 1, "Ti
+00001520: 6d22 2c20 3120 5d2c 0a20 205b 2033 2c20  m", 1 ],.  [ 3, 
+00001530: 312c 2022 4d69 6b65 222c 2031 205d 0a5d  1, "Mike", 1 ].]
+00001540: 2c20 7363 6865 6d61 290a 0a73 6b5f 6466  , schema)..sk_df
+00001550: 203d 2064 6631 2e73 656c 6563 7428 0a20   = df1.select(. 
+00001560: 2027 2a27 2c20 0a20 2073 7572 726f 6761   '*', .  surroga
+00001570: 7465 5f6b 6579 5f68 6173 6828 5b27 6964  te_key_hash(['id
+00001580: 3127 2c20 2769 6432 272c 2027 6e61 6d65  1', 'id2', 'name
+00001590: 275d 2c20 7274 7269 6d3d 5472 7565 292e  '], rtrim=True).
+000015a0: 616c 6961 7328 2768 6173 6827 292c 0a20  alias('hash'),. 
+000015b0: 2073 7572 726f 6761 7465 5f6b 6579 5f73   surrogate_key_s
+000015c0: 7472 696e 6728 5b27 6964 3127 2c20 2769  tring(['id1', 'i
+000015d0: 6432 272c 2027 6e61 6d65 275d 2c20 7274  d2', 'name'], rt
+000015e0: 7269 6d3d 5472 7565 292e 616c 6961 7328  rim=True).alias(
+000015f0: 2768 6173 685f 696e 7075 7427 290a 290a  'hash_input').).
+00001600: 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2b 2d2d  .>> +---+----+--
+00001610: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d  ------------+---
+00001620: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
+00001630: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001640: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001650: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001660: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---------------
+00001670: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 3e3e  ------------+.>>
+00001680: 207c 6964 317c 6964 3220 7c6e 616d 6520   |id1|id2 |name 
+00001690: 2020 2020 2020 2020 207c 6c69 6b65 737c           |likes|
+000016a0: 6861 7368 2020 2020 2020 2020 2020 2020  hash            
+000016b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000016c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000016d0: 2020 2020 2020 2020 2020 2020 207c 6861               |ha
+000016e0: 7368 5f69 6e70 7574 2020 2020 2020 2020  sh_input        
+000016f0: 2020 2020 2020 2020 207c 0a3e 3e20 2b2d           |.>> +-
+00001700: 2d2d 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  --+----+--------
+00001710: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2b2d 2d2d  ------+-----+---
+00001720: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001730: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001740: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001750: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00001760: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001770: 2d2d 2d2d 2d2d 2b0a 3e3e 207c 3120 207c  ------+.>> |1  |
+00001780: 3120 2020 7c47 727a 6547 6f72 7a20 2020  1   |GrzeGorz   
+00001790: 2020 207c 3120 2020 207c 5b36 4620 3231     |1    |[6F 21
+000017a0: 2039 3920 3939 2034 4320 4632 2039 3320   99 99 4C F2 93 
+000017b0: 3536 2032 4520 3743 2043 3320 3239 2046  56 2E 7C C3 29 F
+000017c0: 3920 3641 2034 3220 3246 2036 4420 3632  9 6A 42 2F 6D 62
+000017d0: 2045 4320 3442 5d7c 5b31 2c20 312c 2047   EC 4B]|[1, 1, G
+000017e0: 525a 4547 4f52 5a5d 2020 2020 2020 2020  RZEGORZ]        
+000017f0: 2020 207c 0a3e 3e20 7c31 2020 7c31 2020     |.>> |1  |1  
+00001800: 207c 4772 7a65 676f 727a 2020 2020 2020   |Grzegorz      
+00001810: 7c31 2020 2020 7c5b 3646 2032 3120 3939  |1    |[6F 21 99
+00001820: 2039 3920 3443 2046 3220 3933 2035 3620   99 4C F2 93 56 
+00001830: 3245 2037 4320 4333 2032 3920 4639 2036  2E 7C C3 29 F9 6
+00001840: 4120 3432 2032 4620 3644 2036 3220 4543  A 42 2F 6D 62 EC
+00001850: 2034 425d 7c5b 312c 2031 2c20 4752 5a45   4B]|[1, 1, GRZE
+00001860: 474f 525a 5d20 2020 2020 2020 2020 2020  GORZ]           
+00001870: 7c0a 3e3e 207c 3120 207c 3120 2020 7c47  |.>> |1  |1   |G
+00001880: 727a 6567 6f72 7a20 2020 2020 207c 3120  rzegorz      |1 
+00001890: 2020 207c 5b36 4620 3231 2039 3920 3939     |[6F 21 99 99
+000018a0: 2034 4320 4632 2039 3320 3536 2032 4520   4C F2 93 56 2E 
+000018b0: 3743 2043 3320 3239 2046 3920 3641 2034  7C C3 29 F9 6A 4
+000018c0: 3220 3246 2036 4420 3632 2045 4320 3442  2 2F 6D 62 EC 4B
+000018d0: 5d7c 5b31 2c20 312c 2047 525a 4547 4f52  ]|[1, 1, GRZEGOR
+000018e0: 5a5d 2020 2020 2020 2020 2020 207c 0a3e  Z]           |.>
+000018f0: 3e20 7c31 2020 7c6e 756c 6c7c 4772 7a65  > |1  |null|Grze
+00001900: 676f 727a 2020 2020 2020 7c31 2020 2020  gorz      |1    
+00001910: 7c5b 3445 2039 4520 3341 2032 4220 4338  |[4E 9E 3A 2B C8
+00001920: 2033 3720 3930 2041 3020 3641 2032 3620   37 90 A0 6A 26 
+00001930: 3941 2046 4520 3741 2037 3820 3842 2043  9A FE 7A 78 8B C
+00001940: 4120 3939 2033 3420 3638 2031 435d 7c5b  A 99 34 68 1C]|[
+00001950: 312c 2040 7e3c 6e75 6c6c 3e7e 402c 2047  1, @~<null>~@, G
+00001960: 525a 4547 4f52 5a5d 2020 7c0a 3e3e 207c  RZEGORZ]  |.>> |
+00001970: 3120 207c 6e75 6c6c 7c6e 756c 6c20 2020  1  |null|null   
+00001980: 2020 2020 2020 207c 3120 2020 207c 5b34         |1    |[4
+00001990: 3420 4646 2038 3820 3245 2032 4120 3238  4 FF 88 2E 2A 28
+000019a0: 2033 4220 4545 2045 4520 3533 2043 3820   3B EE EE 53 C8 
+000019b0: 3744 2030 4620 3932 2044 3120 3638 2033  7D 0F 92 D1 68 3
+000019c0: 4520 4132 2046 3220 4535 5d7c 5b31 2c20  E A2 F2 E5]|[1, 
+000019d0: 407e 3c6e 756c 6c3e 7e40 2c20 407e 3c6e  @~<null>~@, @~<n
+000019e0: 756c 6c3e 7e40 5d7c 0a3e 3e20 7c32 2020  ull>~@]|.>> |2  
+000019f0: 7c31 2020 207c 5469 6d20 2020 2020 2020  |1   |Tim       
+00001a00: 2020 2020 7c31 2020 2020 7c5b 4138 2037      |1    |[A8 7
+00001a10: 4120 4230 2032 3920 3934 2039 4620 3543  A B0 29 94 9F 5C
+00001a20: 2044 3120 3738 2044 3420 3238 2038 3920   D1 78 D4 28 89 
+00001a30: 3842 2046 3120 3735 2043 4420 4143 2037  8B F1 75 CD AC 7
+00001a40: 3020 4236 2036 315d 7c5b 322c 2031 2c20  0 B6 61]|[2, 1, 
+00001a50: 5449 4d5d 2020 2020 2020 2020 2020 2020  TIM]            
+00001a60: 2020 2020 7c0a 3e3e 207c 3320 207c 3120      |.>> |3  |1 
+00001a70: 2020 7c4d 696b 6520 2020 2020 2020 2020    |Mike         
+00001a80: 207c 3120 2020 207c 5b39 4420 3643 2037   |1    |[9D 6C 7
+00001a90: 3620 4335 2031 3720 4430 2034 3420 3436  6 C5 17 D0 44 46
+00001aa0: 2034 3720 3141 2037 3120 4544 2034 4120   47 1A 71 ED 4A 
+00001ab0: 3038 2037 3520 3834 2031 4420 3543 2034  08 75 84 1D 5C 4
+00001ac0: 3520 3039 5d7c 5b33 2c20 312c 204d 494b  5 09]|[3, 1, MIK
+00001ad0: 455d 2020 2020 2020 2020 2020 2020 2020  E]              
+00001ae0: 207c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2b   |.>> +---+----+
+00001af0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
+00001b00: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+00001b10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001b20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001b30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001b40: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
+00001b50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a  --------------+.
+00001b60: 6060 600a 0a23 2323 2050 4b20 2620 464b  ```..### PK & FK
+00001b70: 2069 6e74 6572 6772 6974 7920 6368 6563   intergrity chec
+00001b80: 6b73 0a0a 7769 7468 2073 7570 706f 7274  ks..with support
+00001b90: 206f 6620 7368 6f77 696e 6720 7361 6d70   of showing samp
+00001ba0: 6c65 2064 6174 6120 6672 6f6d 2066 6163  le data from fac
+00001bb0: 7420 7461 626c 6520 7468 6174 2064 6964  t table that did
+00001bc0: 206e 6f74 2073 6174 6973 6679 2069 6e74   not satisfy int
+00001bd0: 6567 7269 7479 0a0a 6060 6070 7974 686f  egrity..```pytho
+00001be0: 6e0a 6672 6f6d 2062 6471 2069 6d70 6f72  n.from bdq impor
+00001bf0: 7420 6661 6374 5f64 696d 5f62 726f 6b65  t fact_dim_broke
+00001c00: 6e5f 7265 6c61 7469 6f6e 7368 6970 0a66  n_relationship.f
+00001c10: 726f 6d20 6264 712e 6675 6e63 7469 6f6e  rom bdq.function
+00001c20: 7320 696d 706f 7274 2073 7572 726f 6761  s import surroga
+00001c30: 7465 5f6b 6579 5f68 6173 682c 2073 7572  te_key_hash, sur
+00001c40: 726f 6761 7465 5f6b 6579 5f73 7472 696e  rogate_key_strin
+00001c50: 670a 0a66 6163 745f 6466 203d 2073 7061  g..fact_df = spa
+00001c60: 726b 2e63 7265 6174 6544 6174 6146 7261  rk.createDataFra
+00001c70: 6d65 285b 0a20 2020 205b 2022 4772 7a65  me([.    [ "Grze
+00001c80: 676f 727a 222c 2022 4954 222c 2022 4555  gorz", "IT", "EU
+00001c90: 2220 5d2c 0a20 2020 205b 2022 4d61 726b  " ],.    [ "Mark
+00001ca0: 222c 2022 4954 222c 2022 4555 2220 5d2c  ", "IT", "EU" ],
+00001cb0: 0a20 2020 205b 2022 4a75 7374 696e 222c  .    [ "Justin",
+00001cc0: 2022 4954 2020 222c 2022 4555 2020 2020   "IT  ", "EU    
+00001cd0: 2220 5d2c 0a20 2020 205b 2022 416c 6963  " ],.    [ "Alic
+00001ce0: 6531 222c 2022 4954 222c 2022 5553 4122  e1", "IT", "USA"
+00001cf0: 205d 2c0a 2020 2020 5b20 2241 6c69 6365   ],.    [ "Alice
+00001d00: 3222 2c20 2249 5422 2c20 2255 5341 2220  2", "IT", "USA" 
+00001d10: 5d2c 0a20 2020 205b 2022 416c 6963 6533  ],.    [ "Alice3
+00001d20: 222c 2022 4954 222c 2022 5553 4122 205d  ", "IT", "USA" ]
+00001d30: 2c0a 2020 2020 5b20 2241 6c69 6365 3422  ,.    [ "Alice4"
+00001d40: 2c20 2249 5422 2c20 2255 5341 2220 5d2c  , "IT", "USA" ],
+00001d50: 0a20 2020 205b 2022 416c 6963 6535 222c  .    [ "Alice5",
+00001d60: 2022 4954 222c 2022 5553 4122 205d 2c0a   "IT", "USA" ],.
+00001d70: 2020 2020 5b20 2242 6f62 222c 2022 5361      [ "Bob", "Sa
+00001d80: 6c65 7322 2c20 2255 5341 2220 5d2c 0a20  les", "USA" ],. 
+00001d90: 2020 205b 2022 426f 6232 222c 2022 5361     [ "Bob2", "Sa
+00001da0: 6c65 7322 2c20 2255 5341 2220 5d2c 0a20  les", "USA" ],. 
+00001db0: 2020 205b 2022 426f 6233 222c 2022 5361     [ "Bob3", "Sa
+00001dc0: 6c65 7322 2c20 2255 5341 2220 5d0a 2020  les", "USA" ].  
+00001dd0: 5d2c 2022 4e61 6d65 3a73 7472 696e 672c  ], "Name:string,
+00001de0: 4465 7074 3a73 7472 696e 672c 436f 756e  Dept:string,Coun
+00001df0: 7472 793a 7374 7269 6e67 2229 205c 0a20  try:string") \. 
+00001e00: 202e 7769 7468 436f 6c75 6d6e 2822 6465   .withColumn("de
+00001e10: 7074 5f66 6b22 2c20 7375 7272 6f67 6174  pt_fk", surrogat
+00001e20: 655f 6b65 795f 6861 7368 285b 2244 6570  e_key_hash(["Dep
+00001e30: 7422 2c20 2243 6f75 6e74 7279 225d 2c20  t", "Country"], 
+00001e40: 7274 7269 6d3d 5472 7565 2929 0a0a 6469  rtrim=True))..di
+00001e50: 6d5f 6466 203d 2073 7061 726b 2e63 7265  m_df = spark.cre
+00001e60: 6174 6544 6174 6146 7261 6d65 285b 0a20  ateDataFrame([. 
+00001e70: 2020 205b 2249 5422 2c20 2245 5522 2c20     ["IT", "EU", 
+00001e80: 2245 7572 6f70 6561 6e20 4954 2064 6570  "European IT dep
+00001e90: 6172 746d 656e 7422 5d2c 0a20 2020 205b  artment"],.    [
+00001ea0: 2253 616c 6573 222c 2022 5553 4122 2c20  "Sales", "USA", 
+00001eb0: 2255 5341 2053 616c 6573 2064 6570 742e  "USA Sales dept.
+00001ec0: 225d 0a20 205d 2c20 2264 6570 6172 746d  "].  ], "departm
+00001ed0: 656e 743a 7374 7269 6e67 2c63 6e74 7279  ent:string,cntry
+00001ee0: 3a73 7472 696e 672c 636f 6d6d 656e 743a  :string,comment:
+00001ef0: 7374 7269 6e67 2229 205c 0a20 202e 7769  string") \.  .wi
+00001f00: 7468 436f 6c75 6d6e 2822 6465 7074 5f70  thColumn("dept_p
+00001f10: 6b22 2c20 7375 7272 6f67 6174 655f 6b65  k", surrogate_ke
+00001f20: 795f 6861 7368 285b 2264 6570 6172 746d  y_hash(["departm
+00001f30: 656e 7422 2c20 2263 6e74 7279 225d 2c20  ent", "cntry"], 
+00001f40: 7274 7269 6d3d 5472 7565 2929 0a0a 2364  rtrim=True))..#d
+00001f50: 6972 6563 7420 636f 6c75 6d6e 2063 6f6d  irect column com
+00001f60: 7061 7269 736f 6e2c 2068 656e 6365 2075  parison, hence u
+00001f70: 7070 6572 2c20 6c6f 7765 722c 2065 7874  pper, lower, ext
+00001f80: 7261 2073 7061 6365 7320 6166 6665 6374  ra spaces affect
+00001f90: 2074 6865 2072 6573 756c 7473 0a62 726f   the results.bro
+00001fa0: 6b65 6e5f 6466 203d 2066 6163 745f 6469  ken_df = fact_di
+00001fb0: 6d5f 6272 6f6b 656e 5f72 656c 6174 696f  m_broken_relatio
+00001fc0: 6e73 6869 7028 0a20 2066 6163 745f 6466  nship(.  fact_df
+00001fd0: 3d66 6163 745f 6466 2c0a 2020 666b 5f63  =fact_df,.  fk_c
+00001fe0: 6f6c 756d 6e73 3d5b 2244 6570 7422 2c20  olumns=["Dept", 
+00001ff0: 2243 6f75 6e74 7279 225d 2c0a 2020 6469  "Country"],.  di
+00002000: 6d5f 6466 3d64 696d 5f64 662c 0a20 2070  m_df=dim_df,.  p
+00002010: 6b5f 636f 6c75 6d6e 733d 5b22 6465 7061  k_columns=["depa
+00002020: 7274 6d65 6e74 222c 2022 636e 7472 7922  rtment", "cntry"
+00002030: 5d2c 0a20 2073 616d 706c 655f 6272 6f6b  ],.  sample_brok
+00002040: 656e 5f72 6563 6f72 6473 3d32 0a29 0a0a  en_records=2.)..
+00002050: 3e3e 202b 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  >> +----+-------
+00002060: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---------------
 00002070: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
 00002080: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
 00002090: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000020a0: 2b0a 3e3e 207c 4465 7074 7c43 6f75 6e74  +.>> |Dept|Count
-000020b0: 7279 7c73 616d 706c 655f 7265 636f 7264  ry|sample_record
-000020c0: 7320 2020 2020 2020 2020 2020 2020 2020  s               
-000020d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000020a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000020b0: 2d2d 2d2d 2d2b 0a3e 3e20 7c44 6570 747c  -----+.>> |Dept|
+000020c0: 436f 756e 7472 797c 7361 6d70 6c65 5f72  Country|sample_r
+000020d0: 6563 6f72 6473 2020 2020 2020 2020 2020  ecords          
 000020e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000020f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002100: 2020 2020 2020 207c 0a3e 3e20 2b2d 2d2d         |.>> +---
-00002110: 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  -+-------+------
-00002120: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002110: 2020 2020 2020 2020 2020 2020 7c0a 3e3e              |.>>
+00002120: 202b 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d   +----+-------+-
 00002130: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
 00002140: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
 00002150: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002160: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a  --------------+.
-00002170: 3e3e 207c 4954 2020 7c55 5341 2020 2020  >> |IT  |USA    
-00002180: 7c5b 7b49 542c 2055 5341 2c20 416c 6963  |[{IT, USA, Alic
-00002190: 6531 2c20 efbf bdef bfbd 787a 3471 105f  e1, ......xz4q._
-000021a0: efbf bdef bfbd 115c 7261 efbf bd2d efbf  .......\ra...-..
-000021b0: bd16 efbf bd56 7a7d 2c20 7b49 542c 2055  .....Vz}, {IT, U
-000021c0: 5341 2c20 416c 6963 6532 2c20 efbf bdef  SA, Alice2, ....
-000021d0: bfbd 787a 3471 105f efbf bdef bfbd 115c  ..xz4q._.......\
-000021e0: 7261 efbf bd2d efbf bd16 efbf bd56 7a7d  ra...-.......Vz}
-000021f0: 5d7c 0a3e 3e20 2b2d 2d2d 2d2b 2d2d 2d2d  ]|.>> +----+----
-00002200: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
-00002210: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002220: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002230: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002240: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002250: 2d2d 2d2d 2d2d 2d2d 2b0a 6060 600a 0a23  --------+.```..#
-00002260: 2320 4765 7420 6c61 7465 7374 2072 6563  # Get latest rec
-00002270: 6f72 6473 200a 7769 7468 206f 7074 696f  ords .with optio
-00002280: 6e61 6c20 7072 696d 6172 7920 6b65 7920  nal primary key 
-00002290: 636f 6e66 6c69 6374 2072 6573 6f6c 7574  conflict resolut
-000022a0: 696f 6e2c 2077 6865 7265 2074 6865 7265  ion, where there
-000022b0: 2061 7265 206d 756c 7469 706c 6520 7265   are multiple re
-000022c0: 636f 7264 7320 6265 696e 6720 6361 6e64  cords being cand
-000022d0: 6964 6174 6520 666f 7220 6c61 7465 7374  idate for latest
-000022e0: 2072 6563 6f72 642c 2062 7574 2074 6865   record, but the
-000022f0: 7920 6861 7665 2064 6966 6665 7265 6e74  y have different
-00002300: 2061 7474 7269 6275 6574 7320 616e 6420   attribuets and 
-00002310: 7468 6572 6520 6973 206e 6f20 7761 7920  there is no way 
-00002320: 6f66 2064 6574 6572 6d69 6e69 6e67 2077  of determining w
-00002330: 6869 6368 206f 6e65 2069 7320 7468 6520  hich one is the 
-00002340: 6c61 7465 7374 2e0a 0a60 6060 7079 7468  latest...```pyth
-00002350: 6f6e 0a66 726f 6d20 6461 7465 7469 6d65  on.from datetime
-00002360: 2069 6d70 6f72 7420 6461 7465 7469 6d65   import datetime
-00002370: 2061 7320 6474 0a66 726f 6d20 6264 7120   as dt.from bdq 
-00002380: 696d 706f 7274 2067 6574 5f6c 6174 6573  import get_lates
-00002390: 745f 7265 636f 7264 732c 2067 6574 5f6c  t_records, get_l
-000023a0: 6174 6573 745f 7265 636f 7264 735f 7769  atest_records_wi
-000023b0: 7468 5f70 6b5f 636f 6e66 6963 745f 6465  th_pk_confict_de
-000023c0: 7465 6374 696f 6e5f 666c 6167 0a0a 696e  tection_flag..in
-000023d0: 6372 656d 656e 745f 6461 7461 203d 2020  crement_data =  
-000023e0: 5b0a 2020 2831 2c20 6474 2832 3030 302c  [.  (1, dt(2000,
-000023f0: 2031 2c20 312c 2030 2c20 302c 2030 292c   1, 1, 0, 0, 0),
-00002400: 2022 3130 3031 2229 0a20 202c 2831 2c20   "1001").  ,(1, 
-00002410: 6474 2832 3030 302c 2031 2c20 312c 2032  dt(2000, 1, 1, 2
-00002420: 2c20 302c 2030 292c 2022 3130 3032 2229  , 0, 0), "1002")
-00002430: 0a20 202c 2832 2c20 6474 2832 3030 302c  .  ,(2, dt(2000,
-00002440: 2031 2c20 312c 2030 2c20 302c 2030 292c   1, 1, 0, 0, 0),
-00002450: 2022 3230 3031 2229 2023 6361 7262 6f6e   "2001") #carbon
-00002460: 2063 6f70 7920 6475 706c 6963 6174 650a   copy duplicate.
-00002470: 2020 2c28 322c 2064 7428 3230 3030 2c20    ,(2, dt(2000, 
-00002480: 312c 2031 2c20 302c 2030 2c20 3029 2c20  1, 1, 0, 0, 0), 
-00002490: 2232 3030 3122 2920 2363 6172 626f 6e20  "2001") #carbon 
-000024a0: 636f 7079 2064 7570 6c69 6361 7465 0a20  copy duplicate. 
-000024b0: 202c 2833 2c20 6474 2832 3030 302c 2031   ,(3, dt(2000, 1
-000024c0: 2c20 312c 2030 2c20 302c 2030 292c 2022  , 1, 0, 0, 0), "
-000024d0: 3330 3031 2229 0a20 202c 2833 2c20 6474  3001").  ,(3, dt
-000024e0: 2832 3030 302c 2031 2c20 312c 2032 2c20  (2000, 1, 1, 2, 
-000024f0: 302c 2030 292c 2022 3330 3032 2331 2229  0, 0), "3002#1")
-00002500: 2023 706b 2063 6f6e 666c 6963 742c 2074   #pk conflict, t
-00002510: 776f 2065 6e74 7269 6573 2077 6974 6820  wo entries with 
-00002520: 7468 6520 7361 6d65 2074 6563 686e 6963  the same technic
-00002530: 616c 2066 6965 6c64 732c 2062 7574 2064  al fields, but d
-00002540: 6966 6665 7265 6e74 2061 7472 6962 7574  ifferent atribut
-00002550: 6573 2c20 7768 6963 6820 6f6e 6520 746f  es, which one to
-00002560: 2063 686f 7365 3f0a 2020 2c28 332c 2064   chose?.  ,(3, d
-00002570: 7428 3230 3030 2c20 312c 2031 2c20 322c  t(2000, 1, 1, 2,
-00002580: 2030 2c20 3029 2c20 2233 3030 3223 3222   0, 0), "3002#2"
-00002590: 2920 2370 6b20 636f 6e66 6c69 6374 0a5d  ) #pk conflict.]
-000025a0: 0a0a 6466 203d 2073 7061 726b 2e63 7265  ..df = spark.cre
-000025b0: 6174 6544 6174 6146 7261 6d65 2869 6e63  ateDataFrame(inc
-000025c0: 7265 6d65 6e74 5f64 6174 612c 2022 706b  rement_data, "pk
-000025d0: 3a69 6e74 2c63 6861 6e67 655f 7473 3a74  :int,change_ts:t
-000025e0: 696d 6573 7461 6d70 2c61 7474 723a 7374  imestamp,attr:st
-000025f0: 7269 6e67 2229 0a64 662e 7368 6f77 2874  ring").df.show(t
-00002600: 7275 6e63 6174 653d 5472 7565 290a 0a3e  runcate=True)..>
-00002610: 3e20 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  > +---+---------
-00002620: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
-00002630: 2d2b 0a3e 3e20 7c20 706b 7c20 2020 2020  -+.>> | pk|     
-00002640: 2020 2020 2063 6861 6e67 655f 7473 7c20       change_ts| 
-00002650: 2061 7474 727c 0a3e 3e20 2b2d 2d2d 2b2d   attr|.>> +---+-
-00002660: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002670: 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e 3e20 7c20  --+------+.>> | 
-00002680: 2031 7c32 3030 302d 3031 2d30 3120 3030   1|2000-01-01 00
-00002690: 3a30 303a 3030 7c20 2031 3030 317c 0a3e  :00:00|  1001|.>
-000026a0: 3e20 7c20 2031 7c32 3030 302d 3031 2d30  > |  1|2000-01-0
-000026b0: 3120 3032 3a30 303a 3030 7c20 2031 3030  1 02:00:00|  100
-000026c0: 327c 0a3e 3e20 7c20 2032 7c32 3030 302d  2|.>> |  2|2000-
-000026d0: 3031 2d30 3120 3030 3a30 303a 3030 7c20  01-01 00:00:00| 
-000026e0: 2032 3030 317c 0a3e 3e20 7c20 2032 7c32   2001|.>> |  2|2
-000026f0: 3030 302d 3031 2d30 3120 3030 3a30 303a  000-01-01 00:00:
-00002700: 3030 7c20 2032 3030 317c 0a3e 3e20 7c20  00|  2001|.>> | 
-00002710: 2033 7c32 3030 302d 3031 2d30 3120 3030   3|2000-01-01 00
-00002720: 3a30 303a 3030 7c20 2033 3030 317c 0a3e  :00:00|  3001|.>
-00002730: 3e20 7c20 2033 7c32 3030 302d 3031 2d30  > |  3|2000-01-0
-00002740: 3120 3032 3a30 303a 3030 7c33 3030 3223  1 02:00:00|3002#
-00002750: 317c 0a3e 3e20 7c20 2033 7c32 3030 302d  1|.>> |  3|2000-
-00002760: 3031 2d30 3120 3032 3a30 303a 3030 7c33  01-01 02:00:00|3
-00002770: 3030 3223 327c 0a3e 3e20 2b2d 2d2d 2b2d  002#2|.>> +---+-
-00002780: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002790: 2d2d 2b2d 2d2d 2d2d 2d2b 0a0a 7072 696d  --+------+..prim
-000027a0: 6172 795f 6b65 795f 636f 6c75 6d6e 7320  ary_key_columns 
-000027b0: 3d20 5b27 706b 275d 0a6f 7264 6572 5f62  = ['pk'].order_b
-000027c0: 795f 636f 6c75 6d6e 7320 3d20 5b27 6368  y_columns = ['ch
-000027d0: 616e 6765 5f74 7327 5d0a 0a23 2077 696c  ange_ts']..# wil
-000027e0: 6c20 7261 6e64 6f6d 6c79 2063 686f 7365  l randomly chose
-000027f0: 206f 6e65 2070 6b20 696e 2063 6173 6520   one pk in case 
-00002800: 6f66 2063 6f6e 666c 6963 742c 2077 6974  of conflict, wit
-00002810: 686f 7574 2061 6e79 206e 6f74 6966 6963  hout any notific
-00002820: 6174 696f 6e20 6162 6f75 7420 636f 6e66  ation about conf
-00002830: 6c69 6374 730a 7369 6d70 6c65 5f67 6574  licts.simple_get
-00002840: 5f6c 6174 6573 745f 6466 203d 2067 6574  _latest_df = get
-00002850: 5f6c 6174 6573 745f 7265 636f 7264 7328  _latest_records(
-00002860: 6466 2c20 7072 696d 6172 795f 6b65 795f  df, primary_key_
-00002870: 636f 6c75 6d6e 732c 206f 7264 6572 5f62  columns, order_b
-00002880: 795f 636f 6c75 6d6e 7329 0a73 696d 706c  y_columns).simpl
-00002890: 655f 6765 745f 6c61 7465 7374 5f64 662e  e_get_latest_df.
-000028a0: 7368 6f77 2874 7275 6e63 6174 653d 5472  show(truncate=Tr
-000028b0: 7565 290a 0a3e 3e20 2b2d 2d2d 2b2d 2d2d  ue)..>> +---+---
-000028c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000028d0: 2b2d 2d2d 2d2d 2d2b 0a3e 3e20 7c20 706b  +------+.>> | pk
-000028e0: 7c20 2020 2020 2020 2020 2063 6861 6e67  |          chang
-000028f0: 655f 7473 7c20 2061 7474 727c 0a3e 3e20  e_ts|  attr|.>> 
-00002900: 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---+-----------
-00002910: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b  --------+------+
-00002920: 0a3e 3e20 7c20 2031 7c32 3030 302d 3031  .>> |  1|2000-01
-00002930: 2d30 3120 3032 3a30 303a 3030 7c20 2031  -01 02:00:00|  1
-00002940: 3030 327c 0a3e 3e20 7c20 2032 7c32 3030  002|.>> |  2|200
-00002950: 302d 3031 2d30 3120 3030 3a30 303a 3030  0-01-01 00:00:00
-00002960: 7c20 2032 3030 317c 0a3e 3e20 7c20 2033  |  2001|.>> |  3
-00002970: 7c32 3030 302d 3031 2d30 3120 3032 3a30  |2000-01-01 02:0
-00002980: 303a 3030 7c33 3030 3223 317c 0a3e 3e20  0:00|3002#1|.>> 
-00002990: 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---+-----------
-000029a0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b  --------+------+
-000029b0: 0a0a 2320 7769 6c6c 2066 6c61 6720 7265  ..# will flag re
-000029c0: 636f 7264 7320 7768 6963 6820 6361 7573  cords which caus
-000029d0: 6520 636f 6e66 6c69 6374 7320 616e 6420  e conflicts and 
-000029e0: 6361 6e6e 6f74 2062 6520 7265 736f 6c76  cannot be resolv
-000029f0: 6564 0a23 2062 6164 2072 6563 6f72 6473  ed.# bad records
-00002a00: 206e 6565 6420 746f 2062 6520 7175 6172   need to be quar
-00002a10: 616e 7469 6e65 6420 616e 6420 6861 6e64  antined and hand
-00002a20: 6c65 6420 696e 2073 7065 6369 616c 2070  led in special p
-00002a30: 726f 6365 7373 0a63 6f6e 666c 6963 745f  rocess.conflict_
-00002a40: 6765 745f 6c61 7465 7374 5f64 6620 3d20  get_latest_df = 
-00002a50: 6765 745f 6c61 7465 7374 5f72 6563 6f72  get_latest_recor
-00002a60: 6473 5f77 6974 685f 706b 5f63 6f6e 6669  ds_with_pk_confi
-00002a70: 6374 5f64 6574 6563 7469 6f6e 5f66 6c61  ct_detection_fla
-00002a80: 6728 6466 2c20 7072 696d 6172 795f 6b65  g(df, primary_ke
-00002a90: 795f 636f 6c75 6d6e 732c 206f 7264 6572  y_columns, order
-00002aa0: 5f62 795f 636f 6c75 6d6e 7329 0a63 6f6e  _by_columns).con
-00002ab0: 666c 6963 745f 6765 745f 6c61 7465 7374  flict_get_latest
-00002ac0: 5f64 662e 7368 6f77 2874 7275 6e63 6174  _df.show(truncat
-00002ad0: 653d 5472 7565 290a 0a3e 3e20 2b2d 2d2d  e=True)..>> +---
-00002ae0: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---------------
-00002af0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b 2d2d 2d2d  ----+------+----
-00002b00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e  -------------+.>
-00002b10: 3e20 7c20 706b 7c20 2020 2020 2020 2020  > | pk|         
-00002b20: 2063 6861 6e67 655f 7473 7c20 2061 7474   change_ts|  att
-00002b30: 727c 5f5f 6861 735f 706b 5f63 6f6e 666c  r|__has_pk_confl
-00002b40: 6963 747c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d  ict|.>> +---+---
-00002b50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002b60: 2b2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  +------+--------
-00002b70: 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c20  ---------+.>> | 
-00002b80: 2031 7c32 3030 302d 3031 2d30 3120 3032   1|2000-01-01 02
-00002b90: 3a30 303a 3030 7c20 2031 3030 327c 2020  :00:00|  1002|  
-00002ba0: 2020 2020 2020 2020 2020 6661 6c73 657c            false|
-00002bb0: 0a3e 3e20 7c20 2032 7c32 3030 302d 3031  .>> |  2|2000-01
-00002bc0: 2d30 3120 3030 3a30 303a 3030 7c20 2032  -01 00:00:00|  2
-00002bd0: 3030 317c 2020 2020 2020 2020 2020 2020  001|            
-00002be0: 6661 6c73 657c 0a3e 3e20 7c20 2033 7c32  false|.>> |  3|2
-00002bf0: 3030 302d 3031 2d30 3120 3032 3a30 303a  000-01-01 02:00:
-00002c00: 3030 7c33 3030 3223 327c 2020 2020 2020  00|3002#2|      
-00002c10: 2020 2020 2020 2074 7275 657c 0a3e 3e20         true|.>> 
-00002c20: 7c20 2033 7c32 3030 302d 3031 2d30 3120  |  3|2000-01-01 
-00002c30: 3032 3a30 303a 3030 7c33 3030 3223 317c  02:00:00|3002#1|
-00002c40: 2020 2020 2020 2020 2020 2020 2074 7275               tru
-00002c50: 657c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2d  e|.>> +---+-----
-00002c60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
-00002c70: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
-00002c80: 2d2d 2d2d 2d2d 2d2b 0a0a 6060 600a 0a23  -------+..```..#
-00002c90: 2320 4669 6e64 2063 6f6d 706f 7369 7465  # Find composite
-00002ca0: 2070 7269 6d61 7279 206b 6579 2063 616e   primary key can
-00002cb0: 6469 6461 7465 730a 4769 7665 6e20 6c69  didates.Given li
-00002cc0: 7374 206f 6620 706f 7373 6962 6c65 2063  st of possible c
-00002cd0: 6f6c 756d 6e73 2c20 636f 6e73 7472 7563  olumns, construc
-00002ce0: 7473 2074 6865 206c 6973 7473 206f 6620  ts the lists of 
-00002cf0: 616c 6c20 706f 7373 6962 6c65 2063 6f6d  all possible com
-00002d00: 6269 6e61 7469 6f6e 7320 6f66 2063 6f6d  binations of com
-00002d10: 706f 7369 7465 2070 7269 6d61 7279 206b  posite primary k
-00002d20: 6579 732c 2061 6e64 2065 7865 6375 7465  eys, and execute
-00002d30: 7320 636f 6e63 7572 7265 6e74 6c79 2074  s concurrently t
-00002d40: 6f20 6465 7465 726d 696e 6520 6966 2067  o determine if g
-00002d50: 6976 656e 2073 6574 206f 6620 636f 6c75  iven set of colu
-00002d60: 6d6e 7320 6973 2061 2076 616c 6964 2070  mns is a valid p
-00002d70: 7269 6d61 7279 206b 6579 2e20 5573 6573  rimary key. Uses
-00002d80: 206d 696e 696d 756d 2070 6f73 7369 626c   minimum possibl
-00002d90: 6520 616d 6f75 6e74 206f 6620 7175 6572  e amount of quer
-00002da0: 6965 7320 6167 6169 6e73 7420 7370 6172  ies against spar
-00002db0: 6b20 6279 2073 6b69 7070 696e 6720 7661  k by skipping va
-00002dc0: 6c69 6461 7469 6f6e 2070 6174 6873 2074  lidation paths t
-00002dd0: 6861 7420 6172 6520 6261 7365 6420 6f6e  hat are based on
-00002de0: 2061 6c72 6561 6479 2076 616c 6964 6174   already validat
-00002df0: 6564 2070 7269 6d61 7279 206b 6579 2063  ed primary key c
-00002e00: 6f6d 6269 6e61 7469 6f6e 732e 0a0a 6060  ombinations...``
-00002e10: 6070 7974 686f 6e0a 696d 706f 7274 2062  `python.import b
-00002e20: 6471 0a69 6d70 6f72 7420 7079 7370 6172  dq.import pyspar
-00002e30: 6b2e 7371 6c2e 6675 6e63 7469 6f6e 7320  k.sql.functions 
-00002e40: 6173 2046 0a0a 6466 203d 2073 7061 726b  as F..df = spark
-00002e50: 2e72 616e 6765 2830 2c20 3130 3029 205c  .range(0, 100) \
-00002e60: 0a20 202e 7769 7468 436f 6c75 6d6e 2827  .  .withColumn('
-00002e70: 7479 7065 272c 2046 2e65 7870 7228 2728  type', F.expr('(
-00002e80: 6964 202f 2031 3029 3a3a 696e 7420 2b20  id / 10)::int + 
-00002e90: 3127 2929 205c 0a20 202e 7769 7468 436f  1')) \.  .withCo
-00002ea0: 6c75 6d6e 2827 7265 6d69 6e64 6572 272c  lumn('reminder',
-00002eb0: 2046 2e65 7870 7228 2769 6420 2520 3130   F.expr('id % 10
-00002ec0: 2729 2920 5c0a 2020 2e77 6974 6843 6f6c  ')) \.  .withCol
-00002ed0: 756d 6e28 2773 7461 7469 6327 2c20 462e  umn('static', F.
-00002ee0: 6c69 7428 2741 2729 2920 5c0a 2020 2e77  lit('A')) \.  .w
-00002ef0: 6974 6843 6f6c 756d 6e28 2772 6f75 6e64  ithColumn('round
-00002f00: 5f72 6f62 696e 272c 2046 2e65 7870 7228  _robin', F.expr(
-00002f10: 2769 6420 2520 3227 2929 0a0a 6469 7370  'id % 2'))..disp
-00002f20: 6c61 7928 6466 290a 0a61 6c6c 5f63 6f6d  lay(df)..all_com
-00002f30: 6269 6e61 7469 6f6e 7320 3d20 6c69 7374  binations = list
-00002f40: 2862 6471 2e67 6574 5f63 6f6c 756d 6e5f  (bdq.get_column_
-00002f50: 6e61 6d65 735f 636f 6d62 696e 6174 696f  names_combinatio
-00002f60: 6e73 2864 662e 636f 6c75 6d6e 7329 290a  ns(df.columns)).
-00002f70: 0a62 6471 2e76 616c 6964 6174 655f 7072  .bdq.validate_pr
-00002f80: 696d 6172 795f 6b65 795f 6361 6e64 6964  imary_key_candid
-00002f90: 6174 655f 636f 6d62 696e 6174 696f 6e73  ate_combinations
-00002fa0: 2864 662c 2061 6c6c 5f63 6f6d 6269 6e61  (df, all_combina
-00002fb0: 7469 6f6e 732c 206d 6178 5f77 6f72 6b65  tions, max_worke
-00002fc0: 7273 3d31 302c 2076 6572 626f 7365 3d54  rs=10, verbose=T
-00002fd0: 7275 6529 0a3e 3e20 5b28 2769 6427 2c29  rue).>> [('id',)
-00002fe0: 2c20 2827 7479 7065 272c 2027 7265 6d69  , ('type', 'remi
-00002ff0: 6e64 6572 2729 5d0a 6060 600a 0a23 2320  nder')].```..## 
-00003000: 4578 6563 7574 6520 4441 4720 6861 7669  Execute DAG havi
-00003010: 6e67 206e 6f64 6573 2061 7320 7079 7468  ng nodes as pyth
-00003020: 6f6e 2066 756e 6374 696f 6e73 0a60 6060  on functions.```
-00003030: 7079 7468 6f6e 0a69 6d70 6f72 7420 6264  python.import bd
-00003040: 710a 696d 706f 7274 2074 696d 650a 696d  q.import time.im
-00003050: 706f 7274 2070 7974 6573 740a 0a23 6372  port pytest..#cr
-00003060: 6561 7465 2067 7261 7068 0a67 7261 7068  eate graph.graph
-00003070: 203d 2062 6471 2e44 4147 2829 0a0a 2364   = bdq.DAG()..#d
-00003080: 6566 696e 6520 6e6f 6465 730a 4067 7261  efine nodes.@gra
-00003090: 7068 2e6e 6f64 6528 290a 6465 6620 6128  ph.node().def a(
-000030a0: 293a 0a20 2074 696d 652e 736c 6565 7028  ):.  time.sleep(
-000030b0: 3229 0a20 2072 6574 7572 6e20 350a 0a40  2).  return 5..@
-000030c0: 6772 6170 682e 6e6f 6465 2829 0a64 6566  graph.node().def
-000030d0: 2062 2829 3a0a 2020 7469 6d65 2e73 6c65   b():.  time.sle
-000030e0: 6570 2833 290a 2020 7265 7475 726e 2022  ep(3).  return "
-000030f0: 6265 6565 7022 0a0a 236e 6f64 6573 2063  beeep"..#nodes c
-00003100: 616e 2064 6570 656e 6420 6f6e 206f 7468  an depend on oth
-00003110: 6572 206e 6f64 6573 0a40 6772 6170 682e  er nodes.@graph.
-00003120: 6e6f 6465 2864 6570 656e 6473 5f6f 6e3d  node(depends_on=
-00003130: 5b62 5d29 0a64 6566 2063 2829 3a0a 2020  [b]).def c():.  
-00003140: 7469 6d65 2e73 6c65 6570 2835 290a 2020  time.sleep(5).  
-00003150: 7265 7475 726e 2038 0a0a 2361 6e79 2061  return 8..#any a
-00003160: 6d6f 756e 7420 6f66 2064 6570 656e 6465  mount of depende
-00003170: 6e63 6965 7320 6973 2061 6c6c 6f77 6564  ncies is allowed
-00003180: 0a40 6772 6170 682e 6e6f 6465 2864 6570  .@graph.node(dep
-00003190: 656e 6473 5f6f 6e3d 5b62 2c20 632c 2061  ends_on=[b, c, a
-000031a0: 5d29 0a64 6566 2064 2829 3a0a 2020 7469  ]).def d():.  ti
-000031b0: 6d65 2e73 6c65 6570 2837 290a 2020 2362  me.sleep(7).  #b
-000031c0: 6565 7020 6173 206d 616e 7920 7469 6d65  eep as many time
-000031d0: 7320 6173 2061 6273 6f6c 7574 6520 6469  s as absolute di
-000031e0: 6666 6572 656e 6365 2062 6574 7765 656e  fference between
-000031f0: 2027 6327 2061 6e64 2027 6127 0a20 2072   'c' and 'a'.  r
-00003200: 6574 7572 6e20 2267 206d 616e 2073 6179  eturn "g man say
-00003210: 3a20 2220 2b20 622e 7265 7375 6c74 202a  : " + b.result *
-00003220: 2061 6273 2863 2e72 6573 756c 7420 2d20   abs(c.result - 
-00003230: 612e 7265 7375 6c74 290a 0a40 6772 6170  a.result)..@grap
-00003240: 682e 6e6f 6465 2864 6570 656e 6473 5f6f  h.node(depends_o
-00003250: 6e3d 5b61 5d29 0a64 6566 2065 2829 3a0a  n=[a]).def e():.
-00003260: 2020 7469 6d65 2e73 6c65 6570 2833 290a    time.sleep(3).
-00003270: 2020 2379 6f75 2063 616e 2072 6566 6572    #you can refer
-00003280: 2074 6f20 7061 7265 6e74 206e 6f64 6573   to parent nodes
-00003290: 2c20 746f 2067 6574 2069 6e66 6f72 6d61  , to get informa
-000032a0: 7469 6f6e 2061 626f 7574 2074 6865 6972  tion about their
-000032b0: 2072 6573 756c 7473 0a20 2072 6169 7365   results.  raise
-000032c0: 2056 616c 7565 4572 726f 7228 6622 6f6d   ValueError(f"om
-000032d0: 672c 2063 7261 7368 2120 7b61 2e72 6573  g, crash! {a.res
-000032e0: 756c 747d 2229 0a0a 4067 7261 7068 2e6e  ult}")..@graph.n
-000032f0: 6f64 6528 6465 7065 6e64 735f 6f6e 3d5b  ode(depends_on=[
-00003300: 655d 290a 6465 6620 6628 293a 0a20 2070  e]).def f():.  p
-00003310: 7269 6e74 2822 7468 6973 2077 696c 6c20  rint("this will 
-00003320: 6e65 7665 7220 6578 6563 7574 6522 290a  never execute").
-00003330: 2020 7265 7475 726e 2022 7468 6973 2077    return "this w
-00003340: 696c 6c20 6e65 7665 7220 6578 6563 7574  ill never execut
-00003350: 6522 0a0a 4067 7261 7068 2e6e 6f64 6528  e"..@graph.node(
-00003360: 6465 7065 6e64 735f 6f6e 3d5b 615d 290a  depends_on=[a]).
-00003370: 6465 6620 6728 293a 0a20 2074 696d 652e  def g():.  time.
-00003380: 736c 6565 7028 3329 0a20 2023 7765 2064  sleep(3).  #we d
-00003390: 6f20 6e6f 7420 7761 6e74 2074 6f20 6578  o not want to ex
-000033a0: 6563 7574 6520 6368 696c 6472 656e 206e  ecute children n
-000033b0: 6f64 6573 2061 6e79 6d6f 7265 0a20 2023  odes anymore.  #
-000033c0: 7265 7475 726e 2067 7261 7068 2e42 5245  return graph.BRE
-000033d0: 414b 2074 6869 7320 7769 6c6c 2063 6175  AK this will cau
-000033e0: 7365 2074 6861 7420 616c 6c20 6368 696c  se that all chil
-000033f0: 6472 656e 2f73 7563 6365 7373 6f72 7320  dren/successors 
-00003400: 696e 2067 7261 7068 2077 696c 6c20 6265  in graph will be
-00003410: 2073 6b69 7070 6564 2077 6974 686f 7574   skipped without
-00003420: 2065 7272 726f 720a 2020 7265 7475 726e   errror.  return
-00003430: 2067 7261 7068 2e42 5245 414b 0a0a 4067   graph.BREAK..@g
-00003440: 7261 7068 2e6e 6f64 6528 6465 7065 6e64  raph.node(depend
-00003450: 735f 6f6e 3d5b 675d 290a 6465 6620 6928  s_on=[g]).def i(
-00003460: 293a 0a20 2070 7269 6e74 2822 7468 6973  ):.  print("this
-00003470: 2077 696c 6c20 6e65 7665 7220 6578 6563   will never exec
-00003480: 7574 6520 746f 6f22 290a 2020 7265 7475  ute too").  retu
-00003490: 726e 2022 7468 6973 2077 696c 6c20 6e65  rn "this will ne
-000034a0: 7665 7220 6578 6563 7574 6520 746f 6f22  ver execute too"
-000034b0: 0a0a 2320 6966 2079 6f75 2068 6176 6520  ..# if you have 
-000034c0: 6970 7964 6167 7265 6433 2069 6e73 7461  ipydagred3 insta
-000034d0: 6c6c 6564 2c20 796f 7520 6361 6e20 7365  lled, you can se
-000034e0: 6520 696e 2072 6561 6c20 7469 6d65 2073  e in real time s
-000034f0: 7461 7465 2063 6861 6e67 6573 206f 6620  tate changes of 
-00003500: 6561 6368 206f 6620 7468 6520 6e6f 6465  each of the node
-00003510: 730a 6469 7370 6c61 7928 6772 6170 682e  s.display(graph.
-00003520: 7669 7375 616c 697a 6528 2929 0a0a 2365  visualize())..#e
-00003530: 7865 6375 7465 2044 4147 0a67 7261 7068  xecute DAG.graph
-00003540: 2e65 7865 6375 7465 286d 6178 5f77 6f72  .execute(max_wor
-00003550: 6b65 7273 3d31 3029 0a0a 2369 7465 7261  kers=10)..#itera
-00003560: 7465 206f 7665 7220 7265 7375 6c74 730a  te over results.
-00003570: 7072 696e 7428 2249 7465 7261 7465 206f  print("Iterate o
-00003580: 7665 7220 7265 7375 6c74 732e 2e2e 2229  ver results...")
-00003590: 0a66 6f72 206e 6f64 6520 696e 2067 7261  .for node in gra
-000035a0: 7068 2e6e 6f64 6573 3a0a 2020 7072 696e  ph.nodes:.  prin
-000035b0: 7428 6e6f 6465 290a 0a3e 3e20 5761 6974  t(node)..>> Wait
-000035c0: 696e 6720 666f 7220 616c 6c20 7461 736b  ing for all task
-000035d0: 7320 746f 2066 696e 6973 682e 2e2e 0a3e  s to finish....>
-000035e0: 3e20 2020 7374 6172 7469 6e67 3a20 4e6f  >   starting: No
-000035f0: 6465 283c 6675 6e63 7469 6f6e 2061 2061  de(<function a a
-00003600: 7420 3078 3766 3530 6634 6239 6565 3530  t 0x7f50f4b9ee50
-00003610: 3e3a 207b 2773 7461 7465 273a 2027 5255  >: {'state': 'RU
-00003620: 4e4e 494e 4727 2c20 2772 6573 756c 7427  NNING', 'result'
-00003630: 3a20 4e6f 6e65 2c20 2765 7863 6570 7469  : None, 'excepti
-00003640: 6f6e 273a 204e 6f6e 652c 2027 636f 6d70  on': None, 'comp
-00003650: 6c65 7465 6427 3a20 4661 6c73 657d 2029  leted': False} )
-00003660: 0a3e 3e20 2020 7374 6172 7469 6e67 3a20  .>>   starting: 
-00003670: 4e6f 6465 283c 6675 6e63 7469 6f6e 2062  Node(<function b
-00003680: 2061 7420 3078 3766 3530 6634 6235 3330   at 0x7f50f4b530
-00003690: 3430 3e3a 207b 2773 7461 7465 273a 2027  40>: {'state': '
-000036a0: 5255 4e4e 494e 4727 2c20 2772 6573 756c  RUNNING', 'resul
-000036b0: 7427 3a20 4e6f 6e65 2c20 2765 7863 6570  t': None, 'excep
-000036c0: 7469 6f6e 273a 204e 6f6e 652c 2027 636f  tion': None, 'co
-000036d0: 6d70 6c65 7465 6427 3a20 4661 6c73 657d  mpleted': False}
-000036e0: 2029 0a3e 3e20 2020 7374 6172 7469 6e67   ).>>   starting
-000036f0: 3a20 4e6f 6465 283c 6675 6e63 7469 6f6e  : Node(<function
-00003700: 2065 2061 7420 3078 3766 3530 6634 6235   e at 0x7f50f4b5
-00003710: 3362 3830 3e3a 207b 2773 7461 7465 273a  3b80>: {'state':
-00003720: 2027 5255 4e4e 494e 4727 2c20 2772 6573   'RUNNING', 'res
-00003730: 756c 7427 3a20 4e6f 6e65 2c20 2765 7863  ult': None, 'exc
-00003740: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
-00003750: 636f 6d70 6c65 7465 6427 3a20 4661 6c73  completed': Fals
-00003760: 657d 2029 0a3e 3e20 2020 7374 6172 7469  e} ).>>   starti
-00003770: 6e67 3a20 4e6f 6465 283c 6675 6e63 7469  ng: Node(<functi
-00003780: 6f6e 2067 2061 7420 3078 3766 3530 6634  on g at 0x7f50f4
-00003790: 6235 3335 6530 3e3a 207b 2773 7461 7465  b535e0>: {'state
-000037a0: 273a 2027 5255 4e4e 494e 4727 2c20 2772  ': 'RUNNING', 'r
-000037b0: 6573 756c 7427 3a20 4e6f 6e65 2c20 2765  esult': None, 'e
-000037c0: 7863 6570 7469 6f6e 273a 204e 6f6e 652c  xception': None,
-000037d0: 2027 636f 6d70 6c65 7465 6427 3a20 4661   'completed': Fa
-000037e0: 6c73 657d 2029 0a3e 3e20 2020 6669 6e69  lse} ).>>   fini
-000037f0: 7368 6564 3a20 4e6f 6465 283c 6675 6e63  shed: Node(<func
-00003800: 7469 6f6e 2061 2061 7420 3078 3766 3530  tion a at 0x7f50
-00003810: 6634 6239 6565 3530 3e3a 207b 2773 7461  f4b9ee50>: {'sta
-00003820: 7465 273a 2027 5355 4343 4553 5327 2c20  te': 'SUCCESS', 
-00003830: 2772 6573 756c 7427 3a20 352c 2027 6578  'result': 5, 'ex
-00003840: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
-00003850: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
-00003860: 657d 2029 2028 7374 696c 6c20 7275 6e6e  e} ) (still runn
-00003870: 696e 673a 2033 290a 3e3e 2020 2073 7461  ing: 3).>>   sta
-00003880: 7274 696e 673a 204e 6f64 6528 3c66 756e  rting: Node(<fun
-00003890: 6374 696f 6e20 6320 6174 2030 7837 6635  ction c at 0x7f5
-000038a0: 3066 3462 3533 3463 303e 3a20 7b27 7374  0f4b534c0>: {'st
-000038b0: 6174 6527 3a20 2752 554e 4e49 4e47 272c  ate': 'RUNNING',
-000038c0: 2027 7265 7375 6c74 273a 204e 6f6e 652c   'result': None,
-000038d0: 2027 6578 6365 7074 696f 6e27 3a20 4e6f   'exception': No
-000038e0: 6e65 2c20 2763 6f6d 706c 6574 6564 273a  ne, 'completed':
-000038f0: 2046 616c 7365 7d20 290a 3e3e 2020 2066   False} ).>>   f
-00003900: 696e 6973 6865 643a 204e 6f64 6528 3c66  inished: Node(<f
-00003910: 756e 6374 696f 6e20 6220 6174 2030 7837  unction b at 0x7
-00003920: 6635 3066 3462 3533 3034 303e 3a20 7b27  f50f4b53040>: {'
-00003930: 7374 6174 6527 3a20 2753 5543 4345 5353  state': 'SUCCESS
-00003940: 272c 2027 7265 7375 6c74 273a 2027 6265  ', 'result': 'be
-00003950: 6565 7027 2c20 2765 7863 6570 7469 6f6e  eep', 'exception
-00003960: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
-00003970: 7465 6427 3a20 5472 7565 7d20 2920 2873  ted': True} ) (s
-00003980: 7469 6c6c 2072 756e 6e69 6e67 3a20 3329  till running: 3)
-00003990: 0a3e 3e20 2020 6572 726f 723a 204e 6f64  .>>   error: Nod
-000039a0: 6528 3c66 756e 6374 696f 6e20 6520 6174  e(<function e at
-000039b0: 2030 7837 6635 3066 3462 3533 6238 303e   0x7f50f4b53b80>
-000039c0: 3a20 7b27 7374 6174 6527 3a20 2745 5252  : {'state': 'ERR
-000039d0: 4f52 272c 2027 7265 7375 6c74 273a 204e  OR', 'result': N
-000039e0: 6f6e 652c 2027 6578 6365 7074 696f 6e27  one, 'exception'
-000039f0: 3a20 5661 6c75 6545 7272 6f72 2827 6f6d  : ValueError('om
-00003a00: 672c 2063 7261 7368 2120 3527 292c 2027  g, crash! 5'), '
-00003a10: 636f 6d70 6c65 7465 6427 3a20 5472 7565  completed': True
-00003a20: 7d20 293a 206f 6d67 2c20 6372 6173 6821  } ): omg, crash!
-00003a30: 2035 2028 7374 696c 6c20 7275 6e6e 696e   5 (still runnin
-00003a40: 673a 2032 290a 3e3e 2020 2066 696e 6973  g: 2).>>   finis
-00003a50: 6865 643a 204e 6f64 6528 3c66 756e 6374  hed: Node(<funct
-00003a60: 696f 6e20 6720 6174 2030 7837 6635 3066  ion g at 0x7f50f
-00003a70: 3462 3533 3565 303e 3a20 7b27 7374 6174  4b535e0>: {'stat
-00003a80: 6527 3a20 2753 4b49 5050 4544 272c 2027  e': 'SKIPPED', '
-00003a90: 7265 7375 6c74 273a 203c 7468 7265 6164  result': <thread
-00003aa0: 696e 672e 4576 656e 7420 6f62 6a65 6374  ing.Event object
-00003ab0: 2061 7420 3078 3766 3530 6563 3136 6339   at 0x7f50ec16c9
-00003ac0: 6430 3e2c 2027 6578 6365 7074 696f 6e27  d0>, 'exception'
-00003ad0: 3a20 4e6f 6e65 2c20 2763 6f6d 706c 6574  : None, 'complet
-00003ae0: 6564 273a 2054 7275 657d 2029 2028 7374  ed': True} ) (st
-00003af0: 696c 6c20 7275 6e6e 696e 673a 2031 290a  ill running: 1).
-00003b00: 3e3e 2020 2073 7461 7274 696e 673a 204e  >>   starting: N
-00003b10: 6f64 6528 3c66 756e 6374 696f 6e20 6420  ode(<function d 
-00003b20: 6174 2030 7837 6635 3066 3462 3533 6136  at 0x7f50f4b53a6
-00003b30: 303e 3a20 7b27 7374 6174 6527 3a20 2752  0>: {'state': 'R
-00003b40: 554e 4e49 4e47 272c 2027 7265 7375 6c74  UNNING', 'result
-00003b50: 273a 204e 6f6e 652c 2027 6578 6365 7074  ': None, 'except
-00003b60: 696f 6e27 3a20 4e6f 6e65 2c20 2763 6f6d  ion': None, 'com
-00003b70: 706c 6574 6564 273a 2046 616c 7365 7d20  pleted': False} 
-00003b80: 290a 3e3e 2020 2066 696e 6973 6865 643a  ).>>   finished:
-00003b90: 204e 6f64 6528 3c66 756e 6374 696f 6e20   Node(<function 
-00003ba0: 6320 6174 2030 7837 6635 3066 3462 3533  c at 0x7f50f4b53
-00003bb0: 3463 303e 3a20 7b27 7374 6174 6527 3a20  4c0>: {'state': 
-00003bc0: 2753 5543 4345 5353 272c 2027 7265 7375  'SUCCESS', 'resu
-00003bd0: 6c74 273a 2038 2c20 2765 7863 6570 7469  lt': 8, 'excepti
-00003be0: 6f6e 273a 204e 6f6e 652c 2027 636f 6d70  on': None, 'comp
-00003bf0: 6c65 7465 6427 3a20 5472 7565 7d20 2920  leted': True} ) 
-00003c00: 2873 7469 6c6c 2072 756e 6e69 6e67 3a20  (still running: 
-00003c10: 3129 0a3e 3e20 2020 6669 6e69 7368 6564  1).>>   finished
-00003c20: 3a20 4e6f 6465 283c 6675 6e63 7469 6f6e  : Node(<function
-00003c30: 2064 2061 7420 3078 3766 3530 6634 6235   d at 0x7f50f4b5
-00003c40: 3361 3630 3e3a 207b 2773 7461 7465 273a  3a60>: {'state':
-00003c50: 2027 5355 4343 4553 5327 2c20 2772 6573   'SUCCESS', 'res
-00003c60: 756c 7427 3a20 2767 206d 616e 2073 6179  ult': 'g man say
-00003c70: 3a20 6265 6565 7062 6565 6570 6265 6565  : beeepbeeepbeee
-00003c80: 7027 2c20 2765 7863 6570 7469 6f6e 273a  p', 'exception':
-00003c90: 204e 6f6e 652c 2027 636f 6d70 6c65 7465   None, 'complete
-00003ca0: 6427 3a20 5472 7565 7d20 2920 2873 7469  d': True} ) (sti
-00003cb0: 6c6c 2072 756e 6e69 6e67 3a20 3029 0a3e  ll running: 0).>
-00003cc0: 3e20 416c 6c20 7461 736b 7320 6669 6e69  > All tasks fini
-00003cd0: 7368 6564 2c20 7368 7574 7469 6e67 2064  shed, shutting d
-00003ce0: 6f77 6e0a 3e3e 0a3e 3e20 4974 6572 6174  own.>>.>> Iterat
-00003cf0: 6520 6f76 6572 2072 6573 756c 7473 2e2e  e over results..
-00003d00: 2e0a 3e3e 204e 6f64 6528 3c66 756e 6374  ..>> Node(<funct
-00003d10: 696f 6e20 6120 6174 2030 7837 6635 3066  ion a at 0x7f50f
-00003d20: 3462 3965 6535 303e 3a20 7b27 7374 6174  4b9ee50>: {'stat
-00003d30: 6527 3a20 2753 5543 4345 5353 272c 2027  e': 'SUCCESS', '
-00003d40: 7265 7375 6c74 273a 2035 2c20 2765 7863  result': 5, 'exc
-00003d50: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
-00003d60: 636f 6d70 6c65 7465 6427 3a20 5472 7565  completed': True
-00003d70: 7d20 290a 3e3e 204e 6f64 6528 3c66 756e  } ).>> Node(<fun
-00003d80: 6374 696f 6e20 6220 6174 2030 7837 6635  ction b at 0x7f5
-00003d90: 3066 3462 3533 3034 303e 3a20 7b27 7374  0f4b53040>: {'st
-00003da0: 6174 6527 3a20 2753 5543 4345 5353 272c  ate': 'SUCCESS',
-00003db0: 2027 7265 7375 6c74 273a 2027 6265 6565   'result': 'beee
-00003dc0: 7027 2c20 2765 7863 6570 7469 6f6e 273a  p', 'exception':
-00003dd0: 204e 6f6e 652c 2027 636f 6d70 6c65 7465   None, 'complete
-00003de0: 6427 3a20 5472 7565 7d20 290a 3e3e 204e  d': True} ).>> N
-00003df0: 6f64 6528 3c66 756e 6374 696f 6e20 6320  ode(<function c 
-00003e00: 6174 2030 7837 6635 3066 3462 3533 3463  at 0x7f50f4b534c
-00003e10: 303e 3a20 7b27 7374 6174 6527 3a20 2753  0>: {'state': 'S
-00003e20: 5543 4345 5353 272c 2027 7265 7375 6c74  UCCESS', 'result
-00003e30: 273a 2038 2c20 2765 7863 6570 7469 6f6e  ': 8, 'exception
-00003e40: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
-00003e50: 7465 6427 3a20 5472 7565 7d20 290a 3e3e  ted': True} ).>>
-00003e60: 204e 6f64 6528 3c66 756e 6374 696f 6e20   Node(<function 
-00003e70: 6420 6174 2030 7837 6635 3066 3462 3533  d at 0x7f50f4b53
-00003e80: 6136 303e 3a20 7b27 7374 6174 6527 3a20  a60>: {'state': 
-00003e90: 2753 5543 4345 5353 272c 2027 7265 7375  'SUCCESS', 'resu
-00003ea0: 6c74 273a 2027 6720 6d61 6e20 7361 793a  lt': 'g man say:
-00003eb0: 2062 6565 6570 6265 6565 7062 6565 6570   beeepbeeepbeeep
-00003ec0: 272c 2027 6578 6365 7074 696f 6e27 3a20  ', 'exception': 
-00003ed0: 4e6f 6e65 2c20 2763 6f6d 706c 6574 6564  None, 'completed
-00003ee0: 273a 2054 7275 657d 2029 0a3e 3e20 4e6f  ': True} ).>> No
-00003ef0: 6465 283c 6675 6e63 7469 6f6e 2065 2061  de(<function e a
-00003f00: 7420 3078 3766 3530 6634 6235 3362 3830  t 0x7f50f4b53b80
-00003f10: 3e3a 207b 2773 7461 7465 273a 2027 4552  >: {'state': 'ER
-00003f20: 524f 5227 2c20 2772 6573 756c 7427 3a20  ROR', 'result': 
-00003f30: 4e6f 6e65 2c20 2765 7863 6570 7469 6f6e  None, 'exception
-00003f40: 273a 2056 616c 7565 4572 726f 7228 276f  ': ValueError('o
-00003f50: 6d67 2c20 6372 6173 6821 2035 2729 2c20  mg, crash! 5'), 
-00003f60: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
-00003f70: 657d 2029 0a3e 3e20 4e6f 6465 283c 6675  e} ).>> Node(<fu
-00003f80: 6e63 7469 6f6e 2066 2061 7420 3078 3766  nction f at 0x7f
-00003f90: 3530 6634 6235 3330 6430 3e3a 207b 2773  50f4b530d0>: {'s
-00003fa0: 7461 7465 273a 2027 534b 4950 5045 4427  tate': 'SKIPPED'
-00003fb0: 2c20 2772 6573 756c 7427 3a20 4e6f 6e65  , 'result': None
-00003fc0: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
-00003fd0: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
-00003fe0: 3a20 4661 6c73 657d 2029 0a3e 3e20 4e6f  : False} ).>> No
-00003ff0: 6465 283c 6675 6e63 7469 6f6e 2067 2061  de(<function g a
-00004000: 7420 3078 3766 3530 6634 6235 3335 6530  t 0x7f50f4b535e0
-00004010: 3e3a 207b 2773 7461 7465 273a 2027 534b  >: {'state': 'SK
-00004020: 4950 5045 4427 2c20 2772 6573 756c 7427  IPPED', 'result'
-00004030: 3a20 3c74 6872 6561 6469 6e67 2e45 7665  : <threading.Eve
-00004040: 6e74 206f 626a 6563 7420 6174 2030 7837  nt object at 0x7
-00004050: 6635 3065 6331 3663 3964 303e 2c20 2765  f50ec16c9d0>, 'e
-00004060: 7863 6570 7469 6f6e 273a 204e 6f6e 652c  xception': None,
-00004070: 2027 636f 6d70 6c65 7465 6427 3a20 5472   'completed': Tr
-00004080: 7565 7d20 290a 3e3e 204e 6f64 6528 3c66  ue} ).>> Node(<f
-00004090: 756e 6374 696f 6e20 6920 6174 2030 7837  unction i at 0x7
-000040a0: 6635 3066 3462 3533 3238 303e 3a20 7b27  f50f4b53280>: {'
-000040b0: 7374 6174 6527 3a20 2753 4b49 5050 4544  state': 'SKIPPED
-000040c0: 272c 2027 7265 7375 6c74 273a 204e 6f6e  ', 'result': Non
-000040d0: 652c 2027 6578 6365 7074 696f 6e27 3a20  e, 'exception': 
-000040e0: 4e6f 6e65 2c20 2763 6f6d 706c 6574 6564  None, 'completed
-000040f0: 273a 2046 616c 7365 7d20 290a 6060 600a  ': False} ).```.
-00004100: 0a23 2320 4578 6563 7574 6520 7370 6172  .## Execute spar
-00004110: 6b20 7069 7065 6c69 6e65 206f 6620 6d75  k pipeline of mu
-00004120: 6c74 6970 6c65 2073 7465 7073 0a75 7369  ltiple steps.usi
-00004130: 6e67 2044 4147 2063 6f6d 706f 6e65 6e74  ng DAG component
-00004140: 2074 6f20 6861 6e64 6c65 2070 6172 616c   to handle paral
-00004150: 6c65 6c20 6578 6563 7574 696f 6e0a 6060  lel execution.``
-00004160: 6070 7974 686f 6e0a 696d 706f 7274 2062  `python.import b
-00004170: 6471 0a66 726f 6d20 6264 7120 696d 706f  dq.from bdq impo
-00004180: 7274 2073 7061 726b 2c20 7461 626c 650a  rt spark, table.
-00004190: 0a70 706e 203d 2062 6471 2e53 7061 726b  .ppn = bdq.Spark
-000041a0: 5069 7065 6c69 6e65 2873 7061 726b 2c20  Pipeline(spark, 
-000041b0: 2272 6574 6169 6c22 290a 0a23 2072 6574  "retail")..# ret
-000041c0: 7572 6e73 2064 6174 6166 7261 6d65 2c20  urns dataframe, 
-000041d0: 616e 6420 6372 6561 7465 7320 7370 6172  and creates spar
-000041e0: 6b20 7669 6577 2027 7261 775f 6461 7461  k view 'raw_data
-000041f0: 5f73 696e 676c 655f 736f 7572 6365 270a  _single_source'.
-00004200: 4070 706e 2e73 7465 7028 290a 6465 6620  @ppn.step().def 
-00004210: 7261 775f 6461 7461 5f73 696e 676c 655f  raw_data_single_
-00004220: 736f 7572 6365 2870 293a 0a20 2072 6574  source(p):.  ret
-00004230: 7572 6e20 7370 6172 6b2e 7261 6e67 6528  urn spark.range(
-00004240: 312c 2031 3029 0a0a 2320 7265 7475 726e  1, 10)..# return
-00004250: 7320 6461 7461 6672 616d 652c 2061 6e64  s dataframe, and
-00004260: 2063 7265 6174 6573 2073 7061 726b 2076   creates spark v
-00004270: 6965 7720 2772 6177 5f6e 6963 655f 6e61  iew 'raw_nice_na
-00004280: 6d65 270a 4070 706e 2e73 7465 7028 7265  me'.@ppn.step(re
-00004290: 7475 726e 733d 5b22 7261 775f 6e69 6365  turns=["raw_nice
-000042a0: 5f6e 616d 6522 5d29 0a64 6566 2072 6177  _name"]).def raw
-000042b0: 5f64 6174 615f 7369 6e67 6c65 5f73 6f75  _data_single_sou
-000042c0: 7263 655f 7769 7468 5f63 7573 746f 6d5f  rce_with_custom_
-000042d0: 6e61 6d65 2870 293a 0a20 2072 6574 7572  name(p):.  retur
-000042e0: 6e20 7370 6172 6b2e 7261 6e67 6528 3130  n spark.range(10
-000042f0: 302c 2031 3130 290a 0a23 2072 6574 7572  0, 110)..# retur
-00004300: 6e73 2074 776f 2064 6174 6166 7261 6d65  ns two dataframe
-00004310: 732c 2061 6e64 2063 7265 6174 6573 2074  s, and creates t
-00004320: 776f 2073 7061 726b 2076 6965 7773 2027  wo spark views '
-00004330: 7261 775f 6461 7461 3127 2c20 2772 6177  raw_data1', 'raw
-00004340: 5f64 6174 6132 270a 4070 706e 2e73 7465  _data2'.@ppn.ste
-00004350: 7028 7265 7475 726e 733d 5b22 7261 775f  p(returns=["raw_
-00004360: 6461 7461 3122 2c20 2272 6177 5f64 6174  data1", "raw_dat
-00004370: 6132 225d 290a 6465 6620 7261 775f 6461  a2"]).def raw_da
-00004380: 7461 5f6d 756c 7469 5f73 6f75 7263 6528  ta_multi_source(
-00004390: 7029 3a0a 2020 6466 3120 3d20 7370 6172  p):.  df1 = spar
-000043a0: 6b2e 7261 6e67 6528 3130 3030 2c20 3230  k.range(1000, 20
-000043b0: 3030 290a 2020 6466 3220 3d20 7370 6172  00).  df2 = spar
-000043c0: 6b2e 7261 6e67 6528 3230 3030 2c20 3330  k.range(2000, 30
-000043d0: 3030 290a 0a20 2072 6574 7572 6e20 5b64  00)..  return [d
-000043e0: 6631 2c20 6466 325d 0a0a 2320 7761 6974  f1, df2]..# wait
-000043f0: 7320 666f 7220 7261 7720 6461 7461 2073  s for raw data s
-00004400: 6f75 7263 6573 2074 6f20 6669 6e69 7368  ources to finish
-00004410: 2c20 616e 6420 636f 6d62 696e 6573 2074  , and combines t
-00004420: 6865 2064 6174 6120 696e 746f 206f 6e65  he data into one
-00004430: 2075 6e69 6f6e 6564 2076 6965 7720 6063   unioned view `c
-00004440: 6f6d 6269 6e65 5f64 6174 6160 0a23 206e  ombine_data`.# n
-00004450: 6f74 6520 7468 6174 2064 6570 656e 6465  ote that depende
-00004460: 6e63 6965 7320 6172 6520 7079 7468 6f6e  ncies are python
-00004470: 2066 756e 6374 696f 6e73 2c20 6e6f 7420   functions, not 
-00004480: 6e61 6d65 7320 6f66 2076 6965 7773 2028  names of views (
-00004490: 544f 444f 3a20 746f 2068 616e 646c 6520  TODO: to handle 
-000044a0: 7669 6577 206e 616d 6573 2061 7320 7765  view names as we
-000044b0: 6c6c 290a 4070 706e 2e73 7465 7028 6465  ll).@ppn.step(de
-000044c0: 7065 6e64 735f 6f6e 3d5b 7261 775f 6461  pends_on=[raw_da
-000044d0: 7461 5f73 696e 676c 655f 736f 7572 6365  ta_single_source
-000044e0: 2c20 7261 775f 6461 7461 5f73 696e 676c  , raw_data_singl
-000044f0: 655f 736f 7572 6365 5f77 6974 685f 6375  e_source_with_cu
-00004500: 7374 6f6d 5f6e 616d 652c 2072 6177 5f64  stom_name, raw_d
-00004510: 6174 615f 6d75 6c74 695f 736f 7572 6365  ata_multi_source
-00004520: 5d29 0a64 6566 2063 6f6d 6269 6e65 5f64  ]).def combine_d
-00004530: 6174 6128 7029 3a0a 2020 6466 203d 2074  ata(p):.  df = t
-00004540: 6162 6c65 2827 7261 775f 6461 7461 5f73  able('raw_data_s
-00004550: 696e 676c 655f 736f 7572 6365 2729 205c  ingle_source') \
-00004560: 0a20 2020 202e 756e 696f 6e28 7461 626c  .    .union(tabl
-00004570: 6528 2772 6177 5f6e 6963 655f 6e61 6d65  e('raw_nice_name
-00004580: 2729 2920 5c0a 2020 2020 2e75 6e69 6f6e  ')) \.    .union
-00004590: 2874 6162 6c65 2827 7261 775f 6461 7461  (table('raw_data
-000045a0: 3127 2929 205c 0a20 2020 202e 756e 696f  1')) \.    .unio
-000045b0: 6e28 7461 626c 6528 2772 6177 5f64 6174  n(table('raw_dat
-000045c0: 6132 2729 290a 0a20 2072 6574 7572 6e20  a2'))..  return 
-000045d0: 6466 0a0a 2320 7370 6c69 7473 2074 6865  df..# splits the
-000045e0: 2063 6f6d 6269 6e65 645f 6461 7461 2069   combined_data i
-000045f0: 6e74 6f20 276f 6464 2720 616e 6420 2765  nto 'odd' and 'e
-00004600: 7665 6e27 2076 6965 7773 0a40 7070 6e2e  ven' views.@ppn.
-00004610: 7374 6570 2864 6570 656e 6473 5f6f 6e3d  step(depends_on=
-00004620: 5b63 6f6d 6269 6e65 5f64 6174 615d 2c20  [combine_data], 
-00004630: 7265 7475 726e 733d 5b27 6f64 6427 2c20  returns=['odd', 
-00004640: 2765 7665 6e27 5d29 0a64 6566 2073 706c  'even']).def spl
-00004650: 6974 5f64 6174 6128 7029 3a0a 2020 6466  it_data(p):.  df
-00004660: 5f6f 6464 203d 2074 6162 6c65 2827 636f  _odd = table('co
-00004670: 6d62 696e 655f 6461 7461 2729 2e66 696c  mbine_data').fil
-00004680: 7465 7228 2769 6420 2520 3220 3d3d 2031  ter('id % 2 == 1
-00004690: 2729 0a20 2064 665f 6576 656e 203d 2074  ').  df_even = t
-000046a0: 6162 6c65 2827 636f 6d62 696e 655f 6461  able('combine_da
-000046b0: 7461 2729 2e66 696c 7465 7228 2769 6420  ta').filter('id 
-000046c0: 2520 3220 3d3d 2030 2729 0a0a 2020 7265  % 2 == 0')..  re
-000046d0: 7475 726e 205b 2064 665f 6f64 642c 2064  turn [ df_odd, d
-000046e0: 665f 6576 656e 205d 0a0a 2320 6966 2079  f_even ]..# if y
-000046f0: 6f75 2068 6176 6520 6970 7964 6167 7265  ou have ipydagre
-00004700: 6433 2069 6e73 7461 6c6c 6564 2c20 796f  d3 installed, yo
-00004710: 7520 6361 6e20 7365 6520 696e 2072 6561  u can see in rea
-00004720: 6c20 7469 6d65 2073 7461 7465 2063 6861  l time state cha
-00004730: 6e67 6573 206f 6620 6561 6368 206f 6620  nges of each of 
-00004740: 7468 6520 7374 6570 730a 6469 7370 6c61  the steps.displa
-00004750: 7928 7070 6e2e 7669 7375 616c 697a 6528  y(ppn.visualize(
-00004760: 2929 0a0a 2320 6578 6563 7574 6573 2070  ))..# executes p
-00004770: 6970 656c 696e 6520 7573 696e 6720 636f  ipeline using co
-00004780: 6e63 7572 7265 6e74 2074 6872 6561 6473  ncurrent threads
-00004790: 2c20 6f6e 6520 7065 7220 6561 6368 2073  , one per each s
-000047a0: 7465 702c 2066 6f6c 6c6f 7769 6e67 2074  tep, following t
-000047b0: 6865 2064 6570 656e 6465 6e63 7920 4441  he dependency DA
-000047c0: 470a 2320 7069 7065 6c69 6e65 2069 7320  G.# pipeline is 
-000047d0: 6120 6e6f 726d 616c 2070 7974 686f 6e20  a normal python 
-000047e0: 6361 6c6c 6162 6c65 206f 626a 6563 742c  callable object,
-000047f0: 2061 7320 6966 2069 7420 7761 7320 6120   as if it was a 
-00004800: 6675 6e63 7469 6f6e 2c20 6974 2072 6574  function, it ret
-00004810: 7572 6e73 2061 206c 6973 7420 6f66 2061  urns a list of a
-00004820: 6c6c 2073 7465 7073 0a70 6970 656c 696e  ll steps.pipelin
-00004830: 655f 7265 7375 6c74 7320 3d20 7070 6e28  e_results = ppn(
-00004840: 6d61 785f 636f 6e63 7572 7265 6e74 5f73  max_concurrent_s
-00004850: 7465 7073 3d31 3029 0a0a 7072 696e 7428  teps=10)..print(
-00004860: 2770 6970 656c 696e 6520 7265 7375 6c74  'pipeline result
-00004870: 733a 2729 0a70 7269 6e74 2870 6970 656c  s:').print(pipel
-00004880: 696e 655f 7265 7375 6c74 7329 0a0a 2373  ine_results)..#s
-00004890: 686f 7720 736f 6d65 2066 696e 616c 2076  how some final v
-000048a0: 616c 7565 730a 7072 696e 7428 2765 7665  alues.print('eve
-000048b0: 6e20 6e75 6d62 6572 733a 2729 0a70 7269  n numbers:').pri
-000048c0: 6e74 2874 6162 6c65 2827 6576 656e 2729  nt(table('even')
-000048d0: 2e6c 696d 6974 2831 3029 2e63 6f6c 6c65  .limit(10).colle
-000048e0: 6374 2829 290a 7072 696e 7428 276f 6464  ct()).print('odd
-000048f0: 206e 756d 6265 7273 3a27 290a 7072 696e   numbers:').prin
-00004900: 7428 7461 626c 6528 276f 6464 2729 2e6c  t(table('odd').l
-00004910: 696d 6974 2831 3029 2e63 6f6c 6c65 6374  imit(10).collect
-00004920: 2829 290a 0a3e 3e20 5761 6974 696e 6720  ())..>> Waiting 
-00004930: 666f 7220 616c 6c20 7461 736b 7320 746f  for all tasks to
-00004940: 2066 696e 6973 682e 2e2e 0a3e 3e20 2020   finish....>>   
-00004950: 7374 6172 7469 6e67 3a20 4e6f 6465 2872  starting: Node(r
-00004960: 6177 5f64 6174 615f 7369 6e67 6c65 5f73  aw_data_single_s
-00004970: 6f75 7263 653a 207b 2773 7461 7465 273a  ource: {'state':
-00004980: 2027 5255 4e4e 494e 4727 2c20 2772 6573   'RUNNING', 'res
-00004990: 756c 7427 3a20 4e6f 6e65 2c20 2765 7863  ult': None, 'exc
-000049a0: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
-000049b0: 636f 6d70 6c65 7465 6427 3a20 4661 6c73  completed': Fals
-000049c0: 657d 2029 0a3e 3e20 2020 7374 6172 7469  e} ).>>   starti
-000049d0: 6e67 3a20 4e6f 6465 2872 6177 5f64 6174  ng: Node(raw_dat
-000049e0: 615f 7369 6e67 6c65 5f73 6f75 7263 655f  a_single_source_
-000049f0: 7769 7468 5f63 7573 746f 6d5f 6e61 6d65  with_custom_name
-00004a00: 3a20 7b27 7374 6174 6527 3a20 2752 554e  : {'state': 'RUN
-00004a10: 4e49 4e47 272c 2027 7265 7375 6c74 273a  NING', 'result':
-00004a20: 204e 6f6e 652c 2027 6578 6365 7074 696f   None, 'exceptio
-00004a30: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
-00004a40: 6574 6564 273a 2046 616c 7365 7d20 290a  eted': False} ).
-00004a50: 3e3e 2020 2073 7461 7274 696e 673a 204e  >>   starting: N
-00004a60: 6f64 6528 7261 775f 6461 7461 5f6d 756c  ode(raw_data_mul
-00004a70: 7469 5f73 6f75 7263 653a 207b 2773 7461  ti_source: {'sta
-00004a80: 7465 273a 2027 5255 4e4e 494e 4727 2c20  te': 'RUNNING', 
-00004a90: 2772 6573 756c 7427 3a20 4e6f 6e65 2c20  'result': None, 
-00004aa0: 2765 7863 6570 7469 6f6e 273a 204e 6f6e  'exception': Non
-00004ab0: 652c 2027 636f 6d70 6c65 7465 6427 3a20  e, 'completed': 
-00004ac0: 4661 6c73 657d 2029 0a3e 3e20 2020 6669  False} ).>>   fi
-00004ad0: 6e69 7368 6564 3a20 4e6f 6465 2872 6177  nished: Node(raw
-00004ae0: 5f64 6174 615f 7369 6e67 6c65 5f73 6f75  _data_single_sou
-00004af0: 7263 653a 207b 2773 7461 7465 273a 2027  rce: {'state': '
-00004b00: 5355 4343 4553 5327 2c20 2772 6573 756c  SUCCESS', 'resul
-00004b10: 7427 3a20 5b44 6174 6146 7261 6d65 5b69  t': [DataFrame[i
-00004b20: 643a 2062 6967 696e 745d 5d2c 2027 6578  d: bigint]], 'ex
-00004b30: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
-00004b40: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
-00004b50: 657d 2029 2028 7374 696c 6c20 7275 6e6e  e} ) (still runn
-00004b60: 696e 673a 2032 290a 3e3e 2020 2066 696e  ing: 2).>>   fin
-00004b70: 6973 6865 643a 204e 6f64 6528 7261 775f  ished: Node(raw_
-00004b80: 6461 7461 5f73 696e 676c 655f 736f 7572  data_single_sour
-00004b90: 6365 5f77 6974 685f 6375 7374 6f6d 5f6e  ce_with_custom_n
-00004ba0: 616d 653a 207b 2773 7461 7465 273a 2027  ame: {'state': '
-00004bb0: 5355 4343 4553 5327 2c20 2772 6573 756c  SUCCESS', 'resul
-00004bc0: 7427 3a20 5b44 6174 6146 7261 6d65 5b69  t': [DataFrame[i
-00004bd0: 643a 2062 6967 696e 745d 5d2c 2027 6578  d: bigint]], 'ex
-00004be0: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
-00004bf0: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
-00004c00: 657d 2029 2028 7374 696c 6c20 7275 6e6e  e} ) (still runn
-00004c10: 696e 673a 2031 290a 3e3e 2020 2073 7461  ing: 1).>>   sta
-00004c20: 7274 696e 673a 204e 6f64 6528 636f 6d62  rting: Node(comb
-00004c30: 696e 655f 6461 7461 3a20 7b27 7374 6174  ine_data: {'stat
-00004c40: 6527 3a20 2752 554e 4e49 4e47 272c 2027  e': 'RUNNING', '
-00004c50: 7265 7375 6c74 273a 204e 6f6e 652c 2027  result': None, '
-00004c60: 6578 6365 7074 696f 6e27 3a20 4e6f 6e65  exception': None
-00004c70: 2c20 2763 6f6d 706c 6574 6564 273a 2046  , 'completed': F
-00004c80: 616c 7365 7d20 290a 3e3e 2020 2066 696e  alse} ).>>   fin
-00004c90: 6973 6865 643a 204e 6f64 6528 7261 775f  ished: Node(raw_
-00004ca0: 6461 7461 5f6d 756c 7469 5f73 6f75 7263  data_multi_sourc
-00004cb0: 653a 207b 2773 7461 7465 273a 2027 5355  e: {'state': 'SU
-00004cc0: 4343 4553 5327 2c20 2772 6573 756c 7427  CCESS', 'result'
-00004cd0: 3a20 5b44 6174 6146 7261 6d65 5b69 643a  : [DataFrame[id:
-00004ce0: 2062 6967 696e 745d 2c20 4461 7461 4672   bigint], DataFr
-00004cf0: 616d 655b 6964 3a20 6269 6769 6e74 5d5d  ame[id: bigint]]
-00004d00: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
-00004d10: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
-00004d20: 3a20 5472 7565 7d20 2920 2873 7469 6c6c  : True} ) (still
-00004d30: 2072 756e 6e69 6e67 3a20 3129 0a3e 3e20   running: 1).>> 
-00004d40: 2020 7374 6172 7469 6e67 3a20 4e6f 6465    starting: Node
-00004d50: 2873 706c 6974 5f64 6174 613a 207b 2773  (split_data: {'s
-00004d60: 7461 7465 273a 2027 5255 4e4e 494e 4727  tate': 'RUNNING'
-00004d70: 2c20 2772 6573 756c 7427 3a20 4e6f 6e65  , 'result': None
-00004d80: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
-00004d90: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
-00004da0: 3a20 4661 6c73 657d 2029 0a3e 3e20 2020  : False} ).>>   
-00004db0: 6669 6e69 7368 6564 3a20 4e6f 6465 2863  finished: Node(c
-00004dc0: 6f6d 6269 6e65 5f64 6174 613a 207b 2773  ombine_data: {'s
-00004dd0: 7461 7465 273a 2027 5355 4343 4553 5327  tate': 'SUCCESS'
-00004de0: 2c20 2772 6573 756c 7427 3a20 5b44 6174  , 'result': [Dat
-00004df0: 6146 7261 6d65 5b69 643a 2062 6967 696e  aFrame[id: bigin
-00004e00: 745d 5d2c 2027 6578 6365 7074 696f 6e27  t]], 'exception'
-00004e10: 3a20 4e6f 6e65 2c20 2763 6f6d 706c 6574  : None, 'complet
-00004e20: 6564 273a 2054 7275 657d 2029 2028 7374  ed': True} ) (st
-00004e30: 696c 6c20 7275 6e6e 696e 673a 2031 290a  ill running: 1).
-00004e40: 3e3e 2020 2066 696e 6973 6865 643a 204e  >>   finished: N
-00004e50: 6f64 6528 7370 6c69 745f 6461 7461 3a20  ode(split_data: 
-00004e60: 7b27 7374 6174 6527 3a20 2753 5543 4345  {'state': 'SUCCE
-00004e70: 5353 272c 2027 7265 7375 6c74 273a 205b  SS', 'result': [
-00004e80: 4461 7461 4672 616d 655b 6964 3a20 6269  DataFrame[id: bi
-00004e90: 6769 6e74 5d2c 2044 6174 6146 7261 6d65  gint], DataFrame
-00004ea0: 5b69 643a 2062 6967 696e 745d 5d2c 2027  [id: bigint]], '
-00004eb0: 6578 6365 7074 696f 6e27 3a20 4e6f 6e65  exception': None
-00004ec0: 2c20 2763 6f6d 706c 6574 6564 273a 2054  , 'completed': T
-00004ed0: 7275 657d 2029 2028 7374 696c 6c20 7275  rue} ) (still ru
-00004ee0: 6e6e 696e 673a 2030 290a 3e3e 2041 6c6c  nning: 0).>> All
-00004ef0: 2074 6173 6b73 2066 696e 6973 6865 642c   tasks finished,
-00004f00: 2073 6875 7474 696e 6720 646f 776e 0a3e   shutting down.>
-00004f10: 3e20 7069 7065 6c69 6e65 2072 6573 756c  > pipeline resul
-00004f20: 7473 3a0a 3e3e 205b 7261 775f 6461 7461  ts:.>> [raw_data
-00004f30: 5f73 696e 676c 655f 736f 7572 6365 2c20  _single_source, 
-00004f40: 7261 775f 6461 7461 5f73 696e 676c 655f  raw_data_single_
-00004f50: 736f 7572 6365 5f77 6974 685f 6375 7374  source_with_cust
-00004f60: 6f6d 5f6e 616d 652c 2072 6177 5f64 6174  om_name, raw_dat
-00004f70: 615f 6d75 6c74 695f 736f 7572 6365 2c20  a_multi_source, 
-00004f80: 636f 6d62 696e 655f 6461 7461 2c20 7370  combine_data, sp
-00004f90: 6c69 745f 6461 7461 5d0a 3e3e 2065 7665  lit_data].>> eve
-00004fa0: 6e20 6e75 6d62 6572 733a 0a3e 3e20 5b52  n numbers:.>> [R
-00004fb0: 6f77 2869 643d 3229 2c20 526f 7728 6964  ow(id=2), Row(id
-00004fc0: 3d34 292c 2052 6f77 2869 643d 3629 2c20  =4), Row(id=6), 
-00004fd0: 526f 7728 6964 3d38 292c 2052 6f77 2869  Row(id=8), Row(i
-00004fe0: 643d 3130 3029 2c20 526f 7728 6964 3d31  d=100), Row(id=1
-00004ff0: 3032 292c 2052 6f77 2869 643d 3130 3429  02), Row(id=104)
-00005000: 2c20 526f 7728 6964 3d31 3036 292c 2052  , Row(id=106), R
-00005010: 6f77 2869 643d 3130 3829 2c20 526f 7728  ow(id=108), Row(
-00005020: 6964 3d31 3030 3029 5d0a 3e3e 206f 6464  id=1000)].>> odd
-00005030: 206e 756d 6265 7273 3a0a 3e3e 205b 526f   numbers:.>> [Ro
-00005040: 7728 6964 3d31 292c 2052 6f77 2869 643d  w(id=1), Row(id=
-00005050: 3329 2c20 526f 7728 6964 3d35 292c 2052  3), Row(id=5), R
-00005060: 6f77 2869 643d 3729 2c20 526f 7728 6964  ow(id=7), Row(id
-00005070: 3d39 292c 2052 6f77 2869 643d 3130 3129  =9), Row(id=101)
-00005080: 2c20 526f 7728 6964 3d31 3033 292c 2052  , Row(id=103), R
-00005090: 6f77 2869 643d 3130 3529 2c20 526f 7728  ow(id=105), Row(
-000050a0: 6964 3d31 3037 292c 2052 6f77 2869 643d  id=107), Row(id=
-000050b0: 3130 3929 5d0a 6060 600a 0a70 6970 656c  109)].```..pipel
-000050c0: 696e 6520 7374 6570 7320 6172 6520 7265  ine steps are re
-000050d0: 7275 6e61 626c 6520 6173 2061 6e79 206f  runable as any o
-000050e0: 7264 696e 6172 7920 6675 6e63 7469 6f6e  rdinary function
-000050f0: 3a0a 6060 6070 7974 686f 6e0a 2320 746f  :.```python.# to
-00005100: 2072 6572 756e 2067 6976 656e 2073 7465   rerun given ste
-00005110: 702c 206a 7573 7420 6578 6563 7574 6520  p, just execute 
-00005120: 6974 2061 7320 6966 2069 7420 7761 7320  it as if it was 
-00005130: 6120 7075 7265 2066 756e 6374 696f 6e0a  a pure function.
-00005140: 2320 7265 7475 726e 2069 7320 616c 6177  # return is alaw
-00005150: 6179 7320 6120 6c69 7374 206f 6620 6461  ays a list of da
-00005160: 7461 6672 616d 7320 7468 6174 2067 6976  taframs that giv
-00005170: 656e 2040 7070 6e2e 7374 6570 2072 6574  en @ppn.step ret
-00005180: 7572 6e73 0a23 206e 6f74 653a 2074 6865  urns.# note: the
-00005190: 2073 7061 726b 2076 6965 7720 2772 6177   spark view 'raw
-000051a0: 5f64 6174 615f 7369 6e67 6c65 5f73 6f75  _data_single_sou
-000051b0: 7263 6527 2077 696c 6c20 6265 2075 7064  rce' will be upd
-000051c0: 6174 6564 2077 6865 6e20 7468 6973 2066  ated when this f
-000051d0: 756e 6374 696f 6e20 6669 6e69 7368 6573  unction finishes
-000051e0: 2028 6173 2070 6572 2064 6566 696e 7469   (as per definti
-000051f0: 6f6e 2069 6e20 4070 706e 2e73 7465 7020  on in @ppn.step 
-00005200: 6162 6f76 6529 0a72 6177 5f64 6174 615f  above).raw_data_
-00005210: 7369 6e67 6c65 5f73 6f75 7263 6528 290a  single_source().
-00005220: 6060 600a 0a23 2320 5370 6172 6b20 5549  ```..## Spark UI
-00005230: 2053 7461 6765 2064 6573 6372 6970 7469   Stage descripti
-00005240: 6f6e 730a 5768 656e 2072 756e 6e69 6e67  ons.When running
-00005250: 2063 6f64 6520 7573 696e 6720 7079 7370   code using pysp
-00005260: 6172 6b2c 2073 7061 726b 2075 6920 6765  ark, spark ui ge
-00005270: 7473 2076 6572 7920 6372 6f77 6465 642e  ts very crowded.
-00005280: 2060 5370 6172 6b55 494c 6f67 6765 7260   `SparkUILogger`
-00005290: 2063 6f6e 7465 7874 206d 616e 6167 6572   context manager
-000052a0: 2061 6e64 2064 6563 6f72 6174 6f72 2061   and decorator a
-000052b0: 7373 696e 6773 2068 756d 616e 2072 6561  ssings human rea
-000052c0: 6461 626c 6520 6e61 6d65 7320 746f 2073  dable names to s
-000052d0: 7061 726b 2073 7461 6765 732e 0a0a 6060  park stages...``
-000052e0: 6070 7974 686f 6e0a 6672 6f6d 2062 6471  `python.from bdq
-000052f0: 0a0a 2320 7573 6167 6520 6f66 2064 6563  ..# usage of dec
-00005300: 6f72 6174 6f72 730a 2320 7370 6172 6b20  orators.# spark 
-00005310: 7569 2073 7461 6765 7320 7769 6c6c 2068  ui stages will h
-00005320: 6176 6520 6465 7363 7269 7074 696f 6e20  ave description 
-00005330: 6f66 2027 7879 7a27 0a40 5370 6172 6b55  of 'xyz'.@SparkU
-00005340: 494c 6f67 6765 722e 7461 6728 6465 7363  ILogger.tag(desc
-00005350: 3d27 7879 7a27 290a 6465 6620 736f 6d65  ='xyz').def some
-00005360: 5f66 756e 6374 696f 6e32 286e 756d 6265  _function2(numbe
-00005370: 7229 3a0a 0a20 2072 6574 7572 6e20 7370  r):..  return sp
-00005380: 6172 6b2e 7261 6e67 6528 6e75 6d62 6572  ark.range(number
-00005390: 292e 636f 756e 7428 290a 0a23 2073 7061  ).count()..# spa
-000053a0: 726b 2075 6920 7374 6167 6573 2077 696c  rk ui stages wil
-000053b0: 6c20 6861 7665 2064 6573 6372 6970 7469  l have descripti
-000053c0: 6f6e 206f 6620 2761 6c70 6861 5f66 756e  on of 'alpha_fun
-000053d0: 6374 696f 6e32 2720 2861 7574 6f6d 6174  ction2' (automat
-000053e0: 6963 616c 6c79 2064 6572 6976 6564 2066  ically derived f
-000053f0: 726f 6d20 6675 6e63 7469 6f6e 206e 616d  rom function nam
-00005400: 6529 0a40 5370 6172 6b55 494c 6f67 6765  e).@SparkUILogge
-00005410: 722e 7461 670a 6465 6620 616c 7068 615f  r.tag.def alpha_
-00005420: 6675 6e63 7469 6f6e 3228 6e75 6d62 6572  function2(number
-00005430: 293a 0a20 2023 2031 7374 2061 6e64 2032  ):.  # 1st and 2
-00005440: 6e64 2073 6f6d 655f 6675 6e63 7469 6f6e  nd some_function
-00005450: 3228 2920 6361 6c6c 7320 7368 6f75 6c64  2() calls should
-00005460: 2062 6520 7669 7369 626c 6520 696e 2073   be visible in s
-00005470: 7061 726b 2075 6920 6173 2027 7879 7a27  park ui as 'xyz'
-00005480: 0a20 2023 2074 6865 2033 7264 2070 6172  .  # the 3rd par
-00005490: 7420 6f66 2072 6573 756c 7420 7368 6f75  t of result shou
-000054a0: 6c64 2062 6520 7669 7369 626c 6520 6173  ld be visible as
-000054b0: 2027 616c 7068 615f 6675 6e63 7469 6f6e   'alpha_function
-000054c0: 320a 2020 7265 7475 726e 2073 6f6d 655f  2.  return some_
-000054d0: 6675 6e63 7469 6f6e 3228 6e75 6d62 6572  function2(number
-000054e0: 2a32 2920 2b20 736f 6d65 5f66 756e 6374  *2) + some_funct
-000054f0: 696f 6e32 286e 756d 6265 722a 3329 202b  ion2(number*3) +
-00005500: 2073 7061 726b 2e72 616e 6765 286e 756d   spark.range(num
-00005510: 6265 722f 3130 292e 636f 756e 7428 290a  ber/10).count().
-00005520: 0a23 2075 7361 6765 206f 6620 636f 6e74  .# usage of cont
-00005530: 6578 7420 6d61 6e61 6765 7273 0a23 2077  ext managers.# w
-00005540: 696c 6c20 6265 2076 6973 6962 6c65 2069  ill be visible i
-00005550: 6e20 7370 6172 6b20 7569 2061 7320 2766  n spark ui as 'f
-00005560: 6972 7374 2d63 6f75 6e74 270a 7769 7468  irst-count'.with
-00005570: 2053 7061 726b 5549 4c6f 6767 6572 2827   SparkUILogger('
-00005580: 6669 7273 742d 636f 756e 7427 293a 0a20  first-count'):. 
-00005590: 2073 7061 726b 2e72 616e 6765 2831 3029   spark.range(10)
-000055a0: 2e63 6f75 6e74 2829 0a0a 2320 7769 6c6c  .count()..# will
-000055b0: 2062 6520 7669 7369 626c 6520 696e 2073   be visible in s
-000055c0: 7061 726b 2075 6920 6173 2027 326e 642d  park ui as '2nd-
-000055d0: 636f 756e 7427 0a77 6974 6820 5370 6172  count'.with Spar
-000055e0: 6b55 494c 6f67 6765 7228 2732 6e64 2d63  kUILogger('2nd-c
-000055f0: 6f75 6e74 2729 3a0a 2020 7370 6172 6b2e  ount'):.  spark.
-00005600: 7261 6e67 6528 3230 292e 636f 756e 7428  range(20).count(
-00005610: 290a 0a73 6f6d 655f 6675 6e63 7469 6f6e  )..some_function
-00005620: 3228 3130 3030 290a 616c 7068 615f 6675  2(1000).alpha_fu
-00005630: 6e63 7469 6f6e 3228 3230 3030 290a 6060  nction2(2000).``
-00005640: 600a                                     `.
+00002160: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002170: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002180: 2d2d 2d2b 0a3e 3e20 7c49 5420 207c 5553  ---+.>> |IT  |US
+00002190: 4120 2020 207c 5b7b 4954 2c20 5553 412c  A    |[{IT, USA,
+000021a0: 2041 6c69 6365 312c 20ef bfbd efbf bd78   Alice1, ......x
+000021b0: 7a34 7110 5fef bfbd efbf bd11 5c72 61ef  z4q._.......\ra.
+000021c0: bfbd 2def bfbd 16ef bfbd 567a 7d2c 207b  ..-.......Vz}, {
+000021d0: 4954 2c20 5553 412c 2041 6c69 6365 322c  IT, USA, Alice2,
+000021e0: 20ef bfbd efbf bd78 7a34 7110 5fef bfbd   ......xz4q._...
+000021f0: efbf bd11 5c72 61ef bfbd 2def bfbd 16ef  ....\ra...-.....
+00002200: bfbd 567a 7d5d 7c0a 3e3e 207c 4954 2020  ..Vz}]|.>> |IT  
+00002210: 7c45 5520 2020 2020 7c5b 7b49 5420 202c  |EU     |[{IT  ,
+00002220: 2045 5520 2020 202c 204a 7573 7469 6e2c   EU    , Justin,
+00002230: 20ef bfbd efbf bd48 2756 34ef bfbd 5c72   ......H'V4...\r
+00002240: 592c 67ef bfbd 49ef bfbd efbf bd12 efbf  Y,g...I.........
+00002250: bdef bfbd efbf bd7d 5d20 2020 2020 2020  .......}]       
+00002260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002270: 2020 2020 2020 2020 2020 2020 2020 207c                 |
+00002280: 0a3e 3e20 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d  .>> +----+------
+00002290: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
+000022a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000022b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000022c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000022d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000022e0: 2d2d 2d2d 2d2d 2b0a 0a23 2075 7369 6e67  ------+..# using
+000022f0: 2073 7572 726f 6761 7465 206b 6579 7320   surrogate keys 
+00002300: 7769 6c6c 2079 6965 6c64 2062 6574 7465  will yield bette
+00002310: 7220 7265 7375 6c74 732c 2062 6563 6175  r results, becau
+00002320: 7365 2065 7874 7261 2073 7061 6365 7320  se extra spaces 
+00002330: 6172 6520 7472 696d 6d65 640a 6272 6f6b  are trimmed.brok
+00002340: 656e 5f73 6b5f 6466 203d 2066 6163 745f  en_sk_df = fact_
+00002350: 6469 6d5f 6272 6f6b 656e 5f72 656c 6174  dim_broken_relat
+00002360: 696f 6e73 6869 7028 0a20 2066 6163 745f  ionship(.  fact_
+00002370: 6466 2c20 5b22 6465 7074 5f66 6b22 5d2c  df, ["dept_fk"],
+00002380: 0a20 2064 696d 5f64 662c 205b 2264 6570  .  dim_df, ["dep
+00002390: 745f 706b 225d 2c0a 2020 7361 6d70 6c65  t_pk"],.  sample
+000023a0: 5f62 726f 6b65 6e5f 7265 636f 7264 733d  _broken_records=
+000023b0: 320a 290a 0a3e 3e20 2b2d 2d2d 2d2b 2d2d  2.)..>> +----+--
+000023c0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+000023d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002400: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002410: 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 3e3e 207c  ----------+.>> |
+00002420: 4465 7074 7c43 6f75 6e74 7279 7c73 616d  Dept|Country|sam
+00002430: 706c 655f 7265 636f 7264 7320 2020 2020  ple_records     
+00002440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002480: 207c 0a3e 3e20 2b2d 2d2d 2d2b 2d2d 2d2d   |.>> +----+----
+00002490: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+000024a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000024b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000024c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000024d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000024e0: 2d2d 2d2d 2d2d 2d2d 2b0a 3e3e 207c 4954  --------+.>> |IT
+000024f0: 2020 7c55 5341 2020 2020 7c5b 7b49 542c    |USA    |[{IT,
+00002500: 2055 5341 2c20 416c 6963 6531 2c20 efbf   USA, Alice1, ..
+00002510: bdef bfbd 787a 3471 105f efbf bdef bfbd  ....xz4q._......
+00002520: 115c 7261 efbf bd2d efbf bd16 efbf bd56  .\ra...-.......V
+00002530: 7a7d 2c20 7b49 542c 2055 5341 2c20 416c  z}, {IT, USA, Al
+00002540: 6963 6532 2c20 efbf bdef bfbd 787a 3471  ice2, ......xz4q
+00002550: 105f efbf bdef bfbd 115c 7261 efbf bd2d  ._.......\ra...-
+00002560: efbf bd16 efbf bd56 7a7d 5d7c 0a3e 3e20  .......Vz}]|.>> 
+00002570: 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d  +----+-------+--
+00002580: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002590: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000025a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000025b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000025c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000025d0: 2d2d 2b0a 6060 600a 0a23 2323 2047 6574  --+.```..### Get
+000025e0: 206c 6174 6573 7420 7265 636f 7264 730a   latest records.
+000025f0: 0a77 6974 6820 6f70 7469 6f6e 616c 2070  .with optional p
+00002600: 7269 6d61 7279 206b 6579 2063 6f6e 666c  rimary key confl
+00002610: 6963 7420 7265 736f 6c75 7469 6f6e 2c20  ict resolution, 
+00002620: 7768 6572 6520 7468 6572 6520 6172 6520  where there are 
+00002630: 6d75 6c74 6970 6c65 2072 6563 6f72 6473  multiple records
+00002640: 2062 6569 6e67 2063 616e 6469 6461 7465   being candidate
+00002650: 2066 6f72 206c 6174 6573 7420 7265 636f   for latest reco
+00002660: 7264 2c20 6275 7420 7468 6579 2068 6176  rd, but they hav
+00002670: 6520 6469 6666 6572 656e 7420 6174 7472  e different attr
+00002680: 6962 7565 7473 2061 6e64 2074 6865 7265  ibuets and there
+00002690: 2069 7320 6e6f 2077 6179 206f 6620 6465   is no way of de
+000026a0: 7465 726d 696e 696e 6720 7768 6963 6820  termining which 
+000026b0: 6f6e 6520 6973 2074 6865 206c 6174 6573  one is the lates
+000026c0: 742e 0a0a 6060 6070 7974 686f 6e0a 6672  t...```python.fr
+000026d0: 6f6d 2064 6174 6574 696d 6520 696d 706f  om datetime impo
+000026e0: 7274 2064 6174 6574 696d 6520 6173 2064  rt datetime as d
+000026f0: 740a 6672 6f6d 2062 6471 2069 6d70 6f72  t.from bdq impor
+00002700: 7420 6765 745f 6c61 7465 7374 5f72 6563  t get_latest_rec
+00002710: 6f72 6473 2c20 6765 745f 6c61 7465 7374  ords, get_latest
+00002720: 5f72 6563 6f72 6473 5f77 6974 685f 706b  _records_with_pk
+00002730: 5f63 6f6e 6669 6374 5f64 6574 6563 7469  _confict_detecti
+00002740: 6f6e 5f66 6c61 670a 0a69 6e63 7265 6d65  on_flag..increme
+00002750: 6e74 5f64 6174 6120 3d20 205b 0a20 2028  nt_data =  [.  (
+00002760: 312c 2064 7428 3230 3030 2c20 312c 2031  1, dt(2000, 1, 1
+00002770: 2c20 302c 2030 2c20 3029 2c20 2231 3030  , 0, 0, 0), "100
+00002780: 3122 290a 2020 2c28 312c 2064 7428 3230  1").  ,(1, dt(20
+00002790: 3030 2c20 312c 2031 2c20 322c 2030 2c20  00, 1, 1, 2, 0, 
+000027a0: 3029 2c20 2231 3030 3222 290a 2020 2c28  0), "1002").  ,(
+000027b0: 322c 2064 7428 3230 3030 2c20 312c 2031  2, dt(2000, 1, 1
+000027c0: 2c20 302c 2030 2c20 3029 2c20 2232 3030  , 0, 0, 0), "200
+000027d0: 3122 2920 2363 6172 626f 6e20 636f 7079  1") #carbon copy
+000027e0: 2064 7570 6c69 6361 7465 0a20 202c 2832   duplicate.  ,(2
+000027f0: 2c20 6474 2832 3030 302c 2031 2c20 312c  , dt(2000, 1, 1,
+00002800: 2030 2c20 302c 2030 292c 2022 3230 3031   0, 0, 0), "2001
+00002810: 2229 2023 6361 7262 6f6e 2063 6f70 7920  ") #carbon copy 
+00002820: 6475 706c 6963 6174 650a 2020 2c28 332c  duplicate.  ,(3,
+00002830: 2064 7428 3230 3030 2c20 312c 2031 2c20   dt(2000, 1, 1, 
+00002840: 302c 2030 2c20 3029 2c20 2233 3030 3122  0, 0, 0), "3001"
+00002850: 290a 2020 2c28 332c 2064 7428 3230 3030  ).  ,(3, dt(2000
+00002860: 2c20 312c 2031 2c20 322c 2030 2c20 3029  , 1, 1, 2, 0, 0)
+00002870: 2c20 2233 3030 3223 3122 2920 2370 6b20  , "3002#1") #pk 
+00002880: 636f 6e66 6c69 6374 2c20 7477 6f20 656e  conflict, two en
+00002890: 7472 6965 7320 7769 7468 2074 6865 2073  tries with the s
+000028a0: 616d 6520 7465 6368 6e69 6361 6c20 6669  ame technical fi
+000028b0: 656c 6473 2c20 6275 7420 6469 6666 6572  elds, but differ
+000028c0: 656e 7420 6174 7269 6275 7465 732c 2077  ent atributes, w
+000028d0: 6869 6368 206f 6e65 2074 6f20 6368 6f73  hich one to chos
+000028e0: 653f 0a20 202c 2833 2c20 6474 2832 3030  e?.  ,(3, dt(200
+000028f0: 302c 2031 2c20 312c 2032 2c20 302c 2030  0, 1, 1, 2, 0, 0
+00002900: 292c 2022 3330 3032 2332 2229 2023 706b  ), "3002#2") #pk
+00002910: 2063 6f6e 666c 6963 740a 5d0a 0a64 6620   conflict.]..df 
+00002920: 3d20 7370 6172 6b2e 6372 6561 7465 4461  = spark.createDa
+00002930: 7461 4672 616d 6528 696e 6372 656d 656e  taFrame(incremen
+00002940: 745f 6461 7461 2c20 2270 6b3a 696e 742c  t_data, "pk:int,
+00002950: 6368 616e 6765 5f74 733a 7469 6d65 7374  change_ts:timest
+00002960: 616d 702c 6174 7472 3a73 7472 696e 6722  amp,attr:string"
+00002970: 290a 6466 2e73 686f 7728 7472 756e 6361  ).df.show(trunca
+00002980: 7465 3d54 7275 6529 0a0a 3e3e 202b 2d2d  te=True)..>> +--
+00002990: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
+000029a0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e  -----+------+.>>
+000029b0: 207c 2070 6b7c 2020 2020 2020 2020 2020   | pk|          
+000029c0: 6368 616e 6765 5f74 737c 2020 6174 7472  change_ts|  attr
+000029d0: 7c0a 3e3e 202b 2d2d 2d2b 2d2d 2d2d 2d2d  |.>> +---+------
+000029e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+000029f0: 2d2d 2d2d 2b0a 3e3e 207c 2020 317c 3230  ----+.>> |  1|20
+00002a00: 3030 2d30 312d 3031 2030 303a 3030 3a30  00-01-01 00:00:0
+00002a10: 307c 2020 3130 3031 7c0a 3e3e 207c 2020  0|  1001|.>> |  
+00002a20: 317c 3230 3030 2d30 312d 3031 2030 323a  1|2000-01-01 02:
+00002a30: 3030 3a30 307c 2020 3130 3032 7c0a 3e3e  00:00|  1002|.>>
+00002a40: 207c 2020 327c 3230 3030 2d30 312d 3031   |  2|2000-01-01
+00002a50: 2030 303a 3030 3a30 307c 2020 3230 3031   00:00:00|  2001
+00002a60: 7c0a 3e3e 207c 2020 327c 3230 3030 2d30  |.>> |  2|2000-0
+00002a70: 312d 3031 2030 303a 3030 3a30 307c 2020  1-01 00:00:00|  
+00002a80: 3230 3031 7c0a 3e3e 207c 2020 337c 3230  2001|.>> |  3|20
+00002a90: 3030 2d30 312d 3031 2030 303a 3030 3a30  00-01-01 00:00:0
+00002aa0: 307c 2020 3330 3031 7c0a 3e3e 207c 2020  0|  3001|.>> |  
+00002ab0: 337c 3230 3030 2d30 312d 3031 2030 323a  3|2000-01-01 02:
+00002ac0: 3030 3a30 307c 3330 3032 2331 7c0a 3e3e  00:00|3002#1|.>>
+00002ad0: 207c 2020 337c 3230 3030 2d30 312d 3031   |  3|2000-01-01
+00002ae0: 2030 323a 3030 3a30 307c 3330 3032 2332   02:00:00|3002#2
+00002af0: 7c0a 3e3e 202b 2d2d 2d2b 2d2d 2d2d 2d2d  |.>> +---+------
+00002b00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00002b10: 2d2d 2d2d 2b0a 0a70 7269 6d61 7279 5f6b  ----+..primary_k
+00002b20: 6579 5f63 6f6c 756d 6e73 203d 205b 2770  ey_columns = ['p
+00002b30: 6b27 5d0a 6f72 6465 725f 6279 5f63 6f6c  k'].order_by_col
+00002b40: 756d 6e73 203d 205b 2763 6861 6e67 655f  umns = ['change_
+00002b50: 7473 275d 0a0a 2320 7769 6c6c 2072 616e  ts']..# will ran
+00002b60: 646f 6d6c 7920 6368 6f73 6520 6f6e 6520  domly chose one 
+00002b70: 706b 2069 6e20 6361 7365 206f 6620 636f  pk in case of co
+00002b80: 6e66 6c69 6374 2c20 7769 7468 6f75 7420  nflict, without 
+00002b90: 616e 7920 6e6f 7469 6669 6361 7469 6f6e  any notification
+00002ba0: 2061 626f 7574 2063 6f6e 666c 6963 7473   about conflicts
+00002bb0: 0a73 696d 706c 655f 6765 745f 6c61 7465  .simple_get_late
+00002bc0: 7374 5f64 6620 3d20 6765 745f 6c61 7465  st_df = get_late
+00002bd0: 7374 5f72 6563 6f72 6473 2864 662c 2070  st_records(df, p
+00002be0: 7269 6d61 7279 5f6b 6579 5f63 6f6c 756d  rimary_key_colum
+00002bf0: 6e73 2c20 6f72 6465 725f 6279 5f63 6f6c  ns, order_by_col
+00002c00: 756d 6e73 290a 7369 6d70 6c65 5f67 6574  umns).simple_get
+00002c10: 5f6c 6174 6573 745f 6466 2e73 686f 7728  _latest_df.show(
+00002c20: 7472 756e 6361 7465 3d54 7275 6529 0a0a  truncate=True)..
+00002c30: 3e3e 202b 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  >> +---+--------
+00002c40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00002c50: 2d2d 2b0a 3e3e 207c 2070 6b7c 2020 2020  --+.>> | pk|    
+00002c60: 2020 2020 2020 6368 616e 6765 5f74 737c        change_ts|
+00002c70: 2020 6174 7472 7c0a 3e3e 202b 2d2d 2d2b    attr|.>> +---+
+00002c80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002c90: 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e 207c  ---+------+.>> |
+00002ca0: 2020 317c 3230 3030 2d30 312d 3031 2030    1|2000-01-01 0
+00002cb0: 323a 3030 3a30 307c 2020 3130 3032 7c0a  2:00:00|  1002|.
+00002cc0: 3e3e 207c 2020 327c 3230 3030 2d30 312d  >> |  2|2000-01-
+00002cd0: 3031 2030 303a 3030 3a30 307c 2020 3230  01 00:00:00|  20
+00002ce0: 3031 7c0a 3e3e 207c 2020 337c 3230 3030  01|.>> |  3|2000
+00002cf0: 2d30 312d 3031 2030 323a 3030 3a30 307c  -01-01 02:00:00|
+00002d00: 3330 3032 2331 7c0a 3e3e 202b 2d2d 2d2b  3002#1|.>> +---+
+00002d10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002d20: 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 0a23 2077  ---+------+..# w
+00002d30: 696c 6c20 666c 6167 2072 6563 6f72 6473  ill flag records
+00002d40: 2077 6869 6368 2063 6175 7365 2063 6f6e   which cause con
+00002d50: 666c 6963 7473 2061 6e64 2063 616e 6e6f  flicts and canno
+00002d60: 7420 6265 2072 6573 6f6c 7665 640a 2320  t be resolved.# 
+00002d70: 6261 6420 7265 636f 7264 7320 6e65 6564  bad records need
+00002d80: 2074 6f20 6265 2071 7561 7261 6e74 696e   to be quarantin
+00002d90: 6564 2061 6e64 2068 616e 646c 6564 2069  ed and handled i
+00002da0: 6e20 7370 6563 6961 6c20 7072 6f63 6573  n special proces
+00002db0: 730a 636f 6e66 6c69 6374 5f67 6574 5f6c  s.conflict_get_l
+00002dc0: 6174 6573 745f 6466 203d 2067 6574 5f6c  atest_df = get_l
+00002dd0: 6174 6573 745f 7265 636f 7264 735f 7769  atest_records_wi
+00002de0: 7468 5f70 6b5f 636f 6e66 6963 745f 6465  th_pk_confict_de
+00002df0: 7465 6374 696f 6e5f 666c 6167 2864 662c  tection_flag(df,
+00002e00: 2070 7269 6d61 7279 5f6b 6579 5f63 6f6c   primary_key_col
+00002e10: 756d 6e73 2c20 6f72 6465 725f 6279 5f63  umns, order_by_c
+00002e20: 6f6c 756d 6e73 290a 636f 6e66 6c69 6374  olumns).conflict
+00002e30: 5f67 6574 5f6c 6174 6573 745f 6466 2e73  _get_latest_df.s
+00002e40: 686f 7728 7472 756e 6361 7465 3d54 7275  how(truncate=Tru
+00002e50: 6529 0a0a 3e3e 202b 2d2d 2d2b 2d2d 2d2d  e)..>> +---+----
+00002e60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00002e70: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  ------+---------
+00002e80: 2d2d 2d2d 2d2d 2d2d 2b0a 3e3e 207c 2070  --------+.>> | p
+00002e90: 6b7c 2020 2020 2020 2020 2020 6368 616e  k|          chan
+00002ea0: 6765 5f74 737c 2020 6174 7472 7c5f 5f68  ge_ts|  attr|__h
+00002eb0: 6173 5f70 6b5f 636f 6e66 6c69 6374 7c0a  as_pk_conflict|.
+00002ec0: 3e3e 202b 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  >> +---+--------
+00002ed0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00002ee0: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
+00002ef0: 2d2d 2d2d 2b0a 3e3e 207c 2020 317c 3230  ----+.>> |  1|20
+00002f00: 3030 2d30 312d 3031 2030 323a 3030 3a30  00-01-01 02:00:0
+00002f10: 307c 2020 3130 3032 7c20 2020 2020 2020  0|  1002|       
+00002f20: 2020 2020 2066 616c 7365 7c0a 3e3e 207c       false|.>> |
+00002f30: 2020 327c 3230 3030 2d30 312d 3031 2030    2|2000-01-01 0
+00002f40: 303a 3030 3a30 307c 2020 3230 3031 7c20  0:00:00|  2001| 
+00002f50: 2020 2020 2020 2020 2020 2066 616c 7365             false
+00002f60: 7c0a 3e3e 207c 2020 337c 3230 3030 2d30  |.>> |  3|2000-0
+00002f70: 312d 3031 2030 323a 3030 3a30 307c 3330  1-01 02:00:00|30
+00002f80: 3032 2332 7c20 2020 2020 2020 2020 2020  02#2|           
+00002f90: 2020 7472 7565 7c0a 3e3e 207c 2020 337c    true|.>> |  3|
+00002fa0: 3230 3030 2d30 312d 3031 2030 323a 3030  2000-01-01 02:00
+00002fb0: 3a30 307c 3330 3032 2331 7c20 2020 2020  :00|3002#1|     
+00002fc0: 2020 2020 2020 2020 7472 7565 7c0a 3e3e          true|.>>
+00002fd0: 202b 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d   +---+----------
+00002fe0: 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  ---------+------
+00002ff0: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---------------
+00003000: 2d2d 2b0a 0a60 6060 0a0a 2323 2320 4669  --+..```..### Fi
+00003010: 6e64 2063 6f6d 706f 7369 7465 2070 7269  nd composite pri
+00003020: 6d61 7279 206b 6579 2063 616e 6469 6461  mary key candida
+00003030: 7465 730a 0a47 6976 656e 206c 6973 7420  tes..Given list 
+00003040: 6f66 2070 6f73 7369 626c 6520 636f 6c75  of possible colu
+00003050: 6d6e 732c 2063 6f6e 7374 7275 6374 7320  mns, constructs 
+00003060: 7468 6520 6c69 7374 7320 6f66 2061 6c6c  the lists of all
+00003070: 2070 6f73 7369 626c 6520 636f 6d62 696e   possible combin
+00003080: 6174 696f 6e73 206f 6620 636f 6d70 6f73  ations of compos
+00003090: 6974 6520 7072 696d 6172 7920 6b65 7973  ite primary keys
+000030a0: 2c20 616e 6420 6578 6563 7574 6573 2063  , and executes c
+000030b0: 6f6e 6375 7272 656e 746c 7920 746f 2064  oncurrently to d
+000030c0: 6574 6572 6d69 6e65 2069 6620 6769 7665  etermine if give
+000030d0: 6e20 7365 7420 6f66 2063 6f6c 756d 6e73  n set of columns
+000030e0: 2069 7320 6120 7661 6c69 6420 7072 696d   is a valid prim
+000030f0: 6172 7920 6b65 792e 2055 7365 7320 6d69  ary key. Uses mi
+00003100: 6e69 6d75 6d20 706f 7373 6962 6c65 2061  nimum possible a
+00003110: 6d6f 756e 7420 6f66 2071 7565 7269 6573  mount of queries
+00003120: 2061 6761 696e 7374 2073 7061 726b 2062   against spark b
+00003130: 7920 736b 6970 7069 6e67 2076 616c 6964  y skipping valid
+00003140: 6174 696f 6e20 7061 7468 7320 7468 6174  ation paths that
+00003150: 2061 7265 2062 6173 6564 206f 6e20 616c   are based on al
+00003160: 7265 6164 7920 7661 6c69 6461 7465 6420  ready validated 
+00003170: 7072 696d 6172 7920 6b65 7920 636f 6d62  primary key comb
+00003180: 696e 6174 696f 6e73 2e0a 0a60 6060 7079  inations...```py
+00003190: 7468 6f6e 0a69 6d70 6f72 7420 6264 710a  thon.import bdq.
+000031a0: 696d 706f 7274 2070 7973 7061 726b 2e73  import pyspark.s
+000031b0: 716c 2e66 756e 6374 696f 6e73 2061 7320  ql.functions as 
+000031c0: 460a 0a64 6620 3d20 7370 6172 6b2e 7261  F..df = spark.ra
+000031d0: 6e67 6528 302c 2031 3030 2920 5c0a 2020  nge(0, 100) \.  
+000031e0: 2e77 6974 6843 6f6c 756d 6e28 2774 7970  .withColumn('typ
+000031f0: 6527 2c20 462e 6578 7072 2827 2869 6420  e', F.expr('(id 
+00003200: 2f20 3130 293a 3a69 6e74 202b 2031 2729  / 10)::int + 1')
+00003210: 2920 5c0a 2020 2e77 6974 6843 6f6c 756d  ) \.  .withColum
+00003220: 6e28 2772 656d 696e 6465 7227 2c20 462e  n('reminder', F.
+00003230: 6578 7072 2827 6964 2025 2031 3027 2929  expr('id % 10'))
+00003240: 205c 0a20 202e 7769 7468 436f 6c75 6d6e   \.  .withColumn
+00003250: 2827 7374 6174 6963 272c 2046 2e6c 6974  ('static', F.lit
+00003260: 2827 4127 2929 205c 0a20 202e 7769 7468  ('A')) \.  .with
+00003270: 436f 6c75 6d6e 2827 726f 756e 645f 726f  Column('round_ro
+00003280: 6269 6e27 2c20 462e 6578 7072 2827 6964  bin', F.expr('id
+00003290: 2025 2032 2729 290a 0a64 6973 706c 6179   % 2'))..display
+000032a0: 2864 6629 0a0a 616c 6c5f 636f 6d62 696e  (df)..all_combin
+000032b0: 6174 696f 6e73 203d 206c 6973 7428 6264  ations = list(bd
+000032c0: 712e 6765 745f 636f 6c75 6d6e 5f6e 616d  q.get_column_nam
+000032d0: 6573 5f63 6f6d 6269 6e61 7469 6f6e 7328  es_combinations(
+000032e0: 6466 2e63 6f6c 756d 6e73 2929 0a0a 6264  df.columns))..bd
+000032f0: 712e 7661 6c69 6461 7465 5f70 7269 6d61  q.validate_prima
+00003300: 7279 5f6b 6579 5f63 616e 6469 6461 7465  ry_key_candidate
+00003310: 5f63 6f6d 6269 6e61 7469 6f6e 7328 6466  _combinations(df
+00003320: 2c20 616c 6c5f 636f 6d62 696e 6174 696f  , all_combinatio
+00003330: 6e73 2c20 6d61 785f 776f 726b 6572 733d  ns, max_workers=
+00003340: 3130 2c20 7665 7262 6f73 653d 5472 7565  10, verbose=True
+00003350: 290a 3e3e 205b 2827 6964 272c 292c 2028  ).>> [('id',), (
+00003360: 2774 7970 6527 2c20 2772 656d 696e 6465  'type', 'reminde
+00003370: 7227 295d 0a60 6060 0a0a 2323 2320 4578  r')].```..### Ex
+00003380: 6563 7574 6520 4441 4720 6861 7669 6e67  ecute DAG having
+00003390: 206e 6f64 6573 2061 7320 7079 7468 6f6e   nodes as python
+000033a0: 2066 756e 6374 696f 6e73 0a0a 6060 6070   functions..```p
+000033b0: 7974 686f 6e0a 696d 706f 7274 2062 6471  ython.import bdq
+000033c0: 0a69 6d70 6f72 7420 7469 6d65 0a69 6d70  .import time.imp
+000033d0: 6f72 7420 7079 7465 7374 0a0a 2363 7265  ort pytest..#cre
+000033e0: 6174 6520 6772 6170 680a 6772 6170 6820  ate graph.graph 
+000033f0: 3d20 6264 712e 4441 4728 290a 0a23 6465  = bdq.DAG()..#de
+00003400: 6669 6e65 206e 6f64 6573 0a40 6772 6170  fine nodes.@grap
+00003410: 682e 6e6f 6465 2829 0a64 6566 2061 2829  h.node().def a()
+00003420: 3a0a 2020 7469 6d65 2e73 6c65 6570 2832  :.  time.sleep(2
+00003430: 290a 2020 7265 7475 726e 2035 0a0a 4067  ).  return 5..@g
+00003440: 7261 7068 2e6e 6f64 6528 290a 6465 6620  raph.node().def 
+00003450: 6228 293a 0a20 2074 696d 652e 736c 6565  b():.  time.slee
+00003460: 7028 3329 0a20 2072 6574 7572 6e20 2262  p(3).  return "b
+00003470: 6565 6570 220a 0a23 6e6f 6465 7320 6361  eeep"..#nodes ca
+00003480: 6e20 6465 7065 6e64 206f 6e20 6f74 6865  n depend on othe
+00003490: 7220 6e6f 6465 730a 4067 7261 7068 2e6e  r nodes.@graph.n
+000034a0: 6f64 6528 6465 7065 6e64 735f 6f6e 3d5b  ode(depends_on=[
+000034b0: 625d 290a 6465 6620 6328 293a 0a20 2074  b]).def c():.  t
+000034c0: 696d 652e 736c 6565 7028 3529 0a20 2072  ime.sleep(5).  r
+000034d0: 6574 7572 6e20 380a 0a23 616e 7920 616d  eturn 8..#any am
+000034e0: 6f75 6e74 206f 6620 6465 7065 6e64 656e  ount of dependen
+000034f0: 6369 6573 2069 7320 616c 6c6f 7765 640a  cies is allowed.
+00003500: 4067 7261 7068 2e6e 6f64 6528 6465 7065  @graph.node(depe
+00003510: 6e64 735f 6f6e 3d5b 622c 2063 2c20 615d  nds_on=[b, c, a]
+00003520: 290a 6465 6620 6428 293a 0a20 2074 696d  ).def d():.  tim
+00003530: 652e 736c 6565 7028 3729 0a20 2023 6265  e.sleep(7).  #be
+00003540: 6570 2061 7320 6d61 6e79 2074 696d 6573  ep as many times
+00003550: 2061 7320 6162 736f 6c75 7465 2064 6966   as absolute dif
+00003560: 6665 7265 6e63 6520 6265 7477 6565 6e20  ference between 
+00003570: 2763 2720 616e 6420 2761 270a 2020 7265  'c' and 'a'.  re
+00003580: 7475 726e 2022 6720 6d61 6e20 7361 793a  turn "g man say:
+00003590: 2022 202b 2062 2e72 6573 756c 7420 2a20   " + b.result * 
+000035a0: 6162 7328 632e 7265 7375 6c74 202d 2061  abs(c.result - a
+000035b0: 2e72 6573 756c 7429 0a0a 4067 7261 7068  .result)..@graph
+000035c0: 2e6e 6f64 6528 6465 7065 6e64 735f 6f6e  .node(depends_on
+000035d0: 3d5b 615d 290a 6465 6620 6528 293a 0a20  =[a]).def e():. 
+000035e0: 2074 696d 652e 736c 6565 7028 3329 0a20   time.sleep(3). 
+000035f0: 2023 796f 7520 6361 6e20 7265 6665 7220   #you can refer 
+00003600: 746f 2070 6172 656e 7420 6e6f 6465 732c  to parent nodes,
+00003610: 2074 6f20 6765 7420 696e 666f 726d 6174   to get informat
+00003620: 696f 6e20 6162 6f75 7420 7468 6569 7220  ion about their 
+00003630: 7265 7375 6c74 730a 2020 7261 6973 6520  results.  raise 
+00003640: 5661 6c75 6545 7272 6f72 2866 226f 6d67  ValueError(f"omg
+00003650: 2c20 6372 6173 6821 207b 612e 7265 7375  , crash! {a.resu
+00003660: 6c74 7d22 290a 0a40 6772 6170 682e 6e6f  lt}")..@graph.no
+00003670: 6465 2864 6570 656e 6473 5f6f 6e3d 5b65  de(depends_on=[e
+00003680: 5d29 0a64 6566 2066 2829 3a0a 2020 7072  ]).def f():.  pr
+00003690: 696e 7428 2274 6869 7320 7769 6c6c 206e  int("this will n
+000036a0: 6576 6572 2065 7865 6375 7465 2229 0a20  ever execute"). 
+000036b0: 2072 6574 7572 6e20 2274 6869 7320 7769   return "this wi
+000036c0: 6c6c 206e 6576 6572 2065 7865 6375 7465  ll never execute
+000036d0: 220a 0a40 6772 6170 682e 6e6f 6465 2864  "..@graph.node(d
+000036e0: 6570 656e 6473 5f6f 6e3d 5b61 5d29 0a64  epends_on=[a]).d
+000036f0: 6566 2067 2829 3a0a 2020 7469 6d65 2e73  ef g():.  time.s
+00003700: 6c65 6570 2833 290a 2020 2377 6520 646f  leep(3).  #we do
+00003710: 206e 6f74 2077 616e 7420 746f 2065 7865   not want to exe
+00003720: 6375 7465 2063 6869 6c64 7265 6e20 6e6f  cute children no
+00003730: 6465 7320 616e 796d 6f72 650a 2020 2372  des anymore.  #r
+00003740: 6574 7572 6e20 6772 6170 682e 4252 4541  eturn graph.BREA
+00003750: 4b20 7468 6973 2077 696c 6c20 6361 7573  K this will caus
+00003760: 6520 7468 6174 2061 6c6c 2063 6869 6c64  e that all child
+00003770: 7265 6e2f 7375 6363 6573 736f 7273 2069  ren/successors i
+00003780: 6e20 6772 6170 6820 7769 6c6c 2062 6520  n graph will be 
+00003790: 736b 6970 7065 6420 7769 7468 6f75 7420  skipped without 
+000037a0: 6572 7272 6f72 0a20 2072 6574 7572 6e20  errror.  return 
+000037b0: 6772 6170 682e 4252 4541 4b0a 0a40 6772  graph.BREAK..@gr
+000037c0: 6170 682e 6e6f 6465 2864 6570 656e 6473  aph.node(depends
+000037d0: 5f6f 6e3d 5b67 5d29 0a64 6566 2069 2829  _on=[g]).def i()
+000037e0: 3a0a 2020 7072 696e 7428 2274 6869 7320  :.  print("this 
+000037f0: 7769 6c6c 206e 6576 6572 2065 7865 6375  will never execu
+00003800: 7465 2074 6f6f 2229 0a20 2072 6574 7572  te too").  retur
+00003810: 6e20 2274 6869 7320 7769 6c6c 206e 6576  n "this will nev
+00003820: 6572 2065 7865 6375 7465 2074 6f6f 220a  er execute too".
+00003830: 0a23 2069 6620 796f 7520 6861 7665 2069  .# if you have i
+00003840: 7079 6461 6772 6564 3320 696e 7374 616c  pydagred3 instal
+00003850: 6c65 642c 2079 6f75 2063 616e 2073 6565  led, you can see
+00003860: 2069 6e20 7265 616c 2074 696d 6520 7374   in real time st
+00003870: 6174 6520 6368 616e 6765 7320 6f66 2065  ate changes of e
+00003880: 6163 6820 6f66 2074 6865 206e 6f64 6573  ach of the nodes
+00003890: 0a64 6973 706c 6179 2867 7261 7068 2e76  .display(graph.v
+000038a0: 6973 7561 6c69 7a65 2829 290a 0a23 6578  isualize())..#ex
+000038b0: 6563 7574 6520 4441 470a 6772 6170 682e  ecute DAG.graph.
+000038c0: 6578 6563 7574 6528 6d61 785f 776f 726b  execute(max_work
+000038d0: 6572 733d 3130 290a 0a23 6974 6572 6174  ers=10)..#iterat
+000038e0: 6520 6f76 6572 2072 6573 756c 7473 0a70  e over results.p
+000038f0: 7269 6e74 2822 4974 6572 6174 6520 6f76  rint("Iterate ov
+00003900: 6572 2072 6573 756c 7473 2e2e 2e22 290a  er results...").
+00003910: 666f 7220 6e6f 6465 2069 6e20 6772 6170  for node in grap
+00003920: 682e 6e6f 6465 733a 0a20 2070 7269 6e74  h.nodes:.  print
+00003930: 286e 6f64 6529 0a0a 3e3e 2057 6169 7469  (node)..>> Waiti
+00003940: 6e67 2066 6f72 2061 6c6c 2074 6173 6b73  ng for all tasks
+00003950: 2074 6f20 6669 6e69 7368 2e2e 2e0a 3e3e   to finish....>>
+00003960: 2020 2073 7461 7274 696e 673a 204e 6f64     starting: Nod
+00003970: 6528 3c66 756e 6374 696f 6e20 6120 6174  e(<function a at
+00003980: 2030 7837 6635 3066 3462 3965 6535 303e   0x7f50f4b9ee50>
+00003990: 3a20 7b27 7374 6174 6527 3a20 2752 554e  : {'state': 'RUN
+000039a0: 4e49 4e47 272c 2027 7265 7375 6c74 273a  NING', 'result':
+000039b0: 204e 6f6e 652c 2027 6578 6365 7074 696f   None, 'exceptio
+000039c0: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
+000039d0: 6574 6564 273a 2046 616c 7365 7d20 290a  eted': False} ).
+000039e0: 3e3e 2020 2073 7461 7274 696e 673a 204e  >>   starting: N
+000039f0: 6f64 6528 3c66 756e 6374 696f 6e20 6220  ode(<function b 
+00003a00: 6174 2030 7837 6635 3066 3462 3533 3034  at 0x7f50f4b5304
+00003a10: 303e 3a20 7b27 7374 6174 6527 3a20 2752  0>: {'state': 'R
+00003a20: 554e 4e49 4e47 272c 2027 7265 7375 6c74  UNNING', 'result
+00003a30: 273a 204e 6f6e 652c 2027 6578 6365 7074  ': None, 'except
+00003a40: 696f 6e27 3a20 4e6f 6e65 2c20 2763 6f6d  ion': None, 'com
+00003a50: 706c 6574 6564 273a 2046 616c 7365 7d20  pleted': False} 
+00003a60: 290a 3e3e 2020 2073 7461 7274 696e 673a  ).>>   starting:
+00003a70: 204e 6f64 6528 3c66 756e 6374 696f 6e20   Node(<function 
+00003a80: 6520 6174 2030 7837 6635 3066 3462 3533  e at 0x7f50f4b53
+00003a90: 6238 303e 3a20 7b27 7374 6174 6527 3a20  b80>: {'state': 
+00003aa0: 2752 554e 4e49 4e47 272c 2027 7265 7375  'RUNNING', 'resu
+00003ab0: 6c74 273a 204e 6f6e 652c 2027 6578 6365  lt': None, 'exce
+00003ac0: 7074 696f 6e27 3a20 4e6f 6e65 2c20 2763  ption': None, 'c
+00003ad0: 6f6d 706c 6574 6564 273a 2046 616c 7365  ompleted': False
+00003ae0: 7d20 290a 3e3e 2020 2073 7461 7274 696e  } ).>>   startin
+00003af0: 673a 204e 6f64 6528 3c66 756e 6374 696f  g: Node(<functio
+00003b00: 6e20 6720 6174 2030 7837 6635 3066 3462  n g at 0x7f50f4b
+00003b10: 3533 3565 303e 3a20 7b27 7374 6174 6527  535e0>: {'state'
+00003b20: 3a20 2752 554e 4e49 4e47 272c 2027 7265  : 'RUNNING', 're
+00003b30: 7375 6c74 273a 204e 6f6e 652c 2027 6578  sult': None, 'ex
+00003b40: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
+00003b50: 2763 6f6d 706c 6574 6564 273a 2046 616c  'completed': Fal
+00003b60: 7365 7d20 290a 3e3e 2020 2066 696e 6973  se} ).>>   finis
+00003b70: 6865 643a 204e 6f64 6528 3c66 756e 6374  hed: Node(<funct
+00003b80: 696f 6e20 6120 6174 2030 7837 6635 3066  ion a at 0x7f50f
+00003b90: 3462 3965 6535 303e 3a20 7b27 7374 6174  4b9ee50>: {'stat
+00003ba0: 6527 3a20 2753 5543 4345 5353 272c 2027  e': 'SUCCESS', '
+00003bb0: 7265 7375 6c74 273a 2035 2c20 2765 7863  result': 5, 'exc
+00003bc0: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
+00003bd0: 636f 6d70 6c65 7465 6427 3a20 5472 7565  completed': True
+00003be0: 7d20 2920 2873 7469 6c6c 2072 756e 6e69  } ) (still runni
+00003bf0: 6e67 3a20 3329 0a3e 3e20 2020 7374 6172  ng: 3).>>   star
+00003c00: 7469 6e67 3a20 4e6f 6465 283c 6675 6e63  ting: Node(<func
+00003c10: 7469 6f6e 2063 2061 7420 3078 3766 3530  tion c at 0x7f50
+00003c20: 6634 6235 3334 6330 3e3a 207b 2773 7461  f4b534c0>: {'sta
+00003c30: 7465 273a 2027 5255 4e4e 494e 4727 2c20  te': 'RUNNING', 
+00003c40: 2772 6573 756c 7427 3a20 4e6f 6e65 2c20  'result': None, 
+00003c50: 2765 7863 6570 7469 6f6e 273a 204e 6f6e  'exception': Non
+00003c60: 652c 2027 636f 6d70 6c65 7465 6427 3a20  e, 'completed': 
+00003c70: 4661 6c73 657d 2029 0a3e 3e20 2020 6669  False} ).>>   fi
+00003c80: 6e69 7368 6564 3a20 4e6f 6465 283c 6675  nished: Node(<fu
+00003c90: 6e63 7469 6f6e 2062 2061 7420 3078 3766  nction b at 0x7f
+00003ca0: 3530 6634 6235 3330 3430 3e3a 207b 2773  50f4b53040>: {'s
+00003cb0: 7461 7465 273a 2027 5355 4343 4553 5327  tate': 'SUCCESS'
+00003cc0: 2c20 2772 6573 756c 7427 3a20 2762 6565  , 'result': 'bee
+00003cd0: 6570 272c 2027 6578 6365 7074 696f 6e27  ep', 'exception'
+00003ce0: 3a20 4e6f 6e65 2c20 2763 6f6d 706c 6574  : None, 'complet
+00003cf0: 6564 273a 2054 7275 657d 2029 2028 7374  ed': True} ) (st
+00003d00: 696c 6c20 7275 6e6e 696e 673a 2033 290a  ill running: 3).
+00003d10: 3e3e 2020 2065 7272 6f72 3a20 4e6f 6465  >>   error: Node
+00003d20: 283c 6675 6e63 7469 6f6e 2065 2061 7420  (<function e at 
+00003d30: 3078 3766 3530 6634 6235 3362 3830 3e3a  0x7f50f4b53b80>:
+00003d40: 207b 2773 7461 7465 273a 2027 4552 524f   {'state': 'ERRO
+00003d50: 5227 2c20 2772 6573 756c 7427 3a20 4e6f  R', 'result': No
+00003d60: 6e65 2c20 2765 7863 6570 7469 6f6e 273a  ne, 'exception':
+00003d70: 2056 616c 7565 4572 726f 7228 276f 6d67   ValueError('omg
+00003d80: 2c20 6372 6173 6821 2035 2729 2c20 2763  , crash! 5'), 'c
+00003d90: 6f6d 706c 6574 6564 273a 2054 7275 657d  ompleted': True}
+00003da0: 2029 3a20 6f6d 672c 2063 7261 7368 2120   ): omg, crash! 
+00003db0: 3520 2873 7469 6c6c 2072 756e 6e69 6e67  5 (still running
+00003dc0: 3a20 3229 0a3e 3e20 2020 6669 6e69 7368  : 2).>>   finish
+00003dd0: 6564 3a20 4e6f 6465 283c 6675 6e63 7469  ed: Node(<functi
+00003de0: 6f6e 2067 2061 7420 3078 3766 3530 6634  on g at 0x7f50f4
+00003df0: 6235 3335 6530 3e3a 207b 2773 7461 7465  b535e0>: {'state
+00003e00: 273a 2027 534b 4950 5045 4427 2c20 2772  ': 'SKIPPED', 'r
+00003e10: 6573 756c 7427 3a20 3c74 6872 6561 6469  esult': <threadi
+00003e20: 6e67 2e45 7665 6e74 206f 626a 6563 7420  ng.Event object 
+00003e30: 6174 2030 7837 6635 3065 6331 3663 3964  at 0x7f50ec16c9d
+00003e40: 303e 2c20 2765 7863 6570 7469 6f6e 273a  0>, 'exception':
+00003e50: 204e 6f6e 652c 2027 636f 6d70 6c65 7465   None, 'complete
+00003e60: 6427 3a20 5472 7565 7d20 2920 2873 7469  d': True} ) (sti
+00003e70: 6c6c 2072 756e 6e69 6e67 3a20 3129 0a3e  ll running: 1).>
+00003e80: 3e20 2020 7374 6172 7469 6e67 3a20 4e6f  >   starting: No
+00003e90: 6465 283c 6675 6e63 7469 6f6e 2064 2061  de(<function d a
+00003ea0: 7420 3078 3766 3530 6634 6235 3361 3630  t 0x7f50f4b53a60
+00003eb0: 3e3a 207b 2773 7461 7465 273a 2027 5255  >: {'state': 'RU
+00003ec0: 4e4e 494e 4727 2c20 2772 6573 756c 7427  NNING', 'result'
+00003ed0: 3a20 4e6f 6e65 2c20 2765 7863 6570 7469  : None, 'excepti
+00003ee0: 6f6e 273a 204e 6f6e 652c 2027 636f 6d70  on': None, 'comp
+00003ef0: 6c65 7465 6427 3a20 4661 6c73 657d 2029  leted': False} )
+00003f00: 0a3e 3e20 2020 6669 6e69 7368 6564 3a20  .>>   finished: 
+00003f10: 4e6f 6465 283c 6675 6e63 7469 6f6e 2063  Node(<function c
+00003f20: 2061 7420 3078 3766 3530 6634 6235 3334   at 0x7f50f4b534
+00003f30: 6330 3e3a 207b 2773 7461 7465 273a 2027  c0>: {'state': '
+00003f40: 5355 4343 4553 5327 2c20 2772 6573 756c  SUCCESS', 'resul
+00003f50: 7427 3a20 382c 2027 6578 6365 7074 696f  t': 8, 'exceptio
+00003f60: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
+00003f70: 6574 6564 273a 2054 7275 657d 2029 2028  eted': True} ) (
+00003f80: 7374 696c 6c20 7275 6e6e 696e 673a 2031  still running: 1
+00003f90: 290a 3e3e 2020 2066 696e 6973 6865 643a  ).>>   finished:
+00003fa0: 204e 6f64 6528 3c66 756e 6374 696f 6e20   Node(<function 
+00003fb0: 6420 6174 2030 7837 6635 3066 3462 3533  d at 0x7f50f4b53
+00003fc0: 6136 303e 3a20 7b27 7374 6174 6527 3a20  a60>: {'state': 
+00003fd0: 2753 5543 4345 5353 272c 2027 7265 7375  'SUCCESS', 'resu
+00003fe0: 6c74 273a 2027 6720 6d61 6e20 7361 793a  lt': 'g man say:
+00003ff0: 2062 6565 6570 6265 6565 7062 6565 6570   beeepbeeepbeeep
+00004000: 272c 2027 6578 6365 7074 696f 6e27 3a20  ', 'exception': 
+00004010: 4e6f 6e65 2c20 2763 6f6d 706c 6574 6564  None, 'completed
+00004020: 273a 2054 7275 657d 2029 2028 7374 696c  ': True} ) (stil
+00004030: 6c20 7275 6e6e 696e 673a 2030 290a 3e3e  l running: 0).>>
+00004040: 2041 6c6c 2074 6173 6b73 2066 696e 6973   All tasks finis
+00004050: 6865 642c 2073 6875 7474 696e 6720 646f  hed, shutting do
+00004060: 776e 0a3e 3e0a 3e3e 2049 7465 7261 7465  wn.>>.>> Iterate
+00004070: 206f 7665 7220 7265 7375 6c74 732e 2e2e   over results...
+00004080: 0a3e 3e20 4e6f 6465 283c 6675 6e63 7469  .>> Node(<functi
+00004090: 6f6e 2061 2061 7420 3078 3766 3530 6634  on a at 0x7f50f4
+000040a0: 6239 6565 3530 3e3a 207b 2773 7461 7465  b9ee50>: {'state
+000040b0: 273a 2027 5355 4343 4553 5327 2c20 2772  ': 'SUCCESS', 'r
+000040c0: 6573 756c 7427 3a20 352c 2027 6578 6365  esult': 5, 'exce
+000040d0: 7074 696f 6e27 3a20 4e6f 6e65 2c20 2763  ption': None, 'c
+000040e0: 6f6d 706c 6574 6564 273a 2054 7275 657d  ompleted': True}
+000040f0: 2029 0a3e 3e20 4e6f 6465 283c 6675 6e63   ).>> Node(<func
+00004100: 7469 6f6e 2062 2061 7420 3078 3766 3530  tion b at 0x7f50
+00004110: 6634 6235 3330 3430 3e3a 207b 2773 7461  f4b53040>: {'sta
+00004120: 7465 273a 2027 5355 4343 4553 5327 2c20  te': 'SUCCESS', 
+00004130: 2772 6573 756c 7427 3a20 2762 6565 6570  'result': 'beeep
+00004140: 272c 2027 6578 6365 7074 696f 6e27 3a20  ', 'exception': 
+00004150: 4e6f 6e65 2c20 2763 6f6d 706c 6574 6564  None, 'completed
+00004160: 273a 2054 7275 657d 2029 0a3e 3e20 4e6f  ': True} ).>> No
+00004170: 6465 283c 6675 6e63 7469 6f6e 2063 2061  de(<function c a
+00004180: 7420 3078 3766 3530 6634 6235 3334 6330  t 0x7f50f4b534c0
+00004190: 3e3a 207b 2773 7461 7465 273a 2027 5355  >: {'state': 'SU
+000041a0: 4343 4553 5327 2c20 2772 6573 756c 7427  CCESS', 'result'
+000041b0: 3a20 382c 2027 6578 6365 7074 696f 6e27  : 8, 'exception'
+000041c0: 3a20 4e6f 6e65 2c20 2763 6f6d 706c 6574  : None, 'complet
+000041d0: 6564 273a 2054 7275 657d 2029 0a3e 3e20  ed': True} ).>> 
+000041e0: 4e6f 6465 283c 6675 6e63 7469 6f6e 2064  Node(<function d
+000041f0: 2061 7420 3078 3766 3530 6634 6235 3361   at 0x7f50f4b53a
+00004200: 3630 3e3a 207b 2773 7461 7465 273a 2027  60>: {'state': '
+00004210: 5355 4343 4553 5327 2c20 2772 6573 756c  SUCCESS', 'resul
+00004220: 7427 3a20 2767 206d 616e 2073 6179 3a20  t': 'g man say: 
+00004230: 6265 6565 7062 6565 6570 6265 6565 7027  beeepbeeepbeeep'
+00004240: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
+00004250: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
+00004260: 3a20 5472 7565 7d20 290a 3e3e 204e 6f64  : True} ).>> Nod
+00004270: 6528 3c66 756e 6374 696f 6e20 6520 6174  e(<function e at
+00004280: 2030 7837 6635 3066 3462 3533 6238 303e   0x7f50f4b53b80>
+00004290: 3a20 7b27 7374 6174 6527 3a20 2745 5252  : {'state': 'ERR
+000042a0: 4f52 272c 2027 7265 7375 6c74 273a 204e  OR', 'result': N
+000042b0: 6f6e 652c 2027 6578 6365 7074 696f 6e27  one, 'exception'
+000042c0: 3a20 5661 6c75 6545 7272 6f72 2827 6f6d  : ValueError('om
+000042d0: 672c 2063 7261 7368 2120 3527 292c 2027  g, crash! 5'), '
+000042e0: 636f 6d70 6c65 7465 6427 3a20 5472 7565  completed': True
+000042f0: 7d20 290a 3e3e 204e 6f64 6528 3c66 756e  } ).>> Node(<fun
+00004300: 6374 696f 6e20 6620 6174 2030 7837 6635  ction f at 0x7f5
+00004310: 3066 3462 3533 3064 303e 3a20 7b27 7374  0f4b530d0>: {'st
+00004320: 6174 6527 3a20 2753 4b49 5050 4544 272c  ate': 'SKIPPED',
+00004330: 2027 7265 7375 6c74 273a 204e 6f6e 652c   'result': None,
+00004340: 2027 6578 6365 7074 696f 6e27 3a20 4e6f   'exception': No
+00004350: 6e65 2c20 2763 6f6d 706c 6574 6564 273a  ne, 'completed':
+00004360: 2046 616c 7365 7d20 290a 3e3e 204e 6f64   False} ).>> Nod
+00004370: 6528 3c66 756e 6374 696f 6e20 6720 6174  e(<function g at
+00004380: 2030 7837 6635 3066 3462 3533 3565 303e   0x7f50f4b535e0>
+00004390: 3a20 7b27 7374 6174 6527 3a20 2753 4b49  : {'state': 'SKI
+000043a0: 5050 4544 272c 2027 7265 7375 6c74 273a  PPED', 'result':
+000043b0: 203c 7468 7265 6164 696e 672e 4576 656e   <threading.Even
+000043c0: 7420 6f62 6a65 6374 2061 7420 3078 3766  t object at 0x7f
+000043d0: 3530 6563 3136 6339 6430 3e2c 2027 6578  50ec16c9d0>, 'ex
+000043e0: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
+000043f0: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
+00004400: 657d 2029 0a3e 3e20 4e6f 6465 283c 6675  e} ).>> Node(<fu
+00004410: 6e63 7469 6f6e 2069 2061 7420 3078 3766  nction i at 0x7f
+00004420: 3530 6634 6235 3332 3830 3e3a 207b 2773  50f4b53280>: {'s
+00004430: 7461 7465 273a 2027 534b 4950 5045 4427  tate': 'SKIPPED'
+00004440: 2c20 2772 6573 756c 7427 3a20 4e6f 6e65  , 'result': None
+00004450: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
+00004460: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
+00004470: 3a20 4661 6c73 657d 2029 0a60 6060 0a0a  : False} ).```..
+00004480: 2323 2320 4578 6563 7574 6520 7370 6172  ### Execute spar
+00004490: 6b20 7069 7065 6c69 6e65 206f 6620 6d75  k pipeline of mu
+000044a0: 6c74 6970 6c65 2073 7465 7073 0a0a 7573  ltiple steps..us
+000044b0: 696e 6720 4441 4720 636f 6d70 6f6e 656e  ing DAG componen
+000044c0: 7420 746f 2068 616e 646c 6520 7061 7261  t to handle para
+000044d0: 6c6c 656c 2065 7865 6375 7469 6f6e 0a0a  llel execution..
+000044e0: 6060 6070 7974 686f 6e0a 696d 706f 7274  ```python.import
+000044f0: 2062 6471 0a66 726f 6d20 6264 7120 696d   bdq.from bdq im
+00004500: 706f 7274 2073 7061 726b 2c20 7461 626c  port spark, tabl
+00004510: 650a 0a70 706e 203d 2062 6471 2e53 7061  e..ppn = bdq.Spa
+00004520: 726b 5069 7065 6c69 6e65 2822 7361 6d70  rkPipeline("samp
+00004530: 6c65 2229 0a0a 2320 7265 7475 726e 7320  le")..# returns 
+00004540: 6461 7461 6672 616d 652c 2061 6e64 2063  dataframe, and c
+00004550: 7265 6174 6573 2073 7061 726b 2076 6965  reates spark vie
+00004560: 7720 2772 6177 5f64 6174 615f 7369 6e67  w 'raw_data_sing
+00004570: 6c65 5f73 6f75 7263 6527 0a40 7070 6e2e  le_source'.@ppn.
+00004580: 7374 6570 5f73 7061 726b 5f74 656d 705f  step_spark_temp_
+00004590: 7669 6577 2829 0a64 6566 2072 6177 5f64  view().def raw_d
+000045a0: 6174 615f 7369 6e67 6c65 5f73 6f75 7263  ata_single_sourc
+000045b0: 6528 7374 6570 293a 0a20 2072 6574 7572  e(step):.  retur
+000045c0: 6e20 7370 6172 6b2e 7261 6e67 6528 312c  n spark.range(1,
+000045d0: 2031 3029 0a0a 2320 7265 7475 726e 7320   10)..# returns 
+000045e0: 6461 7461 6672 616d 652c 2061 6e64 2063  dataframe, and c
+000045f0: 7265 6174 6573 2073 7061 726b 2076 6965  reates spark vie
+00004600: 7720 2772 6177 5f6e 6963 655f 6e61 6d65  w 'raw_nice_name
+00004610: 270a 4070 706e 2e73 7465 705f 7370 6172  '.@ppn.step_spar
+00004620: 6b5f 7465 6d70 5f76 6965 7728 6f75 7470  k_temp_view(outp
+00004630: 7574 733d 2272 6177 5f6e 6963 655f 6e61  uts="raw_nice_na
+00004640: 6d65 2229 0a64 6566 2072 6177 5f64 6174  me").def raw_dat
+00004650: 615f 7369 6e67 6c65 5f73 6f75 7263 655f  a_single_source_
+00004660: 7769 7468 5f63 7573 746f 6d5f 6e61 6d65  with_custom_name
+00004670: 2873 7465 7029 3a0a 2020 7265 7475 726e  (step):.  return
+00004680: 2073 7061 726b 2e72 616e 6765 2831 3030   spark.range(100
+00004690: 2c20 3131 3029 0a0a 2320 7265 7475 726e  , 110)..# return
+000046a0: 7320 7477 6f20 6461 7461 6672 616d 6573  s two dataframes
+000046b0: 2c20 616e 6420 6372 6561 7465 7320 7477  , and creates tw
+000046c0: 6f20 7370 6172 6b20 7669 6577 7320 2772  o spark views 'r
+000046d0: 6177 5f64 6174 6131 272c 2027 7261 775f  aw_data1', 'raw_
+000046e0: 6461 7461 3227 0a40 7070 6e2e 7374 6570  data2'.@ppn.step
+000046f0: 5f73 7061 726b 5f74 656d 705f 7669 6577  _spark_temp_view
+00004700: 286f 7574 7075 7473 3d5b 2272 6177 5f64  (outputs=["raw_d
+00004710: 6174 6131 222c 2022 7261 775f 6461 7461  ata1", "raw_data
+00004720: 3222 5d29 0a64 6566 2072 6177 5f64 6174  2"]).def raw_dat
+00004730: 615f 6d75 6c74 695f 736f 7572 6365 2873  a_multi_source(s
+00004740: 7465 7029 3a0a 2020 6466 3120 3d20 7370  tep):.  df1 = sp
+00004750: 6172 6b2e 7261 6e67 6528 3130 3030 2c20  ark.range(1000, 
+00004760: 3230 3030 290a 2020 6466 3220 3d20 7370  2000).  df2 = sp
+00004770: 6172 6b2e 7261 6e67 6528 3230 3030 2c20  ark.range(2000, 
+00004780: 3330 3030 290a 0a20 2072 6574 7572 6e20  3000)..  return 
+00004790: 5b64 6631 2c20 6466 325d 0a0a 2320 7761  [df1, df2]..# wa
+000047a0: 6974 7320 666f 7220 7261 7720 6461 7461  its for raw data
+000047b0: 2073 6f75 7263 6573 2074 6f20 6669 6e69   sources to fini
+000047c0: 7368 2c20 616e 6420 636f 6d62 696e 6573  sh, and combines
+000047d0: 2074 6865 2064 6174 6120 696e 746f 206f   the data into o
+000047e0: 6e65 2075 6e69 6f6e 6564 2076 6965 7720  ne unioned view 
+000047f0: 6063 6f6d 6269 6e65 5f64 6174 6160 0a23  `combine_data`.#
+00004800: 206e 6f74 6520 7468 6174 2064 6570 656e   note that depen
+00004810: 6465 6e63 6965 7320 6172 6520 7079 7468  dencies are pyth
+00004820: 6f6e 2066 756e 6374 696f 6e73 206f 7220  on functions or 
+00004830: 6e61 6d65 7320 6f66 206f 7574 7075 7473  names of outputs
+00004840: 0a40 7070 6e2e 7374 6570 5f73 7061 726b  .@ppn.step_spark
+00004850: 5f74 656d 705f 7669 6577 2864 6570 656e  _temp_view(depen
+00004860: 6473 5f6f 6e3d 5b72 6177 5f64 6174 615f  ds_on=[raw_data_
+00004870: 7369 6e67 6c65 5f73 6f75 7263 652c 2072  single_source, r
+00004880: 6177 5f64 6174 615f 7369 6e67 6c65 5f73  aw_data_single_s
+00004890: 6f75 7263 655f 7769 7468 5f63 7573 746f  ource_with_custo
+000048a0: 6d5f 6e61 6d65 2c20 2772 6177 5f64 6174  m_name, 'raw_dat
+000048b0: 6131 272c 2027 7261 775f 6461 7461 3227  a1', 'raw_data2'
+000048c0: 5d29 0a64 6566 2063 6f6d 6269 6e65 5f64  ]).def combine_d
+000048d0: 6174 6128 7374 6570 293a 0a20 2064 6620  ata(step):.  df 
+000048e0: 3d20 7461 626c 6528 2772 6177 5f64 6174  = table('raw_dat
+000048f0: 615f 7369 6e67 6c65 5f73 6f75 7263 6527  a_single_source'
+00004900: 2920 5c0a 2020 2020 2e75 6e69 6f6e 2874  ) \.    .union(t
+00004910: 6162 6c65 2827 7261 775f 6e69 6365 5f6e  able('raw_nice_n
+00004920: 616d 6527 2929 205c 0a20 2020 202e 756e  ame')) \.    .un
+00004930: 696f 6e28 7461 626c 6528 2772 6177 5f64  ion(table('raw_d
+00004940: 6174 6131 2729 2920 5c0a 2020 2020 2e75  ata1')) \.    .u
+00004950: 6e69 6f6e 2874 6162 6c65 2827 7261 775f  nion(table('raw_
+00004960: 6461 7461 3227 2929 0a0a 2020 7265 7475  data2'))..  retu
+00004970: 726e 2064 660a 0a23 2073 706c 6974 7320  rn df..# splits 
+00004980: 7468 6520 636f 6d62 696e 6564 5f64 6174  the combined_dat
+00004990: 6120 696e 746f 2027 6f64 6427 2061 6e64  a into 'odd' and
+000049a0: 2027 6576 656e 2720 7669 6577 730a 4070   'even' views.@p
+000049b0: 706e 2e73 7465 705f 7370 6172 6b5f 7465  pn.step_spark_te
+000049c0: 6d70 5f76 6965 7728 6465 7065 6e64 735f  mp_view(depends_
+000049d0: 6f6e 3d63 6f6d 6269 6e65 5f64 6174 612c  on=combine_data,
+000049e0: 206f 7574 7075 7473 3d5b 276f 6464 272c   outputs=['odd',
+000049f0: 2027 6576 656e 275d 290a 6465 6620 7370   'even']).def sp
+00004a00: 6c69 745f 6461 7461 2873 7465 7029 3a0a  lit_data(step):.
+00004a10: 2020 6466 5f6f 6464 203d 2074 6162 6c65    df_odd = table
+00004a20: 2827 636f 6d62 696e 655f 6461 7461 2729  ('combine_data')
+00004a30: 2e66 696c 7465 7228 2769 6420 2520 3220  .filter('id % 2 
+00004a40: 3d3d 2031 2729 0a20 2064 665f 6576 656e  == 1').  df_even
+00004a50: 203d 2074 6162 6c65 2827 636f 6d62 696e   = table('combin
+00004a60: 655f 6461 7461 2729 2e66 696c 7465 7228  e_data').filter(
+00004a70: 2769 6420 2520 3220 3d3d 2030 2729 0a0a  'id % 2 == 0')..
+00004a80: 2020 7265 7475 726e 205b 2064 665f 6f64    return [ df_od
+00004a90: 642c 2064 665f 6576 656e 205d 0a0a 2320  d, df_even ]..# 
+00004aa0: 6578 6563 7574 6573 2070 6970 656c 696e  executes pipelin
+00004ab0: 6520 7573 696e 6720 636f 6e63 7572 7265  e using concurre
+00004ac0: 6e74 2074 6872 6561 6473 2c20 6f6e 6520  nt threads, one 
+00004ad0: 7065 7220 6561 6368 2073 7465 702c 2066  per each step, f
+00004ae0: 6f6c 6c6f 7769 6e67 2074 6865 2064 6570  ollowing the dep
+00004af0: 656e 6465 6e63 7920 4441 470a 2320 7069  endency DAG.# pi
+00004b00: 7065 6c69 6e65 2069 7320 6120 6e6f 726d  peline is a norm
+00004b10: 616c 2070 7974 686f 6e20 6361 6c6c 6162  al python callab
+00004b20: 6c65 206f 626a 6563 742c 2061 7320 6966  le object, as if
+00004b30: 2069 7420 7761 7320 6120 6675 6e63 7469   it was a functi
+00004b40: 6f6e 2c20 6974 2072 6574 7572 6e73 2061  on, it returns a
+00004b50: 206c 6973 7420 6f66 2061 6c6c 2073 7465   list of all ste
+00004b60: 7073 0a70 6970 656c 696e 655f 7265 7375  ps.pipeline_resu
+00004b70: 6c74 7320 3d20 7070 6e28 6d61 785f 636f  lts = ppn(max_co
+00004b80: 6e63 7572 7265 6e74 5f73 7465 7073 3d31  ncurrent_steps=1
+00004b90: 3029 0a0a 7072 696e 7428 2770 6970 656c  0)..print('pipel
+00004ba0: 696e 6520 7265 7375 6c74 733a 2729 0a70  ine results:').p
+00004bb0: 7269 6e74 2870 6970 656c 696e 655f 7265  rint(pipeline_re
+00004bc0: 7375 6c74 7329 0a0a 2373 686f 7720 736f  sults)..#show so
+00004bd0: 6d65 2066 696e 616c 2076 616c 7565 730a  me final values.
+00004be0: 7072 696e 7428 2765 7665 6e20 6e75 6d62  print('even numb
+00004bf0: 6572 733a 2729 0a70 7269 6e74 2874 6162  ers:').print(tab
+00004c00: 6c65 2827 6576 656e 2729 2e6c 696d 6974  le('even').limit
+00004c10: 2831 3029 2e63 6f6c 6c65 6374 2829 290a  (10).collect()).
+00004c20: 7072 696e 7428 276f 6464 206e 756d 6265  print('odd numbe
+00004c30: 7273 3a27 290a 7072 696e 7428 7461 626c  rs:').print(tabl
+00004c40: 6528 276f 6464 2729 2e6c 696d 6974 2831  e('odd').limit(1
+00004c50: 3029 2e63 6f6c 6c65 6374 2829 290a 0a23  0).collect())..#
+00004c60: 6765 7420 736b 6970 7065 6420 7374 6570  get skipped step
+00004c70: 730a 6173 7365 7274 206c 6973 7428 7070  s.assert list(pp
+00004c80: 6e2e 736b 6970 7065 645f 7374 6570 7329  n.skipped_steps)
+00004c90: 203d 3d20 5b5d 0a0a 2367 6574 2065 7272   == []..#get err
+00004ca0: 6f72 6564 2073 7465 7073 2028 796f 7520  ored steps (you 
+00004cb0: 776f 756c 6420 6e65 6564 2074 6f20 2761  would need to 'a
+00004cc0: 646a 7573 7427 2063 6f64 6520 6f66 206f  djust' code of o
+00004cd0: 6e20 6f66 2074 6865 2073 7465 7073 2074  n of the steps t
+00004ce0: 6f20 6d61 6b65 2069 7420 6661 696c 2074  o make it fail t
+00004cf0: 6f20 7365 6520 736f 6d65 7468 696e 6720  o see something 
+00004d00: 6865 7265 290a 6173 7365 7274 206c 6973  here).assert lis
+00004d10: 7428 7070 6e2e 6572 726f 725f 7374 6570  t(ppn.error_step
+00004d20: 7329 203d 3d20 5b5d 0a0a 2367 6574 2073  s) == []..#get s
+00004d30: 7563 6365 7373 6675 6c6c 2073 7465 7073  uccessfull steps
+00004d40: 0a61 7373 6572 7420 7365 7428 7070 6e2e  .assert set(ppn.
+00004d50: 7375 6363 6573 735f 7374 6570 732e 7661  success_steps.va
+00004d60: 6c75 6573 2829 2920 3d3d 2073 6574 285b  lues()) == set([
+00004d70: 0a20 2072 6177 5f64 6174 615f 7369 6e67  .  raw_data_sing
+00004d80: 6c65 5f73 6f75 7263 655f 7769 7468 5f63  le_source_with_c
+00004d90: 7573 746f 6d5f 6e61 6d65 2c0a 2020 7261  ustom_name,.  ra
+00004da0: 775f 6461 7461 5f6d 756c 7469 5f73 6f75  w_data_multi_sou
+00004db0: 7263 652c 0a20 2073 706c 6974 5f64 6174  rce,.  split_dat
+00004dc0: 612c 0a20 2063 6f6d 6269 6e65 5f64 6174  a,.  combine_dat
+00004dd0: 612c 0a20 2072 6177 5f64 6174 615f 7369  a,.  raw_data_si
+00004de0: 6e67 6c65 5f73 6f75 7263 650a 5d29 0a0a  ngle_source.])..
+00004df0: 3e3e 2057 6169 7469 6e67 2066 6f72 2061  >> Waiting for a
+00004e00: 6c6c 2074 6173 6b73 2074 6f20 6669 6e69  ll tasks to fini
+00004e10: 7368 2e2e 2e0a 3e3e 2020 2073 7461 7274  sh....>>   start
+00004e20: 696e 673a 204e 6f64 6528 7261 775f 6461  ing: Node(raw_da
+00004e30: 7461 5f73 696e 676c 655f 736f 7572 6365  ta_single_source
+00004e40: 3a20 7b27 7374 6174 6527 3a20 2752 554e  : {'state': 'RUN
+00004e50: 4e49 4e47 272c 2027 7265 7375 6c74 273a  NING', 'result':
+00004e60: 204e 6f6e 652c 2027 6578 6365 7074 696f   None, 'exceptio
+00004e70: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
+00004e80: 6574 6564 273a 2046 616c 7365 7d20 290a  eted': False} ).
+00004e90: 3e3e 2020 2073 7461 7274 696e 673a 204e  >>   starting: N
+00004ea0: 6f64 6528 7261 775f 6461 7461 5f73 696e  ode(raw_data_sin
+00004eb0: 676c 655f 736f 7572 6365 5f77 6974 685f  gle_source_with_
+00004ec0: 6375 7374 6f6d 5f6e 616d 653a 207b 2773  custom_name: {'s
+00004ed0: 7461 7465 273a 2027 5255 4e4e 494e 4727  tate': 'RUNNING'
+00004ee0: 2c20 2772 6573 756c 7427 3a20 4e6f 6e65  , 'result': None
+00004ef0: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
+00004f00: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
+00004f10: 3a20 4661 6c73 657d 2029 0a3e 3e20 2020  : False} ).>>   
+00004f20: 7374 6172 7469 6e67 3a20 4e6f 6465 2872  starting: Node(r
+00004f30: 6177 5f64 6174 615f 6d75 6c74 695f 736f  aw_data_multi_so
+00004f40: 7572 6365 3a20 7b27 7374 6174 6527 3a20  urce: {'state': 
+00004f50: 2752 554e 4e49 4e47 272c 2027 7265 7375  'RUNNING', 'resu
+00004f60: 6c74 273a 204e 6f6e 652c 2027 6578 6365  lt': None, 'exce
+00004f70: 7074 696f 6e27 3a20 4e6f 6e65 2c20 2763  ption': None, 'c
+00004f80: 6f6d 706c 6574 6564 273a 2046 616c 7365  ompleted': False
+00004f90: 7d20 290a 3e3e 2020 2066 696e 6973 6865  } ).>>   finishe
+00004fa0: 643a 204e 6f64 6528 7261 775f 6461 7461  d: Node(raw_data
+00004fb0: 5f73 696e 676c 655f 736f 7572 6365 3a20  _single_source: 
+00004fc0: 7b27 7374 6174 6527 3a20 2753 5543 4345  {'state': 'SUCCE
+00004fd0: 5353 272c 2027 7265 7375 6c74 273a 205b  SS', 'result': [
+00004fe0: 4461 7461 4672 616d 655b 6964 3a20 6269  DataFrame[id: bi
+00004ff0: 6769 6e74 5d5d 2c20 2765 7863 6570 7469  gint]], 'excepti
+00005000: 6f6e 273a 204e 6f6e 652c 2027 636f 6d70  on': None, 'comp
+00005010: 6c65 7465 6427 3a20 5472 7565 7d20 2920  leted': True} ) 
+00005020: 2873 7469 6c6c 2072 756e 6e69 6e67 3a20  (still running: 
+00005030: 3229 0a3e 3e20 2020 6669 6e69 7368 6564  2).>>   finished
+00005040: 3a20 4e6f 6465 2872 6177 5f64 6174 615f  : Node(raw_data_
+00005050: 7369 6e67 6c65 5f73 6f75 7263 655f 7769  single_source_wi
+00005060: 7468 5f63 7573 746f 6d5f 6e61 6d65 3a20  th_custom_name: 
+00005070: 7b27 7374 6174 6527 3a20 2753 5543 4345  {'state': 'SUCCE
+00005080: 5353 272c 2027 7265 7375 6c74 273a 205b  SS', 'result': [
+00005090: 4461 7461 4672 616d 655b 6964 3a20 6269  DataFrame[id: bi
+000050a0: 6769 6e74 5d5d 2c20 2765 7863 6570 7469  gint]], 'excepti
+000050b0: 6f6e 273a 204e 6f6e 652c 2027 636f 6d70  on': None, 'comp
+000050c0: 6c65 7465 6427 3a20 5472 7565 7d20 2920  leted': True} ) 
+000050d0: 2873 7469 6c6c 2072 756e 6e69 6e67 3a20  (still running: 
+000050e0: 3129 0a3e 3e20 2020 7374 6172 7469 6e67  1).>>   starting
+000050f0: 3a20 4e6f 6465 2863 6f6d 6269 6e65 5f64  : Node(combine_d
+00005100: 6174 613a 207b 2773 7461 7465 273a 2027  ata: {'state': '
+00005110: 5255 4e4e 494e 4727 2c20 2772 6573 756c  RUNNING', 'resul
+00005120: 7427 3a20 4e6f 6e65 2c20 2765 7863 6570  t': None, 'excep
+00005130: 7469 6f6e 273a 204e 6f6e 652c 2027 636f  tion': None, 'co
+00005140: 6d70 6c65 7465 6427 3a20 4661 6c73 657d  mpleted': False}
+00005150: 2029 0a3e 3e20 2020 6669 6e69 7368 6564   ).>>   finished
+00005160: 3a20 4e6f 6465 2872 6177 5f64 6174 615f  : Node(raw_data_
+00005170: 6d75 6c74 695f 736f 7572 6365 3a20 7b27  multi_source: {'
+00005180: 7374 6174 6527 3a20 2753 5543 4345 5353  state': 'SUCCESS
+00005190: 272c 2027 7265 7375 6c74 273a 205b 4461  ', 'result': [Da
+000051a0: 7461 4672 616d 655b 6964 3a20 6269 6769  taFrame[id: bigi
+000051b0: 6e74 5d2c 2044 6174 6146 7261 6d65 5b69  nt], DataFrame[i
+000051c0: 643a 2062 6967 696e 745d 5d2c 2027 6578  d: bigint]], 'ex
+000051d0: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
+000051e0: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
+000051f0: 657d 2029 2028 7374 696c 6c20 7275 6e6e  e} ) (still runn
+00005200: 696e 673a 2031 290a 3e3e 2020 2073 7461  ing: 1).>>   sta
+00005210: 7274 696e 673a 204e 6f64 6528 7370 6c69  rting: Node(spli
+00005220: 745f 6461 7461 3a20 7b27 7374 6174 6527  t_data: {'state'
+00005230: 3a20 2752 554e 4e49 4e47 272c 2027 7265  : 'RUNNING', 're
+00005240: 7375 6c74 273a 204e 6f6e 652c 2027 6578  sult': None, 'ex
+00005250: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
+00005260: 2763 6f6d 706c 6574 6564 273a 2046 616c  'completed': Fal
+00005270: 7365 7d20 290a 3e3e 2020 2066 696e 6973  se} ).>>   finis
+00005280: 6865 643a 204e 6f64 6528 636f 6d62 696e  hed: Node(combin
+00005290: 655f 6461 7461 3a20 7b27 7374 6174 6527  e_data: {'state'
+000052a0: 3a20 2753 5543 4345 5353 272c 2027 7265  : 'SUCCESS', 're
+000052b0: 7375 6c74 273a 205b 4461 7461 4672 616d  sult': [DataFram
+000052c0: 655b 6964 3a20 6269 6769 6e74 5d5d 2c20  e[id: bigint]], 
+000052d0: 2765 7863 6570 7469 6f6e 273a 204e 6f6e  'exception': Non
+000052e0: 652c 2027 636f 6d70 6c65 7465 6427 3a20  e, 'completed': 
+000052f0: 5472 7565 7d20 2920 2873 7469 6c6c 2072  True} ) (still r
+00005300: 756e 6e69 6e67 3a20 3129 0a3e 3e20 2020  unning: 1).>>   
+00005310: 6669 6e69 7368 6564 3a20 4e6f 6465 2873  finished: Node(s
+00005320: 706c 6974 5f64 6174 613a 207b 2773 7461  plit_data: {'sta
+00005330: 7465 273a 2027 5355 4343 4553 5327 2c20  te': 'SUCCESS', 
+00005340: 2772 6573 756c 7427 3a20 5b44 6174 6146  'result': [DataF
+00005350: 7261 6d65 5b69 643a 2062 6967 696e 745d  rame[id: bigint]
+00005360: 2c20 4461 7461 4672 616d 655b 6964 3a20  , DataFrame[id: 
+00005370: 6269 6769 6e74 5d5d 2c20 2765 7863 6570  bigint]], 'excep
+00005380: 7469 6f6e 273a 204e 6f6e 652c 2027 636f  tion': None, 'co
+00005390: 6d70 6c65 7465 6427 3a20 5472 7565 7d20  mpleted': True} 
+000053a0: 2920 2873 7469 6c6c 2072 756e 6e69 6e67  ) (still running
+000053b0: 3a20 3029 0a3e 3e20 416c 6c20 7461 736b  : 0).>> All task
+000053c0: 7320 6669 6e69 7368 6564 2c20 7368 7574  s finished, shut
+000053d0: 7469 6e67 2064 6f77 6e0a 3e3e 2070 6970  ting down.>> pip
+000053e0: 656c 696e 6520 7265 7375 6c74 733a 0a3e  eline results:.>
+000053f0: 3e20 5b72 6177 5f64 6174 615f 7369 6e67  > [raw_data_sing
+00005400: 6c65 5f73 6f75 7263 652c 2072 6177 5f64  le_source, raw_d
+00005410: 6174 615f 7369 6e67 6c65 5f73 6f75 7263  ata_single_sourc
+00005420: 655f 7769 7468 5f63 7573 746f 6d5f 6e61  e_with_custom_na
+00005430: 6d65 2c20 7261 775f 6461 7461 5f6d 756c  me, raw_data_mul
+00005440: 7469 5f73 6f75 7263 652c 2063 6f6d 6269  ti_source, combi
+00005450: 6e65 5f64 6174 612c 2073 706c 6974 5f64  ne_data, split_d
+00005460: 6174 615d 0a3e 3e20 6576 656e 206e 756d  ata].>> even num
+00005470: 6265 7273 3a0a 3e3e 205b 526f 7728 6964  bers:.>> [Row(id
+00005480: 3d32 292c 2052 6f77 2869 643d 3429 2c20  =2), Row(id=4), 
+00005490: 526f 7728 6964 3d36 292c 2052 6f77 2869  Row(id=6), Row(i
+000054a0: 643d 3829 2c20 526f 7728 6964 3d31 3030  d=8), Row(id=100
+000054b0: 292c 2052 6f77 2869 643d 3130 3229 2c20  ), Row(id=102), 
+000054c0: 526f 7728 6964 3d31 3034 292c 2052 6f77  Row(id=104), Row
+000054d0: 2869 643d 3130 3629 2c20 526f 7728 6964  (id=106), Row(id
+000054e0: 3d31 3038 292c 2052 6f77 2869 643d 3130  =108), Row(id=10
+000054f0: 3030 295d 0a3e 3e20 6f64 6420 6e75 6d62  00)].>> odd numb
+00005500: 6572 733a 0a3e 3e20 5b52 6f77 2869 643d  ers:.>> [Row(id=
+00005510: 3129 2c20 526f 7728 6964 3d33 292c 2052  1), Row(id=3), R
+00005520: 6f77 2869 643d 3529 2c20 526f 7728 6964  ow(id=5), Row(id
+00005530: 3d37 292c 2052 6f77 2869 643d 3929 2c20  =7), Row(id=9), 
+00005540: 526f 7728 6964 3d31 3031 292c 2052 6f77  Row(id=101), Row
+00005550: 2869 643d 3130 3329 2c20 526f 7728 6964  (id=103), Row(id
+00005560: 3d31 3035 292c 2052 6f77 2869 643d 3130  =105), Row(id=10
+00005570: 3729 2c20 526f 7728 6964 3d31 3039 295d  7), Row(id=109)]
+00005580: 0a60 6060 0a0a 7069 7065 6c69 6e65 2073  .```..pipeline s
+00005590: 7465 7073 2061 7265 2072 6572 756e 6162  teps are rerunab
+000055a0: 6c65 2061 7320 616e 7920 6f72 6469 6e61  le as any ordina
+000055b0: 7279 2066 756e 6374 696f 6e3a 0a0a 6060  ry function:..``
+000055c0: 6070 7974 686f 6e0a 2320 746f 2072 6572  `python.# to rer
+000055d0: 756e 2067 6976 656e 2073 7465 702c 206a  un given step, j
+000055e0: 7573 7420 6578 6563 7574 6520 6974 2061  ust execute it a
+000055f0: 7320 6966 2069 7420 7761 7320 6120 7075  s if it was a pu
+00005600: 7265 2066 756e 6374 696f 6e0a 2320 7265  re function.# re
+00005610: 7475 726e 2069 7320 616c 6177 6179 7320  turn is alaways 
+00005620: 6120 6c69 7374 206f 6620 6461 7461 6672  a list of datafr
+00005630: 616d 7320 7468 6174 2067 6976 656e 2040  ams that given @
+00005640: 7070 6e2e 7374 6570 2072 6574 7572 6e73  ppn.step returns
+00005650: 0a23 206e 6f74 653a 2074 6865 2073 7061  .# note: the spa
+00005660: 726b 2076 6965 7720 2772 6177 5f64 6174  rk view 'raw_dat
+00005670: 615f 7369 6e67 6c65 5f73 6f75 7263 6527  a_single_source'
+00005680: 2077 696c 6c20 6265 2075 7064 6174 6564   will be updated
+00005690: 2077 6865 6e20 7468 6973 2066 756e 6374   when this funct
+000056a0: 696f 6e20 6669 6e69 7368 6573 2028 6173  ion finishes (as
+000056b0: 2070 6572 2064 6566 696e 7469 6f6e 2069   per defintion i
+000056c0: 6e20 4070 706e 2e73 7465 7020 6162 6f76  n @ppn.step abov
+000056d0: 6529 0a72 6177 5f64 6174 615f 7369 6e67  e).raw_data_sing
+000056e0: 6c65 5f73 6f75 7263 6528 290a 6060 600a  le_source().```.
+000056f0: 0a23 2323 2053 7061 726b 2055 4920 5374  .### Spark UI St
+00005700: 6167 6520 6465 7363 7269 7074 696f 6e73  age descriptions
+00005710: 0a0a 5768 656e 2072 756e 6e69 6e67 2063  ..When running c
+00005720: 6f64 6520 7573 696e 6720 7079 7370 6172  ode using pyspar
+00005730: 6b2c 2073 7061 726b 2075 6920 6765 7473  k, spark ui gets
+00005740: 2076 6572 7920 6372 6f77 6465 642e 2060   very crowded. `
+00005750: 5370 6172 6b55 494c 6f67 6765 7260 2063  SparkUILogger` c
+00005760: 6f6e 7465 7874 206d 616e 6167 6572 2061  ontext manager a
+00005770: 6e64 2064 6563 6f72 6174 6f72 2061 7373  nd decorator ass
+00005780: 696e 6773 2068 756d 616e 2072 6561 6461  ings human reada
+00005790: 626c 6520 6e61 6d65 7320 746f 2073 7061  ble names to spa
+000057a0: 726b 2073 7461 6765 732e 0a0a 6060 6070  rk stages...```p
+000057b0: 7974 686f 6e0a 6672 6f6d 2062 6471 2069  ython.from bdq i
+000057c0: 6d70 6f72 7420 5370 6172 6b55 494c 6f67  mport SparkUILog
+000057d0: 6765 720a 0a23 2075 7361 6765 206f 6620  ger..# usage of 
+000057e0: 6465 636f 7261 746f 7273 0a23 2073 7061  decorators.# spa
+000057f0: 726b 2075 6920 7374 6167 6573 2077 696c  rk ui stages wil
+00005800: 6c20 6861 7665 2064 6573 6372 6970 7469  l have descripti
+00005810: 6f6e 206f 6620 2778 797a 270a 4053 7061  on of 'xyz'.@Spa
+00005820: 726b 5549 4c6f 6767 6572 2e74 6167 2864  rkUILogger.tag(d
+00005830: 6573 633d 2778 797a 2729 0a64 6566 2073  esc='xyz').def s
+00005840: 6f6d 655f 6675 6e63 7469 6f6e 3228 6e75  ome_function2(nu
+00005850: 6d62 6572 293a 0a0a 2020 7265 7475 726e  mber):..  return
+00005860: 2073 7061 726b 2e72 616e 6765 286e 756d   spark.range(num
+00005870: 6265 7229 2e63 6f75 6e74 2829 0a0a 2320  ber).count()..# 
+00005880: 7370 6172 6b20 7569 2073 7461 6765 7320  spark ui stages 
+00005890: 7769 6c6c 2068 6176 6520 6465 7363 7269  will have descri
+000058a0: 7074 696f 6e20 6f66 2027 616c 7068 615f  ption of 'alpha_
+000058b0: 6675 6e63 7469 6f6e 3227 2028 6175 746f  function2' (auto
+000058c0: 6d61 7469 6361 6c6c 7920 6465 7269 7665  matically derive
+000058d0: 6420 6672 6f6d 2066 756e 6374 696f 6e20  d from function 
+000058e0: 6e61 6d65 290a 4053 7061 726b 5549 4c6f  name).@SparkUILo
+000058f0: 6767 6572 2e74 6167 0a64 6566 2061 6c70  gger.tag.def alp
+00005900: 6861 5f66 756e 6374 696f 6e32 286e 756d  ha_function2(num
+00005910: 6265 7229 3a0a 2020 2320 3173 7420 616e  ber):.  # 1st an
+00005920: 6420 326e 6420 736f 6d65 5f66 756e 6374  d 2nd some_funct
+00005930: 696f 6e32 2829 2063 616c 6c73 2073 686f  ion2() calls sho
+00005940: 756c 6420 6265 2076 6973 6962 6c65 2069  uld be visible i
+00005950: 6e20 7370 6172 6b20 7569 2061 7320 2778  n spark ui as 'x
+00005960: 797a 270a 2020 2320 7468 6520 3372 6420  yz'.  # the 3rd 
+00005970: 7061 7274 206f 6620 7265 7375 6c74 2073  part of result s
+00005980: 686f 756c 6420 6265 2076 6973 6962 6c65  hould be visible
+00005990: 2061 7320 2761 6c70 6861 5f66 756e 6374   as 'alpha_funct
+000059a0: 696f 6e32 0a20 2072 6574 7572 6e20 736f  ion2.  return so
+000059b0: 6d65 5f66 756e 6374 696f 6e32 286e 756d  me_function2(num
+000059c0: 6265 722a 3229 202b 2073 6f6d 655f 6675  ber*2) + some_fu
+000059d0: 6e63 7469 6f6e 3228 6e75 6d62 6572 2a33  nction2(number*3
+000059e0: 2920 2b20 7370 6172 6b2e 7261 6e67 6528  ) + spark.range(
+000059f0: 6e75 6d62 6572 2f31 3029 2e63 6f75 6e74  number/10).count
+00005a00: 2829 0a0a 2320 7573 6167 6520 6f66 2063  ()..# usage of c
+00005a10: 6f6e 7465 7874 206d 616e 6167 6572 730a  ontext managers.
+00005a20: 2320 7769 6c6c 2062 6520 7669 7369 626c  # will be visibl
+00005a30: 6520 696e 2073 7061 726b 2075 6920 6173  e in spark ui as
+00005a40: 2027 6669 7273 742d 636f 756e 7427 0a77   'first-count'.w
+00005a50: 6974 6820 5370 6172 6b55 494c 6f67 6765  ith SparkUILogge
+00005a60: 7228 2766 6972 7374 2d63 6f75 6e74 2729  r('first-count')
+00005a70: 3a0a 2020 7370 6172 6b2e 7261 6e67 6528  :.  spark.range(
+00005a80: 3130 292e 636f 756e 7428 290a 0a23 2077  10).count()..# w
+00005a90: 696c 6c20 6265 2076 6973 6962 6c65 2069  ill be visible i
+00005aa0: 6e20 7370 6172 6b20 7569 2061 7320 2732  n spark ui as '2
+00005ab0: 6e64 2d63 6f75 6e74 270a 7769 7468 2053  nd-count'.with S
+00005ac0: 7061 726b 5549 4c6f 6767 6572 2827 326e  parkUILogger('2n
+00005ad0: 642d 636f 756e 7427 293a 0a20 2073 7061  d-count'):.  spa
+00005ae0: 726b 2e72 616e 6765 2832 3029 2e63 6f75  rk.range(20).cou
+00005af0: 6e74 2829 0a0a 736f 6d65 5f66 756e 6374  nt()..some_funct
+00005b00: 696f 6e32 2831 3030 3029 0a61 6c70 6861  ion2(1000).alpha
+00005b10: 5f66 756e 6374 696f 6e32 2832 3030 3029  _function2(2000)
+00005b20: 0a60 6060 0a                             .```.
```

### Comparing `bdq-0.0.5/README.md` & `bdq-0.1.0/PKG-INFO`

 * *Files 4% similar despite different names*

```diff
@@ -1,1343 +1,1497 @@
-00000000: 2320 5768 6174 2069 7320 6264 713f 0a42  # What is bdq?.B
-00000010: 4451 2073 7461 6e64 7320 666f 7220 4269  DQ stands for Bi
-00000020: 6720 4461 7461 2051 7561 6c69 7479 2c20  g Data Quality, 
-00000030: 6120 7365 7420 6f66 2074 6f6f 6c73 2f66  a set of tools/f
-00000040: 756e 6374 696f 6e20 7468 6174 2068 656c  unction that hel
-00000050: 7020 796f 7520 6576 6572 7920 6461 7920  p you every day 
-00000060: 6173 7365 7274 2071 7561 6c69 7479 206f  assert quality o
-00000070: 6620 6461 7461 7365 7473 2079 6f75 2068  f datasets you h
-00000080: 6176 6520 7072 6f63 6573 7365 6420 6f72  ave processed or
-00000090: 2069 6e67 6573 7465 642e 204c 6962 7261   ingested. Libra
-000000a0: 7279 206c 6576 6572 6167 6573 2070 6f77  ry leverages pow
-000000b0: 6572 206f 6620 7370 6172 6b2c 2068 656e  er of spark, hen
-000000c0: 6365 2069 7420 7072 6f63 6573 7365 7320  ce it processes 
-000000d0: 796f 7572 2071 7561 6c69 7479 2063 6865  your quality che
-000000e0: 636b 7320 6174 2073 6361 6c65 206f 6666  cks at scale off
-000000f0: 6572 6564 2062 7920 7370 6172 6b20 616e  ered by spark an
-00000100: 6420 6461 7461 6272 6963 6b73 2e0a 0a23  d databricks...#
-00000110: 2320 436f 6d70 6172 696e 6720 6461 7461  # Comparing data
-00000120: 6672 616d 6520 7363 6865 6d61 730a 6060  frame schemas.``
-00000130: 6070 7974 686f 6e0a 696d 706f 7274 2062  `python.import b
-00000140: 6471 0a66 726f 6d20 6461 7465 7469 6d65  dq.from datetime
-00000150: 2069 6d70 6f72 7420 6461 7465 7469 6d65   import datetime
-00000160: 0a69 6d70 6f72 7420 7079 7370 6172 6b2e  .import pyspark.
-00000170: 7371 6c2e 6675 6e63 7469 6f6e 7320 6173  sql.functions as
-00000180: 2046 0a0a 6466 3220 3d20 7370 6172 6b2e   F..df2 = spark.
-00000190: 6372 6561 7465 4461 7461 4672 616d 6528  createDataFrame(
-000001a0: 5b0a 5b20 312c 2031 2c20 2247 727a 6567  [.[ 1, 1, "Grzeg
-000001b0: 6f72 7a22 2c20 6461 7465 7469 6d65 2832  orz", datetime(2
-000001c0: 3031 382c 2031 2c20 3129 2c20 6461 7465  018, 1, 1), date
-000001d0: 7469 6d65 2832 3031 382c 2031 2c20 312c  time(2018, 1, 1,
-000001e0: 2031 322c 2033 342c 2035 3629 2c20 3236   12, 34, 56), 26
-000001f0: 2e39 2c20 3132 3332 3334 3233 3433 3435  .9, 123234234345
-00000200: 2c20 5472 7565 5d2c 0a5b 2033 2c20 312c  , True],.[ 3, 1,
-00000210: 2022 4d69 6b65 222c 2020 2020 2064 6174   "Mike",     dat
-00000220: 6574 696d 6528 3230 3139 2c20 312c 2031  etime(2019, 1, 1
-00000230: 292c 2064 6174 6574 696d 6528 3230 3138  ), datetime(2018
-00000240: 2c20 332c 2031 2c20 3132 2c20 3334 2c20  , 3, 1, 12, 34, 
-00000250: 3536 292c 2034 362e 372c 2035 3636 3738  56), 46.7, 56678
-00000260: 3838 3938 392c 2046 616c 7365 5d2c 0a5b  88989, False],.[
-00000270: 2032 2c20 322c 2022 5469 6d6d 7922 2c20   2, 2, "Timmy", 
-00000280: 2020 2064 6174 6574 696d 6528 3230 3138     datetime(2018
-00000290: 2c20 312c 2031 292c 2064 6174 6574 696d  , 1, 1), datetim
-000002a0: 6528 3230 3138 2c20 322c 2031 2c20 3132  e(2018, 2, 1, 12
-000002b0: 2c20 3334 2c20 3536 292c 2033 362e 372c  , 34, 56), 36.7,
-000002c0: 2038 3735 3438 3537 3834 352c 2054 7275   8754857845, Tru
-000002d0: 655d 0a5d 2c20 7363 6865 6d61 290a 0a64  e].], schema)..d
-000002e0: 6632 5f63 6861 6e67 6564 203d 2064 6632  f2_changed = df2
-000002f0: 205c 0a20 202e 6472 6f70 2827 6669 7273   \.  .drop('firs
-00000300: 745f 6c6f 6769 6e5f 6474 2729 205c 0a20  t_login_dt') \. 
-00000310: 202e 7769 7468 436f 6c75 6d6e 2827 6e65   .withColumn('ne
-00000320: 775f 6461 7461 272c 2046 2e6c 6974 284e  w_data', F.lit(N
-00000330: 6f6e 6529 2e63 6173 7428 2764 6174 6527  one).cast('date'
-00000340: 2929 205c 0a20 202e 7769 7468 436f 6c75  )) \.  .withColu
-00000350: 6d6e 2827 6c69 6b65 7327 2c20 462e 636f  mn('likes', F.co
-00000360: 6c28 276c 696b 6573 2729 2e63 6173 7428  l('likes').cast(
-00000370: 2769 6e74 2729 290a 0a61 7373 6572 7420  'int'))..assert 
-00000380: 6264 712e 636f 6d70 6172 655f 7363 6865  bdq.compare_sche
-00000390: 6d61 7328 6466 322e 7363 6865 6d61 2c20  mas(df2.schema, 
-000003a0: 6466 325f 6368 616e 6765 642e 7363 6865  df2_changed.sche
-000003b0: 6d61 2920 3d3d 207b 0a20 2027 6164 6465  ma) == {.  'adde
-000003c0: 6427 3a20 7b27 6669 7273 745f 6c6f 6769  d': {'first_logi
-000003d0: 6e5f 6474 277d 2c20 0a20 2027 7265 6d6f  n_dt'}, .  'remo
-000003e0: 7665 6427 3a20 7b27 6e65 775f 6461 7461  ved': {'new_data
-000003f0: 277d 2c20 0a20 2027 6368 616e 6765 6427  '}, .  'changed'
-00000400: 3a20 7b0a 2020 2020 276c 696b 6573 273a  : {.    'likes':
-00000410: 207b 2762 6566 6f72 6527 3a20 2762 6967   {'before': 'big
-00000420: 696e 7427 2c20 2761 6674 6572 273a 2027  int', 'after': '
-00000430: 696e 7427 7d0a 2020 7d2c 0a20 2027 6e6f  int'}.  },.  'no
-00000440: 745f 6368 616e 6765 6427 3a20 7b0a 2020  t_changed': {.  
-00000450: 2020 276e 616d 6527 2c20 2769 6431 272c    'name', 'id1',
-00000460: 2027 6c61 7374 5f6c 6f67 696e 5f74 7327   'last_login_ts'
-00000470: 2c20 2769 6432 272c 2027 6372 6564 6974  , 'id2', 'credit
-00000480: 7327 2c20 2761 6374 6976 6527 0a20 207d  s', 'active'.  }
-00000490: 0a7d 0a60 6060 0a0a 2323 2043 6f6d 7061  .}.```..## Compa
-000004a0: 7269 6e67 2064 6174 6166 7261 6d65 2773  ring dataframe's
-000004b0: 2064 6174 610a 0a60 6060 7079 7468 6f6e   data..```python
-000004c0: 0a69 6d70 6f72 7420 6264 710a 0a64 6631  .import bdq..df1
-000004d0: 203d 2073 7061 726b 2e63 7265 6174 6544   = spark.createD
-000004e0: 6174 6146 7261 6d65 285b 0a5b 2031 2c20  ataFrame([.[ 1, 
-000004f0: 312c 2022 4772 7a65 676f 727a 222c 2064  1, "Grzegorz", d
-00000500: 6174 6574 696d 6528 3230 3137 2c20 312c  atetime(2017, 1,
-00000510: 2031 292c 2064 6174 6574 696d 6528 3230   1), datetime(20
-00000520: 3138 2c20 312c 2031 2c20 3132 2c20 3334  18, 1, 1, 12, 34
-00000530: 2c20 3536 292c 2032 362e 372c 2031 3233  , 56), 26.7, 123
-00000540: 3233 3432 3334 3334 352c 2054 7275 655d  234234345, True]
-00000550: 2c0a 5b20 322c 2031 2c20 2254 696d 222c  ,.[ 2, 1, "Tim",
-00000560: 2020 2020 2020 6461 7465 7469 6d65 2832        datetime(2
-00000570: 3031 382c 2031 2c20 3129 2c20 6461 7465  018, 1, 1), date
-00000580: 7469 6d65 2832 3031 382c 2032 2c20 312c  time(2018, 2, 1,
-00000590: 2031 322c 2033 342c 2035 3629 2c20 3336   12, 34, 56), 36
-000005a0: 2e37 2c20 3534 3534 352c 2020 2020 2020  .7, 54545,      
-000005b0: 5472 7565 5d2c 0a5b 2033 2c20 312c 2022  True],.[ 3, 1, "
-000005c0: 4d69 6b65 222c 2020 2020 2064 6174 6574  Mike",     datet
-000005d0: 696d 6528 3230 3139 2c20 312c 2031 292c  ime(2019, 1, 1),
-000005e0: 2064 6174 6574 696d 6528 3230 3138 2c20   datetime(2018, 
-000005f0: 332c 2031 2c20 3132 2c20 3334 2c20 3536  3, 1, 12, 34, 56
-00000600: 292c 2034 362e 372c 2035 3636 3738 3838  ), 46.7, 5667888
-00000610: 3938 392c 2046 616c 7365 5d0a 5d2c 2073  989, False].], s
-00000620: 6368 656d 6129 0a0a 6466 3220 3d20 7370  chema)..df2 = sp
-00000630: 6172 6b2e 6372 6561 7465 4461 7461 4672  ark.createDataFr
-00000640: 616d 6528 5b0a 5b20 312c 2031 2c20 2247  ame([.[ 1, 1, "G
-00000650: 727a 6567 6f72 7a22 2c20 6461 7465 7469  rzegorz", dateti
-00000660: 6d65 2832 3031 382c 2031 2c20 3129 2c20  me(2018, 1, 1), 
-00000670: 6461 7465 7469 6d65 2832 3031 382c 2031  datetime(2018, 1
-00000680: 2c20 312c 2031 322c 2033 342c 2035 3629  , 1, 12, 34, 56)
-00000690: 2c20 3236 2e39 2c20 3132 3332 3334 3233  , 26.9, 12323423
-000006a0: 3433 3435 2c20 5472 7565 5d2c 0a5b 2033  4345, True],.[ 3
-000006b0: 2c20 312c 2022 4d69 6b65 222c 2020 2020  , 1, "Mike",    
-000006c0: 2064 6174 6574 696d 6528 3230 3139 2c20   datetime(2019, 
-000006d0: 312c 2031 292c 2064 6174 6574 696d 6528  1, 1), datetime(
-000006e0: 3230 3138 2c20 332c 2031 2c20 3132 2c20  2018, 3, 1, 12, 
-000006f0: 3334 2c20 3536 292c 2034 362e 372c 2035  34, 56), 46.7, 5
-00000700: 3636 3738 3838 3938 392c 2046 616c 7365  667888989, False
-00000710: 5d2c 0a5b 2032 2c20 322c 2022 5469 6d6d  ],.[ 2, 2, "Timm
-00000720: 7922 2c20 2020 2064 6174 6574 696d 6528  y",    datetime(
-00000730: 3230 3138 2c20 312c 2031 292c 2064 6174  2018, 1, 1), dat
-00000740: 6574 696d 6528 3230 3138 2c20 322c 2031  etime(2018, 2, 1
-00000750: 2c20 3132 2c20 3334 2c20 3536 292c 2033  , 12, 34, 56), 3
-00000760: 362e 372c 2038 3735 3438 3537 3834 352c  6.7, 8754857845,
-00000770: 2054 7275 655d 0a5d 2c20 7363 6865 6d61   True].], schema
-00000780: 290a 0a23 7265 7475 726e 7320 6469 6374  )..#returns dict
-00000790: 7320 7769 7468 2061 6464 6564 2c20 7265  s with added, re
-000007a0: 6d6f 7665 642c 2063 6861 6e67 6564 2061  moved, changed a
-000007b0: 6e64 206e 6f74 2063 6861 6e67 6564 2064  nd not changed d
-000007c0: 6174 6166 7261 6d65 732c 2061 6e64 2072  ataframes, and r
-000007d0: 6563 6f72 6420 636f 756e 7473 0a64 665f  ecord counts.df_
-000007e0: 6469 6666 203d 2062 6471 2e63 6f6d 7061  diff = bdq.compa
-000007f0: 7265 5f64 6174 6166 7261 6d65 7328 6466  re_dataframes(df
-00000800: 312c 2064 6632 2c20 5b27 6964 3127 2c20  1, df2, ['id1', 
-00000810: 2769 6432 275d 2c20 5472 7565 290a 0a23  'id2'], True)..#
-00000820: 7368 6f77 2061 6c6c 2069 6e66 6f20 6162  show all info ab
-00000830: 6f75 7420 636f 6d70 6172 6520 7265 7375  out compare resu
-00000840: 6c74 730a 6264 712e 6469 7370 6c61 795f  lts.bdq.display_
-00000850: 636f 6d70 6172 655f 6461 7461 6672 616d  compare_datafram
-00000860: 6573 5f72 6573 756c 7473 2864 665f 6469  es_results(df_di
-00000870: 6666 290a 0a3e 3e20 4164 6465 6420 7265  ff)..>> Added re
-00000880: 636f 7264 7320 636f 756e 743a 2031 0a3e  cords count: 1.>
-00000890: 3e20 2b2d 2d2d 2b2d 2d2d 2b2d 2d2d 2d2d  > +---+---+-----
-000008a0: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  +--------------+
-000008b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000008c0: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  ---+-------+----
-000008d0: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e  ------+------+.>
-000008e0: 3e20 7c69 6431 7c69 6432 7c6e 616d 6520  > |id1|id2|name 
-000008f0: 7c66 6972 7374 5f6c 6f67 696e 5f64 747c  |first_login_dt|
-00000900: 6c61 7374 5f6c 6f67 696e 5f74 7320 2020  last_login_ts   
-00000910: 2020 207c 6372 6564 6974 737c 6c69 6b65     |credits|like
-00000920: 7320 2020 2020 7c61 6374 6976 657c 0a3e  s     |active|.>
-00000930: 3e20 2b2d 2d2d 2b2d 2d2d 2b2d 2d2d 2d2d  > +---+---+-----
-00000940: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  +--------------+
-00000950: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000960: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  ---+-------+----
-00000970: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e  ------+------+.>
-00000980: 3e20 7c32 2020 7c32 2020 7c54 696d 6d79  > |2  |2  |Timmy
-00000990: 7c32 3031 382d 3031 2d30 3120 2020 207c  |2018-01-01    |
-000009a0: 3230 3138 2d30 322d 3031 2031 323a 3334  2018-02-01 12:34
-000009b0: 3a35 367c 3336 2e37 2020 207c 3837 3534  :56|36.7   |8754
-000009c0: 3835 3738 3435 7c74 7275 6520 207c 0a3e  857845|true  |.>
-000009d0: 3e20 2b2d 2d2d 2b2d 2d2d 2b2d 2d2d 2d2d  > +---+---+-----
-000009e0: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  +--------------+
-000009f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000a00: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  ---+-------+----
-00000a10: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e  ------+------+.>
-00000a20: 3e20 0a3e 3e20 5265 6d6f 7665 6420 7265  > .>> Removed re
-00000a30: 636f 7264 7320 636f 756e 743a 2031 0a3e  cords count: 1.>
-00000a40: 3e20 2b2d 2d2d 2b2d 2d2d 2b2d 2d2d 2d2b  > +---+---+----+
-00000a50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
-00000a60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000a70: 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  --+-------+-----
-00000a80: 2b2d 2d2d 2d2d 2d2b 0a3e 3e20 7c69 6431  +------+.>> |id1
-00000a90: 7c69 6432 7c6e 616d 657c 6669 7273 745f  |id2|name|first_
-00000aa0: 6c6f 6769 6e5f 6474 7c6c 6173 745f 6c6f  login_dt|last_lo
-00000ab0: 6769 6e5f 7473 2020 2020 2020 7c63 7265  gin_ts      |cre
-00000ac0: 6469 7473 7c6c 696b 6573 7c61 6374 6976  dits|likes|activ
-00000ad0: 657c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d  e|.>> +---+---+-
-00000ae0: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
-00000af0: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
-00000b00: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d  ------+-------+-
-00000b10: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e 3e20  ----+------+.>> 
-00000b20: 7c32 2020 7c31 2020 7c54 696d 207c 3230  |2  |1  |Tim |20
-00000b30: 3138 2d30 312d 3031 2020 2020 7c32 3031  18-01-01    |201
-00000b40: 382d 3032 2d30 3120 3132 3a33 343a 3536  8-02-01 12:34:56
-00000b50: 7c33 362e 3720 2020 7c35 3435 3435 7c74  |36.7   |54545|t
-00000b60: 7275 6520 207c 0a3e 3e20 2b2d 2d2d 2b2d  rue  |.>> +---+-
-00000b70: 2d2d 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  --+----+--------
-00000b80: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  ------+---------
-00000b90: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
-00000ba0: 2d2d 2b2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b  --+-----+------+
-00000bb0: 0a3e 3e20 0a3e 3e20 4368 616e 6765 6420  .>> .>> Changed 
-00000bc0: 7265 636f 7264 7320 636f 756e 743a 2031  records count: 1
-00000bd0: 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d 2d2d  .>> +---+---+---
-00000be0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000bf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000c00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000c10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000c20: 2d2d 2b0a 3e3e 207c 6964 317c 6964 327c  --+.>> |id1|id2|
-00000c30: 6368 616e 6765 6420 2020 2020 2020 2020  changed         
-00000c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000c70: 2020 2020 207c 0a3e 3e20 2b2d 2d2d 2b2d       |.>> +---+-
-00000c80: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
-00000c90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000ca0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000cb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000cc0: 2d2d 2d2d 2d2d 2d2d 2b0a 3e3e 207c 3120  --------+.>> |1 
-00000cd0: 207c 3120 207c 7b66 6972 7374 5f6c 6f67   |1  |{first_log
-00000ce0: 696e 5f64 7420 2d3e 207b 3230 3137 2d30  in_dt -> {2017-0
-00000cf0: 312d 3031 2c20 3230 3138 2d30 312d 3031  1-01, 2018-01-01
-00000d00: 7d2c 2063 7265 6469 7473 202d 3e20 7b32  }, credits -> {2
-00000d10: 362e 372c 2032 362e 397d 7d7c 0a3e 3e20  6.7, 26.9}}|.>> 
-00000d20: 2b2d 2d2d 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d  +---+---+-------
-00000d30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000d40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000d50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000d60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a  --------------+.
-00000d70: 0a4e 6f74 2063 6861 6e67 6564 2072 6563  .Not changed rec
-00000d80: 6f72 6473 2063 6f75 6e74 3a20 310a 6060  ords count: 1.``
-00000d90: 600a 0a23 2320 5375 7272 6f67 6174 6520  `..## Surrogate 
-00000da0: 6b65 7920 6765 6e65 7261 7469 6f6e 0a77  key generation.w
-00000db0: 6974 6820 7375 7070 6f72 7420 6f66 206f  ith support of o
-00000dc0: 7074 696f 6e61 6c20 7570 7065 7263 6173  ptional uppercas
-00000dd0: 696e 6720 616e 6420 7472 696d 6d69 6e67  ing and trimming
-00000de0: 206f 6620 6b65 7920 636f 6c75 6d6e 730a   of key columns.
-00000df0: 0a60 6060 7079 7468 6f6e 0a66 726f 6d20  .```python.from 
-00000e00: 6461 7465 7469 6d65 2069 6d70 6f72 7420  datetime import 
-00000e10: 6461 7465 7469 6d65 0a66 726f 6d20 6264  datetime.from bd
-00000e20: 712e 6675 6e63 7469 6f6e 7320 696d 706f  q.functions impo
-00000e30: 7274 2073 7572 726f 6761 7465 5f6b 6579  rt surrogate_key
-00000e40: 5f68 6173 682c 2073 7572 726f 6761 7465  _hash, surrogate
-00000e50: 5f6b 6579 5f73 7472 696e 670a 0a73 6368  _key_string..sch
-00000e60: 656d 6120 3d20 2269 6431 3a6c 6f6e 672c  ema = "id1:long,
-00000e70: 6964 323a 6c6f 6e67 2c6e 616d 653a 7374  id2:long,name:st
-00000e80: 7269 6e67 2c6c 696b 6573 3a69 6e74 220a  ring,likes:int".
-00000e90: 0a64 6631 203d 2073 7061 726b 2e63 7265  .df1 = spark.cre
-00000ea0: 6174 6544 6174 6146 7261 6d65 285b 0a20  ateDataFrame([. 
-00000eb0: 205b 2031 2c20 312c 2022 4772 7a65 476f   [ 1, 1, "GrzeGo
-00000ec0: 727a 222c 2031 205d 2c0a 2020 5b20 312c  rz", 1 ],.  [ 1,
-00000ed0: 2031 2c20 2247 727a 6567 6f72 7a22 2c20   1, "Grzegorz", 
-00000ee0: 2031 205d 2c0a 2020 5b20 312c 2031 2c20   1 ],.  [ 1, 1, 
-00000ef0: 2247 727a 6567 6f72 7a20 2020 2020 2022  "Grzegorz      "
-00000f00: 2c20 2031 205d 2c0a 2020 5b20 312c 204e  ,  1 ],.  [ 1, N
-00000f10: 6f6e 652c 2022 4772 7a65 676f 727a 222c  one, "Grzegorz",
-00000f20: 2031 5d2c 0a20 205b 2031 2c20 4e6f 6e65   1],.  [ 1, None
-00000f30: 2c20 4e6f 6e65 2c20 315d 2c0a 2020 5b20  , None, 1],.  [ 
-00000f40: 322c 2031 2c20 2254 696d 222c 2031 205d  2, 1, "Tim", 1 ]
-00000f50: 2c0a 2020 5b20 332c 2031 2c20 224d 696b  ,.  [ 3, 1, "Mik
-00000f60: 6522 2c20 3120 5d0a 5d2c 2073 6368 656d  e", 1 ].], schem
-00000f70: 6129 0a0a 736b 5f64 6620 3d20 6466 312e  a)..sk_df = df1.
-00000f80: 7365 6c65 6374 280a 2020 272a 272c 200a  select(.  '*', .
-00000f90: 2020 7375 7272 6f67 6174 655f 6b65 795f    surrogate_key_
-00000fa0: 6861 7368 285b 2769 6431 272c 2027 6964  hash(['id1', 'id
-00000fb0: 3227 2c20 276e 616d 6527 5d2c 2072 7472  2', 'name'], rtr
-00000fc0: 696d 3d54 7275 6529 2e61 6c69 6173 2827  im=True).alias('
-00000fd0: 6861 7368 2729 2c0a 2020 7375 7272 6f67  hash'),.  surrog
-00000fe0: 6174 655f 6b65 795f 7374 7269 6e67 285b  ate_key_string([
-00000ff0: 2769 6431 272c 2027 6964 3227 2c20 276e  'id1', 'id2', 'n
-00001000: 616d 6527 5d2c 2072 7472 696d 3d54 7275  ame'], rtrim=Tru
-00001010: 6529 2e61 6c69 6173 2827 6861 7368 5f69  e).alias('hash_i
-00001020: 6e70 7574 2729 0a29 0a0a 3e3e 202b 2d2d  nput').)..>> +--
-00001030: 2d2b 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  -+----+---------
-00001040: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2b 2d2d 2d2d  -----+-----+----
-00001050: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001060: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001070: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001080: 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  ---------+------
-00001090: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000010a0: 2d2d 2d2d 2d2b 0a3e 3e20 7c69 6431 7c69  -----+.>> |id1|i
-000010b0: 6432 207c 6e61 6d65 2020 2020 2020 2020  d2 |name        
-000010c0: 2020 7c6c 696b 6573 7c68 6173 6820 2020    |likes|hash   
-000010d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000010e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000010f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001100: 2020 2020 2020 7c68 6173 685f 696e 7075        |hash_inpu
-00001110: 7420 2020 2020 2020 2020 2020 2020 2020  t               
-00001120: 2020 7c0a 3e3e 202b 2d2d 2d2b 2d2d 2d2d    |.>> +---+----
-00001130: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  +--------------+
-00001140: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
-00001150: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001160: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001170: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00000000: 4d65 7461 6461 7461 2d56 6572 7369 6f6e  Metadata-Version
+00000010: 3a20 322e 310a 4e61 6d65 3a20 6264 710a  : 2.1.Name: bdq.
+00000020: 5665 7273 696f 6e3a 2030 2e31 2e30 0a53  Version: 0.1.0.S
+00000030: 756d 6d61 7279 3a20 4269 6720 4461 7461  ummary: Big Data
+00000040: 2051 7561 6c69 7479 2c20 6120 7365 7420   Quality, a set 
+00000050: 6f66 2074 6f6f 6c73 2f66 756e 6374 696f  of tools/functio
+00000060: 6e20 7468 6174 2068 656c 7020 796f 7520  n that help you 
+00000070: 6576 6572 7920 6461 7920 6173 7365 7274  every day assert
+00000080: 2071 7561 6c69 7479 206f 6620 6461 7461   quality of data
+00000090: 7365 7473 2079 6f75 2068 6176 6520 7072  sets you have pr
+000000a0: 6f63 6573 7365 6420 6f72 2069 6e67 6573  ocessed or inges
+000000b0: 7465 640a 4175 7468 6f72 2d65 6d61 696c  ted.Author-email
+000000c0: 3a20 4772 7a65 676f 727a 2052 7573 696e  : Grzegorz Rusin
+000000d0: 203c 6772 7a65 676f 727a 2e72 7573 696e   <grzegorz.rusin
+000000e0: 4064 6174 6162 7269 636b 732e 636f 6d3e  @databricks.com>
+000000f0: 0a50 726f 6a65 6374 2d55 524c 3a20 486f  .Project-URL: Ho
+00000100: 6d65 7061 6765 2c20 6874 7470 733a 2f2f  mepage, https://
+00000110: 6769 7468 7562 2e63 6f6d 2f67 7275 7369  github.com/grusi
+00000120: 6e2d 6462 2f62 6471 0a50 726f 6a65 6374  n-db/bdq.Project
+00000130: 2d55 524c 3a20 4275 6720 5472 6163 6b65  -URL: Bug Tracke
+00000140: 722c 2068 7474 7073 3a2f 2f67 6974 6875  r, https://githu
+00000150: 622e 636f 6d2f 6772 7573 696e 2d64 622f  b.com/grusin-db/
+00000160: 6264 712f 6973 7375 6573 0a43 6c61 7373  bdq/issues.Class
+00000170: 6966 6965 723a 2050 726f 6772 616d 6d69  ifier: Programmi
+00000180: 6e67 204c 616e 6775 6167 6520 3a3a 2050  ng Language :: P
+00000190: 7974 686f 6e20 3a3a 2033 0a43 6c61 7373  ython :: 3.Class
+000001a0: 6966 6965 723a 204c 6963 656e 7365 203a  ifier: License :
+000001b0: 3a20 4f53 4920 4170 7072 6f76 6564 203a  : OSI Approved :
+000001c0: 3a20 4170 6163 6865 2053 6f66 7477 6172  : Apache Softwar
+000001d0: 6520 4c69 6365 6e73 650a 436c 6173 7369  e License.Classi
+000001e0: 6669 6572 3a20 4f70 6572 6174 696e 6720  fier: Operating 
+000001f0: 5379 7374 656d 203a 3a20 4f53 2049 6e64  System :: OS Ind
+00000200: 6570 656e 6465 6e74 0a52 6571 7569 7265  ependent.Require
+00000210: 732d 5079 7468 6f6e 3a20 3e3d 332e 380a  s-Python: >=3.8.
+00000220: 4465 7363 7269 7074 696f 6e2d 436f 6e74  Description-Cont
+00000230: 656e 742d 5479 7065 3a20 7465 7874 2f6d  ent-Type: text/m
+00000240: 6172 6b64 6f77 6e0a 4c69 6365 6e73 652d  arkdown.License-
+00000250: 4669 6c65 3a20 4c49 4345 4e53 450a 0a23  File: LICENSE..#
+00000260: 2057 6861 7420 6973 2062 6471 3f0a 0a42   What is bdq?..B
+00000270: 4451 2073 7461 6e64 7320 666f 7220 4269  DQ stands for Bi
+00000280: 6720 4461 7461 2051 7561 6c69 7479 2c20  g Data Quality, 
+00000290: 6120 7365 7420 6f66 2074 6f6f 6c73 2f66  a set of tools/f
+000002a0: 756e 6374 696f 6e20 7468 6174 2068 656c  unction that hel
+000002b0: 7020 796f 7520 6576 6572 7920 6461 7920  p you every day 
+000002c0: 6173 7365 7274 2071 7561 6c69 7479 206f  assert quality o
+000002d0: 6620 6461 7461 7365 7473 2079 6f75 2068  f datasets you h
+000002e0: 6176 6520 7072 6f63 6573 7365 6420 6f72  ave processed or
+000002f0: 2069 6e67 6573 7465 642e 204c 6962 7261   ingested. Libra
+00000300: 7279 206c 6576 6572 6167 6573 2070 6f77  ry leverages pow
+00000310: 6572 206f 6620 7370 6172 6b2c 2068 656e  er of spark, hen
+00000320: 6365 2069 7420 7072 6f63 6573 7365 7320  ce it processes 
+00000330: 796f 7572 2071 7561 6c69 7479 2063 6865  your quality che
+00000340: 636b 7320 6174 2073 6361 6c65 206f 6666  cks at scale off
+00000350: 6572 6564 2062 7920 7370 6172 6b20 616e  ered by spark an
+00000360: 6420 6461 7461 6272 6963 6b73 2e0a 0a4c  d databricks...L
+00000370: 6962 7261 7279 206f 7665 7220 7469 6d65  ibrary over time
+00000380: 2065 766f 6c76 6564 2069 6e74 6f20 4441   evolved into DA
+00000390: 4720 6578 6563 7574 6f72 206f 6620 6172  G executor of ar
+000003a0: 6269 7472 6172 7920 7079 7468 6f6e 2f70  bitrary python/p
+000003b0: 7973 7061 726b 2066 756e 6374 696f 6e73  yspark functions
+000003c0: 2e20 5468 6973 2061 6c6c 6f77 7320 746f  . This allows to
+000003d0: 2073 6361 6c65 2065 7865 6375 7469 6f6e   scale execution
+000003e0: 2077 6974 6820 6465 7065 6e64 656e 6379   with dependency
+000003f0: 2074 7261 636b 696e 6720 746f 206e 6578   tracking to nex
+00000400: 7420 6c65 7665 6c2e 0a0a 2323 2048 6f77  t level...## How
+00000410: 2074 6f20 696e 7374 616c 6c3f 0a0a 4f6e   to install?..On
+00000420: 2064 6174 6162 7269 636b 7320 7275 6e20   databricks run 
+00000430: 6025 7069 7020 696e 7374 616c 6c20 6264  `%pip install bd
+00000440: 713d 3d78 2e79 2e7a 602e 204d 616b 6520  q==x.y.z`. Make 
+00000450: 7375 7265 2079 6f75 2074 6167 2076 6572  sure you tag ver
+00000460: 7369 6f6e 206e 756d 6265 7220 796f 7520  sion number you 
+00000470: 6172 6520 636f 6e66 6f72 7461 626c 6520  are confortable 
+00000480: 7769 7468 2074 6f20 656e 7375 7265 2041  with to ensure A
+00000490: 5049 2073 7461 6269 6c69 7479 2e0a 0a54  PI stability...T
+000004a0: 6869 7320 7061 636b 6167 6520 6973 2063  his package is c
+000004b0: 7572 7265 6e74 6c79 2069 6e20 4558 5045  urrently in EXPE
+000004c0: 5249 4d45 4e54 414c 2073 7461 6765 2061  RIMENTAL stage a
+000004d0: 6e64 206e 6577 6572 2072 656c 6573 6573  nd newer releses
+000004e0: 206d 6967 6874 2063 6861 6e67 6520 4150   might change AP
+000004f0: 4973 2028 6675 6e63 7469 6f6e 206e 616d  Is (function nam
+00000500: 6573 2c20 7061 7261 6d65 7465 7273 2c20  es, parameters, 
+00000510: 6574 632e 2e29 2e0a 0a23 2320 5375 7070  etc..)...## Supp
+00000520: 6f72 7465 6420 7370 6172 6b2f 6461 7461  orted spark/data
+00000530: 6272 6963 6b73 2076 6572 7369 6f6e 730a  bricks versions.
+00000540: 0a44 6576 656c 6f70 6d65 6e74 2061 6e64  .Development and
+00000550: 2074 6573 7469 6e67 2068 6173 2062 6565   testing has bee
+00000560: 6e20 7065 7266 6f72 6d65 6420 6f6e 2031  n performed on 1
+00000570: 322e 3220 4c54 5320 6461 7461 6272 6963  2.2 LTS databric
+00000580: 6b73 2072 756e 7469 6d65 2e20 4461 7461  ks runtime. Data
+00000590: 6272 6963 6b73 2072 756e 7469 6d65 2031  bricks runtime 1
+000005a0: 302e 3420 4c54 5320 7368 6f75 6c64 2061  0.4 LTS should a
+000005b0: 6c73 6f20 776f 726b 2077 6974 6820 6578  lso work with ex
+000005c0: 6365 7074 696f 6e20 6f66 2060 5370 6172  ception of `Spar
+000005d0: 6b50 6970 656c 696e 652e 7374 6570 5f73  kPipeline.step_s
+000005e0: 7061 726b 5f66 6f72 5f65 6163 685f 6261  park_for_each_ba
+000005f0: 7463 6860 2061 6e64 2060 5370 6172 6b50  tch` and `SparkP
+00000600: 6970 656c 696e 652e 7370 6172 6b5f 6d65  ipeline.spark_me
+00000610: 7472 6963 6020 7768 6963 6820 7265 7175  tric` which requ
+00000620: 6972 6520 3132 2e32 204c 5453 2072 756e  ire 12.2 LTS run
+00000630: 7469 6d65 2074 6f20 776f 726b 2e0a 0a23  time to work...#
+00000640: 2320 5665 7262 6f73 6520 6f75 7470 7574  # Verbose output
+00000650: 0a0a 6264 7120 7574 696c 697a 6573 2070  ..bdq utilizes p
+00000660: 7974 686f 6e20 606c 6f67 6769 6e67 6020  ython `logging` 
+00000670: 6d6f 6475 6c65 2c20 6865 6e63 6520 666f  module, hence fo
+00000680: 7220 7468 6520 6265 7374 206c 6f67 6769  r the best loggi
+00000690: 6e67 2065 7870 6572 6965 6e63 6520 636f  ng experience co
+000006a0: 6e66 6967 7572 6520 6c6f 6767 6572 2c20  nfigure logger, 
+000006b0: 6578 616d 706c 6520 7365 7475 703a 0a0a  example setup:..
+000006c0: 6060 6070 7974 686f 6e0a 696d 706f 7274  ```python.import
+000006d0: 206c 6f67 6769 6e67 0a69 6d70 6f72 7420   logging.import 
+000006e0: 7379 730a 0a23 2070 7934 6a20 6973 2076  sys..# py4j is v
+000006f0: 6572 7920 6368 6174 7479 2c20 6e6f 206e  ery chatty, no n
+00000700: 6565 6420 746f 2064 6561 6c20 7769 7468  eed to deal with
+00000710: 2069 7420 756e 6c65 7373 2069 7427 7320   it unless it's 
+00000720: 6372 6974 6963 616c 0a6c 6f67 6769 6e67  critical.logging
+00000730: 2e67 6574 4c6f 6767 6572 2827 7079 346a  .getLogger('py4j
+00000740: 2729 2e73 6574 4c65 7665 6c28 6c6f 6767  ').setLevel(logg
+00000750: 696e 672e 4352 4954 4943 414c 290a 0a23  ing.CRITICAL)..#
+00000760: 2072 756e 2065 7665 7279 7468 696e 6720   run everything 
+00000770: 656c 7365 206f 6e20 4445 4255 4720 6279  else on DEBUG by
+00000780: 2064 6566 6175 6c74 0a23 2044 4542 5547   default.# DEBUG
+00000790: 2070 7269 6e74 7320 6120 6c6f 7420 6f66   prints a lot of
+000007a0: 2075 7365 6675 6c6c 2069 6e66 6f2c 2049   usefull info, I
+000007b0: 4e46 4f20 6973 2067 6f6f 6420 696e 2067  NFO is good in g
+000007c0: 656e 6572 616c 2075 7365 2063 6173 6573  eneral use cases
+000007d0: 0a6c 6f67 6769 6e67 2e62 6173 6963 436f  .logging.basicCo
+000007e0: 6e66 6967 280a 2020 7374 7265 616d 3d73  nfig(.  stream=s
+000007f0: 7973 2e73 7464 6572 722c 0a20 206c 6576  ys.stderr,.  lev
+00000800: 656c 3d6c 6f67 6769 6e67 2e44 4542 5547  el=logging.DEBUG
+00000810: 2c20 0a20 2066 6f72 6d61 743d 2725 2861  , .  format='%(a
+00000820: 7363 7469 6d65 2973 2025 286c 6576 656c  sctime)s %(level
+00000830: 6e61 6d65 2973 2025 2874 6872 6561 644e  name)s %(threadN
+00000840: 616d 6529 7320 5b25 286e 616d 6529 735d  ame)s [%(name)s]
+00000850: 2025 286d 6573 7361 6765 2973 270a 290a   %(message)s'.).
+00000860: 6060 600a 0a23 2323 2045 7861 6d70 6c65  ```..### Example
+00000870: 730a 0a53 6565 2065 7861 6d70 6c65 7320  s..See examples 
+00000880: 6265 6c6c 6f77 2066 6f72 2073 686f 7274  bellow for short
+00000890: 206c 6973 7469 6e67 206f 6620 6d61 6a6f   listing of majo
+000008a0: 7220 6675 6e63 7469 6f6e 616c 6974 6965  r functionalitie
+000008b0: 732e 2053 6565 2060 7465 7374 7360 2066  s. See `tests` f
+000008c0: 6f6c 6465 7220 666f 7220 6465 7461 696c  older for detail
+000008d0: 6564 2065 7861 6d70 6c65 732e 2054 6573  ed examples. Tes
+000008e0: 7473 2061 7265 206d 6561 6e74 2074 6f20  ts are meant to 
+000008f0: 646f 7562 6c65 2061 7320 7265 616c 2075  double as real u
+00000900: 7365 2063 6173 6573 2068 656e 6365 2074  se cases hence t
+00000910: 6865 7920 7365 7276 6520 6173 2064 6f63  hey serve as doc
+00000920: 756d 656e 7461 7469 6f6e 206f 6620 6578  umentation of ex
+00000930: 616d 706c 6573 2066 6f72 206e 6f77 2e0a  amples for now..
+00000940: 0a23 2320 436f 6d70 6172 696e 6720 6461  .## Comparing da
+00000950: 7461 6672 616d 6520 7363 6865 6d61 730a  taframe schemas.
+00000960: 0a60 6060 7079 7468 6f6e 0a69 6d70 6f72  .```python.impor
+00000970: 7420 6264 710a 6672 6f6d 2064 6174 6574  t bdq.from datet
+00000980: 696d 6520 696d 706f 7274 2064 6174 6574  ime import datet
+00000990: 696d 650a 696d 706f 7274 2070 7973 7061  ime.import pyspa
+000009a0: 726b 2e73 716c 2e66 756e 6374 696f 6e73  rk.sql.functions
+000009b0: 2061 7320 460a 0a64 6632 203d 2073 7061   as F..df2 = spa
+000009c0: 726b 2e63 7265 6174 6544 6174 6146 7261  rk.createDataFra
+000009d0: 6d65 285b 0a5b 2031 2c20 312c 2022 4772  me([.[ 1, 1, "Gr
+000009e0: 7a65 676f 727a 222c 2064 6174 6574 696d  zegorz", datetim
+000009f0: 6528 3230 3138 2c20 312c 2031 292c 2064  e(2018, 1, 1), d
+00000a00: 6174 6574 696d 6528 3230 3138 2c20 312c  atetime(2018, 1,
+00000a10: 2031 2c20 3132 2c20 3334 2c20 3536 292c   1, 12, 34, 56),
+00000a20: 2032 362e 392c 2031 3233 3233 3432 3334   26.9, 123234234
+00000a30: 3334 352c 2054 7275 655d 2c0a 5b20 332c  345, True],.[ 3,
+00000a40: 2031 2c20 224d 696b 6522 2c20 2020 2020   1, "Mike",     
+00000a50: 6461 7465 7469 6d65 2832 3031 392c 2031  datetime(2019, 1
+00000a60: 2c20 3129 2c20 6461 7465 7469 6d65 2832  , 1), datetime(2
+00000a70: 3031 382c 2033 2c20 312c 2031 322c 2033  018, 3, 1, 12, 3
+00000a80: 342c 2035 3629 2c20 3436 2e37 2c20 3536  4, 56), 46.7, 56
+00000a90: 3637 3838 3839 3839 2c20 4661 6c73 655d  67888989, False]
+00000aa0: 2c0a 5b20 322c 2032 2c20 2254 696d 6d79  ,.[ 2, 2, "Timmy
+00000ab0: 222c 2020 2020 6461 7465 7469 6d65 2832  ",    datetime(2
+00000ac0: 3031 382c 2031 2c20 3129 2c20 6461 7465  018, 1, 1), date
+00000ad0: 7469 6d65 2832 3031 382c 2032 2c20 312c  time(2018, 2, 1,
+00000ae0: 2031 322c 2033 342c 2035 3629 2c20 3336   12, 34, 56), 36
+00000af0: 2e37 2c20 3837 3534 3835 3738 3435 2c20  .7, 8754857845, 
+00000b00: 5472 7565 5d0a 5d2c 2073 6368 656d 6129  True].], schema)
+00000b10: 0a0a 6466 325f 6368 616e 6765 6420 3d20  ..df2_changed = 
+00000b20: 6466 3220 5c0a 2020 2e64 726f 7028 2766  df2 \.  .drop('f
+00000b30: 6972 7374 5f6c 6f67 696e 5f64 7427 2920  irst_login_dt') 
+00000b40: 5c0a 2020 2e77 6974 6843 6f6c 756d 6e28  \.  .withColumn(
+00000b50: 276e 6577 5f64 6174 6127 2c20 462e 6c69  'new_data', F.li
+00000b60: 7428 4e6f 6e65 292e 6361 7374 2827 6461  t(None).cast('da
+00000b70: 7465 2729 2920 5c0a 2020 2e77 6974 6843  te')) \.  .withC
+00000b80: 6f6c 756d 6e28 276c 696b 6573 272c 2046  olumn('likes', F
+00000b90: 2e63 6f6c 2827 6c69 6b65 7327 292e 6361  .col('likes').ca
+00000ba0: 7374 2827 696e 7427 2929 0a0a 6173 7365  st('int'))..asse
+00000bb0: 7274 2062 6471 2e63 6f6d 7061 7265 5f73  rt bdq.compare_s
+00000bc0: 6368 656d 6173 2864 6632 2e73 6368 656d  chemas(df2.schem
+00000bd0: 612c 2064 6632 5f63 6861 6e67 6564 2e73  a, df2_changed.s
+00000be0: 6368 656d 6129 203d 3d20 7b0a 2020 2761  chema) == {.  'a
+00000bf0: 6464 6564 273a 207b 2766 6972 7374 5f6c  dded': {'first_l
+00000c00: 6f67 696e 5f64 7427 7d2c 200a 2020 2772  ogin_dt'}, .  'r
+00000c10: 656d 6f76 6564 273a 207b 276e 6577 5f64  emoved': {'new_d
+00000c20: 6174 6127 7d2c 200a 2020 2763 6861 6e67  ata'}, .  'chang
+00000c30: 6564 273a 207b 0a20 2020 2027 6c69 6b65  ed': {.    'like
+00000c40: 7327 3a20 7b27 6265 666f 7265 273a 2027  s': {'before': '
+00000c50: 6269 6769 6e74 272c 2027 6166 7465 7227  bigint', 'after'
+00000c60: 3a20 2769 6e74 277d 0a20 207d 2c0a 2020  : 'int'}.  },.  
+00000c70: 276e 6f74 5f63 6861 6e67 6564 273a 207b  'not_changed': {
+00000c80: 0a20 2020 2027 6e61 6d65 272c 2027 6964  .    'name', 'id
+00000c90: 3127 2c20 276c 6173 745f 6c6f 6769 6e5f  1', 'last_login_
+00000ca0: 7473 272c 2027 6964 3227 2c20 2763 7265  ts', 'id2', 'cre
+00000cb0: 6469 7473 272c 2027 6163 7469 7665 270a  dits', 'active'.
+00000cc0: 2020 7d0a 7d0a 6060 600a 0a23 2323 2043    }.}.```..### C
+00000cd0: 6f6d 7061 7269 6e67 2064 6174 6166 7261  omparing datafra
+00000ce0: 6d65 2773 2064 6174 610a 0a60 6060 7079  me's data..```py
+00000cf0: 7468 6f6e 0a69 6d70 6f72 7420 6264 710a  thon.import bdq.
+00000d00: 0a64 6631 203d 2073 7061 726b 2e63 7265  .df1 = spark.cre
+00000d10: 6174 6544 6174 6146 7261 6d65 285b 0a5b  ateDataFrame([.[
+00000d20: 2031 2c20 312c 2022 4772 7a65 676f 727a   1, 1, "Grzegorz
+00000d30: 222c 2064 6174 6574 696d 6528 3230 3137  ", datetime(2017
+00000d40: 2c20 312c 2031 292c 2064 6174 6574 696d  , 1, 1), datetim
+00000d50: 6528 3230 3138 2c20 312c 2031 2c20 3132  e(2018, 1, 1, 12
+00000d60: 2c20 3334 2c20 3536 292c 2032 362e 372c  , 34, 56), 26.7,
+00000d70: 2031 3233 3233 3432 3334 3334 352c 2054   123234234345, T
+00000d80: 7275 655d 2c0a 5b20 322c 2031 2c20 2254  rue],.[ 2, 1, "T
+00000d90: 696d 222c 2020 2020 2020 6461 7465 7469  im",      dateti
+00000da0: 6d65 2832 3031 382c 2031 2c20 3129 2c20  me(2018, 1, 1), 
+00000db0: 6461 7465 7469 6d65 2832 3031 382c 2032  datetime(2018, 2
+00000dc0: 2c20 312c 2031 322c 2033 342c 2035 3629  , 1, 12, 34, 56)
+00000dd0: 2c20 3336 2e37 2c20 3534 3534 352c 2020  , 36.7, 54545,  
+00000de0: 2020 2020 5472 7565 5d2c 0a5b 2033 2c20      True],.[ 3, 
+00000df0: 312c 2022 4d69 6b65 222c 2020 2020 2064  1, "Mike",     d
+00000e00: 6174 6574 696d 6528 3230 3139 2c20 312c  atetime(2019, 1,
+00000e10: 2031 292c 2064 6174 6574 696d 6528 3230   1), datetime(20
+00000e20: 3138 2c20 332c 2031 2c20 3132 2c20 3334  18, 3, 1, 12, 34
+00000e30: 2c20 3536 292c 2034 362e 372c 2035 3636  , 56), 46.7, 566
+00000e40: 3738 3838 3938 392c 2046 616c 7365 5d0a  7888989, False].
+00000e50: 5d2c 2073 6368 656d 6129 0a0a 6466 3220  ], schema)..df2 
+00000e60: 3d20 7370 6172 6b2e 6372 6561 7465 4461  = spark.createDa
+00000e70: 7461 4672 616d 6528 5b0a 5b20 312c 2031  taFrame([.[ 1, 1
+00000e80: 2c20 2247 727a 6567 6f72 7a22 2c20 6461  , "Grzegorz", da
+00000e90: 7465 7469 6d65 2832 3031 382c 2031 2c20  tetime(2018, 1, 
+00000ea0: 3129 2c20 6461 7465 7469 6d65 2832 3031  1), datetime(201
+00000eb0: 382c 2031 2c20 312c 2031 322c 2033 342c  8, 1, 1, 12, 34,
+00000ec0: 2035 3629 2c20 3236 2e39 2c20 3132 3332   56), 26.9, 1232
+00000ed0: 3334 3233 3433 3435 2c20 5472 7565 5d2c  34234345, True],
+00000ee0: 0a5b 2033 2c20 312c 2022 4d69 6b65 222c  .[ 3, 1, "Mike",
+00000ef0: 2020 2020 2064 6174 6574 696d 6528 3230       datetime(20
+00000f00: 3139 2c20 312c 2031 292c 2064 6174 6574  19, 1, 1), datet
+00000f10: 696d 6528 3230 3138 2c20 332c 2031 2c20  ime(2018, 3, 1, 
+00000f20: 3132 2c20 3334 2c20 3536 292c 2034 362e  12, 34, 56), 46.
+00000f30: 372c 2035 3636 3738 3838 3938 392c 2046  7, 5667888989, F
+00000f40: 616c 7365 5d2c 0a5b 2032 2c20 322c 2022  alse],.[ 2, 2, "
+00000f50: 5469 6d6d 7922 2c20 2020 2064 6174 6574  Timmy",    datet
+00000f60: 696d 6528 3230 3138 2c20 312c 2031 292c  ime(2018, 1, 1),
+00000f70: 2064 6174 6574 696d 6528 3230 3138 2c20   datetime(2018, 
+00000f80: 322c 2031 2c20 3132 2c20 3334 2c20 3536  2, 1, 12, 34, 56
+00000f90: 292c 2033 362e 372c 2038 3735 3438 3537  ), 36.7, 8754857
+00000fa0: 3834 352c 2054 7275 655d 0a5d 2c20 7363  845, True].], sc
+00000fb0: 6865 6d61 290a 0a23 7265 7475 726e 7320  hema)..#returns 
+00000fc0: 6469 6374 7320 7769 7468 2061 6464 6564  dicts with added
+00000fd0: 2c20 7265 6d6f 7665 642c 2063 6861 6e67  , removed, chang
+00000fe0: 6564 2061 6e64 206e 6f74 2063 6861 6e67  ed and not chang
+00000ff0: 6564 2064 6174 6166 7261 6d65 732c 2061  ed dataframes, a
+00001000: 6e64 2072 6563 6f72 6420 636f 756e 7473  nd record counts
+00001010: 0a64 665f 6469 6666 203d 2062 6471 2e63  .df_diff = bdq.c
+00001020: 6f6d 7061 7265 5f64 6174 6166 7261 6d65  ompare_dataframe
+00001030: 7328 6466 312c 2064 6632 2c20 5b27 6964  s(df1, df2, ['id
+00001040: 3127 2c20 2769 6432 275d 2c20 5472 7565  1', 'id2'], True
+00001050: 290a 0a23 7368 6f77 2061 6c6c 2069 6e66  )..#show all inf
+00001060: 6f20 6162 6f75 7420 636f 6d70 6172 6520  o about compare 
+00001070: 7265 7375 6c74 730a 6264 712e 6469 7370  results.bdq.disp
+00001080: 6c61 795f 636f 6d70 6172 655f 6461 7461  lay_compare_data
+00001090: 6672 616d 6573 5f72 6573 756c 7473 2864  frames_results(d
+000010a0: 665f 6469 6666 290a 0a3e 3e20 4164 6465  f_diff)..>> Adde
+000010b0: 6420 7265 636f 7264 7320 636f 756e 743a  d records count:
+000010c0: 2031 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d   1.>> +---+---+-
+000010d0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+000010e0: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+000010f0: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b  -------+-------+
+00001100: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00001110: 2d2b 0a3e 3e20 7c69 6431 7c69 6432 7c6e  -+.>> |id1|id2|n
+00001120: 616d 6520 7c66 6972 7374 5f6c 6f67 696e  ame |first_login
+00001130: 5f64 747c 6c61 7374 5f6c 6f67 696e 5f74  _dt|last_login_t
+00001140: 7320 2020 2020 207c 6372 6564 6974 737c  s      |credits|
+00001150: 6c69 6b65 7320 2020 2020 7c61 6374 6976  likes     |activ
+00001160: 657c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d  e|.>> +---+---+-
+00001170: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
 00001180: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
-00001190: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
-000011a0: 0a3e 3e20 7c31 2020 7c31 2020 207c 4772  .>> |1  |1   |Gr
-000011b0: 7a65 476f 727a 2020 2020 2020 7c31 2020  zeGorz      |1  
-000011c0: 2020 7c5b 3646 2032 3120 3939 2039 3920    |[6F 21 99 99 
-000011d0: 3443 2046 3220 3933 2035 3620 3245 2037  4C F2 93 56 2E 7
-000011e0: 4320 4333 2032 3920 4639 2036 4120 3432  C C3 29 F9 6A 42
-000011f0: 2032 4620 3644 2036 3220 4543 2034 425d   2F 6D 62 EC 4B]
-00001200: 7c5b 312c 2031 2c20 4752 5a45 474f 525a  |[1, 1, GRZEGORZ
-00001210: 5d20 2020 2020 2020 2020 2020 7c0a 3e3e  ]           |.>>
-00001220: 207c 3120 207c 3120 2020 7c47 727a 6567   |1  |1   |Grzeg
-00001230: 6f72 7a20 2020 2020 207c 3120 2020 207c  orz      |1    |
-00001240: 5b36 4620 3231 2039 3920 3939 2034 4320  [6F 21 99 99 4C 
-00001250: 4632 2039 3320 3536 2032 4520 3743 2043  F2 93 56 2E 7C C
-00001260: 3320 3239 2046 3920 3641 2034 3220 3246  3 29 F9 6A 42 2F
-00001270: 2036 4420 3632 2045 4320 3442 5d7c 5b31   6D 62 EC 4B]|[1
-00001280: 2c20 312c 2047 525a 4547 4f52 5a5d 2020  , 1, GRZEGORZ]  
-00001290: 2020 2020 2020 2020 207c 0a3e 3e20 7c31           |.>> |1
-000012a0: 2020 7c31 2020 207c 4772 7a65 676f 727a    |1   |Grzegorz
-000012b0: 2020 2020 2020 7c31 2020 2020 7c5b 3646        |1    |[6F
-000012c0: 2032 3120 3939 2039 3920 3443 2046 3220   21 99 99 4C F2 
-000012d0: 3933 2035 3620 3245 2037 4320 4333 2032  93 56 2E 7C C3 2
-000012e0: 3920 4639 2036 4120 3432 2032 4620 3644  9 F9 6A 42 2F 6D
-000012f0: 2036 3220 4543 2034 425d 7c5b 312c 2031   62 EC 4B]|[1, 1
-00001300: 2c20 4752 5a45 474f 525a 5d20 2020 2020  , GRZEGORZ]     
-00001310: 2020 2020 2020 7c0a 3e3e 207c 3120 207c        |.>> |1  |
-00001320: 6e75 6c6c 7c47 727a 6567 6f72 7a20 2020  null|Grzegorz   
-00001330: 2020 207c 3120 2020 207c 5b34 4520 3945     |1    |[4E 9E
-00001340: 2033 4120 3242 2043 3820 3337 2039 3020   3A 2B C8 37 90 
-00001350: 4130 2036 4120 3236 2039 4120 4645 2037  A0 6A 26 9A FE 7
-00001360: 4120 3738 2038 4220 4341 2039 3920 3334  A 78 8B CA 99 34
-00001370: 2036 3820 3143 5d7c 5b31 2c20 407e 3c6e   68 1C]|[1, @~<n
-00001380: 756c 6c3e 7e40 2c20 4752 5a45 474f 525a  ull>~@, GRZEGORZ
-00001390: 5d20 207c 0a3e 3e20 7c31 2020 7c6e 756c  ]  |.>> |1  |nul
-000013a0: 6c7c 6e75 6c6c 2020 2020 2020 2020 2020  l|null          
-000013b0: 7c31 2020 2020 7c5b 3434 2046 4620 3838  |1    |[44 FF 88
-000013c0: 2032 4520 3241 2032 3820 3342 2045 4520   2E 2A 28 3B EE 
-000013d0: 4545 2035 3320 4338 2037 4420 3046 2039  EE 53 C8 7D 0F 9
-000013e0: 3220 4431 2036 3820 3345 2041 3220 4632  2 D1 68 3E A2 F2
-000013f0: 2045 355d 7c5b 312c 2040 7e3c 6e75 6c6c   E5]|[1, @~<null
-00001400: 3e7e 402c 2040 7e3c 6e75 6c6c 3e7e 405d  >~@, @~<null>~@]
-00001410: 7c0a 3e3e 207c 3220 207c 3120 2020 7c54  |.>> |2  |1   |T
-00001420: 696d 2020 2020 2020 2020 2020 207c 3120  im           |1 
-00001430: 2020 207c 5b41 3820 3741 2042 3020 3239     |[A8 7A B0 29
-00001440: 2039 3420 3946 2035 4320 4431 2037 3820   94 9F 5C D1 78 
-00001450: 4434 2032 3820 3839 2038 4220 4631 2037  D4 28 89 8B F1 7
-00001460: 3520 4344 2041 4320 3730 2042 3620 3631  5 CD AC 70 B6 61
-00001470: 5d7c 5b32 2c20 312c 2054 494d 5d20 2020  ]|[2, 1, TIM]   
-00001480: 2020 2020 2020 2020 2020 2020 207c 0a3e               |.>
-00001490: 3e20 7c33 2020 7c31 2020 207c 4d69 6b65  > |3  |1   |Mike
-000014a0: 2020 2020 2020 2020 2020 7c31 2020 2020            |1    
-000014b0: 7c5b 3944 2036 4320 3736 2043 3520 3137  |[9D 6C 76 C5 17
-000014c0: 2044 3020 3434 2034 3620 3437 2031 4120   D0 44 46 47 1A 
-000014d0: 3731 2045 4420 3441 2030 3820 3735 2038  71 ED 4A 08 75 8
-000014e0: 3420 3144 2035 4320 3435 2030 395d 7c5b  4 1D 5C 45 09]|[
-000014f0: 332c 2031 2c20 4d49 4b45 5d20 2020 2020  3, 1, MIKE]     
-00001500: 2020 2020 2020 2020 2020 7c0a 3e3e 202b            |.>> +
-00001510: 2d2d 2d2b 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  ---+----+-------
-00001520: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2b 2d2d  -------+-----+--
-00001530: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001540: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001550: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001560: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00001190: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b  -------+-------+
+000011a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000011b0: 2d2b 0a3e 3e20 7c32 2020 7c32 2020 7c54  -+.>> |2  |2  |T
+000011c0: 696d 6d79 7c32 3031 382d 3031 2d30 3120  immy|2018-01-01 
+000011d0: 2020 207c 3230 3138 2d30 322d 3031 2031     |2018-02-01 1
+000011e0: 323a 3334 3a35 367c 3336 2e37 2020 207c  2:34:56|36.7   |
+000011f0: 3837 3534 3835 3738 3435 7c74 7275 6520  8754857845|true 
+00001200: 207c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d   |.>> +---+---+-
+00001210: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+00001220: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+00001230: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b  -------+-------+
+00001240: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00001250: 2d2b 0a3e 3e20 0a3e 3e20 5265 6d6f 7665  -+.>> .>> Remove
+00001260: 6420 7265 636f 7264 7320 636f 756e 743a  d records count:
+00001270: 2031 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d   1.>> +---+---+-
+00001280: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+00001290: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
+000012a0: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d  ------+-------+-
+000012b0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e 3e20  ----+------+.>> 
+000012c0: 7c69 6431 7c69 6432 7c6e 616d 657c 6669  |id1|id2|name|fi
+000012d0: 7273 745f 6c6f 6769 6e5f 6474 7c6c 6173  rst_login_dt|las
+000012e0: 745f 6c6f 6769 6e5f 7473 2020 2020 2020  t_login_ts      
+000012f0: 7c63 7265 6469 7473 7c6c 696b 6573 7c61  |credits|likes|a
+00001300: 6374 6976 657c 0a3e 3e20 2b2d 2d2d 2b2d  ctive|.>> +---+-
+00001310: 2d2d 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  --+----+--------
+00001320: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  ------+---------
+00001330: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00001340: 2d2d 2b2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b  --+-----+------+
+00001350: 0a3e 3e20 7c32 2020 7c31 2020 7c54 696d  .>> |2  |1  |Tim
+00001360: 207c 3230 3138 2d30 312d 3031 2020 2020   |2018-01-01    
+00001370: 7c32 3031 382d 3032 2d30 3120 3132 3a33  |2018-02-01 12:3
+00001380: 343a 3536 7c33 362e 3720 2020 7c35 3435  4:56|36.7   |545
+00001390: 3435 7c74 7275 6520 207c 0a3e 3e20 2b2d  45|true  |.>> +-
+000013a0: 2d2d 2b2d 2d2d 2b2d 2d2d 2d2b 2d2d 2d2d  --+---+----+----
+000013b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000013c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
+000013d0: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2b2d 2d2d  ------+-----+---
+000013e0: 2d2d 2d2b 0a3e 3e20 0a3e 3e20 4368 616e  ---+.>> .>> Chan
+000013f0: 6765 6420 7265 636f 7264 7320 636f 756e  ged records coun
+00001400: 743a 2031 0a3e 3e20 2b2d 2d2d 2b2d 2d2d  t: 1.>> +---+---
+00001410: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---------------
+00001420: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001430: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001440: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001450: 2d2d 2d2d 2d2d 2b0a 3e3e 207c 6964 317c  ------+.>> |id1|
+00001460: 6964 327c 6368 616e 6765 6420 2020 2020  id2|changed     
+00001470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000014a0: 2020 2020 2020 2020 207c 0a3e 3e20 2b2d           |.>> +-
+000014b0: 2d2d 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  --+---+---------
+000014c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000014d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000014e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000014f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 3e3e  ------------+.>>
+00001500: 207c 3120 207c 3120 207c 7b66 6972 7374   |1  |1  |{first
+00001510: 5f6c 6f67 696e 5f64 7420 2d3e 207b 3230  _login_dt -> {20
+00001520: 3137 2d30 312d 3031 2c20 3230 3138 2d30  17-01-01, 2018-0
+00001530: 312d 3031 7d2c 2063 7265 6469 7473 202d  1-01}, credits -
+00001540: 3e20 7b32 362e 372c 2032 362e 397d 7d7c  > {26.7, 26.9}}|
+00001550: 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d 2d2d  .>> +---+---+---
+00001560: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
 00001570: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001580: 2d2d 2d2d 2d2d 2d2b 0a60 6060 0a0a 2323  -------+.```..##
-00001590: 2050 4b20 2620 464b 2069 6e74 6572 6772   PK & FK intergr
-000015a0: 6974 7920 6368 6563 6b73 0a77 6974 6820  ity checks.with 
-000015b0: 7375 7070 6f72 7420 6f66 2073 686f 7769  support of showi
-000015c0: 6e67 2073 616d 706c 6520 6461 7461 2066  ng sample data f
-000015d0: 726f 6d20 6661 6374 2074 6162 6c65 2074  rom fact table t
-000015e0: 6861 7420 6469 6420 6e6f 7420 7361 7469  hat did not sati
-000015f0: 7366 7920 696e 7465 6772 6974 790a 0a60  sfy integrity..`
-00001600: 6060 7079 7468 6f6e 0a66 726f 6d20 6264  ``python.from bd
-00001610: 7120 696d 706f 7274 2066 6163 745f 6469  q import fact_di
-00001620: 6d5f 6272 6f6b 656e 5f72 656c 6174 696f  m_broken_relatio
-00001630: 6e73 6869 700a 6672 6f6d 2062 6471 2e66  nship.from bdq.f
-00001640: 756e 6374 696f 6e73 2069 6d70 6f72 7420  unctions import 
-00001650: 7375 7272 6f67 6174 655f 6b65 795f 6861  surrogate_key_ha
-00001660: 7368 2c20 7375 7272 6f67 6174 655f 6b65  sh, surrogate_ke
-00001670: 795f 7374 7269 6e67 0a0a 6661 6374 5f64  y_string..fact_d
-00001680: 6620 3d20 7370 6172 6b2e 6372 6561 7465  f = spark.create
-00001690: 4461 7461 4672 616d 6528 5b0a 2020 2020  DataFrame([.    
-000016a0: 5b20 2247 727a 6567 6f72 7a22 2c20 2249  [ "Grzegorz", "I
-000016b0: 5422 2c20 2245 5522 205d 2c0a 2020 2020  T", "EU" ],.    
-000016c0: 5b20 224d 6172 6b22 2c20 2249 5422 2c20  [ "Mark", "IT", 
-000016d0: 2245 5522 205d 2c0a 2020 2020 5b20 224a  "EU" ],.    [ "J
-000016e0: 7573 7469 6e22 2c20 2249 5420 2022 2c20  ustin", "IT  ", 
-000016f0: 2245 5520 2020 2022 205d 2c0a 2020 2020  "EU    " ],.    
-00001700: 5b20 2241 6c69 6365 3122 2c20 2249 5422  [ "Alice1", "IT"
-00001710: 2c20 2255 5341 2220 5d2c 0a20 2020 205b  , "USA" ],.    [
-00001720: 2022 416c 6963 6532 222c 2022 4954 222c   "Alice2", "IT",
-00001730: 2022 5553 4122 205d 2c0a 2020 2020 5b20   "USA" ],.    [ 
-00001740: 2241 6c69 6365 3322 2c20 2249 5422 2c20  "Alice3", "IT", 
-00001750: 2255 5341 2220 5d2c 0a20 2020 205b 2022  "USA" ],.    [ "
-00001760: 416c 6963 6534 222c 2022 4954 222c 2022  Alice4", "IT", "
-00001770: 5553 4122 205d 2c0a 2020 2020 5b20 2241  USA" ],.    [ "A
-00001780: 6c69 6365 3522 2c20 2249 5422 2c20 2255  lice5", "IT", "U
-00001790: 5341 2220 5d2c 0a20 2020 205b 2022 426f  SA" ],.    [ "Bo
-000017a0: 6222 2c20 2253 616c 6573 222c 2022 5553  b", "Sales", "US
-000017b0: 4122 205d 2c0a 2020 2020 5b20 2242 6f62  A" ],.    [ "Bob
-000017c0: 3222 2c20 2253 616c 6573 222c 2022 5553  2", "Sales", "US
-000017d0: 4122 205d 2c0a 2020 2020 5b20 2242 6f62  A" ],.    [ "Bob
-000017e0: 3322 2c20 2253 616c 6573 222c 2022 5553  3", "Sales", "US
-000017f0: 4122 205d 0a20 205d 2c20 224e 616d 653a  A" ].  ], "Name:
-00001800: 7374 7269 6e67 2c44 6570 743a 7374 7269  string,Dept:stri
-00001810: 6e67 2c43 6f75 6e74 7279 3a73 7472 696e  ng,Country:strin
-00001820: 6722 2920 5c0a 2020 2e77 6974 6843 6f6c  g") \.  .withCol
-00001830: 756d 6e28 2264 6570 745f 666b 222c 2073  umn("dept_fk", s
-00001840: 7572 726f 6761 7465 5f6b 6579 5f68 6173  urrogate_key_has
-00001850: 6828 5b22 4465 7074 222c 2022 436f 756e  h(["Dept", "Coun
-00001860: 7472 7922 5d2c 2072 7472 696d 3d54 7275  try"], rtrim=Tru
-00001870: 6529 290a 0a64 696d 5f64 6620 3d20 7370  e))..dim_df = sp
-00001880: 6172 6b2e 6372 6561 7465 4461 7461 4672  ark.createDataFr
-00001890: 616d 6528 5b0a 2020 2020 5b22 4954 222c  ame([.    ["IT",
-000018a0: 2022 4555 222c 2022 4575 726f 7065 616e   "EU", "European
-000018b0: 2049 5420 6465 7061 7274 6d65 6e74 225d   IT department"]
-000018c0: 2c0a 2020 2020 5b22 5361 6c65 7322 2c20  ,.    ["Sales", 
-000018d0: 2255 5341 222c 2022 5553 4120 5361 6c65  "USA", "USA Sale
-000018e0: 7320 6465 7074 2e22 5d0a 2020 5d2c 2022  s dept."].  ], "
-000018f0: 6465 7061 7274 6d65 6e74 3a73 7472 696e  department:strin
-00001900: 672c 636e 7472 793a 7374 7269 6e67 2c63  g,cntry:string,c
-00001910: 6f6d 6d65 6e74 3a73 7472 696e 6722 2920  omment:string") 
-00001920: 5c0a 2020 2e77 6974 6843 6f6c 756d 6e28  \.  .withColumn(
-00001930: 2264 6570 745f 706b 222c 2073 7572 726f  "dept_pk", surro
-00001940: 6761 7465 5f6b 6579 5f68 6173 6828 5b22  gate_key_hash(["
-00001950: 6465 7061 7274 6d65 6e74 222c 2022 636e  department", "cn
-00001960: 7472 7922 5d2c 2072 7472 696d 3d54 7275  try"], rtrim=Tru
-00001970: 6529 290a 0a23 6469 7265 6374 2063 6f6c  e))..#direct col
-00001980: 756d 6e20 636f 6d70 6172 6973 6f6e 2c20  umn comparison, 
-00001990: 6865 6e63 6520 7570 7065 722c 206c 6f77  hence upper, low
-000019a0: 6572 2c20 6578 7472 6120 7370 6163 6573  er, extra spaces
-000019b0: 2061 6666 6563 7420 7468 6520 7265 7375   affect the resu
-000019c0: 6c74 730a 6272 6f6b 656e 5f64 6620 3d20  lts.broken_df = 
-000019d0: 6661 6374 5f64 696d 5f62 726f 6b65 6e5f  fact_dim_broken_
-000019e0: 7265 6c61 7469 6f6e 7368 6970 280a 2020  relationship(.  
-000019f0: 6661 6374 5f64 663d 6661 6374 5f64 662c  fact_df=fact_df,
-00001a00: 0a20 2066 6b5f 636f 6c75 6d6e 733d 5b22  .  fk_columns=["
-00001a10: 4465 7074 222c 2022 436f 756e 7472 7922  Dept", "Country"
-00001a20: 5d2c 0a20 2064 696d 5f64 663d 6469 6d5f  ],.  dim_df=dim_
-00001a30: 6466 2c0a 2020 706b 5f63 6f6c 756d 6e73  df,.  pk_columns
-00001a40: 3d5b 2264 6570 6172 746d 656e 7422 2c20  =["department", 
-00001a50: 2263 6e74 7279 225d 2c0a 2020 7361 6d70  "cntry"],.  samp
-00001a60: 6c65 5f62 726f 6b65 6e5f 7265 636f 7264  le_broken_record
-00001a70: 733d 320a 290a 0a3e 3e20 2b2d 2d2d 2d2b  s=2.)..>> +----+
-00001a80: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  -------+--------
-00001a90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001aa0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001ab0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001ac0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001ad0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 3e3e  ------------+.>>
-00001ae0: 207c 4465 7074 7c43 6f75 6e74 7279 7c73   |Dept|Country|s
-00001af0: 616d 706c 655f 7265 636f 7264 7320 2020  ample_records   
-00001b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b40: 2020 207c 0a3e 3e20 2b2d 2d2d 2d2b 2d2d     |.>> +----+--
-00001b50: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
-00001b60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001b70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001b80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001b90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001ba0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 3e3e 207c  ----------+.>> |
-00001bb0: 4954 2020 7c55 5341 2020 2020 7c5b 7b49  IT  |USA    |[{I
-00001bc0: 542c 2055 5341 2c20 416c 6963 6531 2c20  T, USA, Alice1, 
-00001bd0: efbf bdef bfbd 787a 3471 105f efbf bdef  ......xz4q._....
-00001be0: bfbd 115c 7261 efbf bd2d efbf bd16 efbf  ...\ra...-......
-00001bf0: bd56 7a7d 2c20 7b49 542c 2055 5341 2c20  .Vz}, {IT, USA, 
-00001c00: 416c 6963 6532 2c20 efbf bdef bfbd 787a  Alice2, ......xz
-00001c10: 3471 105f efbf bdef bfbd 115c 7261 efbf  4q._.......\ra..
-00001c20: bd2d efbf bd16 efbf bd56 7a7d 5d7c 0a3e  .-.......Vz}]|.>
-00001c30: 3e20 7c49 5420 207c 4555 2020 2020 207c  > |IT  |EU     |
-00001c40: 5b7b 4954 2020 2c20 4555 2020 2020 2c20  [{IT  , EU    , 
-00001c50: 4a75 7374 696e 2c20 efbf bdef bfbd 4827  Justin, ......H'
-00001c60: 5634 efbf bd5c 7259 2c67 efbf bd49 efbf  V4...\rY,g...I..
-00001c70: bdef bfbd 12ef bfbd efbf bdef bfbd 7d5d  ..............}]
-00001c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ca0: 2020 2020 2020 7c0a 3e3e 202b 2d2d 2d2d        |.>> +----
-00001cb0: 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  +-------+-------
-00001cc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001cd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001ce0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001cf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001d00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a0a  -------------+..
-00001d10: 2320 7573 696e 6720 7375 7272 6f67 6174  # using surrogat
-00001d20: 6520 6b65 7973 2077 696c 6c20 7969 656c  e keys will yiel
-00001d30: 6420 6265 7474 6572 2072 6573 756c 7473  d better results
-00001d40: 2c20 6265 6361 7573 6520 6578 7472 6120  , because extra 
-00001d50: 7370 6163 6573 2061 7265 2074 7269 6d6d  spaces are trimm
-00001d60: 6564 0a62 726f 6b65 6e5f 736b 5f64 6620  ed.broken_sk_df 
-00001d70: 3d20 6661 6374 5f64 696d 5f62 726f 6b65  = fact_dim_broke
-00001d80: 6e5f 7265 6c61 7469 6f6e 7368 6970 280a  n_relationship(.
-00001d90: 2020 6661 6374 5f64 662c 205b 2264 6570    fact_df, ["dep
-00001da0: 745f 666b 225d 2c0a 2020 6469 6d5f 6466  t_fk"],.  dim_df
-00001db0: 2c20 5b22 6465 7074 5f70 6b22 5d2c 0a20  , ["dept_pk"],. 
-00001dc0: 2073 616d 706c 655f 6272 6f6b 656e 5f72   sample_broken_r
-00001dd0: 6563 6f72 6473 3d32 0a29 0a0a 3e3e 202b  ecords=2.)..>> +
-00001de0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d  ----+-------+---
-00001df0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001e00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001e10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001e20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001e30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001e40: 2d2b 0a3e 3e20 7c44 6570 747c 436f 756e  -+.>> |Dept|Coun
-00001e50: 7472 797c 7361 6d70 6c65 5f72 6563 6f72  try|sample_recor
-00001e60: 6473 2020 2020 2020 2020 2020 2020 2020  ds              
-00001e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ea0: 2020 2020 2020 2020 7c0a 3e3e 202b 2d2d          |.>> +--
-00001eb0: 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  --+-------+-----
-00001ec0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001ed0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001ee0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001ef0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001f00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
-00001f10: 0a3e 3e20 7c49 5420 207c 5553 4120 2020  .>> |IT  |USA   
-00001f20: 207c 5b7b 4954 2c20 5553 412c 2041 6c69   |[{IT, USA, Ali
-00001f30: 6365 312c 20ef bfbd efbf bd78 7a34 7110  ce1, ......xz4q.
-00001f40: 5fef bfbd efbf bd11 5c72 61ef bfbd 2def  _.......\ra...-.
-00001f50: bfbd 16ef bfbd 567a 7d2c 207b 4954 2c20  ......Vz}, {IT, 
-00001f60: 5553 412c 2041 6c69 6365 322c 20ef bfbd  USA, Alice2, ...
-00001f70: efbf bd78 7a34 7110 5fef bfbd efbf bd11  ...xz4q._.......
-00001f80: 5c72 61ef bfbd 2def bfbd 16ef bfbd 567a  \ra...-.......Vz
-00001f90: 7d5d 7c0a 3e3e 202b 2d2d 2d2d 2b2d 2d2d  }]|.>> +----+---
-00001fa0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
-00001fb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001fc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001fd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001fe0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001ff0: 2d2d 2d2d 2d2d 2d2d 2d2b 0a60 6060 0a0a  ---------+.```..
-00002000: 2323 2047 6574 206c 6174 6573 7420 7265  ## Get latest re
-00002010: 636f 7264 7320 0a77 6974 6820 6f70 7469  cords .with opti
-00002020: 6f6e 616c 2070 7269 6d61 7279 206b 6579  onal primary key
-00002030: 2063 6f6e 666c 6963 7420 7265 736f 6c75   conflict resolu
-00002040: 7469 6f6e 2c20 7768 6572 6520 7468 6572  tion, where ther
-00002050: 6520 6172 6520 6d75 6c74 6970 6c65 2072  e are multiple r
-00002060: 6563 6f72 6473 2062 6569 6e67 2063 616e  ecords being can
-00002070: 6469 6461 7465 2066 6f72 206c 6174 6573  didate for lates
-00002080: 7420 7265 636f 7264 2c20 6275 7420 7468  t record, but th
-00002090: 6579 2068 6176 6520 6469 6666 6572 656e  ey have differen
-000020a0: 7420 6174 7472 6962 7565 7473 2061 6e64  t attribuets and
-000020b0: 2074 6865 7265 2069 7320 6e6f 2077 6179   there is no way
-000020c0: 206f 6620 6465 7465 726d 696e 696e 6720   of determining 
-000020d0: 7768 6963 6820 6f6e 6520 6973 2074 6865  which one is the
-000020e0: 206c 6174 6573 742e 0a0a 6060 6070 7974   latest...```pyt
-000020f0: 686f 6e0a 6672 6f6d 2064 6174 6574 696d  hon.from datetim
-00002100: 6520 696d 706f 7274 2064 6174 6574 696d  e import datetim
-00002110: 6520 6173 2064 740a 6672 6f6d 2062 6471  e as dt.from bdq
-00002120: 2069 6d70 6f72 7420 6765 745f 6c61 7465   import get_late
-00002130: 7374 5f72 6563 6f72 6473 2c20 6765 745f  st_records, get_
-00002140: 6c61 7465 7374 5f72 6563 6f72 6473 5f77  latest_records_w
-00002150: 6974 685f 706b 5f63 6f6e 6669 6374 5f64  ith_pk_confict_d
-00002160: 6574 6563 7469 6f6e 5f66 6c61 670a 0a69  etection_flag..i
-00002170: 6e63 7265 6d65 6e74 5f64 6174 6120 3d20  ncrement_data = 
-00002180: 205b 0a20 2028 312c 2064 7428 3230 3030   [.  (1, dt(2000
-00002190: 2c20 312c 2031 2c20 302c 2030 2c20 3029  , 1, 1, 0, 0, 0)
-000021a0: 2c20 2231 3030 3122 290a 2020 2c28 312c  , "1001").  ,(1,
-000021b0: 2064 7428 3230 3030 2c20 312c 2031 2c20   dt(2000, 1, 1, 
-000021c0: 322c 2030 2c20 3029 2c20 2231 3030 3222  2, 0, 0), "1002"
-000021d0: 290a 2020 2c28 322c 2064 7428 3230 3030  ).  ,(2, dt(2000
-000021e0: 2c20 312c 2031 2c20 302c 2030 2c20 3029  , 1, 1, 0, 0, 0)
-000021f0: 2c20 2232 3030 3122 2920 2363 6172 626f  , "2001") #carbo
-00002200: 6e20 636f 7079 2064 7570 6c69 6361 7465  n copy duplicate
-00002210: 0a20 202c 2832 2c20 6474 2832 3030 302c  .  ,(2, dt(2000,
-00002220: 2031 2c20 312c 2030 2c20 302c 2030 292c   1, 1, 0, 0, 0),
-00002230: 2022 3230 3031 2229 2023 6361 7262 6f6e   "2001") #carbon
-00002240: 2063 6f70 7920 6475 706c 6963 6174 650a   copy duplicate.
-00002250: 2020 2c28 332c 2064 7428 3230 3030 2c20    ,(3, dt(2000, 
-00002260: 312c 2031 2c20 302c 2030 2c20 3029 2c20  1, 1, 0, 0, 0), 
-00002270: 2233 3030 3122 290a 2020 2c28 332c 2064  "3001").  ,(3, d
-00002280: 7428 3230 3030 2c20 312c 2031 2c20 322c  t(2000, 1, 1, 2,
-00002290: 2030 2c20 3029 2c20 2233 3030 3223 3122   0, 0), "3002#1"
-000022a0: 2920 2370 6b20 636f 6e66 6c69 6374 2c20  ) #pk conflict, 
-000022b0: 7477 6f20 656e 7472 6965 7320 7769 7468  two entries with
-000022c0: 2074 6865 2073 616d 6520 7465 6368 6e69   the same techni
-000022d0: 6361 6c20 6669 656c 6473 2c20 6275 7420  cal fields, but 
-000022e0: 6469 6666 6572 656e 7420 6174 7269 6275  different atribu
-000022f0: 7465 732c 2077 6869 6368 206f 6e65 2074  tes, which one t
-00002300: 6f20 6368 6f73 653f 0a20 202c 2833 2c20  o chose?.  ,(3, 
-00002310: 6474 2832 3030 302c 2031 2c20 312c 2032  dt(2000, 1, 1, 2
-00002320: 2c20 302c 2030 292c 2022 3330 3032 2332  , 0, 0), "3002#2
-00002330: 2229 2023 706b 2063 6f6e 666c 6963 740a  ") #pk conflict.
-00002340: 5d0a 0a64 6620 3d20 7370 6172 6b2e 6372  ]..df = spark.cr
-00002350: 6561 7465 4461 7461 4672 616d 6528 696e  eateDataFrame(in
-00002360: 6372 656d 656e 745f 6461 7461 2c20 2270  crement_data, "p
-00002370: 6b3a 696e 742c 6368 616e 6765 5f74 733a  k:int,change_ts:
-00002380: 7469 6d65 7374 616d 702c 6174 7472 3a73  timestamp,attr:s
-00002390: 7472 696e 6722 290a 6466 2e73 686f 7728  tring").df.show(
-000023a0: 7472 756e 6361 7465 3d54 7275 6529 0a0a  truncate=True)..
-000023b0: 3e3e 202b 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  >> +---+--------
-000023c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
-000023d0: 2d2d 2b0a 3e3e 207c 2070 6b7c 2020 2020  --+.>> | pk|    
-000023e0: 2020 2020 2020 6368 616e 6765 5f74 737c        change_ts|
-000023f0: 2020 6174 7472 7c0a 3e3e 202b 2d2d 2d2b    attr|.>> +---+
-00002400: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002410: 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e 207c  ---+------+.>> |
-00002420: 2020 317c 3230 3030 2d30 312d 3031 2030    1|2000-01-01 0
-00002430: 303a 3030 3a30 307c 2020 3130 3031 7c0a  0:00:00|  1001|.
-00002440: 3e3e 207c 2020 317c 3230 3030 2d30 312d  >> |  1|2000-01-
-00002450: 3031 2030 323a 3030 3a30 307c 2020 3130  01 02:00:00|  10
-00002460: 3032 7c0a 3e3e 207c 2020 327c 3230 3030  02|.>> |  2|2000
-00002470: 2d30 312d 3031 2030 303a 3030 3a30 307c  -01-01 00:00:00|
-00002480: 2020 3230 3031 7c0a 3e3e 207c 2020 327c    2001|.>> |  2|
-00002490: 3230 3030 2d30 312d 3031 2030 303a 3030  2000-01-01 00:00
-000024a0: 3a30 307c 2020 3230 3031 7c0a 3e3e 207c  :00|  2001|.>> |
-000024b0: 2020 337c 3230 3030 2d30 312d 3031 2030    3|2000-01-01 0
-000024c0: 303a 3030 3a30 307c 2020 3330 3031 7c0a  0:00:00|  3001|.
-000024d0: 3e3e 207c 2020 337c 3230 3030 2d30 312d  >> |  3|2000-01-
-000024e0: 3031 2030 323a 3030 3a30 307c 3330 3032  01 02:00:00|3002
-000024f0: 2331 7c0a 3e3e 207c 2020 337c 3230 3030  #1|.>> |  3|2000
-00002500: 2d30 312d 3031 2030 323a 3030 3a30 307c  -01-01 02:00:00|
-00002510: 3330 3032 2332 7c0a 3e3e 202b 2d2d 2d2b  3002#2|.>> +---+
+00001580: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001590: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000015a0: 2d2d 2b0a 0a4e 6f74 2063 6861 6e67 6564  --+..Not changed
+000015b0: 2072 6563 6f72 6473 2063 6f75 6e74 3a20   records count: 
+000015c0: 310a 6060 600a 0a23 2323 2053 7572 726f  1.```..### Surro
+000015d0: 6761 7465 206b 6579 2067 656e 6572 6174  gate key generat
+000015e0: 696f 6e0a 0a77 6974 6820 7375 7070 6f72  ion..with suppor
+000015f0: 7420 6f66 206f 7074 696f 6e61 6c20 7570  t of optional up
+00001600: 7065 7263 6173 696e 6720 616e 6420 7472  percasing and tr
+00001610: 696d 6d69 6e67 206f 6620 6b65 7920 636f  imming of key co
+00001620: 6c75 6d6e 730a 0a60 6060 7079 7468 6f6e  lumns..```python
+00001630: 0a66 726f 6d20 6461 7465 7469 6d65 2069  .from datetime i
+00001640: 6d70 6f72 7420 6461 7465 7469 6d65 0a66  mport datetime.f
+00001650: 726f 6d20 6264 712e 6675 6e63 7469 6f6e  rom bdq.function
+00001660: 7320 696d 706f 7274 2073 7572 726f 6761  s import surroga
+00001670: 7465 5f6b 6579 5f68 6173 682c 2073 7572  te_key_hash, sur
+00001680: 726f 6761 7465 5f6b 6579 5f73 7472 696e  rogate_key_strin
+00001690: 670a 0a73 6368 656d 6120 3d20 2269 6431  g..schema = "id1
+000016a0: 3a6c 6f6e 672c 6964 323a 6c6f 6e67 2c6e  :long,id2:long,n
+000016b0: 616d 653a 7374 7269 6e67 2c6c 696b 6573  ame:string,likes
+000016c0: 3a69 6e74 220a 0a64 6631 203d 2073 7061  :int"..df1 = spa
+000016d0: 726b 2e63 7265 6174 6544 6174 6146 7261  rk.createDataFra
+000016e0: 6d65 285b 0a20 205b 2031 2c20 312c 2022  me([.  [ 1, 1, "
+000016f0: 4772 7a65 476f 727a 222c 2031 205d 2c0a  GrzeGorz", 1 ],.
+00001700: 2020 5b20 312c 2031 2c20 2247 727a 6567    [ 1, 1, "Grzeg
+00001710: 6f72 7a22 2c20 2031 205d 2c0a 2020 5b20  orz",  1 ],.  [ 
+00001720: 312c 2031 2c20 2247 727a 6567 6f72 7a20  1, 1, "Grzegorz 
+00001730: 2020 2020 2022 2c20 2031 205d 2c0a 2020       ",  1 ],.  
+00001740: 5b20 312c 204e 6f6e 652c 2022 4772 7a65  [ 1, None, "Grze
+00001750: 676f 727a 222c 2031 5d2c 0a20 205b 2031  gorz", 1],.  [ 1
+00001760: 2c20 4e6f 6e65 2c20 4e6f 6e65 2c20 315d  , None, None, 1]
+00001770: 2c0a 2020 5b20 322c 2031 2c20 2254 696d  ,.  [ 2, 1, "Tim
+00001780: 222c 2031 205d 2c0a 2020 5b20 332c 2031  ", 1 ],.  [ 3, 1
+00001790: 2c20 224d 696b 6522 2c20 3120 5d0a 5d2c  , "Mike", 1 ].],
+000017a0: 2073 6368 656d 6129 0a0a 736b 5f64 6620   schema)..sk_df 
+000017b0: 3d20 6466 312e 7365 6c65 6374 280a 2020  = df1.select(.  
+000017c0: 272a 272c 200a 2020 7375 7272 6f67 6174  '*', .  surrogat
+000017d0: 655f 6b65 795f 6861 7368 285b 2769 6431  e_key_hash(['id1
+000017e0: 272c 2027 6964 3227 2c20 276e 616d 6527  ', 'id2', 'name'
+000017f0: 5d2c 2072 7472 696d 3d54 7275 6529 2e61  ], rtrim=True).a
+00001800: 6c69 6173 2827 6861 7368 2729 2c0a 2020  lias('hash'),.  
+00001810: 7375 7272 6f67 6174 655f 6b65 795f 7374  surrogate_key_st
+00001820: 7269 6e67 285b 2769 6431 272c 2027 6964  ring(['id1', 'id
+00001830: 3227 2c20 276e 616d 6527 5d2c 2072 7472  2', 'name'], rtr
+00001840: 696d 3d54 7275 6529 2e61 6c69 6173 2827  im=True).alias('
+00001850: 6861 7368 5f69 6e70 7574 2729 0a29 0a0a  hash_input').)..
+00001860: 3e3e 202b 2d2d 2d2b 2d2d 2d2d 2b2d 2d2d  >> +---+----+---
+00001870: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00001880: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
+00001890: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000018a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000018b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+000018c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000018d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e 3e20  -----------+.>> 
+000018e0: 7c69 6431 7c69 6432 207c 6e61 6d65 2020  |id1|id2 |name  
+000018f0: 2020 2020 2020 2020 7c6c 696b 6573 7c68          |likes|h
+00001900: 6173 6820 2020 2020 2020 2020 2020 2020  ash             
+00001910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001930: 2020 2020 2020 2020 2020 2020 7c68 6173              |has
+00001940: 685f 696e 7075 7420 2020 2020 2020 2020  h_input         
+00001950: 2020 2020 2020 2020 7c0a 3e3e 202b 2d2d          |.>> +--
+00001960: 2d2b 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  -+----+---------
+00001970: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2b 2d2d 2d2d  -----+-----+----
+00001980: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001990: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000019a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000019b0: 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  ---------+------
+000019c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000019d0: 2d2d 2d2d 2d2b 0a3e 3e20 7c31 2020 7c31  -----+.>> |1  |1
+000019e0: 2020 207c 4772 7a65 476f 727a 2020 2020     |GrzeGorz    
+000019f0: 2020 7c31 2020 2020 7c5b 3646 2032 3120    |1    |[6F 21 
+00001a00: 3939 2039 3920 3443 2046 3220 3933 2035  99 99 4C F2 93 5
+00001a10: 3620 3245 2037 4320 4333 2032 3920 4639  6 2E 7C C3 29 F9
+00001a20: 2036 4120 3432 2032 4620 3644 2036 3220   6A 42 2F 6D 62 
+00001a30: 4543 2034 425d 7c5b 312c 2031 2c20 4752  EC 4B]|[1, 1, GR
+00001a40: 5a45 474f 525a 5d20 2020 2020 2020 2020  ZEGORZ]         
+00001a50: 2020 7c0a 3e3e 207c 3120 207c 3120 2020    |.>> |1  |1   
+00001a60: 7c47 727a 6567 6f72 7a20 2020 2020 207c  |Grzegorz      |
+00001a70: 3120 2020 207c 5b36 4620 3231 2039 3920  1    |[6F 21 99 
+00001a80: 3939 2034 4320 4632 2039 3320 3536 2032  99 4C F2 93 56 2
+00001a90: 4520 3743 2043 3320 3239 2046 3920 3641  E 7C C3 29 F9 6A
+00001aa0: 2034 3220 3246 2036 4420 3632 2045 4320   42 2F 6D 62 EC 
+00001ab0: 3442 5d7c 5b31 2c20 312c 2047 525a 4547  4B]|[1, 1, GRZEG
+00001ac0: 4f52 5a5d 2020 2020 2020 2020 2020 207c  ORZ]           |
+00001ad0: 0a3e 3e20 7c31 2020 7c31 2020 207c 4772  .>> |1  |1   |Gr
+00001ae0: 7a65 676f 727a 2020 2020 2020 7c31 2020  zegorz      |1  
+00001af0: 2020 7c5b 3646 2032 3120 3939 2039 3920    |[6F 21 99 99 
+00001b00: 3443 2046 3220 3933 2035 3620 3245 2037  4C F2 93 56 2E 7
+00001b10: 4320 4333 2032 3920 4639 2036 4120 3432  C C3 29 F9 6A 42
+00001b20: 2032 4620 3644 2036 3220 4543 2034 425d   2F 6D 62 EC 4B]
+00001b30: 7c5b 312c 2031 2c20 4752 5a45 474f 525a  |[1, 1, GRZEGORZ
+00001b40: 5d20 2020 2020 2020 2020 2020 7c0a 3e3e  ]           |.>>
+00001b50: 207c 3120 207c 6e75 6c6c 7c47 727a 6567   |1  |null|Grzeg
+00001b60: 6f72 7a20 2020 2020 207c 3120 2020 207c  orz      |1    |
+00001b70: 5b34 4520 3945 2033 4120 3242 2043 3820  [4E 9E 3A 2B C8 
+00001b80: 3337 2039 3020 4130 2036 4120 3236 2039  37 90 A0 6A 26 9
+00001b90: 4120 4645 2037 4120 3738 2038 4220 4341  A FE 7A 78 8B CA
+00001ba0: 2039 3920 3334 2036 3820 3143 5d7c 5b31   99 34 68 1C]|[1
+00001bb0: 2c20 407e 3c6e 756c 6c3e 7e40 2c20 4752  , @~<null>~@, GR
+00001bc0: 5a45 474f 525a 5d20 207c 0a3e 3e20 7c31  ZEGORZ]  |.>> |1
+00001bd0: 2020 7c6e 756c 6c7c 6e75 6c6c 2020 2020    |null|null    
+00001be0: 2020 2020 2020 7c31 2020 2020 7c5b 3434        |1    |[44
+00001bf0: 2046 4620 3838 2032 4520 3241 2032 3820   FF 88 2E 2A 28 
+00001c00: 3342 2045 4520 4545 2035 3320 4338 2037  3B EE EE 53 C8 7
+00001c10: 4420 3046 2039 3220 4431 2036 3820 3345  D 0F 92 D1 68 3E
+00001c20: 2041 3220 4632 2045 355d 7c5b 312c 2040   A2 F2 E5]|[1, @
+00001c30: 7e3c 6e75 6c6c 3e7e 402c 2040 7e3c 6e75  ~<null>~@, @~<nu
+00001c40: 6c6c 3e7e 405d 7c0a 3e3e 207c 3220 207c  ll>~@]|.>> |2  |
+00001c50: 3120 2020 7c54 696d 2020 2020 2020 2020  1   |Tim        
+00001c60: 2020 207c 3120 2020 207c 5b41 3820 3741     |1    |[A8 7A
+00001c70: 2042 3020 3239 2039 3420 3946 2035 4320   B0 29 94 9F 5C 
+00001c80: 4431 2037 3820 4434 2032 3820 3839 2038  D1 78 D4 28 89 8
+00001c90: 4220 4631 2037 3520 4344 2041 4320 3730  B F1 75 CD AC 70
+00001ca0: 2042 3620 3631 5d7c 5b32 2c20 312c 2054   B6 61]|[2, 1, T
+00001cb0: 494d 5d20 2020 2020 2020 2020 2020 2020  IM]             
+00001cc0: 2020 207c 0a3e 3e20 7c33 2020 7c31 2020     |.>> |3  |1  
+00001cd0: 207c 4d69 6b65 2020 2020 2020 2020 2020   |Mike          
+00001ce0: 7c31 2020 2020 7c5b 3944 2036 4320 3736  |1    |[9D 6C 76
+00001cf0: 2043 3520 3137 2044 3020 3434 2034 3620   C5 17 D0 44 46 
+00001d00: 3437 2031 4120 3731 2045 4420 3441 2030  47 1A 71 ED 4A 0
+00001d10: 3820 3735 2038 3420 3144 2035 4320 3435  8 75 84 1D 5C 45
+00001d20: 2030 395d 7c5b 332c 2031 2c20 4d49 4b45   09]|[3, 1, MIKE
+00001d30: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
+00001d40: 7c0a 3e3e 202b 2d2d 2d2b 2d2d 2d2d 2b2d  |.>> +---+----+-
+00001d50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00001d60: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+00001d70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001d80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001d90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001da0: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
+00001db0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a60  -------------+.`
+00001dc0: 6060 0a0a 2323 2320 504b 2026 2046 4b20  ``..### PK & FK 
+00001dd0: 696e 7465 7267 7269 7479 2063 6865 636b  intergrity check
+00001de0: 730a 0a77 6974 6820 7375 7070 6f72 7420  s..with support 
+00001df0: 6f66 2073 686f 7769 6e67 2073 616d 706c  of showing sampl
+00001e00: 6520 6461 7461 2066 726f 6d20 6661 6374  e data from fact
+00001e10: 2074 6162 6c65 2074 6861 7420 6469 6420   table that did 
+00001e20: 6e6f 7420 7361 7469 7366 7920 696e 7465  not satisfy inte
+00001e30: 6772 6974 790a 0a60 6060 7079 7468 6f6e  grity..```python
+00001e40: 0a66 726f 6d20 6264 7120 696d 706f 7274  .from bdq import
+00001e50: 2066 6163 745f 6469 6d5f 6272 6f6b 656e   fact_dim_broken
+00001e60: 5f72 656c 6174 696f 6e73 6869 700a 6672  _relationship.fr
+00001e70: 6f6d 2062 6471 2e66 756e 6374 696f 6e73  om bdq.functions
+00001e80: 2069 6d70 6f72 7420 7375 7272 6f67 6174   import surrogat
+00001e90: 655f 6b65 795f 6861 7368 2c20 7375 7272  e_key_hash, surr
+00001ea0: 6f67 6174 655f 6b65 795f 7374 7269 6e67  ogate_key_string
+00001eb0: 0a0a 6661 6374 5f64 6620 3d20 7370 6172  ..fact_df = spar
+00001ec0: 6b2e 6372 6561 7465 4461 7461 4672 616d  k.createDataFram
+00001ed0: 6528 5b0a 2020 2020 5b20 2247 727a 6567  e([.    [ "Grzeg
+00001ee0: 6f72 7a22 2c20 2249 5422 2c20 2245 5522  orz", "IT", "EU"
+00001ef0: 205d 2c0a 2020 2020 5b20 224d 6172 6b22   ],.    [ "Mark"
+00001f00: 2c20 2249 5422 2c20 2245 5522 205d 2c0a  , "IT", "EU" ],.
+00001f10: 2020 2020 5b20 224a 7573 7469 6e22 2c20      [ "Justin", 
+00001f20: 2249 5420 2022 2c20 2245 5520 2020 2022  "IT  ", "EU    "
+00001f30: 205d 2c0a 2020 2020 5b20 2241 6c69 6365   ],.    [ "Alice
+00001f40: 3122 2c20 2249 5422 2c20 2255 5341 2220  1", "IT", "USA" 
+00001f50: 5d2c 0a20 2020 205b 2022 416c 6963 6532  ],.    [ "Alice2
+00001f60: 222c 2022 4954 222c 2022 5553 4122 205d  ", "IT", "USA" ]
+00001f70: 2c0a 2020 2020 5b20 2241 6c69 6365 3322  ,.    [ "Alice3"
+00001f80: 2c20 2249 5422 2c20 2255 5341 2220 5d2c  , "IT", "USA" ],
+00001f90: 0a20 2020 205b 2022 416c 6963 6534 222c  .    [ "Alice4",
+00001fa0: 2022 4954 222c 2022 5553 4122 205d 2c0a   "IT", "USA" ],.
+00001fb0: 2020 2020 5b20 2241 6c69 6365 3522 2c20      [ "Alice5", 
+00001fc0: 2249 5422 2c20 2255 5341 2220 5d2c 0a20  "IT", "USA" ],. 
+00001fd0: 2020 205b 2022 426f 6222 2c20 2253 616c     [ "Bob", "Sal
+00001fe0: 6573 222c 2022 5553 4122 205d 2c0a 2020  es", "USA" ],.  
+00001ff0: 2020 5b20 2242 6f62 3222 2c20 2253 616c    [ "Bob2", "Sal
+00002000: 6573 222c 2022 5553 4122 205d 2c0a 2020  es", "USA" ],.  
+00002010: 2020 5b20 2242 6f62 3322 2c20 2253 616c    [ "Bob3", "Sal
+00002020: 6573 222c 2022 5553 4122 205d 0a20 205d  es", "USA" ].  ]
+00002030: 2c20 224e 616d 653a 7374 7269 6e67 2c44  , "Name:string,D
+00002040: 6570 743a 7374 7269 6e67 2c43 6f75 6e74  ept:string,Count
+00002050: 7279 3a73 7472 696e 6722 2920 5c0a 2020  ry:string") \.  
+00002060: 2e77 6974 6843 6f6c 756d 6e28 2264 6570  .withColumn("dep
+00002070: 745f 666b 222c 2073 7572 726f 6761 7465  t_fk", surrogate
+00002080: 5f6b 6579 5f68 6173 6828 5b22 4465 7074  _key_hash(["Dept
+00002090: 222c 2022 436f 756e 7472 7922 5d2c 2072  ", "Country"], r
+000020a0: 7472 696d 3d54 7275 6529 290a 0a64 696d  trim=True))..dim
+000020b0: 5f64 6620 3d20 7370 6172 6b2e 6372 6561  _df = spark.crea
+000020c0: 7465 4461 7461 4672 616d 6528 5b0a 2020  teDataFrame([.  
+000020d0: 2020 5b22 4954 222c 2022 4555 222c 2022    ["IT", "EU", "
+000020e0: 4575 726f 7065 616e 2049 5420 6465 7061  European IT depa
+000020f0: 7274 6d65 6e74 225d 2c0a 2020 2020 5b22  rtment"],.    ["
+00002100: 5361 6c65 7322 2c20 2255 5341 222c 2022  Sales", "USA", "
+00002110: 5553 4120 5361 6c65 7320 6465 7074 2e22  USA Sales dept."
+00002120: 5d0a 2020 5d2c 2022 6465 7061 7274 6d65  ].  ], "departme
+00002130: 6e74 3a73 7472 696e 672c 636e 7472 793a  nt:string,cntry:
+00002140: 7374 7269 6e67 2c63 6f6d 6d65 6e74 3a73  string,comment:s
+00002150: 7472 696e 6722 2920 5c0a 2020 2e77 6974  tring") \.  .wit
+00002160: 6843 6f6c 756d 6e28 2264 6570 745f 706b  hColumn("dept_pk
+00002170: 222c 2073 7572 726f 6761 7465 5f6b 6579  ", surrogate_key
+00002180: 5f68 6173 6828 5b22 6465 7061 7274 6d65  _hash(["departme
+00002190: 6e74 222c 2022 636e 7472 7922 5d2c 2072  nt", "cntry"], r
+000021a0: 7472 696d 3d54 7275 6529 290a 0a23 6469  trim=True))..#di
+000021b0: 7265 6374 2063 6f6c 756d 6e20 636f 6d70  rect column comp
+000021c0: 6172 6973 6f6e 2c20 6865 6e63 6520 7570  arison, hence up
+000021d0: 7065 722c 206c 6f77 6572 2c20 6578 7472  per, lower, extr
+000021e0: 6120 7370 6163 6573 2061 6666 6563 7420  a spaces affect 
+000021f0: 7468 6520 7265 7375 6c74 730a 6272 6f6b  the results.brok
+00002200: 656e 5f64 6620 3d20 6661 6374 5f64 696d  en_df = fact_dim
+00002210: 5f62 726f 6b65 6e5f 7265 6c61 7469 6f6e  _broken_relation
+00002220: 7368 6970 280a 2020 6661 6374 5f64 663d  ship(.  fact_df=
+00002230: 6661 6374 5f64 662c 0a20 2066 6b5f 636f  fact_df,.  fk_co
+00002240: 6c75 6d6e 733d 5b22 4465 7074 222c 2022  lumns=["Dept", "
+00002250: 436f 756e 7472 7922 5d2c 0a20 2064 696d  Country"],.  dim
+00002260: 5f64 663d 6469 6d5f 6466 2c0a 2020 706b  _df=dim_df,.  pk
+00002270: 5f63 6f6c 756d 6e73 3d5b 2264 6570 6172  _columns=["depar
+00002280: 746d 656e 7422 2c20 2263 6e74 7279 225d  tment", "cntry"]
+00002290: 2c0a 2020 7361 6d70 6c65 5f62 726f 6b65  ,.  sample_broke
+000022a0: 6e5f 7265 636f 7264 733d 320a 290a 0a3e  n_records=2.)..>
+000022b0: 3e20 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b  > +----+-------+
+000022c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000022d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000022e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000022f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002300: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002310: 2d2d 2d2d 2b0a 3e3e 207c 4465 7074 7c43  ----+.>> |Dept|C
+00002320: 6f75 6e74 7279 7c73 616d 706c 655f 7265  ountry|sample_re
+00002330: 636f 7264 7320 2020 2020 2020 2020 2020  cords           
+00002340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002370: 2020 2020 2020 2020 2020 207c 0a3e 3e20             |.>> 
+00002380: 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d  +----+-------+--
+00002390: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023e0: 2d2d 2b0a 3e3e 207c 4954 2020 7c55 5341  --+.>> |IT  |USA
+000023f0: 2020 2020 7c5b 7b49 542c 2055 5341 2c20      |[{IT, USA, 
+00002400: 416c 6963 6531 2c20 efbf bdef bfbd 787a  Alice1, ......xz
+00002410: 3471 105f efbf bdef bfbd 115c 7261 efbf  4q._.......\ra..
+00002420: bd2d efbf bd16 efbf bd56 7a7d 2c20 7b49  .-.......Vz}, {I
+00002430: 542c 2055 5341 2c20 416c 6963 6532 2c20  T, USA, Alice2, 
+00002440: efbf bdef bfbd 787a 3471 105f efbf bdef  ......xz4q._....
+00002450: bfbd 115c 7261 efbf bd2d efbf bd16 efbf  ...\ra...-......
+00002460: bd56 7a7d 5d7c 0a3e 3e20 7c49 5420 207c  .Vz}]|.>> |IT  |
+00002470: 4555 2020 2020 207c 5b7b 4954 2020 2c20  EU     |[{IT  , 
+00002480: 4555 2020 2020 2c20 4a75 7374 696e 2c20  EU    , Justin, 
+00002490: efbf bdef bfbd 4827 5634 efbf bd5c 7259  ......H'V4...\rY
+000024a0: 2c67 efbf bd49 efbf bdef bfbd 12ef bfbd  ,g...I..........
+000024b0: efbf bdef bfbd 7d5d 2020 2020 2020 2020  ......}]        
+000024c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000024d0: 2020 2020 2020 2020 2020 2020 2020 7c0a                |.
+000024e0: 3e3e 202b 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  >> +----+-------
+000024f0: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---------------
+00002500: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002510: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
 00002520: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002530: 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 0a70 7269  ---+------+..pri
-00002540: 6d61 7279 5f6b 6579 5f63 6f6c 756d 6e73  mary_key_columns
-00002550: 203d 205b 2770 6b27 5d0a 6f72 6465 725f   = ['pk'].order_
-00002560: 6279 5f63 6f6c 756d 6e73 203d 205b 2763  by_columns = ['c
-00002570: 6861 6e67 655f 7473 275d 0a0a 2320 7769  hange_ts']..# wi
-00002580: 6c6c 2072 616e 646f 6d6c 7920 6368 6f73  ll randomly chos
-00002590: 6520 6f6e 6520 706b 2069 6e20 6361 7365  e one pk in case
-000025a0: 206f 6620 636f 6e66 6c69 6374 2c20 7769   of conflict, wi
-000025b0: 7468 6f75 7420 616e 7920 6e6f 7469 6669  thout any notifi
-000025c0: 6361 7469 6f6e 2061 626f 7574 2063 6f6e  cation about con
-000025d0: 666c 6963 7473 0a73 696d 706c 655f 6765  flicts.simple_ge
-000025e0: 745f 6c61 7465 7374 5f64 6620 3d20 6765  t_latest_df = ge
-000025f0: 745f 6c61 7465 7374 5f72 6563 6f72 6473  t_latest_records
-00002600: 2864 662c 2070 7269 6d61 7279 5f6b 6579  (df, primary_key
-00002610: 5f63 6f6c 756d 6e73 2c20 6f72 6465 725f  _columns, order_
-00002620: 6279 5f63 6f6c 756d 6e73 290a 7369 6d70  by_columns).simp
-00002630: 6c65 5f67 6574 5f6c 6174 6573 745f 6466  le_get_latest_df
-00002640: 2e73 686f 7728 7472 756e 6361 7465 3d54  .show(truncate=T
-00002650: 7275 6529 0a0a 3e3e 202b 2d2d 2d2b 2d2d  rue)..>> +---+--
+00002530: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002540: 2d2d 2d2d 2d2b 0a0a 2320 7573 696e 6720  -----+..# using 
+00002550: 7375 7272 6f67 6174 6520 6b65 7973 2077  surrogate keys w
+00002560: 696c 6c20 7969 656c 6420 6265 7474 6572  ill yield better
+00002570: 2072 6573 756c 7473 2c20 6265 6361 7573   results, becaus
+00002580: 6520 6578 7472 6120 7370 6163 6573 2061  e extra spaces a
+00002590: 7265 2074 7269 6d6d 6564 0a62 726f 6b65  re trimmed.broke
+000025a0: 6e5f 736b 5f64 6620 3d20 6661 6374 5f64  n_sk_df = fact_d
+000025b0: 696d 5f62 726f 6b65 6e5f 7265 6c61 7469  im_broken_relati
+000025c0: 6f6e 7368 6970 280a 2020 6661 6374 5f64  onship(.  fact_d
+000025d0: 662c 205b 2264 6570 745f 666b 225d 2c0a  f, ["dept_fk"],.
+000025e0: 2020 6469 6d5f 6466 2c20 5b22 6465 7074    dim_df, ["dept
+000025f0: 5f70 6b22 5d2c 0a20 2073 616d 706c 655f  _pk"],.  sample_
+00002600: 6272 6f6b 656e 5f72 6563 6f72 6473 3d32  broken_records=2
+00002610: 0a29 0a0a 3e3e 202b 2d2d 2d2d 2b2d 2d2d  .)..>> +----+---
+00002620: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+00002630: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002640: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002650: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
 00002660: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002670: 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e 207c 2070  -+------+.>> | p
-00002680: 6b7c 2020 2020 2020 2020 2020 6368 616e  k|          chan
-00002690: 6765 5f74 737c 2020 6174 7472 7c0a 3e3e  ge_ts|  attr|.>>
-000026a0: 202b 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d   +---+----------
-000026b0: 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  ---------+------
-000026c0: 2b0a 3e3e 207c 2020 317c 3230 3030 2d30  +.>> |  1|2000-0
-000026d0: 312d 3031 2030 323a 3030 3a30 307c 2020  1-01 02:00:00|  
-000026e0: 3130 3032 7c0a 3e3e 207c 2020 327c 3230  1002|.>> |  2|20
-000026f0: 3030 2d30 312d 3031 2030 303a 3030 3a30  00-01-01 00:00:0
-00002700: 307c 2020 3230 3031 7c0a 3e3e 207c 2020  0|  2001|.>> |  
-00002710: 337c 3230 3030 2d30 312d 3031 2030 323a  3|2000-01-01 02:
-00002720: 3030 3a30 307c 3330 3032 2331 7c0a 3e3e  00:00|3002#1|.>>
-00002730: 202b 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d   +---+----------
-00002740: 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  ---------+------
-00002750: 2b0a 0a23 2077 696c 6c20 666c 6167 2072  +..# will flag r
-00002760: 6563 6f72 6473 2077 6869 6368 2063 6175  ecords which cau
-00002770: 7365 2063 6f6e 666c 6963 7473 2061 6e64  se conflicts and
-00002780: 2063 616e 6e6f 7420 6265 2072 6573 6f6c   cannot be resol
-00002790: 7665 640a 2320 6261 6420 7265 636f 7264  ved.# bad record
-000027a0: 7320 6e65 6564 2074 6f20 6265 2071 7561  s need to be qua
-000027b0: 7261 6e74 696e 6564 2061 6e64 2068 616e  rantined and han
-000027c0: 646c 6564 2069 6e20 7370 6563 6961 6c20  dled in special 
-000027d0: 7072 6f63 6573 730a 636f 6e66 6c69 6374  process.conflict
-000027e0: 5f67 6574 5f6c 6174 6573 745f 6466 203d  _get_latest_df =
-000027f0: 2067 6574 5f6c 6174 6573 745f 7265 636f   get_latest_reco
-00002800: 7264 735f 7769 7468 5f70 6b5f 636f 6e66  rds_with_pk_conf
-00002810: 6963 745f 6465 7465 6374 696f 6e5f 666c  ict_detection_fl
-00002820: 6167 2864 662c 2070 7269 6d61 7279 5f6b  ag(df, primary_k
-00002830: 6579 5f63 6f6c 756d 6e73 2c20 6f72 6465  ey_columns, orde
-00002840: 725f 6279 5f63 6f6c 756d 6e73 290a 636f  r_by_columns).co
-00002850: 6e66 6c69 6374 5f67 6574 5f6c 6174 6573  nflict_get_lates
-00002860: 745f 6466 2e73 686f 7728 7472 756e 6361  t_df.show(trunca
-00002870: 7465 3d54 7275 6529 0a0a 3e3e 202b 2d2d  te=True)..>> +--
-00002880: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
-00002890: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2b2d 2d2d  -----+------+---
-000028a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a  --------------+.
-000028b0: 3e3e 207c 2070 6b7c 2020 2020 2020 2020  >> | pk|        
-000028c0: 2020 6368 616e 6765 5f74 737c 2020 6174    change_ts|  at
-000028d0: 7472 7c5f 5f68 6173 5f70 6b5f 636f 6e66  tr|__has_pk_conf
-000028e0: 6c69 6374 7c0a 3e3e 202b 2d2d 2d2b 2d2d  lict|.>> +---+--
-000028f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002900: 2d2b 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  -+------+-------
-00002910: 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 3e3e 207c  ----------+.>> |
-00002920: 2020 317c 3230 3030 2d30 312d 3031 2030    1|2000-01-01 0
-00002930: 323a 3030 3a30 307c 2020 3130 3032 7c20  2:00:00|  1002| 
-00002940: 2020 2020 2020 2020 2020 2066 616c 7365             false
-00002950: 7c0a 3e3e 207c 2020 327c 3230 3030 2d30  |.>> |  2|2000-0
-00002960: 312d 3031 2030 303a 3030 3a30 307c 2020  1-01 00:00:00|  
-00002970: 3230 3031 7c20 2020 2020 2020 2020 2020  2001|           
-00002980: 2066 616c 7365 7c0a 3e3e 207c 2020 337c   false|.>> |  3|
-00002990: 3230 3030 2d30 312d 3031 2030 323a 3030  2000-01-01 02:00
-000029a0: 3a30 307c 3330 3032 2332 7c20 2020 2020  :00|3002#2|     
-000029b0: 2020 2020 2020 2020 7472 7565 7c0a 3e3e          true|.>>
-000029c0: 207c 2020 337c 3230 3030 2d30 312d 3031   |  3|2000-01-01
-000029d0: 2030 323a 3030 3a30 307c 3330 3032 2331   02:00:00|3002#1
-000029e0: 7c20 2020 2020 2020 2020 2020 2020 7472  |             tr
-000029f0: 7565 7c0a 3e3e 202b 2d2d 2d2b 2d2d 2d2d  ue|.>> +---+----
-00002a00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
-00002a10: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  ------+---------
-00002a20: 2d2d 2d2d 2d2d 2d2d 2b0a 0a60 6060 0a0a  --------+..```..
-00002a30: 2323 2046 696e 6420 636f 6d70 6f73 6974  ## Find composit
-00002a40: 6520 7072 696d 6172 7920 6b65 7920 6361  e primary key ca
-00002a50: 6e64 6964 6174 6573 0a47 6976 656e 206c  ndidates.Given l
-00002a60: 6973 7420 6f66 2070 6f73 7369 626c 6520  ist of possible 
-00002a70: 636f 6c75 6d6e 732c 2063 6f6e 7374 7275  columns, constru
-00002a80: 6374 7320 7468 6520 6c69 7374 7320 6f66  cts the lists of
-00002a90: 2061 6c6c 2070 6f73 7369 626c 6520 636f   all possible co
-00002aa0: 6d62 696e 6174 696f 6e73 206f 6620 636f  mbinations of co
-00002ab0: 6d70 6f73 6974 6520 7072 696d 6172 7920  mposite primary 
-00002ac0: 6b65 7973 2c20 616e 6420 6578 6563 7574  keys, and execut
-00002ad0: 6573 2063 6f6e 6375 7272 656e 746c 7920  es concurrently 
-00002ae0: 746f 2064 6574 6572 6d69 6e65 2069 6620  to determine if 
-00002af0: 6769 7665 6e20 7365 7420 6f66 2063 6f6c  given set of col
-00002b00: 756d 6e73 2069 7320 6120 7661 6c69 6420  umns is a valid 
-00002b10: 7072 696d 6172 7920 6b65 792e 2055 7365  primary key. Use
-00002b20: 7320 6d69 6e69 6d75 6d20 706f 7373 6962  s minimum possib
-00002b30: 6c65 2061 6d6f 756e 7420 6f66 2071 7565  le amount of que
-00002b40: 7269 6573 2061 6761 696e 7374 2073 7061  ries against spa
-00002b50: 726b 2062 7920 736b 6970 7069 6e67 2076  rk by skipping v
-00002b60: 616c 6964 6174 696f 6e20 7061 7468 7320  alidation paths 
-00002b70: 7468 6174 2061 7265 2062 6173 6564 206f  that are based o
-00002b80: 6e20 616c 7265 6164 7920 7661 6c69 6461  n already valida
-00002b90: 7465 6420 7072 696d 6172 7920 6b65 7920  ted primary key 
-00002ba0: 636f 6d62 696e 6174 696f 6e73 2e0a 0a60  combinations...`
-00002bb0: 6060 7079 7468 6f6e 0a69 6d70 6f72 7420  ``python.import 
-00002bc0: 6264 710a 696d 706f 7274 2070 7973 7061  bdq.import pyspa
-00002bd0: 726b 2e73 716c 2e66 756e 6374 696f 6e73  rk.sql.functions
-00002be0: 2061 7320 460a 0a64 6620 3d20 7370 6172   as F..df = spar
-00002bf0: 6b2e 7261 6e67 6528 302c 2031 3030 2920  k.range(0, 100) 
-00002c00: 5c0a 2020 2e77 6974 6843 6f6c 756d 6e28  \.  .withColumn(
-00002c10: 2774 7970 6527 2c20 462e 6578 7072 2827  'type', F.expr('
-00002c20: 2869 6420 2f20 3130 293a 3a69 6e74 202b  (id / 10)::int +
-00002c30: 2031 2729 2920 5c0a 2020 2e77 6974 6843   1')) \.  .withC
-00002c40: 6f6c 756d 6e28 2772 656d 696e 6465 7227  olumn('reminder'
-00002c50: 2c20 462e 6578 7072 2827 6964 2025 2031  , F.expr('id % 1
-00002c60: 3027 2929 205c 0a20 202e 7769 7468 436f  0')) \.  .withCo
-00002c70: 6c75 6d6e 2827 7374 6174 6963 272c 2046  lumn('static', F
-00002c80: 2e6c 6974 2827 4127 2929 205c 0a20 202e  .lit('A')) \.  .
-00002c90: 7769 7468 436f 6c75 6d6e 2827 726f 756e  withColumn('roun
-00002ca0: 645f 726f 6269 6e27 2c20 462e 6578 7072  d_robin', F.expr
-00002cb0: 2827 6964 2025 2032 2729 290a 0a64 6973  ('id % 2'))..dis
-00002cc0: 706c 6179 2864 6629 0a0a 616c 6c5f 636f  play(df)..all_co
-00002cd0: 6d62 696e 6174 696f 6e73 203d 206c 6973  mbinations = lis
-00002ce0: 7428 6264 712e 6765 745f 636f 6c75 6d6e  t(bdq.get_column
-00002cf0: 5f6e 616d 6573 5f63 6f6d 6269 6e61 7469  _names_combinati
-00002d00: 6f6e 7328 6466 2e63 6f6c 756d 6e73 2929  ons(df.columns))
-00002d10: 0a0a 6264 712e 7661 6c69 6461 7465 5f70  ..bdq.validate_p
-00002d20: 7269 6d61 7279 5f6b 6579 5f63 616e 6469  rimary_key_candi
-00002d30: 6461 7465 5f63 6f6d 6269 6e61 7469 6f6e  date_combination
-00002d40: 7328 6466 2c20 616c 6c5f 636f 6d62 696e  s(df, all_combin
-00002d50: 6174 696f 6e73 2c20 6d61 785f 776f 726b  ations, max_work
-00002d60: 6572 733d 3130 2c20 7665 7262 6f73 653d  ers=10, verbose=
-00002d70: 5472 7565 290a 3e3e 205b 2827 6964 272c  True).>> [('id',
-00002d80: 292c 2028 2774 7970 6527 2c20 2772 656d  ), ('type', 'rem
-00002d90: 696e 6465 7227 295d 0a60 6060 0a0a 2323  inder')].```..##
-00002da0: 2045 7865 6375 7465 2044 4147 2068 6176   Execute DAG hav
-00002db0: 696e 6720 6e6f 6465 7320 6173 2070 7974  ing nodes as pyt
-00002dc0: 686f 6e20 6675 6e63 7469 6f6e 730a 6060  hon functions.``
-00002dd0: 6070 7974 686f 6e0a 696d 706f 7274 2062  `python.import b
-00002de0: 6471 0a69 6d70 6f72 7420 7469 6d65 0a69  dq.import time.i
-00002df0: 6d70 6f72 7420 7079 7465 7374 0a0a 2363  mport pytest..#c
-00002e00: 7265 6174 6520 6772 6170 680a 6772 6170  reate graph.grap
-00002e10: 6820 3d20 6264 712e 4441 4728 290a 0a23  h = bdq.DAG()..#
-00002e20: 6465 6669 6e65 206e 6f64 6573 0a40 6772  define nodes.@gr
-00002e30: 6170 682e 6e6f 6465 2829 0a64 6566 2061  aph.node().def a
-00002e40: 2829 3a0a 2020 7469 6d65 2e73 6c65 6570  ():.  time.sleep
-00002e50: 2832 290a 2020 7265 7475 726e 2035 0a0a  (2).  return 5..
-00002e60: 4067 7261 7068 2e6e 6f64 6528 290a 6465  @graph.node().de
-00002e70: 6620 6228 293a 0a20 2074 696d 652e 736c  f b():.  time.sl
-00002e80: 6565 7028 3329 0a20 2072 6574 7572 6e20  eep(3).  return 
-00002e90: 2262 6565 6570 220a 0a23 6e6f 6465 7320  "beeep"..#nodes 
-00002ea0: 6361 6e20 6465 7065 6e64 206f 6e20 6f74  can depend on ot
-00002eb0: 6865 7220 6e6f 6465 730a 4067 7261 7068  her nodes.@graph
-00002ec0: 2e6e 6f64 6528 6465 7065 6e64 735f 6f6e  .node(depends_on
-00002ed0: 3d5b 625d 290a 6465 6620 6328 293a 0a20  =[b]).def c():. 
-00002ee0: 2074 696d 652e 736c 6565 7028 3529 0a20   time.sleep(5). 
-00002ef0: 2072 6574 7572 6e20 380a 0a23 616e 7920   return 8..#any 
-00002f00: 616d 6f75 6e74 206f 6620 6465 7065 6e64  amount of depend
-00002f10: 656e 6369 6573 2069 7320 616c 6c6f 7765  encies is allowe
-00002f20: 640a 4067 7261 7068 2e6e 6f64 6528 6465  d.@graph.node(de
-00002f30: 7065 6e64 735f 6f6e 3d5b 622c 2063 2c20  pends_on=[b, c, 
-00002f40: 615d 290a 6465 6620 6428 293a 0a20 2074  a]).def d():.  t
-00002f50: 696d 652e 736c 6565 7028 3729 0a20 2023  ime.sleep(7).  #
-00002f60: 6265 6570 2061 7320 6d61 6e79 2074 696d  beep as many tim
-00002f70: 6573 2061 7320 6162 736f 6c75 7465 2064  es as absolute d
-00002f80: 6966 6665 7265 6e63 6520 6265 7477 6565  ifference betwee
-00002f90: 6e20 2763 2720 616e 6420 2761 270a 2020  n 'c' and 'a'.  
-00002fa0: 7265 7475 726e 2022 6720 6d61 6e20 7361  return "g man sa
-00002fb0: 793a 2022 202b 2062 2e72 6573 756c 7420  y: " + b.result 
-00002fc0: 2a20 6162 7328 632e 7265 7375 6c74 202d  * abs(c.result -
-00002fd0: 2061 2e72 6573 756c 7429 0a0a 4067 7261   a.result)..@gra
-00002fe0: 7068 2e6e 6f64 6528 6465 7065 6e64 735f  ph.node(depends_
-00002ff0: 6f6e 3d5b 615d 290a 6465 6620 6528 293a  on=[a]).def e():
-00003000: 0a20 2074 696d 652e 736c 6565 7028 3329  .  time.sleep(3)
-00003010: 0a20 2023 796f 7520 6361 6e20 7265 6665  .  #you can refe
-00003020: 7220 746f 2070 6172 656e 7420 6e6f 6465  r to parent node
-00003030: 732c 2074 6f20 6765 7420 696e 666f 726d  s, to get inform
-00003040: 6174 696f 6e20 6162 6f75 7420 7468 6569  ation about thei
-00003050: 7220 7265 7375 6c74 730a 2020 7261 6973  r results.  rais
-00003060: 6520 5661 6c75 6545 7272 6f72 2866 226f  e ValueError(f"o
-00003070: 6d67 2c20 6372 6173 6821 207b 612e 7265  mg, crash! {a.re
-00003080: 7375 6c74 7d22 290a 0a40 6772 6170 682e  sult}")..@graph.
-00003090: 6e6f 6465 2864 6570 656e 6473 5f6f 6e3d  node(depends_on=
-000030a0: 5b65 5d29 0a64 6566 2066 2829 3a0a 2020  [e]).def f():.  
-000030b0: 7072 696e 7428 2274 6869 7320 7769 6c6c  print("this will
-000030c0: 206e 6576 6572 2065 7865 6375 7465 2229   never execute")
-000030d0: 0a20 2072 6574 7572 6e20 2274 6869 7320  .  return "this 
-000030e0: 7769 6c6c 206e 6576 6572 2065 7865 6375  will never execu
-000030f0: 7465 220a 0a40 6772 6170 682e 6e6f 6465  te"..@graph.node
-00003100: 2864 6570 656e 6473 5f6f 6e3d 5b61 5d29  (depends_on=[a])
-00003110: 0a64 6566 2067 2829 3a0a 2020 7469 6d65  .def g():.  time
-00003120: 2e73 6c65 6570 2833 290a 2020 2377 6520  .sleep(3).  #we 
-00003130: 646f 206e 6f74 2077 616e 7420 746f 2065  do not want to e
-00003140: 7865 6375 7465 2063 6869 6c64 7265 6e20  xecute children 
-00003150: 6e6f 6465 7320 616e 796d 6f72 650a 2020  nodes anymore.  
-00003160: 2372 6574 7572 6e20 6772 6170 682e 4252  #return graph.BR
-00003170: 4541 4b20 7468 6973 2077 696c 6c20 6361  EAK this will ca
-00003180: 7573 6520 7468 6174 2061 6c6c 2063 6869  use that all chi
-00003190: 6c64 7265 6e2f 7375 6363 6573 736f 7273  ldren/successors
-000031a0: 2069 6e20 6772 6170 6820 7769 6c6c 2062   in graph will b
-000031b0: 6520 736b 6970 7065 6420 7769 7468 6f75  e skipped withou
-000031c0: 7420 6572 7272 6f72 0a20 2072 6574 7572  t errror.  retur
-000031d0: 6e20 6772 6170 682e 4252 4541 4b0a 0a40  n graph.BREAK..@
-000031e0: 6772 6170 682e 6e6f 6465 2864 6570 656e  graph.node(depen
-000031f0: 6473 5f6f 6e3d 5b67 5d29 0a64 6566 2069  ds_on=[g]).def i
-00003200: 2829 3a0a 2020 7072 696e 7428 2274 6869  ():.  print("thi
-00003210: 7320 7769 6c6c 206e 6576 6572 2065 7865  s will never exe
-00003220: 6375 7465 2074 6f6f 2229 0a20 2072 6574  cute too").  ret
-00003230: 7572 6e20 2274 6869 7320 7769 6c6c 206e  urn "this will n
-00003240: 6576 6572 2065 7865 6375 7465 2074 6f6f  ever execute too
-00003250: 220a 0a23 2069 6620 796f 7520 6861 7665  "..# if you have
-00003260: 2069 7079 6461 6772 6564 3320 696e 7374   ipydagred3 inst
-00003270: 616c 6c65 642c 2079 6f75 2063 616e 2073  alled, you can s
-00003280: 6565 2069 6e20 7265 616c 2074 696d 6520  ee in real time 
-00003290: 7374 6174 6520 6368 616e 6765 7320 6f66  state changes of
-000032a0: 2065 6163 6820 6f66 2074 6865 206e 6f64   each of the nod
-000032b0: 6573 0a64 6973 706c 6179 2867 7261 7068  es.display(graph
-000032c0: 2e76 6973 7561 6c69 7a65 2829 290a 0a23  .visualize())..#
-000032d0: 6578 6563 7574 6520 4441 470a 6772 6170  execute DAG.grap
-000032e0: 682e 6578 6563 7574 6528 6d61 785f 776f  h.execute(max_wo
-000032f0: 726b 6572 733d 3130 290a 0a23 6974 6572  rkers=10)..#iter
-00003300: 6174 6520 6f76 6572 2072 6573 756c 7473  ate over results
-00003310: 0a70 7269 6e74 2822 4974 6572 6174 6520  .print("Iterate 
-00003320: 6f76 6572 2072 6573 756c 7473 2e2e 2e22  over results..."
-00003330: 290a 666f 7220 6e6f 6465 2069 6e20 6772  ).for node in gr
-00003340: 6170 682e 6e6f 6465 733a 0a20 2070 7269  aph.nodes:.  pri
-00003350: 6e74 286e 6f64 6529 0a0a 3e3e 2057 6169  nt(node)..>> Wai
-00003360: 7469 6e67 2066 6f72 2061 6c6c 2074 6173  ting for all tas
-00003370: 6b73 2074 6f20 6669 6e69 7368 2e2e 2e0a  ks to finish....
-00003380: 3e3e 2020 2073 7461 7274 696e 673a 204e  >>   starting: N
-00003390: 6f64 6528 3c66 756e 6374 696f 6e20 6120  ode(<function a 
-000033a0: 6174 2030 7837 6635 3066 3462 3965 6535  at 0x7f50f4b9ee5
-000033b0: 303e 3a20 7b27 7374 6174 6527 3a20 2752  0>: {'state': 'R
-000033c0: 554e 4e49 4e47 272c 2027 7265 7375 6c74  UNNING', 'result
-000033d0: 273a 204e 6f6e 652c 2027 6578 6365 7074  ': None, 'except
-000033e0: 696f 6e27 3a20 4e6f 6e65 2c20 2763 6f6d  ion': None, 'com
-000033f0: 706c 6574 6564 273a 2046 616c 7365 7d20  pleted': False} 
-00003400: 290a 3e3e 2020 2073 7461 7274 696e 673a  ).>>   starting:
-00003410: 204e 6f64 6528 3c66 756e 6374 696f 6e20   Node(<function 
-00003420: 6220 6174 2030 7837 6635 3066 3462 3533  b at 0x7f50f4b53
-00003430: 3034 303e 3a20 7b27 7374 6174 6527 3a20  040>: {'state': 
-00003440: 2752 554e 4e49 4e47 272c 2027 7265 7375  'RUNNING', 'resu
-00003450: 6c74 273a 204e 6f6e 652c 2027 6578 6365  lt': None, 'exce
-00003460: 7074 696f 6e27 3a20 4e6f 6e65 2c20 2763  ption': None, 'c
-00003470: 6f6d 706c 6574 6564 273a 2046 616c 7365  ompleted': False
-00003480: 7d20 290a 3e3e 2020 2073 7461 7274 696e  } ).>>   startin
-00003490: 673a 204e 6f64 6528 3c66 756e 6374 696f  g: Node(<functio
-000034a0: 6e20 6520 6174 2030 7837 6635 3066 3462  n e at 0x7f50f4b
-000034b0: 3533 6238 303e 3a20 7b27 7374 6174 6527  53b80>: {'state'
-000034c0: 3a20 2752 554e 4e49 4e47 272c 2027 7265  : 'RUNNING', 're
-000034d0: 7375 6c74 273a 204e 6f6e 652c 2027 6578  sult': None, 'ex
-000034e0: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
-000034f0: 2763 6f6d 706c 6574 6564 273a 2046 616c  'completed': Fal
-00003500: 7365 7d20 290a 3e3e 2020 2073 7461 7274  se} ).>>   start
-00003510: 696e 673a 204e 6f64 6528 3c66 756e 6374  ing: Node(<funct
-00003520: 696f 6e20 6720 6174 2030 7837 6635 3066  ion g at 0x7f50f
-00003530: 3462 3533 3565 303e 3a20 7b27 7374 6174  4b535e0>: {'stat
-00003540: 6527 3a20 2752 554e 4e49 4e47 272c 2027  e': 'RUNNING', '
-00003550: 7265 7375 6c74 273a 204e 6f6e 652c 2027  result': None, '
-00003560: 6578 6365 7074 696f 6e27 3a20 4e6f 6e65  exception': None
-00003570: 2c20 2763 6f6d 706c 6574 6564 273a 2046  , 'completed': F
-00003580: 616c 7365 7d20 290a 3e3e 2020 2066 696e  alse} ).>>   fin
-00003590: 6973 6865 643a 204e 6f64 6528 3c66 756e  ished: Node(<fun
-000035a0: 6374 696f 6e20 6120 6174 2030 7837 6635  ction a at 0x7f5
-000035b0: 3066 3462 3965 6535 303e 3a20 7b27 7374  0f4b9ee50>: {'st
-000035c0: 6174 6527 3a20 2753 5543 4345 5353 272c  ate': 'SUCCESS',
-000035d0: 2027 7265 7375 6c74 273a 2035 2c20 2765   'result': 5, 'e
-000035e0: 7863 6570 7469 6f6e 273a 204e 6f6e 652c  xception': None,
-000035f0: 2027 636f 6d70 6c65 7465 6427 3a20 5472   'completed': Tr
-00003600: 7565 7d20 2920 2873 7469 6c6c 2072 756e  ue} ) (still run
-00003610: 6e69 6e67 3a20 3329 0a3e 3e20 2020 7374  ning: 3).>>   st
-00003620: 6172 7469 6e67 3a20 4e6f 6465 283c 6675  arting: Node(<fu
-00003630: 6e63 7469 6f6e 2063 2061 7420 3078 3766  nction c at 0x7f
-00003640: 3530 6634 6235 3334 6330 3e3a 207b 2773  50f4b534c0>: {'s
-00003650: 7461 7465 273a 2027 5255 4e4e 494e 4727  tate': 'RUNNING'
-00003660: 2c20 2772 6573 756c 7427 3a20 4e6f 6e65  , 'result': None
-00003670: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
-00003680: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
-00003690: 3a20 4661 6c73 657d 2029 0a3e 3e20 2020  : False} ).>>   
-000036a0: 6669 6e69 7368 6564 3a20 4e6f 6465 283c  finished: Node(<
-000036b0: 6675 6e63 7469 6f6e 2062 2061 7420 3078  function b at 0x
-000036c0: 3766 3530 6634 6235 3330 3430 3e3a 207b  7f50f4b53040>: {
-000036d0: 2773 7461 7465 273a 2027 5355 4343 4553  'state': 'SUCCES
-000036e0: 5327 2c20 2772 6573 756c 7427 3a20 2762  S', 'result': 'b
-000036f0: 6565 6570 272c 2027 6578 6365 7074 696f  eeep', 'exceptio
-00003700: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
-00003710: 6574 6564 273a 2054 7275 657d 2029 2028  eted': True} ) (
-00003720: 7374 696c 6c20 7275 6e6e 696e 673a 2033  still running: 3
-00003730: 290a 3e3e 2020 2065 7272 6f72 3a20 4e6f  ).>>   error: No
-00003740: 6465 283c 6675 6e63 7469 6f6e 2065 2061  de(<function e a
-00003750: 7420 3078 3766 3530 6634 6235 3362 3830  t 0x7f50f4b53b80
-00003760: 3e3a 207b 2773 7461 7465 273a 2027 4552  >: {'state': 'ER
-00003770: 524f 5227 2c20 2772 6573 756c 7427 3a20  ROR', 'result': 
-00003780: 4e6f 6e65 2c20 2765 7863 6570 7469 6f6e  None, 'exception
-00003790: 273a 2056 616c 7565 4572 726f 7228 276f  ': ValueError('o
-000037a0: 6d67 2c20 6372 6173 6821 2035 2729 2c20  mg, crash! 5'), 
-000037b0: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
-000037c0: 657d 2029 3a20 6f6d 672c 2063 7261 7368  e} ): omg, crash
-000037d0: 2120 3520 2873 7469 6c6c 2072 756e 6e69  ! 5 (still runni
-000037e0: 6e67 3a20 3229 0a3e 3e20 2020 6669 6e69  ng: 2).>>   fini
-000037f0: 7368 6564 3a20 4e6f 6465 283c 6675 6e63  shed: Node(<func
-00003800: 7469 6f6e 2067 2061 7420 3078 3766 3530  tion g at 0x7f50
-00003810: 6634 6235 3335 6530 3e3a 207b 2773 7461  f4b535e0>: {'sta
-00003820: 7465 273a 2027 534b 4950 5045 4427 2c20  te': 'SKIPPED', 
-00003830: 2772 6573 756c 7427 3a20 3c74 6872 6561  'result': <threa
-00003840: 6469 6e67 2e45 7665 6e74 206f 626a 6563  ding.Event objec
-00003850: 7420 6174 2030 7837 6635 3065 6331 3663  t at 0x7f50ec16c
-00003860: 3964 303e 2c20 2765 7863 6570 7469 6f6e  9d0>, 'exception
-00003870: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
-00003880: 7465 6427 3a20 5472 7565 7d20 2920 2873  ted': True} ) (s
-00003890: 7469 6c6c 2072 756e 6e69 6e67 3a20 3129  till running: 1)
-000038a0: 0a3e 3e20 2020 7374 6172 7469 6e67 3a20  .>>   starting: 
-000038b0: 4e6f 6465 283c 6675 6e63 7469 6f6e 2064  Node(<function d
-000038c0: 2061 7420 3078 3766 3530 6634 6235 3361   at 0x7f50f4b53a
-000038d0: 3630 3e3a 207b 2773 7461 7465 273a 2027  60>: {'state': '
-000038e0: 5255 4e4e 494e 4727 2c20 2772 6573 756c  RUNNING', 'resul
-000038f0: 7427 3a20 4e6f 6e65 2c20 2765 7863 6570  t': None, 'excep
-00003900: 7469 6f6e 273a 204e 6f6e 652c 2027 636f  tion': None, 'co
-00003910: 6d70 6c65 7465 6427 3a20 4661 6c73 657d  mpleted': False}
-00003920: 2029 0a3e 3e20 2020 6669 6e69 7368 6564   ).>>   finished
-00003930: 3a20 4e6f 6465 283c 6675 6e63 7469 6f6e  : Node(<function
-00003940: 2063 2061 7420 3078 3766 3530 6634 6235   c at 0x7f50f4b5
-00003950: 3334 6330 3e3a 207b 2773 7461 7465 273a  34c0>: {'state':
-00003960: 2027 5355 4343 4553 5327 2c20 2772 6573   'SUCCESS', 'res
-00003970: 756c 7427 3a20 382c 2027 6578 6365 7074  ult': 8, 'except
-00003980: 696f 6e27 3a20 4e6f 6e65 2c20 2763 6f6d  ion': None, 'com
-00003990: 706c 6574 6564 273a 2054 7275 657d 2029  pleted': True} )
-000039a0: 2028 7374 696c 6c20 7275 6e6e 696e 673a   (still running:
-000039b0: 2031 290a 3e3e 2020 2066 696e 6973 6865   1).>>   finishe
-000039c0: 643a 204e 6f64 6528 3c66 756e 6374 696f  d: Node(<functio
-000039d0: 6e20 6420 6174 2030 7837 6635 3066 3462  n d at 0x7f50f4b
-000039e0: 3533 6136 303e 3a20 7b27 7374 6174 6527  53a60>: {'state'
-000039f0: 3a20 2753 5543 4345 5353 272c 2027 7265  : 'SUCCESS', 're
-00003a00: 7375 6c74 273a 2027 6720 6d61 6e20 7361  sult': 'g man sa
-00003a10: 793a 2062 6565 6570 6265 6565 7062 6565  y: beeepbeeepbee
-00003a20: 6570 272c 2027 6578 6365 7074 696f 6e27  ep', 'exception'
-00003a30: 3a20 4e6f 6e65 2c20 2763 6f6d 706c 6574  : None, 'complet
-00003a40: 6564 273a 2054 7275 657d 2029 2028 7374  ed': True} ) (st
-00003a50: 696c 6c20 7275 6e6e 696e 673a 2030 290a  ill running: 0).
-00003a60: 3e3e 2041 6c6c 2074 6173 6b73 2066 696e  >> All tasks fin
-00003a70: 6973 6865 642c 2073 6875 7474 696e 6720  ished, shutting 
-00003a80: 646f 776e 0a3e 3e0a 3e3e 2049 7465 7261  down.>>.>> Itera
-00003a90: 7465 206f 7665 7220 7265 7375 6c74 732e  te over results.
-00003aa0: 2e2e 0a3e 3e20 4e6f 6465 283c 6675 6e63  ...>> Node(<func
-00003ab0: 7469 6f6e 2061 2061 7420 3078 3766 3530  tion a at 0x7f50
-00003ac0: 6634 6239 6565 3530 3e3a 207b 2773 7461  f4b9ee50>: {'sta
-00003ad0: 7465 273a 2027 5355 4343 4553 5327 2c20  te': 'SUCCESS', 
-00003ae0: 2772 6573 756c 7427 3a20 352c 2027 6578  'result': 5, 'ex
-00003af0: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
-00003b00: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
-00003b10: 657d 2029 0a3e 3e20 4e6f 6465 283c 6675  e} ).>> Node(<fu
-00003b20: 6e63 7469 6f6e 2062 2061 7420 3078 3766  nction b at 0x7f
-00003b30: 3530 6634 6235 3330 3430 3e3a 207b 2773  50f4b53040>: {'s
-00003b40: 7461 7465 273a 2027 5355 4343 4553 5327  tate': 'SUCCESS'
-00003b50: 2c20 2772 6573 756c 7427 3a20 2762 6565  , 'result': 'bee
-00003b60: 6570 272c 2027 6578 6365 7074 696f 6e27  ep', 'exception'
-00003b70: 3a20 4e6f 6e65 2c20 2763 6f6d 706c 6574  : None, 'complet
-00003b80: 6564 273a 2054 7275 657d 2029 0a3e 3e20  ed': True} ).>> 
-00003b90: 4e6f 6465 283c 6675 6e63 7469 6f6e 2063  Node(<function c
-00003ba0: 2061 7420 3078 3766 3530 6634 6235 3334   at 0x7f50f4b534
-00003bb0: 6330 3e3a 207b 2773 7461 7465 273a 2027  c0>: {'state': '
-00003bc0: 5355 4343 4553 5327 2c20 2772 6573 756c  SUCCESS', 'resul
-00003bd0: 7427 3a20 382c 2027 6578 6365 7074 696f  t': 8, 'exceptio
-00003be0: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
-00003bf0: 6574 6564 273a 2054 7275 657d 2029 0a3e  eted': True} ).>
-00003c00: 3e20 4e6f 6465 283c 6675 6e63 7469 6f6e  > Node(<function
-00003c10: 2064 2061 7420 3078 3766 3530 6634 6235   d at 0x7f50f4b5
-00003c20: 3361 3630 3e3a 207b 2773 7461 7465 273a  3a60>: {'state':
-00003c30: 2027 5355 4343 4553 5327 2c20 2772 6573   'SUCCESS', 'res
-00003c40: 756c 7427 3a20 2767 206d 616e 2073 6179  ult': 'g man say
-00003c50: 3a20 6265 6565 7062 6565 6570 6265 6565  : beeepbeeepbeee
-00003c60: 7027 2c20 2765 7863 6570 7469 6f6e 273a  p', 'exception':
-00003c70: 204e 6f6e 652c 2027 636f 6d70 6c65 7465   None, 'complete
-00003c80: 6427 3a20 5472 7565 7d20 290a 3e3e 204e  d': True} ).>> N
-00003c90: 6f64 6528 3c66 756e 6374 696f 6e20 6520  ode(<function e 
-00003ca0: 6174 2030 7837 6635 3066 3462 3533 6238  at 0x7f50f4b53b8
-00003cb0: 303e 3a20 7b27 7374 6174 6527 3a20 2745  0>: {'state': 'E
-00003cc0: 5252 4f52 272c 2027 7265 7375 6c74 273a  RROR', 'result':
-00003cd0: 204e 6f6e 652c 2027 6578 6365 7074 696f   None, 'exceptio
-00003ce0: 6e27 3a20 5661 6c75 6545 7272 6f72 2827  n': ValueError('
-00003cf0: 6f6d 672c 2063 7261 7368 2120 3527 292c  omg, crash! 5'),
-00003d00: 2027 636f 6d70 6c65 7465 6427 3a20 5472   'completed': Tr
-00003d10: 7565 7d20 290a 3e3e 204e 6f64 6528 3c66  ue} ).>> Node(<f
-00003d20: 756e 6374 696f 6e20 6620 6174 2030 7837  unction f at 0x7
-00003d30: 6635 3066 3462 3533 3064 303e 3a20 7b27  f50f4b530d0>: {'
-00003d40: 7374 6174 6527 3a20 2753 4b49 5050 4544  state': 'SKIPPED
-00003d50: 272c 2027 7265 7375 6c74 273a 204e 6f6e  ', 'result': Non
-00003d60: 652c 2027 6578 6365 7074 696f 6e27 3a20  e, 'exception': 
-00003d70: 4e6f 6e65 2c20 2763 6f6d 706c 6574 6564  None, 'completed
-00003d80: 273a 2046 616c 7365 7d20 290a 3e3e 204e  ': False} ).>> N
-00003d90: 6f64 6528 3c66 756e 6374 696f 6e20 6720  ode(<function g 
-00003da0: 6174 2030 7837 6635 3066 3462 3533 3565  at 0x7f50f4b535e
-00003db0: 303e 3a20 7b27 7374 6174 6527 3a20 2753  0>: {'state': 'S
-00003dc0: 4b49 5050 4544 272c 2027 7265 7375 6c74  KIPPED', 'result
-00003dd0: 273a 203c 7468 7265 6164 696e 672e 4576  ': <threading.Ev
-00003de0: 656e 7420 6f62 6a65 6374 2061 7420 3078  ent object at 0x
-00003df0: 3766 3530 6563 3136 6339 6430 3e2c 2027  7f50ec16c9d0>, '
-00003e00: 6578 6365 7074 696f 6e27 3a20 4e6f 6e65  exception': None
-00003e10: 2c20 2763 6f6d 706c 6574 6564 273a 2054  , 'completed': T
-00003e20: 7275 657d 2029 0a3e 3e20 4e6f 6465 283c  rue} ).>> Node(<
-00003e30: 6675 6e63 7469 6f6e 2069 2061 7420 3078  function i at 0x
-00003e40: 3766 3530 6634 6235 3332 3830 3e3a 207b  7f50f4b53280>: {
-00003e50: 2773 7461 7465 273a 2027 534b 4950 5045  'state': 'SKIPPE
-00003e60: 4427 2c20 2772 6573 756c 7427 3a20 4e6f  D', 'result': No
-00003e70: 6e65 2c20 2765 7863 6570 7469 6f6e 273a  ne, 'exception':
-00003e80: 204e 6f6e 652c 2027 636f 6d70 6c65 7465   None, 'complete
-00003e90: 6427 3a20 4661 6c73 657d 2029 0a60 6060  d': False} ).```
-00003ea0: 0a0a 2323 2045 7865 6375 7465 2073 7061  ..## Execute spa
-00003eb0: 726b 2070 6970 656c 696e 6520 6f66 206d  rk pipeline of m
-00003ec0: 756c 7469 706c 6520 7374 6570 730a 7573  ultiple steps.us
-00003ed0: 696e 6720 4441 4720 636f 6d70 6f6e 656e  ing DAG componen
-00003ee0: 7420 746f 2068 616e 646c 6520 7061 7261  t to handle para
-00003ef0: 6c6c 656c 2065 7865 6375 7469 6f6e 0a60  llel execution.`
-00003f00: 6060 7079 7468 6f6e 0a69 6d70 6f72 7420  ``python.import 
-00003f10: 6264 710a 6672 6f6d 2062 6471 2069 6d70  bdq.from bdq imp
-00003f20: 6f72 7420 7370 6172 6b2c 2074 6162 6c65  ort spark, table
-00003f30: 0a0a 7070 6e20 3d20 6264 712e 5370 6172  ..ppn = bdq.Spar
-00003f40: 6b50 6970 656c 696e 6528 7370 6172 6b2c  kPipeline(spark,
-00003f50: 2022 7265 7461 696c 2229 0a0a 2320 7265   "retail")..# re
-00003f60: 7475 726e 7320 6461 7461 6672 616d 652c  turns dataframe,
-00003f70: 2061 6e64 2063 7265 6174 6573 2073 7061   and creates spa
-00003f80: 726b 2076 6965 7720 2772 6177 5f64 6174  rk view 'raw_dat
-00003f90: 615f 7369 6e67 6c65 5f73 6f75 7263 6527  a_single_source'
-00003fa0: 0a40 7070 6e2e 7374 6570 2829 0a64 6566  .@ppn.step().def
-00003fb0: 2072 6177 5f64 6174 615f 7369 6e67 6c65   raw_data_single
-00003fc0: 5f73 6f75 7263 6528 7029 3a0a 2020 7265  _source(p):.  re
-00003fd0: 7475 726e 2073 7061 726b 2e72 616e 6765  turn spark.range
-00003fe0: 2831 2c20 3130 290a 0a23 2072 6574 7572  (1, 10)..# retur
-00003ff0: 6e73 2064 6174 6166 7261 6d65 2c20 616e  ns dataframe, an
-00004000: 6420 6372 6561 7465 7320 7370 6172 6b20  d creates spark 
-00004010: 7669 6577 2027 7261 775f 6e69 6365 5f6e  view 'raw_nice_n
-00004020: 616d 6527 0a40 7070 6e2e 7374 6570 2872  ame'.@ppn.step(r
-00004030: 6574 7572 6e73 3d5b 2272 6177 5f6e 6963  eturns=["raw_nic
-00004040: 655f 6e61 6d65 225d 290a 6465 6620 7261  e_name"]).def ra
-00004050: 775f 6461 7461 5f73 696e 676c 655f 736f  w_data_single_so
-00004060: 7572 6365 5f77 6974 685f 6375 7374 6f6d  urce_with_custom
-00004070: 5f6e 616d 6528 7029 3a0a 2020 7265 7475  _name(p):.  retu
-00004080: 726e 2073 7061 726b 2e72 616e 6765 2831  rn spark.range(1
-00004090: 3030 2c20 3131 3029 0a0a 2320 7265 7475  00, 110)..# retu
-000040a0: 726e 7320 7477 6f20 6461 7461 6672 616d  rns two datafram
-000040b0: 6573 2c20 616e 6420 6372 6561 7465 7320  es, and creates 
-000040c0: 7477 6f20 7370 6172 6b20 7669 6577 7320  two spark views 
-000040d0: 2772 6177 5f64 6174 6131 272c 2027 7261  'raw_data1', 'ra
-000040e0: 775f 6461 7461 3227 0a40 7070 6e2e 7374  w_data2'.@ppn.st
-000040f0: 6570 2872 6574 7572 6e73 3d5b 2272 6177  ep(returns=["raw
-00004100: 5f64 6174 6131 222c 2022 7261 775f 6461  _data1", "raw_da
-00004110: 7461 3222 5d29 0a64 6566 2072 6177 5f64  ta2"]).def raw_d
-00004120: 6174 615f 6d75 6c74 695f 736f 7572 6365  ata_multi_source
-00004130: 2870 293a 0a20 2064 6631 203d 2073 7061  (p):.  df1 = spa
-00004140: 726b 2e72 616e 6765 2831 3030 302c 2032  rk.range(1000, 2
-00004150: 3030 3029 0a20 2064 6632 203d 2073 7061  000).  df2 = spa
-00004160: 726b 2e72 616e 6765 2832 3030 302c 2033  rk.range(2000, 3
-00004170: 3030 3029 0a0a 2020 7265 7475 726e 205b  000)..  return [
-00004180: 6466 312c 2064 6632 5d0a 0a23 2077 6169  df1, df2]..# wai
-00004190: 7473 2066 6f72 2072 6177 2064 6174 6120  ts for raw data 
-000041a0: 736f 7572 6365 7320 746f 2066 696e 6973  sources to finis
-000041b0: 682c 2061 6e64 2063 6f6d 6269 6e65 7320  h, and combines 
-000041c0: 7468 6520 6461 7461 2069 6e74 6f20 6f6e  the data into on
-000041d0: 6520 756e 696f 6e65 6420 7669 6577 2060  e unioned view `
-000041e0: 636f 6d62 696e 655f 6461 7461 600a 2320  combine_data`.# 
-000041f0: 6e6f 7465 2074 6861 7420 6465 7065 6e64  note that depend
-00004200: 656e 6369 6573 2061 7265 2070 7974 686f  encies are pytho
-00004210: 6e20 6675 6e63 7469 6f6e 732c 206e 6f74  n functions, not
-00004220: 206e 616d 6573 206f 6620 7669 6577 7320   names of views 
-00004230: 2854 4f44 4f3a 2074 6f20 6861 6e64 6c65  (TODO: to handle
-00004240: 2076 6965 7720 6e61 6d65 7320 6173 2077   view names as w
-00004250: 656c 6c29 0a40 7070 6e2e 7374 6570 2864  ell).@ppn.step(d
-00004260: 6570 656e 6473 5f6f 6e3d 5b72 6177 5f64  epends_on=[raw_d
-00004270: 6174 615f 7369 6e67 6c65 5f73 6f75 7263  ata_single_sourc
-00004280: 652c 2072 6177 5f64 6174 615f 7369 6e67  e, raw_data_sing
-00004290: 6c65 5f73 6f75 7263 655f 7769 7468 5f63  le_source_with_c
-000042a0: 7573 746f 6d5f 6e61 6d65 2c20 7261 775f  ustom_name, raw_
-000042b0: 6461 7461 5f6d 756c 7469 5f73 6f75 7263  data_multi_sourc
-000042c0: 655d 290a 6465 6620 636f 6d62 696e 655f  e]).def combine_
-000042d0: 6461 7461 2870 293a 0a20 2064 6620 3d20  data(p):.  df = 
-000042e0: 7461 626c 6528 2772 6177 5f64 6174 615f  table('raw_data_
-000042f0: 7369 6e67 6c65 5f73 6f75 7263 6527 2920  single_source') 
-00004300: 5c0a 2020 2020 2e75 6e69 6f6e 2874 6162  \.    .union(tab
-00004310: 6c65 2827 7261 775f 6e69 6365 5f6e 616d  le('raw_nice_nam
-00004320: 6527 2929 205c 0a20 2020 202e 756e 696f  e')) \.    .unio
-00004330: 6e28 7461 626c 6528 2772 6177 5f64 6174  n(table('raw_dat
-00004340: 6131 2729 2920 5c0a 2020 2020 2e75 6e69  a1')) \.    .uni
-00004350: 6f6e 2874 6162 6c65 2827 7261 775f 6461  on(table('raw_da
-00004360: 7461 3227 2929 0a0a 2020 7265 7475 726e  ta2'))..  return
-00004370: 2064 660a 0a23 2073 706c 6974 7320 7468   df..# splits th
-00004380: 6520 636f 6d62 696e 6564 5f64 6174 6120  e combined_data 
-00004390: 696e 746f 2027 6f64 6427 2061 6e64 2027  into 'odd' and '
-000043a0: 6576 656e 2720 7669 6577 730a 4070 706e  even' views.@ppn
-000043b0: 2e73 7465 7028 6465 7065 6e64 735f 6f6e  .step(depends_on
-000043c0: 3d5b 636f 6d62 696e 655f 6461 7461 5d2c  =[combine_data],
-000043d0: 2072 6574 7572 6e73 3d5b 276f 6464 272c   returns=['odd',
-000043e0: 2027 6576 656e 275d 290a 6465 6620 7370   'even']).def sp
-000043f0: 6c69 745f 6461 7461 2870 293a 0a20 2064  lit_data(p):.  d
-00004400: 665f 6f64 6420 3d20 7461 626c 6528 2763  f_odd = table('c
-00004410: 6f6d 6269 6e65 5f64 6174 6127 292e 6669  ombine_data').fi
-00004420: 6c74 6572 2827 6964 2025 2032 203d 3d20  lter('id % 2 == 
-00004430: 3127 290a 2020 6466 5f65 7665 6e20 3d20  1').  df_even = 
-00004440: 7461 626c 6528 2763 6f6d 6269 6e65 5f64  table('combine_d
-00004450: 6174 6127 292e 6669 6c74 6572 2827 6964  ata').filter('id
-00004460: 2025 2032 203d 3d20 3027 290a 0a20 2072   % 2 == 0')..  r
-00004470: 6574 7572 6e20 5b20 6466 5f6f 6464 2c20  eturn [ df_odd, 
-00004480: 6466 5f65 7665 6e20 5d0a 0a23 2069 6620  df_even ]..# if 
-00004490: 796f 7520 6861 7665 2069 7079 6461 6772  you have ipydagr
-000044a0: 6564 3320 696e 7374 616c 6c65 642c 2079  ed3 installed, y
-000044b0: 6f75 2063 616e 2073 6565 2069 6e20 7265  ou can see in re
-000044c0: 616c 2074 696d 6520 7374 6174 6520 6368  al time state ch
-000044d0: 616e 6765 7320 6f66 2065 6163 6820 6f66  anges of each of
-000044e0: 2074 6865 2073 7465 7073 0a64 6973 706c   the steps.displ
-000044f0: 6179 2870 706e 2e76 6973 7561 6c69 7a65  ay(ppn.visualize
-00004500: 2829 290a 0a23 2065 7865 6375 7465 7320  ())..# executes 
-00004510: 7069 7065 6c69 6e65 2075 7369 6e67 2063  pipeline using c
-00004520: 6f6e 6375 7272 656e 7420 7468 7265 6164  oncurrent thread
-00004530: 732c 206f 6e65 2070 6572 2065 6163 6820  s, one per each 
-00004540: 7374 6570 2c20 666f 6c6c 6f77 696e 6720  step, following 
-00004550: 7468 6520 6465 7065 6e64 656e 6379 2044  the dependency D
-00004560: 4147 0a23 2070 6970 656c 696e 6520 6973  AG.# pipeline is
-00004570: 2061 206e 6f72 6d61 6c20 7079 7468 6f6e   a normal python
-00004580: 2063 616c 6c61 626c 6520 6f62 6a65 6374   callable object
-00004590: 2c20 6173 2069 6620 6974 2077 6173 2061  , as if it was a
-000045a0: 2066 756e 6374 696f 6e2c 2069 7420 7265   function, it re
-000045b0: 7475 726e 7320 6120 6c69 7374 206f 6620  turns a list of 
-000045c0: 616c 6c20 7374 6570 730a 7069 7065 6c69  all steps.pipeli
-000045d0: 6e65 5f72 6573 756c 7473 203d 2070 706e  ne_results = ppn
-000045e0: 286d 6178 5f63 6f6e 6375 7272 656e 745f  (max_concurrent_
-000045f0: 7374 6570 733d 3130 290a 0a70 7269 6e74  steps=10)..print
-00004600: 2827 7069 7065 6c69 6e65 2072 6573 756c  ('pipeline resul
-00004610: 7473 3a27 290a 7072 696e 7428 7069 7065  ts:').print(pipe
-00004620: 6c69 6e65 5f72 6573 756c 7473 290a 0a23  line_results)..#
-00004630: 7368 6f77 2073 6f6d 6520 6669 6e61 6c20  show some final 
-00004640: 7661 6c75 6573 0a70 7269 6e74 2827 6576  values.print('ev
-00004650: 656e 206e 756d 6265 7273 3a27 290a 7072  en numbers:').pr
-00004660: 696e 7428 7461 626c 6528 2765 7665 6e27  int(table('even'
-00004670: 292e 6c69 6d69 7428 3130 292e 636f 6c6c  ).limit(10).coll
-00004680: 6563 7428 2929 0a70 7269 6e74 2827 6f64  ect()).print('od
-00004690: 6420 6e75 6d62 6572 733a 2729 0a70 7269  d numbers:').pri
-000046a0: 6e74 2874 6162 6c65 2827 6f64 6427 292e  nt(table('odd').
-000046b0: 6c69 6d69 7428 3130 292e 636f 6c6c 6563  limit(10).collec
-000046c0: 7428 2929 0a0a 3e3e 2057 6169 7469 6e67  t())..>> Waiting
-000046d0: 2066 6f72 2061 6c6c 2074 6173 6b73 2074   for all tasks t
-000046e0: 6f20 6669 6e69 7368 2e2e 2e0a 3e3e 2020  o finish....>>  
-000046f0: 2073 7461 7274 696e 673a 204e 6f64 6528   starting: Node(
-00004700: 7261 775f 6461 7461 5f73 696e 676c 655f  raw_data_single_
-00004710: 736f 7572 6365 3a20 7b27 7374 6174 6527  source: {'state'
-00004720: 3a20 2752 554e 4e49 4e47 272c 2027 7265  : 'RUNNING', 're
-00004730: 7375 6c74 273a 204e 6f6e 652c 2027 6578  sult': None, 'ex
-00004740: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
-00004750: 2763 6f6d 706c 6574 6564 273a 2046 616c  'completed': Fal
-00004760: 7365 7d20 290a 3e3e 2020 2073 7461 7274  se} ).>>   start
-00004770: 696e 673a 204e 6f64 6528 7261 775f 6461  ing: Node(raw_da
-00004780: 7461 5f73 696e 676c 655f 736f 7572 6365  ta_single_source
-00004790: 5f77 6974 685f 6375 7374 6f6d 5f6e 616d  _with_custom_nam
-000047a0: 653a 207b 2773 7461 7465 273a 2027 5255  e: {'state': 'RU
-000047b0: 4e4e 494e 4727 2c20 2772 6573 756c 7427  NNING', 'result'
-000047c0: 3a20 4e6f 6e65 2c20 2765 7863 6570 7469  : None, 'excepti
-000047d0: 6f6e 273a 204e 6f6e 652c 2027 636f 6d70  on': None, 'comp
-000047e0: 6c65 7465 6427 3a20 4661 6c73 657d 2029  leted': False} )
-000047f0: 0a3e 3e20 2020 7374 6172 7469 6e67 3a20  .>>   starting: 
-00004800: 4e6f 6465 2872 6177 5f64 6174 615f 6d75  Node(raw_data_mu
-00004810: 6c74 695f 736f 7572 6365 3a20 7b27 7374  lti_source: {'st
-00004820: 6174 6527 3a20 2752 554e 4e49 4e47 272c  ate': 'RUNNING',
-00004830: 2027 7265 7375 6c74 273a 204e 6f6e 652c   'result': None,
-00004840: 2027 6578 6365 7074 696f 6e27 3a20 4e6f   'exception': No
-00004850: 6e65 2c20 2763 6f6d 706c 6574 6564 273a  ne, 'completed':
-00004860: 2046 616c 7365 7d20 290a 3e3e 2020 2066   False} ).>>   f
-00004870: 696e 6973 6865 643a 204e 6f64 6528 7261  inished: Node(ra
-00004880: 775f 6461 7461 5f73 696e 676c 655f 736f  w_data_single_so
-00004890: 7572 6365 3a20 7b27 7374 6174 6527 3a20  urce: {'state': 
-000048a0: 2753 5543 4345 5353 272c 2027 7265 7375  'SUCCESS', 'resu
-000048b0: 6c74 273a 205b 4461 7461 4672 616d 655b  lt': [DataFrame[
-000048c0: 6964 3a20 6269 6769 6e74 5d5d 2c20 2765  id: bigint]], 'e
-000048d0: 7863 6570 7469 6f6e 273a 204e 6f6e 652c  xception': None,
-000048e0: 2027 636f 6d70 6c65 7465 6427 3a20 5472   'completed': Tr
-000048f0: 7565 7d20 2920 2873 7469 6c6c 2072 756e  ue} ) (still run
-00004900: 6e69 6e67 3a20 3229 0a3e 3e20 2020 6669  ning: 2).>>   fi
-00004910: 6e69 7368 6564 3a20 4e6f 6465 2872 6177  nished: Node(raw
-00004920: 5f64 6174 615f 7369 6e67 6c65 5f73 6f75  _data_single_sou
-00004930: 7263 655f 7769 7468 5f63 7573 746f 6d5f  rce_with_custom_
-00004940: 6e61 6d65 3a20 7b27 7374 6174 6527 3a20  name: {'state': 
-00004950: 2753 5543 4345 5353 272c 2027 7265 7375  'SUCCESS', 'resu
-00004960: 6c74 273a 205b 4461 7461 4672 616d 655b  lt': [DataFrame[
-00004970: 6964 3a20 6269 6769 6e74 5d5d 2c20 2765  id: bigint]], 'e
-00004980: 7863 6570 7469 6f6e 273a 204e 6f6e 652c  xception': None,
-00004990: 2027 636f 6d70 6c65 7465 6427 3a20 5472   'completed': Tr
-000049a0: 7565 7d20 2920 2873 7469 6c6c 2072 756e  ue} ) (still run
-000049b0: 6e69 6e67 3a20 3129 0a3e 3e20 2020 7374  ning: 1).>>   st
-000049c0: 6172 7469 6e67 3a20 4e6f 6465 2863 6f6d  arting: Node(com
-000049d0: 6269 6e65 5f64 6174 613a 207b 2773 7461  bine_data: {'sta
-000049e0: 7465 273a 2027 5255 4e4e 494e 4727 2c20  te': 'RUNNING', 
-000049f0: 2772 6573 756c 7427 3a20 4e6f 6e65 2c20  'result': None, 
-00004a00: 2765 7863 6570 7469 6f6e 273a 204e 6f6e  'exception': Non
-00004a10: 652c 2027 636f 6d70 6c65 7465 6427 3a20  e, 'completed': 
-00004a20: 4661 6c73 657d 2029 0a3e 3e20 2020 6669  False} ).>>   fi
-00004a30: 6e69 7368 6564 3a20 4e6f 6465 2872 6177  nished: Node(raw
-00004a40: 5f64 6174 615f 6d75 6c74 695f 736f 7572  _data_multi_sour
-00004a50: 6365 3a20 7b27 7374 6174 6527 3a20 2753  ce: {'state': 'S
-00004a60: 5543 4345 5353 272c 2027 7265 7375 6c74  UCCESS', 'result
-00004a70: 273a 205b 4461 7461 4672 616d 655b 6964  ': [DataFrame[id
-00004a80: 3a20 6269 6769 6e74 5d2c 2044 6174 6146  : bigint], DataF
-00004a90: 7261 6d65 5b69 643a 2062 6967 696e 745d  rame[id: bigint]
-00004aa0: 5d2c 2027 6578 6365 7074 696f 6e27 3a20  ], 'exception': 
-00004ab0: 4e6f 6e65 2c20 2763 6f6d 706c 6574 6564  None, 'completed
-00004ac0: 273a 2054 7275 657d 2029 2028 7374 696c  ': True} ) (stil
-00004ad0: 6c20 7275 6e6e 696e 673a 2031 290a 3e3e  l running: 1).>>
-00004ae0: 2020 2073 7461 7274 696e 673a 204e 6f64     starting: Nod
-00004af0: 6528 7370 6c69 745f 6461 7461 3a20 7b27  e(split_data: {'
-00004b00: 7374 6174 6527 3a20 2752 554e 4e49 4e47  state': 'RUNNING
-00004b10: 272c 2027 7265 7375 6c74 273a 204e 6f6e  ', 'result': Non
-00004b20: 652c 2027 6578 6365 7074 696f 6e27 3a20  e, 'exception': 
-00004b30: 4e6f 6e65 2c20 2763 6f6d 706c 6574 6564  None, 'completed
-00004b40: 273a 2046 616c 7365 7d20 290a 3e3e 2020  ': False} ).>>  
-00004b50: 2066 696e 6973 6865 643a 204e 6f64 6528   finished: Node(
-00004b60: 636f 6d62 696e 655f 6461 7461 3a20 7b27  combine_data: {'
-00004b70: 7374 6174 6527 3a20 2753 5543 4345 5353  state': 'SUCCESS
-00004b80: 272c 2027 7265 7375 6c74 273a 205b 4461  ', 'result': [Da
-00004b90: 7461 4672 616d 655b 6964 3a20 6269 6769  taFrame[id: bigi
-00004ba0: 6e74 5d5d 2c20 2765 7863 6570 7469 6f6e  nt]], 'exception
-00004bb0: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
-00004bc0: 7465 6427 3a20 5472 7565 7d20 2920 2873  ted': True} ) (s
-00004bd0: 7469 6c6c 2072 756e 6e69 6e67 3a20 3129  till running: 1)
-00004be0: 0a3e 3e20 2020 6669 6e69 7368 6564 3a20  .>>   finished: 
-00004bf0: 4e6f 6465 2873 706c 6974 5f64 6174 613a  Node(split_data:
-00004c00: 207b 2773 7461 7465 273a 2027 5355 4343   {'state': 'SUCC
-00004c10: 4553 5327 2c20 2772 6573 756c 7427 3a20  ESS', 'result': 
-00004c20: 5b44 6174 6146 7261 6d65 5b69 643a 2062  [DataFrame[id: b
-00004c30: 6967 696e 745d 2c20 4461 7461 4672 616d  igint], DataFram
-00004c40: 655b 6964 3a20 6269 6769 6e74 5d5d 2c20  e[id: bigint]], 
-00004c50: 2765 7863 6570 7469 6f6e 273a 204e 6f6e  'exception': Non
-00004c60: 652c 2027 636f 6d70 6c65 7465 6427 3a20  e, 'completed': 
-00004c70: 5472 7565 7d20 2920 2873 7469 6c6c 2072  True} ) (still r
-00004c80: 756e 6e69 6e67 3a20 3029 0a3e 3e20 416c  unning: 0).>> Al
-00004c90: 6c20 7461 736b 7320 6669 6e69 7368 6564  l tasks finished
-00004ca0: 2c20 7368 7574 7469 6e67 2064 6f77 6e0a  , shutting down.
-00004cb0: 3e3e 2070 6970 656c 696e 6520 7265 7375  >> pipeline resu
-00004cc0: 6c74 733a 0a3e 3e20 5b72 6177 5f64 6174  lts:.>> [raw_dat
-00004cd0: 615f 7369 6e67 6c65 5f73 6f75 7263 652c  a_single_source,
-00004ce0: 2072 6177 5f64 6174 615f 7369 6e67 6c65   raw_data_single
-00004cf0: 5f73 6f75 7263 655f 7769 7468 5f63 7573  _source_with_cus
-00004d00: 746f 6d5f 6e61 6d65 2c20 7261 775f 6461  tom_name, raw_da
-00004d10: 7461 5f6d 756c 7469 5f73 6f75 7263 652c  ta_multi_source,
-00004d20: 2063 6f6d 6269 6e65 5f64 6174 612c 2073   combine_data, s
-00004d30: 706c 6974 5f64 6174 615d 0a3e 3e20 6576  plit_data].>> ev
-00004d40: 656e 206e 756d 6265 7273 3a0a 3e3e 205b  en numbers:.>> [
-00004d50: 526f 7728 6964 3d32 292c 2052 6f77 2869  Row(id=2), Row(i
-00004d60: 643d 3429 2c20 526f 7728 6964 3d36 292c  d=4), Row(id=6),
-00004d70: 2052 6f77 2869 643d 3829 2c20 526f 7728   Row(id=8), Row(
-00004d80: 6964 3d31 3030 292c 2052 6f77 2869 643d  id=100), Row(id=
-00004d90: 3130 3229 2c20 526f 7728 6964 3d31 3034  102), Row(id=104
-00004da0: 292c 2052 6f77 2869 643d 3130 3629 2c20  ), Row(id=106), 
-00004db0: 526f 7728 6964 3d31 3038 292c 2052 6f77  Row(id=108), Row
-00004dc0: 2869 643d 3130 3030 295d 0a3e 3e20 6f64  (id=1000)].>> od
-00004dd0: 6420 6e75 6d62 6572 733a 0a3e 3e20 5b52  d numbers:.>> [R
-00004de0: 6f77 2869 643d 3129 2c20 526f 7728 6964  ow(id=1), Row(id
-00004df0: 3d33 292c 2052 6f77 2869 643d 3529 2c20  =3), Row(id=5), 
-00004e00: 526f 7728 6964 3d37 292c 2052 6f77 2869  Row(id=7), Row(i
-00004e10: 643d 3929 2c20 526f 7728 6964 3d31 3031  d=9), Row(id=101
-00004e20: 292c 2052 6f77 2869 643d 3130 3329 2c20  ), Row(id=103), 
-00004e30: 526f 7728 6964 3d31 3035 292c 2052 6f77  Row(id=105), Row
-00004e40: 2869 643d 3130 3729 2c20 526f 7728 6964  (id=107), Row(id
-00004e50: 3d31 3039 295d 0a60 6060 0a0a 7069 7065  =109)].```..pipe
-00004e60: 6c69 6e65 2073 7465 7073 2061 7265 2072  line steps are r
-00004e70: 6572 756e 6162 6c65 2061 7320 616e 7920  erunable as any 
-00004e80: 6f72 6469 6e61 7279 2066 756e 6374 696f  ordinary functio
-00004e90: 6e3a 0a60 6060 7079 7468 6f6e 0a23 2074  n:.```python.# t
-00004ea0: 6f20 7265 7275 6e20 6769 7665 6e20 7374  o rerun given st
-00004eb0: 6570 2c20 6a75 7374 2065 7865 6375 7465  ep, just execute
-00004ec0: 2069 7420 6173 2069 6620 6974 2077 6173   it as if it was
-00004ed0: 2061 2070 7572 6520 6675 6e63 7469 6f6e   a pure function
-00004ee0: 0a23 2072 6574 7572 6e20 6973 2061 6c61  .# return is ala
-00004ef0: 7761 7973 2061 206c 6973 7420 6f66 2064  ways a list of d
-00004f00: 6174 6166 7261 6d73 2074 6861 7420 6769  ataframs that gi
-00004f10: 7665 6e20 4070 706e 2e73 7465 7020 7265  ven @ppn.step re
-00004f20: 7475 726e 730a 2320 6e6f 7465 3a20 7468  turns.# note: th
-00004f30: 6520 7370 6172 6b20 7669 6577 2027 7261  e spark view 'ra
-00004f40: 775f 6461 7461 5f73 696e 676c 655f 736f  w_data_single_so
-00004f50: 7572 6365 2720 7769 6c6c 2062 6520 7570  urce' will be up
-00004f60: 6461 7465 6420 7768 656e 2074 6869 7320  dated when this 
-00004f70: 6675 6e63 7469 6f6e 2066 696e 6973 6865  function finishe
-00004f80: 7320 2861 7320 7065 7220 6465 6669 6e74  s (as per defint
-00004f90: 696f 6e20 696e 2040 7070 6e2e 7374 6570  ion in @ppn.step
-00004fa0: 2061 626f 7665 290a 7261 775f 6461 7461   above).raw_data
-00004fb0: 5f73 696e 676c 655f 736f 7572 6365 2829  _single_source()
-00004fc0: 0a60 6060 0a0a 2323 2053 7061 726b 2055  .```..## Spark U
-00004fd0: 4920 5374 6167 6520 6465 7363 7269 7074  I Stage descript
-00004fe0: 696f 6e73 0a57 6865 6e20 7275 6e6e 696e  ions.When runnin
-00004ff0: 6720 636f 6465 2075 7369 6e67 2070 7973  g code using pys
-00005000: 7061 726b 2c20 7370 6172 6b20 7569 2067  park, spark ui g
-00005010: 6574 7320 7665 7279 2063 726f 7764 6564  ets very crowded
-00005020: 2e20 6053 7061 726b 5549 4c6f 6767 6572  . `SparkUILogger
-00005030: 6020 636f 6e74 6578 7420 6d61 6e61 6765  ` context manage
-00005040: 7220 616e 6420 6465 636f 7261 746f 7220  r and decorator 
-00005050: 6173 7369 6e67 7320 6875 6d61 6e20 7265  assings human re
-00005060: 6164 6162 6c65 206e 616d 6573 2074 6f20  adable names to 
-00005070: 7370 6172 6b20 7374 6167 6573 2e0a 0a60  spark stages...`
-00005080: 6060 7079 7468 6f6e 0a66 726f 6d20 6264  ``python.from bd
-00005090: 710a 0a23 2075 7361 6765 206f 6620 6465  q..# usage of de
-000050a0: 636f 7261 746f 7273 0a23 2073 7061 726b  corators.# spark
-000050b0: 2075 6920 7374 6167 6573 2077 696c 6c20   ui stages will 
-000050c0: 6861 7665 2064 6573 6372 6970 7469 6f6e  have description
-000050d0: 206f 6620 2778 797a 270a 4053 7061 726b   of 'xyz'.@Spark
-000050e0: 5549 4c6f 6767 6572 2e74 6167 2864 6573  UILogger.tag(des
-000050f0: 633d 2778 797a 2729 0a64 6566 2073 6f6d  c='xyz').def som
-00005100: 655f 6675 6e63 7469 6f6e 3228 6e75 6d62  e_function2(numb
-00005110: 6572 293a 0a0a 2020 7265 7475 726e 2073  er):..  return s
-00005120: 7061 726b 2e72 616e 6765 286e 756d 6265  park.range(numbe
-00005130: 7229 2e63 6f75 6e74 2829 0a0a 2320 7370  r).count()..# sp
-00005140: 6172 6b20 7569 2073 7461 6765 7320 7769  ark ui stages wi
-00005150: 6c6c 2068 6176 6520 6465 7363 7269 7074  ll have descript
-00005160: 696f 6e20 6f66 2027 616c 7068 615f 6675  ion of 'alpha_fu
-00005170: 6e63 7469 6f6e 3227 2028 6175 746f 6d61  nction2' (automa
-00005180: 7469 6361 6c6c 7920 6465 7269 7665 6420  tically derived 
-00005190: 6672 6f6d 2066 756e 6374 696f 6e20 6e61  from function na
-000051a0: 6d65 290a 4053 7061 726b 5549 4c6f 6767  me).@SparkUILogg
-000051b0: 6572 2e74 6167 0a64 6566 2061 6c70 6861  er.tag.def alpha
-000051c0: 5f66 756e 6374 696f 6e32 286e 756d 6265  _function2(numbe
-000051d0: 7229 3a0a 2020 2320 3173 7420 616e 6420  r):.  # 1st and 
-000051e0: 326e 6420 736f 6d65 5f66 756e 6374 696f  2nd some_functio
-000051f0: 6e32 2829 2063 616c 6c73 2073 686f 756c  n2() calls shoul
-00005200: 6420 6265 2076 6973 6962 6c65 2069 6e20  d be visible in 
-00005210: 7370 6172 6b20 7569 2061 7320 2778 797a  spark ui as 'xyz
-00005220: 270a 2020 2320 7468 6520 3372 6420 7061  '.  # the 3rd pa
-00005230: 7274 206f 6620 7265 7375 6c74 2073 686f  rt of result sho
-00005240: 756c 6420 6265 2076 6973 6962 6c65 2061  uld be visible a
-00005250: 7320 2761 6c70 6861 5f66 756e 6374 696f  s 'alpha_functio
-00005260: 6e32 0a20 2072 6574 7572 6e20 736f 6d65  n2.  return some
-00005270: 5f66 756e 6374 696f 6e32 286e 756d 6265  _function2(numbe
-00005280: 722a 3229 202b 2073 6f6d 655f 6675 6e63  r*2) + some_func
-00005290: 7469 6f6e 3228 6e75 6d62 6572 2a33 2920  tion2(number*3) 
-000052a0: 2b20 7370 6172 6b2e 7261 6e67 6528 6e75  + spark.range(nu
-000052b0: 6d62 6572 2f31 3029 2e63 6f75 6e74 2829  mber/10).count()
-000052c0: 0a0a 2320 7573 6167 6520 6f66 2063 6f6e  ..# usage of con
-000052d0: 7465 7874 206d 616e 6167 6572 730a 2320  text managers.# 
-000052e0: 7769 6c6c 2062 6520 7669 7369 626c 6520  will be visible 
-000052f0: 696e 2073 7061 726b 2075 6920 6173 2027  in spark ui as '
-00005300: 6669 7273 742d 636f 756e 7427 0a77 6974  first-count'.wit
-00005310: 6820 5370 6172 6b55 494c 6f67 6765 7228  h SparkUILogger(
-00005320: 2766 6972 7374 2d63 6f75 6e74 2729 3a0a  'first-count'):.
-00005330: 2020 7370 6172 6b2e 7261 6e67 6528 3130    spark.range(10
-00005340: 292e 636f 756e 7428 290a 0a23 2077 696c  ).count()..# wil
-00005350: 6c20 6265 2076 6973 6962 6c65 2069 6e20  l be visible in 
-00005360: 7370 6172 6b20 7569 2061 7320 2732 6e64  spark ui as '2nd
-00005370: 2d63 6f75 6e74 270a 7769 7468 2053 7061  -count'.with Spa
-00005380: 726b 5549 4c6f 6767 6572 2827 326e 642d  rkUILogger('2nd-
-00005390: 636f 756e 7427 293a 0a20 2073 7061 726b  count'):.  spark
-000053a0: 2e72 616e 6765 2832 3029 2e63 6f75 6e74  .range(20).count
-000053b0: 2829 0a0a 736f 6d65 5f66 756e 6374 696f  ()..some_functio
-000053c0: 6e32 2831 3030 3029 0a61 6c70 6861 5f66  n2(1000).alpha_f
-000053d0: 756e 6374 696f 6e32 2832 3030 3029 0a60  unction2(2000).`
-000053e0: 6060 0a                                  ``.
+00002670: 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c44  ---------+.>> |D
+00002680: 6570 747c 436f 756e 7472 797c 7361 6d70  ept|Country|samp
+00002690: 6c65 5f72 6563 6f72 6473 2020 2020 2020  le_records      
+000026a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026e0: 7c0a 3e3e 202b 2d2d 2d2d 2b2d 2d2d 2d2d  |.>> +----+-----
+000026f0: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
+00002700: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002710: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002720: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002730: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002740: 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c49 5420  -------+.>> |IT 
+00002750: 207c 5553 4120 2020 207c 5b7b 4954 2c20   |USA    |[{IT, 
+00002760: 5553 412c 2041 6c69 6365 312c 20ef bfbd  USA, Alice1, ...
+00002770: efbf bd78 7a34 7110 5fef bfbd efbf bd11  ...xz4q._.......
+00002780: 5c72 61ef bfbd 2def bfbd 16ef bfbd 567a  \ra...-.......Vz
+00002790: 7d2c 207b 4954 2c20 5553 412c 2041 6c69  }, {IT, USA, Ali
+000027a0: 6365 322c 20ef bfbd efbf bd78 7a34 7110  ce2, ......xz4q.
+000027b0: 5fef bfbd efbf bd11 5c72 61ef bfbd 2def  _.......\ra...-.
+000027c0: bfbd 16ef bfbd 567a 7d5d 7c0a 3e3e 202b  ......Vz}]|.>> +
+000027d0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d  ----+-------+---
+000027e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000027f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002800: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002810: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002820: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002830: 2d2b 0a60 6060 0a0a 2323 2320 4765 7420  -+.```..### Get 
+00002840: 6c61 7465 7374 2072 6563 6f72 6473 0a0a  latest records..
+00002850: 7769 7468 206f 7074 696f 6e61 6c20 7072  with optional pr
+00002860: 696d 6172 7920 6b65 7920 636f 6e66 6c69  imary key confli
+00002870: 6374 2072 6573 6f6c 7574 696f 6e2c 2077  ct resolution, w
+00002880: 6865 7265 2074 6865 7265 2061 7265 206d  here there are m
+00002890: 756c 7469 706c 6520 7265 636f 7264 7320  ultiple records 
+000028a0: 6265 696e 6720 6361 6e64 6964 6174 6520  being candidate 
+000028b0: 666f 7220 6c61 7465 7374 2072 6563 6f72  for latest recor
+000028c0: 642c 2062 7574 2074 6865 7920 6861 7665  d, but they have
+000028d0: 2064 6966 6665 7265 6e74 2061 7474 7269   different attri
+000028e0: 6275 6574 7320 616e 6420 7468 6572 6520  buets and there 
+000028f0: 6973 206e 6f20 7761 7920 6f66 2064 6574  is no way of det
+00002900: 6572 6d69 6e69 6e67 2077 6869 6368 206f  ermining which o
+00002910: 6e65 2069 7320 7468 6520 6c61 7465 7374  ne is the latest
+00002920: 2e0a 0a60 6060 7079 7468 6f6e 0a66 726f  ...```python.fro
+00002930: 6d20 6461 7465 7469 6d65 2069 6d70 6f72  m datetime impor
+00002940: 7420 6461 7465 7469 6d65 2061 7320 6474  t datetime as dt
+00002950: 0a66 726f 6d20 6264 7120 696d 706f 7274  .from bdq import
+00002960: 2067 6574 5f6c 6174 6573 745f 7265 636f   get_latest_reco
+00002970: 7264 732c 2067 6574 5f6c 6174 6573 745f  rds, get_latest_
+00002980: 7265 636f 7264 735f 7769 7468 5f70 6b5f  records_with_pk_
+00002990: 636f 6e66 6963 745f 6465 7465 6374 696f  confict_detectio
+000029a0: 6e5f 666c 6167 0a0a 696e 6372 656d 656e  n_flag..incremen
+000029b0: 745f 6461 7461 203d 2020 5b0a 2020 2831  t_data =  [.  (1
+000029c0: 2c20 6474 2832 3030 302c 2031 2c20 312c  , dt(2000, 1, 1,
+000029d0: 2030 2c20 302c 2030 292c 2022 3130 3031   0, 0, 0), "1001
+000029e0: 2229 0a20 202c 2831 2c20 6474 2832 3030  ").  ,(1, dt(200
+000029f0: 302c 2031 2c20 312c 2032 2c20 302c 2030  0, 1, 1, 2, 0, 0
+00002a00: 292c 2022 3130 3032 2229 0a20 202c 2832  ), "1002").  ,(2
+00002a10: 2c20 6474 2832 3030 302c 2031 2c20 312c  , dt(2000, 1, 1,
+00002a20: 2030 2c20 302c 2030 292c 2022 3230 3031   0, 0, 0), "2001
+00002a30: 2229 2023 6361 7262 6f6e 2063 6f70 7920  ") #carbon copy 
+00002a40: 6475 706c 6963 6174 650a 2020 2c28 322c  duplicate.  ,(2,
+00002a50: 2064 7428 3230 3030 2c20 312c 2031 2c20   dt(2000, 1, 1, 
+00002a60: 302c 2030 2c20 3029 2c20 2232 3030 3122  0, 0, 0), "2001"
+00002a70: 2920 2363 6172 626f 6e20 636f 7079 2064  ) #carbon copy d
+00002a80: 7570 6c69 6361 7465 0a20 202c 2833 2c20  uplicate.  ,(3, 
+00002a90: 6474 2832 3030 302c 2031 2c20 312c 2030  dt(2000, 1, 1, 0
+00002aa0: 2c20 302c 2030 292c 2022 3330 3031 2229  , 0, 0), "3001")
+00002ab0: 0a20 202c 2833 2c20 6474 2832 3030 302c  .  ,(3, dt(2000,
+00002ac0: 2031 2c20 312c 2032 2c20 302c 2030 292c   1, 1, 2, 0, 0),
+00002ad0: 2022 3330 3032 2331 2229 2023 706b 2063   "3002#1") #pk c
+00002ae0: 6f6e 666c 6963 742c 2074 776f 2065 6e74  onflict, two ent
+00002af0: 7269 6573 2077 6974 6820 7468 6520 7361  ries with the sa
+00002b00: 6d65 2074 6563 686e 6963 616c 2066 6965  me technical fie
+00002b10: 6c64 732c 2062 7574 2064 6966 6665 7265  lds, but differe
+00002b20: 6e74 2061 7472 6962 7574 6573 2c20 7768  nt atributes, wh
+00002b30: 6963 6820 6f6e 6520 746f 2063 686f 7365  ich one to chose
+00002b40: 3f0a 2020 2c28 332c 2064 7428 3230 3030  ?.  ,(3, dt(2000
+00002b50: 2c20 312c 2031 2c20 322c 2030 2c20 3029  , 1, 1, 2, 0, 0)
+00002b60: 2c20 2233 3030 3223 3222 2920 2370 6b20  , "3002#2") #pk 
+00002b70: 636f 6e66 6c69 6374 0a5d 0a0a 6466 203d  conflict.]..df =
+00002b80: 2073 7061 726b 2e63 7265 6174 6544 6174   spark.createDat
+00002b90: 6146 7261 6d65 2869 6e63 7265 6d65 6e74  aFrame(increment
+00002ba0: 5f64 6174 612c 2022 706b 3a69 6e74 2c63  _data, "pk:int,c
+00002bb0: 6861 6e67 655f 7473 3a74 696d 6573 7461  hange_ts:timesta
+00002bc0: 6d70 2c61 7474 723a 7374 7269 6e67 2229  mp,attr:string")
+00002bd0: 0a64 662e 7368 6f77 2874 7275 6e63 6174  .df.show(truncat
+00002be0: 653d 5472 7565 290a 0a3e 3e20 2b2d 2d2d  e=True)..>> +---
+00002bf0: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---------------
+00002c00: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e 3e20  ----+------+.>> 
+00002c10: 7c20 706b 7c20 2020 2020 2020 2020 2063  | pk|          c
+00002c20: 6861 6e67 655f 7473 7c20 2061 7474 727c  hange_ts|  attr|
+00002c30: 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d  .>> +---+-------
+00002c40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d  ------------+---
+00002c50: 2d2d 2d2b 0a3e 3e20 7c20 2031 7c32 3030  ---+.>> |  1|200
+00002c60: 302d 3031 2d30 3120 3030 3a30 303a 3030  0-01-01 00:00:00
+00002c70: 7c20 2031 3030 317c 0a3e 3e20 7c20 2031  |  1001|.>> |  1
+00002c80: 7c32 3030 302d 3031 2d30 3120 3032 3a30  |2000-01-01 02:0
+00002c90: 303a 3030 7c20 2031 3030 327c 0a3e 3e20  0:00|  1002|.>> 
+00002ca0: 7c20 2032 7c32 3030 302d 3031 2d30 3120  |  2|2000-01-01 
+00002cb0: 3030 3a30 303a 3030 7c20 2032 3030 317c  00:00:00|  2001|
+00002cc0: 0a3e 3e20 7c20 2032 7c32 3030 302d 3031  .>> |  2|2000-01
+00002cd0: 2d30 3120 3030 3a30 303a 3030 7c20 2032  -01 00:00:00|  2
+00002ce0: 3030 317c 0a3e 3e20 7c20 2033 7c32 3030  001|.>> |  3|200
+00002cf0: 302d 3031 2d30 3120 3030 3a30 303a 3030  0-01-01 00:00:00
+00002d00: 7c20 2033 3030 317c 0a3e 3e20 7c20 2033  |  3001|.>> |  3
+00002d10: 7c32 3030 302d 3031 2d30 3120 3032 3a30  |2000-01-01 02:0
+00002d20: 303a 3030 7c33 3030 3223 317c 0a3e 3e20  0:00|3002#1|.>> 
+00002d30: 7c20 2033 7c32 3030 302d 3031 2d30 3120  |  3|2000-01-01 
+00002d40: 3032 3a30 303a 3030 7c33 3030 3223 327c  02:00:00|3002#2|
+00002d50: 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d  .>> +---+-------
+00002d60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d  ------------+---
+00002d70: 2d2d 2d2b 0a0a 7072 696d 6172 795f 6b65  ---+..primary_ke
+00002d80: 795f 636f 6c75 6d6e 7320 3d20 5b27 706b  y_columns = ['pk
+00002d90: 275d 0a6f 7264 6572 5f62 795f 636f 6c75  '].order_by_colu
+00002da0: 6d6e 7320 3d20 5b27 6368 616e 6765 5f74  mns = ['change_t
+00002db0: 7327 5d0a 0a23 2077 696c 6c20 7261 6e64  s']..# will rand
+00002dc0: 6f6d 6c79 2063 686f 7365 206f 6e65 2070  omly chose one p
+00002dd0: 6b20 696e 2063 6173 6520 6f66 2063 6f6e  k in case of con
+00002de0: 666c 6963 742c 2077 6974 686f 7574 2061  flict, without a
+00002df0: 6e79 206e 6f74 6966 6963 6174 696f 6e20  ny notification 
+00002e00: 6162 6f75 7420 636f 6e66 6c69 6374 730a  about conflicts.
+00002e10: 7369 6d70 6c65 5f67 6574 5f6c 6174 6573  simple_get_lates
+00002e20: 745f 6466 203d 2067 6574 5f6c 6174 6573  t_df = get_lates
+00002e30: 745f 7265 636f 7264 7328 6466 2c20 7072  t_records(df, pr
+00002e40: 696d 6172 795f 6b65 795f 636f 6c75 6d6e  imary_key_column
+00002e50: 732c 206f 7264 6572 5f62 795f 636f 6c75  s, order_by_colu
+00002e60: 6d6e 7329 0a73 696d 706c 655f 6765 745f  mns).simple_get_
+00002e70: 6c61 7465 7374 5f64 662e 7368 6f77 2874  latest_df.show(t
+00002e80: 7275 6e63 6174 653d 5472 7565 290a 0a3e  runcate=True)..>
+00002e90: 3e20 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  > +---+---------
+00002ea0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00002eb0: 2d2b 0a3e 3e20 7c20 706b 7c20 2020 2020  -+.>> | pk|     
+00002ec0: 2020 2020 2063 6861 6e67 655f 7473 7c20       change_ts| 
+00002ed0: 2061 7474 727c 0a3e 3e20 2b2d 2d2d 2b2d   attr|.>> +---+-
+00002ee0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002ef0: 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e 3e20 7c20  --+------+.>> | 
+00002f00: 2031 7c32 3030 302d 3031 2d30 3120 3032   1|2000-01-01 02
+00002f10: 3a30 303a 3030 7c20 2031 3030 327c 0a3e  :00:00|  1002|.>
+00002f20: 3e20 7c20 2032 7c32 3030 302d 3031 2d30  > |  2|2000-01-0
+00002f30: 3120 3030 3a30 303a 3030 7c20 2032 3030  1 00:00:00|  200
+00002f40: 317c 0a3e 3e20 7c20 2033 7c32 3030 302d  1|.>> |  3|2000-
+00002f50: 3031 2d30 3120 3032 3a30 303a 3030 7c33  01-01 02:00:00|3
+00002f60: 3030 3223 317c 0a3e 3e20 2b2d 2d2d 2b2d  002#1|.>> +---+-
+00002f70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002f80: 2d2d 2b2d 2d2d 2d2d 2d2b 0a0a 2320 7769  --+------+..# wi
+00002f90: 6c6c 2066 6c61 6720 7265 636f 7264 7320  ll flag records 
+00002fa0: 7768 6963 6820 6361 7573 6520 636f 6e66  which cause conf
+00002fb0: 6c69 6374 7320 616e 6420 6361 6e6e 6f74  licts and cannot
+00002fc0: 2062 6520 7265 736f 6c76 6564 0a23 2062   be resolved.# b
+00002fd0: 6164 2072 6563 6f72 6473 206e 6565 6420  ad records need 
+00002fe0: 746f 2062 6520 7175 6172 616e 7469 6e65  to be quarantine
+00002ff0: 6420 616e 6420 6861 6e64 6c65 6420 696e  d and handled in
+00003000: 2073 7065 6369 616c 2070 726f 6365 7373   special process
+00003010: 0a63 6f6e 666c 6963 745f 6765 745f 6c61  .conflict_get_la
+00003020: 7465 7374 5f64 6620 3d20 6765 745f 6c61  test_df = get_la
+00003030: 7465 7374 5f72 6563 6f72 6473 5f77 6974  test_records_wit
+00003040: 685f 706b 5f63 6f6e 6669 6374 5f64 6574  h_pk_confict_det
+00003050: 6563 7469 6f6e 5f66 6c61 6728 6466 2c20  ection_flag(df, 
+00003060: 7072 696d 6172 795f 6b65 795f 636f 6c75  primary_key_colu
+00003070: 6d6e 732c 206f 7264 6572 5f62 795f 636f  mns, order_by_co
+00003080: 6c75 6d6e 7329 0a63 6f6e 666c 6963 745f  lumns).conflict_
+00003090: 6765 745f 6c61 7465 7374 5f64 662e 7368  get_latest_df.sh
+000030a0: 6f77 2874 7275 6e63 6174 653d 5472 7565  ow(truncate=True
+000030b0: 290a 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2d  )..>> +---+-----
+000030c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
+000030d0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+000030e0: 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c20 706b  -------+.>> | pk
+000030f0: 7c20 2020 2020 2020 2020 2063 6861 6e67  |          chang
+00003100: 655f 7473 7c20 2061 7474 727c 5f5f 6861  e_ts|  attr|__ha
+00003110: 735f 706b 5f63 6f6e 666c 6963 747c 0a3e  s_pk_conflict|.>
+00003120: 3e20 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  > +---+---------
+00003130: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00003140: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
+00003150: 2d2d 2d2b 0a3e 3e20 7c20 2031 7c32 3030  ---+.>> |  1|200
+00003160: 302d 3031 2d30 3120 3032 3a30 303a 3030  0-01-01 02:00:00
+00003170: 7c20 2031 3030 327c 2020 2020 2020 2020  |  1002|        
+00003180: 2020 2020 6661 6c73 657c 0a3e 3e20 7c20      false|.>> | 
+00003190: 2032 7c32 3030 302d 3031 2d30 3120 3030   2|2000-01-01 00
+000031a0: 3a30 303a 3030 7c20 2032 3030 317c 2020  :00:00|  2001|  
+000031b0: 2020 2020 2020 2020 2020 6661 6c73 657c            false|
+000031c0: 0a3e 3e20 7c20 2033 7c32 3030 302d 3031  .>> |  3|2000-01
+000031d0: 2d30 3120 3032 3a30 303a 3030 7c33 3030  -01 02:00:00|300
+000031e0: 3223 327c 2020 2020 2020 2020 2020 2020  2#2|            
+000031f0: 2074 7275 657c 0a3e 3e20 7c20 2033 7c32   true|.>> |  3|2
+00003200: 3030 302d 3031 2d30 3120 3032 3a30 303a  000-01-01 02:00:
+00003210: 3030 7c33 3030 3223 317c 2020 2020 2020  00|3002#1|      
+00003220: 2020 2020 2020 2074 7275 657c 0a3e 3e20         true|.>> 
+00003230: 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---+-----------
+00003240: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b  --------+------+
+00003250: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00003260: 2d2b 0a0a 6060 600a 0a23 2323 2046 696e  -+..```..### Fin
+00003270: 6420 636f 6d70 6f73 6974 6520 7072 696d  d composite prim
+00003280: 6172 7920 6b65 7920 6361 6e64 6964 6174  ary key candidat
+00003290: 6573 0a0a 4769 7665 6e20 6c69 7374 206f  es..Given list o
+000032a0: 6620 706f 7373 6962 6c65 2063 6f6c 756d  f possible colum
+000032b0: 6e73 2c20 636f 6e73 7472 7563 7473 2074  ns, constructs t
+000032c0: 6865 206c 6973 7473 206f 6620 616c 6c20  he lists of all 
+000032d0: 706f 7373 6962 6c65 2063 6f6d 6269 6e61  possible combina
+000032e0: 7469 6f6e 7320 6f66 2063 6f6d 706f 7369  tions of composi
+000032f0: 7465 2070 7269 6d61 7279 206b 6579 732c  te primary keys,
+00003300: 2061 6e64 2065 7865 6375 7465 7320 636f   and executes co
+00003310: 6e63 7572 7265 6e74 6c79 2074 6f20 6465  ncurrently to de
+00003320: 7465 726d 696e 6520 6966 2067 6976 656e  termine if given
+00003330: 2073 6574 206f 6620 636f 6c75 6d6e 7320   set of columns 
+00003340: 6973 2061 2076 616c 6964 2070 7269 6d61  is a valid prima
+00003350: 7279 206b 6579 2e20 5573 6573 206d 696e  ry key. Uses min
+00003360: 696d 756d 2070 6f73 7369 626c 6520 616d  imum possible am
+00003370: 6f75 6e74 206f 6620 7175 6572 6965 7320  ount of queries 
+00003380: 6167 6169 6e73 7420 7370 6172 6b20 6279  against spark by
+00003390: 2073 6b69 7070 696e 6720 7661 6c69 6461   skipping valida
+000033a0: 7469 6f6e 2070 6174 6873 2074 6861 7420  tion paths that 
+000033b0: 6172 6520 6261 7365 6420 6f6e 2061 6c72  are based on alr
+000033c0: 6561 6479 2076 616c 6964 6174 6564 2070  eady validated p
+000033d0: 7269 6d61 7279 206b 6579 2063 6f6d 6269  rimary key combi
+000033e0: 6e61 7469 6f6e 732e 0a0a 6060 6070 7974  nations...```pyt
+000033f0: 686f 6e0a 696d 706f 7274 2062 6471 0a69  hon.import bdq.i
+00003400: 6d70 6f72 7420 7079 7370 6172 6b2e 7371  mport pyspark.sq
+00003410: 6c2e 6675 6e63 7469 6f6e 7320 6173 2046  l.functions as F
+00003420: 0a0a 6466 203d 2073 7061 726b 2e72 616e  ..df = spark.ran
+00003430: 6765 2830 2c20 3130 3029 205c 0a20 202e  ge(0, 100) \.  .
+00003440: 7769 7468 436f 6c75 6d6e 2827 7479 7065  withColumn('type
+00003450: 272c 2046 2e65 7870 7228 2728 6964 202f  ', F.expr('(id /
+00003460: 2031 3029 3a3a 696e 7420 2b20 3127 2929   10)::int + 1'))
+00003470: 205c 0a20 202e 7769 7468 436f 6c75 6d6e   \.  .withColumn
+00003480: 2827 7265 6d69 6e64 6572 272c 2046 2e65  ('reminder', F.e
+00003490: 7870 7228 2769 6420 2520 3130 2729 2920  xpr('id % 10')) 
+000034a0: 5c0a 2020 2e77 6974 6843 6f6c 756d 6e28  \.  .withColumn(
+000034b0: 2773 7461 7469 6327 2c20 462e 6c69 7428  'static', F.lit(
+000034c0: 2741 2729 2920 5c0a 2020 2e77 6974 6843  'A')) \.  .withC
+000034d0: 6f6c 756d 6e28 2772 6f75 6e64 5f72 6f62  olumn('round_rob
+000034e0: 696e 272c 2046 2e65 7870 7228 2769 6420  in', F.expr('id 
+000034f0: 2520 3227 2929 0a0a 6469 7370 6c61 7928  % 2'))..display(
+00003500: 6466 290a 0a61 6c6c 5f63 6f6d 6269 6e61  df)..all_combina
+00003510: 7469 6f6e 7320 3d20 6c69 7374 2862 6471  tions = list(bdq
+00003520: 2e67 6574 5f63 6f6c 756d 6e5f 6e61 6d65  .get_column_name
+00003530: 735f 636f 6d62 696e 6174 696f 6e73 2864  s_combinations(d
+00003540: 662e 636f 6c75 6d6e 7329 290a 0a62 6471  f.columns))..bdq
+00003550: 2e76 616c 6964 6174 655f 7072 696d 6172  .validate_primar
+00003560: 795f 6b65 795f 6361 6e64 6964 6174 655f  y_key_candidate_
+00003570: 636f 6d62 696e 6174 696f 6e73 2864 662c  combinations(df,
+00003580: 2061 6c6c 5f63 6f6d 6269 6e61 7469 6f6e   all_combination
+00003590: 732c 206d 6178 5f77 6f72 6b65 7273 3d31  s, max_workers=1
+000035a0: 302c 2076 6572 626f 7365 3d54 7275 6529  0, verbose=True)
+000035b0: 0a3e 3e20 5b28 2769 6427 2c29 2c20 2827  .>> [('id',), ('
+000035c0: 7479 7065 272c 2027 7265 6d69 6e64 6572  type', 'reminder
+000035d0: 2729 5d0a 6060 600a 0a23 2323 2045 7865  ')].```..### Exe
+000035e0: 6375 7465 2044 4147 2068 6176 696e 6720  cute DAG having 
+000035f0: 6e6f 6465 7320 6173 2070 7974 686f 6e20  nodes as python 
+00003600: 6675 6e63 7469 6f6e 730a 0a60 6060 7079  functions..```py
+00003610: 7468 6f6e 0a69 6d70 6f72 7420 6264 710a  thon.import bdq.
+00003620: 696d 706f 7274 2074 696d 650a 696d 706f  import time.impo
+00003630: 7274 2070 7974 6573 740a 0a23 6372 6561  rt pytest..#crea
+00003640: 7465 2067 7261 7068 0a67 7261 7068 203d  te graph.graph =
+00003650: 2062 6471 2e44 4147 2829 0a0a 2364 6566   bdq.DAG()..#def
+00003660: 696e 6520 6e6f 6465 730a 4067 7261 7068  ine nodes.@graph
+00003670: 2e6e 6f64 6528 290a 6465 6620 6128 293a  .node().def a():
+00003680: 0a20 2074 696d 652e 736c 6565 7028 3229  .  time.sleep(2)
+00003690: 0a20 2072 6574 7572 6e20 350a 0a40 6772  .  return 5..@gr
+000036a0: 6170 682e 6e6f 6465 2829 0a64 6566 2062  aph.node().def b
+000036b0: 2829 3a0a 2020 7469 6d65 2e73 6c65 6570  ():.  time.sleep
+000036c0: 2833 290a 2020 7265 7475 726e 2022 6265  (3).  return "be
+000036d0: 6565 7022 0a0a 236e 6f64 6573 2063 616e  eep"..#nodes can
+000036e0: 2064 6570 656e 6420 6f6e 206f 7468 6572   depend on other
+000036f0: 206e 6f64 6573 0a40 6772 6170 682e 6e6f   nodes.@graph.no
+00003700: 6465 2864 6570 656e 6473 5f6f 6e3d 5b62  de(depends_on=[b
+00003710: 5d29 0a64 6566 2063 2829 3a0a 2020 7469  ]).def c():.  ti
+00003720: 6d65 2e73 6c65 6570 2835 290a 2020 7265  me.sleep(5).  re
+00003730: 7475 726e 2038 0a0a 2361 6e79 2061 6d6f  turn 8..#any amo
+00003740: 756e 7420 6f66 2064 6570 656e 6465 6e63  unt of dependenc
+00003750: 6965 7320 6973 2061 6c6c 6f77 6564 0a40  ies is allowed.@
+00003760: 6772 6170 682e 6e6f 6465 2864 6570 656e  graph.node(depen
+00003770: 6473 5f6f 6e3d 5b62 2c20 632c 2061 5d29  ds_on=[b, c, a])
+00003780: 0a64 6566 2064 2829 3a0a 2020 7469 6d65  .def d():.  time
+00003790: 2e73 6c65 6570 2837 290a 2020 2362 6565  .sleep(7).  #bee
+000037a0: 7020 6173 206d 616e 7920 7469 6d65 7320  p as many times 
+000037b0: 6173 2061 6273 6f6c 7574 6520 6469 6666  as absolute diff
+000037c0: 6572 656e 6365 2062 6574 7765 656e 2027  erence between '
+000037d0: 6327 2061 6e64 2027 6127 0a20 2072 6574  c' and 'a'.  ret
+000037e0: 7572 6e20 2267 206d 616e 2073 6179 3a20  urn "g man say: 
+000037f0: 2220 2b20 622e 7265 7375 6c74 202a 2061  " + b.result * a
+00003800: 6273 2863 2e72 6573 756c 7420 2d20 612e  bs(c.result - a.
+00003810: 7265 7375 6c74 290a 0a40 6772 6170 682e  result)..@graph.
+00003820: 6e6f 6465 2864 6570 656e 6473 5f6f 6e3d  node(depends_on=
+00003830: 5b61 5d29 0a64 6566 2065 2829 3a0a 2020  [a]).def e():.  
+00003840: 7469 6d65 2e73 6c65 6570 2833 290a 2020  time.sleep(3).  
+00003850: 2379 6f75 2063 616e 2072 6566 6572 2074  #you can refer t
+00003860: 6f20 7061 7265 6e74 206e 6f64 6573 2c20  o parent nodes, 
+00003870: 746f 2067 6574 2069 6e66 6f72 6d61 7469  to get informati
+00003880: 6f6e 2061 626f 7574 2074 6865 6972 2072  on about their r
+00003890: 6573 756c 7473 0a20 2072 6169 7365 2056  esults.  raise V
+000038a0: 616c 7565 4572 726f 7228 6622 6f6d 672c  alueError(f"omg,
+000038b0: 2063 7261 7368 2120 7b61 2e72 6573 756c   crash! {a.resul
+000038c0: 747d 2229 0a0a 4067 7261 7068 2e6e 6f64  t}")..@graph.nod
+000038d0: 6528 6465 7065 6e64 735f 6f6e 3d5b 655d  e(depends_on=[e]
+000038e0: 290a 6465 6620 6628 293a 0a20 2070 7269  ).def f():.  pri
+000038f0: 6e74 2822 7468 6973 2077 696c 6c20 6e65  nt("this will ne
+00003900: 7665 7220 6578 6563 7574 6522 290a 2020  ver execute").  
+00003910: 7265 7475 726e 2022 7468 6973 2077 696c  return "this wil
+00003920: 6c20 6e65 7665 7220 6578 6563 7574 6522  l never execute"
+00003930: 0a0a 4067 7261 7068 2e6e 6f64 6528 6465  ..@graph.node(de
+00003940: 7065 6e64 735f 6f6e 3d5b 615d 290a 6465  pends_on=[a]).de
+00003950: 6620 6728 293a 0a20 2074 696d 652e 736c  f g():.  time.sl
+00003960: 6565 7028 3329 0a20 2023 7765 2064 6f20  eep(3).  #we do 
+00003970: 6e6f 7420 7761 6e74 2074 6f20 6578 6563  not want to exec
+00003980: 7574 6520 6368 696c 6472 656e 206e 6f64  ute children nod
+00003990: 6573 2061 6e79 6d6f 7265 0a20 2023 7265  es anymore.  #re
+000039a0: 7475 726e 2067 7261 7068 2e42 5245 414b  turn graph.BREAK
+000039b0: 2074 6869 7320 7769 6c6c 2063 6175 7365   this will cause
+000039c0: 2074 6861 7420 616c 6c20 6368 696c 6472   that all childr
+000039d0: 656e 2f73 7563 6365 7373 6f72 7320 696e  en/successors in
+000039e0: 2067 7261 7068 2077 696c 6c20 6265 2073   graph will be s
+000039f0: 6b69 7070 6564 2077 6974 686f 7574 2065  kipped without e
+00003a00: 7272 726f 720a 2020 7265 7475 726e 2067  rrror.  return g
+00003a10: 7261 7068 2e42 5245 414b 0a0a 4067 7261  raph.BREAK..@gra
+00003a20: 7068 2e6e 6f64 6528 6465 7065 6e64 735f  ph.node(depends_
+00003a30: 6f6e 3d5b 675d 290a 6465 6620 6928 293a  on=[g]).def i():
+00003a40: 0a20 2070 7269 6e74 2822 7468 6973 2077  .  print("this w
+00003a50: 696c 6c20 6e65 7665 7220 6578 6563 7574  ill never execut
+00003a60: 6520 746f 6f22 290a 2020 7265 7475 726e  e too").  return
+00003a70: 2022 7468 6973 2077 696c 6c20 6e65 7665   "this will neve
+00003a80: 7220 6578 6563 7574 6520 746f 6f22 0a0a  r execute too"..
+00003a90: 2320 6966 2079 6f75 2068 6176 6520 6970  # if you have ip
+00003aa0: 7964 6167 7265 6433 2069 6e73 7461 6c6c  ydagred3 install
+00003ab0: 6564 2c20 796f 7520 6361 6e20 7365 6520  ed, you can see 
+00003ac0: 696e 2072 6561 6c20 7469 6d65 2073 7461  in real time sta
+00003ad0: 7465 2063 6861 6e67 6573 206f 6620 6561  te changes of ea
+00003ae0: 6368 206f 6620 7468 6520 6e6f 6465 730a  ch of the nodes.
+00003af0: 6469 7370 6c61 7928 6772 6170 682e 7669  display(graph.vi
+00003b00: 7375 616c 697a 6528 2929 0a0a 2365 7865  sualize())..#exe
+00003b10: 6375 7465 2044 4147 0a67 7261 7068 2e65  cute DAG.graph.e
+00003b20: 7865 6375 7465 286d 6178 5f77 6f72 6b65  xecute(max_worke
+00003b30: 7273 3d31 3029 0a0a 2369 7465 7261 7465  rs=10)..#iterate
+00003b40: 206f 7665 7220 7265 7375 6c74 730a 7072   over results.pr
+00003b50: 696e 7428 2249 7465 7261 7465 206f 7665  int("Iterate ove
+00003b60: 7220 7265 7375 6c74 732e 2e2e 2229 0a66  r results...").f
+00003b70: 6f72 206e 6f64 6520 696e 2067 7261 7068  or node in graph
+00003b80: 2e6e 6f64 6573 3a0a 2020 7072 696e 7428  .nodes:.  print(
+00003b90: 6e6f 6465 290a 0a3e 3e20 5761 6974 696e  node)..>> Waitin
+00003ba0: 6720 666f 7220 616c 6c20 7461 736b 7320  g for all tasks 
+00003bb0: 746f 2066 696e 6973 682e 2e2e 0a3e 3e20  to finish....>> 
+00003bc0: 2020 7374 6172 7469 6e67 3a20 4e6f 6465    starting: Node
+00003bd0: 283c 6675 6e63 7469 6f6e 2061 2061 7420  (<function a at 
+00003be0: 3078 3766 3530 6634 6239 6565 3530 3e3a  0x7f50f4b9ee50>:
+00003bf0: 207b 2773 7461 7465 273a 2027 5255 4e4e   {'state': 'RUNN
+00003c00: 494e 4727 2c20 2772 6573 756c 7427 3a20  ING', 'result': 
+00003c10: 4e6f 6e65 2c20 2765 7863 6570 7469 6f6e  None, 'exception
+00003c20: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
+00003c30: 7465 6427 3a20 4661 6c73 657d 2029 0a3e  ted': False} ).>
+00003c40: 3e20 2020 7374 6172 7469 6e67 3a20 4e6f  >   starting: No
+00003c50: 6465 283c 6675 6e63 7469 6f6e 2062 2061  de(<function b a
+00003c60: 7420 3078 3766 3530 6634 6235 3330 3430  t 0x7f50f4b53040
+00003c70: 3e3a 207b 2773 7461 7465 273a 2027 5255  >: {'state': 'RU
+00003c80: 4e4e 494e 4727 2c20 2772 6573 756c 7427  NNING', 'result'
+00003c90: 3a20 4e6f 6e65 2c20 2765 7863 6570 7469  : None, 'excepti
+00003ca0: 6f6e 273a 204e 6f6e 652c 2027 636f 6d70  on': None, 'comp
+00003cb0: 6c65 7465 6427 3a20 4661 6c73 657d 2029  leted': False} )
+00003cc0: 0a3e 3e20 2020 7374 6172 7469 6e67 3a20  .>>   starting: 
+00003cd0: 4e6f 6465 283c 6675 6e63 7469 6f6e 2065  Node(<function e
+00003ce0: 2061 7420 3078 3766 3530 6634 6235 3362   at 0x7f50f4b53b
+00003cf0: 3830 3e3a 207b 2773 7461 7465 273a 2027  80>: {'state': '
+00003d00: 5255 4e4e 494e 4727 2c20 2772 6573 756c  RUNNING', 'resul
+00003d10: 7427 3a20 4e6f 6e65 2c20 2765 7863 6570  t': None, 'excep
+00003d20: 7469 6f6e 273a 204e 6f6e 652c 2027 636f  tion': None, 'co
+00003d30: 6d70 6c65 7465 6427 3a20 4661 6c73 657d  mpleted': False}
+00003d40: 2029 0a3e 3e20 2020 7374 6172 7469 6e67   ).>>   starting
+00003d50: 3a20 4e6f 6465 283c 6675 6e63 7469 6f6e  : Node(<function
+00003d60: 2067 2061 7420 3078 3766 3530 6634 6235   g at 0x7f50f4b5
+00003d70: 3335 6530 3e3a 207b 2773 7461 7465 273a  35e0>: {'state':
+00003d80: 2027 5255 4e4e 494e 4727 2c20 2772 6573   'RUNNING', 'res
+00003d90: 756c 7427 3a20 4e6f 6e65 2c20 2765 7863  ult': None, 'exc
+00003da0: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
+00003db0: 636f 6d70 6c65 7465 6427 3a20 4661 6c73  completed': Fals
+00003dc0: 657d 2029 0a3e 3e20 2020 6669 6e69 7368  e} ).>>   finish
+00003dd0: 6564 3a20 4e6f 6465 283c 6675 6e63 7469  ed: Node(<functi
+00003de0: 6f6e 2061 2061 7420 3078 3766 3530 6634  on a at 0x7f50f4
+00003df0: 6239 6565 3530 3e3a 207b 2773 7461 7465  b9ee50>: {'state
+00003e00: 273a 2027 5355 4343 4553 5327 2c20 2772  ': 'SUCCESS', 'r
+00003e10: 6573 756c 7427 3a20 352c 2027 6578 6365  esult': 5, 'exce
+00003e20: 7074 696f 6e27 3a20 4e6f 6e65 2c20 2763  ption': None, 'c
+00003e30: 6f6d 706c 6574 6564 273a 2054 7275 657d  ompleted': True}
+00003e40: 2029 2028 7374 696c 6c20 7275 6e6e 696e   ) (still runnin
+00003e50: 673a 2033 290a 3e3e 2020 2073 7461 7274  g: 3).>>   start
+00003e60: 696e 673a 204e 6f64 6528 3c66 756e 6374  ing: Node(<funct
+00003e70: 696f 6e20 6320 6174 2030 7837 6635 3066  ion c at 0x7f50f
+00003e80: 3462 3533 3463 303e 3a20 7b27 7374 6174  4b534c0>: {'stat
+00003e90: 6527 3a20 2752 554e 4e49 4e47 272c 2027  e': 'RUNNING', '
+00003ea0: 7265 7375 6c74 273a 204e 6f6e 652c 2027  result': None, '
+00003eb0: 6578 6365 7074 696f 6e27 3a20 4e6f 6e65  exception': None
+00003ec0: 2c20 2763 6f6d 706c 6574 6564 273a 2046  , 'completed': F
+00003ed0: 616c 7365 7d20 290a 3e3e 2020 2066 696e  alse} ).>>   fin
+00003ee0: 6973 6865 643a 204e 6f64 6528 3c66 756e  ished: Node(<fun
+00003ef0: 6374 696f 6e20 6220 6174 2030 7837 6635  ction b at 0x7f5
+00003f00: 3066 3462 3533 3034 303e 3a20 7b27 7374  0f4b53040>: {'st
+00003f10: 6174 6527 3a20 2753 5543 4345 5353 272c  ate': 'SUCCESS',
+00003f20: 2027 7265 7375 6c74 273a 2027 6265 6565   'result': 'beee
+00003f30: 7027 2c20 2765 7863 6570 7469 6f6e 273a  p', 'exception':
+00003f40: 204e 6f6e 652c 2027 636f 6d70 6c65 7465   None, 'complete
+00003f50: 6427 3a20 5472 7565 7d20 2920 2873 7469  d': True} ) (sti
+00003f60: 6c6c 2072 756e 6e69 6e67 3a20 3329 0a3e  ll running: 3).>
+00003f70: 3e20 2020 6572 726f 723a 204e 6f64 6528  >   error: Node(
+00003f80: 3c66 756e 6374 696f 6e20 6520 6174 2030  <function e at 0
+00003f90: 7837 6635 3066 3462 3533 6238 303e 3a20  x7f50f4b53b80>: 
+00003fa0: 7b27 7374 6174 6527 3a20 2745 5252 4f52  {'state': 'ERROR
+00003fb0: 272c 2027 7265 7375 6c74 273a 204e 6f6e  ', 'result': Non
+00003fc0: 652c 2027 6578 6365 7074 696f 6e27 3a20  e, 'exception': 
+00003fd0: 5661 6c75 6545 7272 6f72 2827 6f6d 672c  ValueError('omg,
+00003fe0: 2063 7261 7368 2120 3527 292c 2027 636f   crash! 5'), 'co
+00003ff0: 6d70 6c65 7465 6427 3a20 5472 7565 7d20  mpleted': True} 
+00004000: 293a 206f 6d67 2c20 6372 6173 6821 2035  ): omg, crash! 5
+00004010: 2028 7374 696c 6c20 7275 6e6e 696e 673a   (still running:
+00004020: 2032 290a 3e3e 2020 2066 696e 6973 6865   2).>>   finishe
+00004030: 643a 204e 6f64 6528 3c66 756e 6374 696f  d: Node(<functio
+00004040: 6e20 6720 6174 2030 7837 6635 3066 3462  n g at 0x7f50f4b
+00004050: 3533 3565 303e 3a20 7b27 7374 6174 6527  535e0>: {'state'
+00004060: 3a20 2753 4b49 5050 4544 272c 2027 7265  : 'SKIPPED', 're
+00004070: 7375 6c74 273a 203c 7468 7265 6164 696e  sult': <threadin
+00004080: 672e 4576 656e 7420 6f62 6a65 6374 2061  g.Event object a
+00004090: 7420 3078 3766 3530 6563 3136 6339 6430  t 0x7f50ec16c9d0
+000040a0: 3e2c 2027 6578 6365 7074 696f 6e27 3a20  >, 'exception': 
+000040b0: 4e6f 6e65 2c20 2763 6f6d 706c 6574 6564  None, 'completed
+000040c0: 273a 2054 7275 657d 2029 2028 7374 696c  ': True} ) (stil
+000040d0: 6c20 7275 6e6e 696e 673a 2031 290a 3e3e  l running: 1).>>
+000040e0: 2020 2073 7461 7274 696e 673a 204e 6f64     starting: Nod
+000040f0: 6528 3c66 756e 6374 696f 6e20 6420 6174  e(<function d at
+00004100: 2030 7837 6635 3066 3462 3533 6136 303e   0x7f50f4b53a60>
+00004110: 3a20 7b27 7374 6174 6527 3a20 2752 554e  : {'state': 'RUN
+00004120: 4e49 4e47 272c 2027 7265 7375 6c74 273a  NING', 'result':
+00004130: 204e 6f6e 652c 2027 6578 6365 7074 696f   None, 'exceptio
+00004140: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
+00004150: 6574 6564 273a 2046 616c 7365 7d20 290a  eted': False} ).
+00004160: 3e3e 2020 2066 696e 6973 6865 643a 204e  >>   finished: N
+00004170: 6f64 6528 3c66 756e 6374 696f 6e20 6320  ode(<function c 
+00004180: 6174 2030 7837 6635 3066 3462 3533 3463  at 0x7f50f4b534c
+00004190: 303e 3a20 7b27 7374 6174 6527 3a20 2753  0>: {'state': 'S
+000041a0: 5543 4345 5353 272c 2027 7265 7375 6c74  UCCESS', 'result
+000041b0: 273a 2038 2c20 2765 7863 6570 7469 6f6e  ': 8, 'exception
+000041c0: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
+000041d0: 7465 6427 3a20 5472 7565 7d20 2920 2873  ted': True} ) (s
+000041e0: 7469 6c6c 2072 756e 6e69 6e67 3a20 3129  till running: 1)
+000041f0: 0a3e 3e20 2020 6669 6e69 7368 6564 3a20  .>>   finished: 
+00004200: 4e6f 6465 283c 6675 6e63 7469 6f6e 2064  Node(<function d
+00004210: 2061 7420 3078 3766 3530 6634 6235 3361   at 0x7f50f4b53a
+00004220: 3630 3e3a 207b 2773 7461 7465 273a 2027  60>: {'state': '
+00004230: 5355 4343 4553 5327 2c20 2772 6573 756c  SUCCESS', 'resul
+00004240: 7427 3a20 2767 206d 616e 2073 6179 3a20  t': 'g man say: 
+00004250: 6265 6565 7062 6565 6570 6265 6565 7027  beeepbeeepbeeep'
+00004260: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
+00004270: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
+00004280: 3a20 5472 7565 7d20 2920 2873 7469 6c6c  : True} ) (still
+00004290: 2072 756e 6e69 6e67 3a20 3029 0a3e 3e20   running: 0).>> 
+000042a0: 416c 6c20 7461 736b 7320 6669 6e69 7368  All tasks finish
+000042b0: 6564 2c20 7368 7574 7469 6e67 2064 6f77  ed, shutting dow
+000042c0: 6e0a 3e3e 0a3e 3e20 4974 6572 6174 6520  n.>>.>> Iterate 
+000042d0: 6f76 6572 2072 6573 756c 7473 2e2e 2e0a  over results....
+000042e0: 3e3e 204e 6f64 6528 3c66 756e 6374 696f  >> Node(<functio
+000042f0: 6e20 6120 6174 2030 7837 6635 3066 3462  n a at 0x7f50f4b
+00004300: 3965 6535 303e 3a20 7b27 7374 6174 6527  9ee50>: {'state'
+00004310: 3a20 2753 5543 4345 5353 272c 2027 7265  : 'SUCCESS', 're
+00004320: 7375 6c74 273a 2035 2c20 2765 7863 6570  sult': 5, 'excep
+00004330: 7469 6f6e 273a 204e 6f6e 652c 2027 636f  tion': None, 'co
+00004340: 6d70 6c65 7465 6427 3a20 5472 7565 7d20  mpleted': True} 
+00004350: 290a 3e3e 204e 6f64 6528 3c66 756e 6374  ).>> Node(<funct
+00004360: 696f 6e20 6220 6174 2030 7837 6635 3066  ion b at 0x7f50f
+00004370: 3462 3533 3034 303e 3a20 7b27 7374 6174  4b53040>: {'stat
+00004380: 6527 3a20 2753 5543 4345 5353 272c 2027  e': 'SUCCESS', '
+00004390: 7265 7375 6c74 273a 2027 6265 6565 7027  result': 'beeep'
+000043a0: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
+000043b0: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
+000043c0: 3a20 5472 7565 7d20 290a 3e3e 204e 6f64  : True} ).>> Nod
+000043d0: 6528 3c66 756e 6374 696f 6e20 6320 6174  e(<function c at
+000043e0: 2030 7837 6635 3066 3462 3533 3463 303e   0x7f50f4b534c0>
+000043f0: 3a20 7b27 7374 6174 6527 3a20 2753 5543  : {'state': 'SUC
+00004400: 4345 5353 272c 2027 7265 7375 6c74 273a  CESS', 'result':
+00004410: 2038 2c20 2765 7863 6570 7469 6f6e 273a   8, 'exception':
+00004420: 204e 6f6e 652c 2027 636f 6d70 6c65 7465   None, 'complete
+00004430: 6427 3a20 5472 7565 7d20 290a 3e3e 204e  d': True} ).>> N
+00004440: 6f64 6528 3c66 756e 6374 696f 6e20 6420  ode(<function d 
+00004450: 6174 2030 7837 6635 3066 3462 3533 6136  at 0x7f50f4b53a6
+00004460: 303e 3a20 7b27 7374 6174 6527 3a20 2753  0>: {'state': 'S
+00004470: 5543 4345 5353 272c 2027 7265 7375 6c74  UCCESS', 'result
+00004480: 273a 2027 6720 6d61 6e20 7361 793a 2062  ': 'g man say: b
+00004490: 6565 6570 6265 6565 7062 6565 6570 272c  eeepbeeepbeeep',
+000044a0: 2027 6578 6365 7074 696f 6e27 3a20 4e6f   'exception': No
+000044b0: 6e65 2c20 2763 6f6d 706c 6574 6564 273a  ne, 'completed':
+000044c0: 2054 7275 657d 2029 0a3e 3e20 4e6f 6465   True} ).>> Node
+000044d0: 283c 6675 6e63 7469 6f6e 2065 2061 7420  (<function e at 
+000044e0: 3078 3766 3530 6634 6235 3362 3830 3e3a  0x7f50f4b53b80>:
+000044f0: 207b 2773 7461 7465 273a 2027 4552 524f   {'state': 'ERRO
+00004500: 5227 2c20 2772 6573 756c 7427 3a20 4e6f  R', 'result': No
+00004510: 6e65 2c20 2765 7863 6570 7469 6f6e 273a  ne, 'exception':
+00004520: 2056 616c 7565 4572 726f 7228 276f 6d67   ValueError('omg
+00004530: 2c20 6372 6173 6821 2035 2729 2c20 2763  , crash! 5'), 'c
+00004540: 6f6d 706c 6574 6564 273a 2054 7275 657d  ompleted': True}
+00004550: 2029 0a3e 3e20 4e6f 6465 283c 6675 6e63   ).>> Node(<func
+00004560: 7469 6f6e 2066 2061 7420 3078 3766 3530  tion f at 0x7f50
+00004570: 6634 6235 3330 6430 3e3a 207b 2773 7461  f4b530d0>: {'sta
+00004580: 7465 273a 2027 534b 4950 5045 4427 2c20  te': 'SKIPPED', 
+00004590: 2772 6573 756c 7427 3a20 4e6f 6e65 2c20  'result': None, 
+000045a0: 2765 7863 6570 7469 6f6e 273a 204e 6f6e  'exception': Non
+000045b0: 652c 2027 636f 6d70 6c65 7465 6427 3a20  e, 'completed': 
+000045c0: 4661 6c73 657d 2029 0a3e 3e20 4e6f 6465  False} ).>> Node
+000045d0: 283c 6675 6e63 7469 6f6e 2067 2061 7420  (<function g at 
+000045e0: 3078 3766 3530 6634 6235 3335 6530 3e3a  0x7f50f4b535e0>:
+000045f0: 207b 2773 7461 7465 273a 2027 534b 4950   {'state': 'SKIP
+00004600: 5045 4427 2c20 2772 6573 756c 7427 3a20  PED', 'result': 
+00004610: 3c74 6872 6561 6469 6e67 2e45 7665 6e74  <threading.Event
+00004620: 206f 626a 6563 7420 6174 2030 7837 6635   object at 0x7f5
+00004630: 3065 6331 3663 3964 303e 2c20 2765 7863  0ec16c9d0>, 'exc
+00004640: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
+00004650: 636f 6d70 6c65 7465 6427 3a20 5472 7565  completed': True
+00004660: 7d20 290a 3e3e 204e 6f64 6528 3c66 756e  } ).>> Node(<fun
+00004670: 6374 696f 6e20 6920 6174 2030 7837 6635  ction i at 0x7f5
+00004680: 3066 3462 3533 3238 303e 3a20 7b27 7374  0f4b53280>: {'st
+00004690: 6174 6527 3a20 2753 4b49 5050 4544 272c  ate': 'SKIPPED',
+000046a0: 2027 7265 7375 6c74 273a 204e 6f6e 652c   'result': None,
+000046b0: 2027 6578 6365 7074 696f 6e27 3a20 4e6f   'exception': No
+000046c0: 6e65 2c20 2763 6f6d 706c 6574 6564 273a  ne, 'completed':
+000046d0: 2046 616c 7365 7d20 290a 6060 600a 0a23   False} ).```..#
+000046e0: 2323 2045 7865 6375 7465 2073 7061 726b  ## Execute spark
+000046f0: 2070 6970 656c 696e 6520 6f66 206d 756c   pipeline of mul
+00004700: 7469 706c 6520 7374 6570 730a 0a75 7369  tiple steps..usi
+00004710: 6e67 2044 4147 2063 6f6d 706f 6e65 6e74  ng DAG component
+00004720: 2074 6f20 6861 6e64 6c65 2070 6172 616c   to handle paral
+00004730: 6c65 6c20 6578 6563 7574 696f 6e0a 0a60  lel execution..`
+00004740: 6060 7079 7468 6f6e 0a69 6d70 6f72 7420  ``python.import 
+00004750: 6264 710a 6672 6f6d 2062 6471 2069 6d70  bdq.from bdq imp
+00004760: 6f72 7420 7370 6172 6b2c 2074 6162 6c65  ort spark, table
+00004770: 0a0a 7070 6e20 3d20 6264 712e 5370 6172  ..ppn = bdq.Spar
+00004780: 6b50 6970 656c 696e 6528 2273 616d 706c  kPipeline("sampl
+00004790: 6522 290a 0a23 2072 6574 7572 6e73 2064  e")..# returns d
+000047a0: 6174 6166 7261 6d65 2c20 616e 6420 6372  ataframe, and cr
+000047b0: 6561 7465 7320 7370 6172 6b20 7669 6577  eates spark view
+000047c0: 2027 7261 775f 6461 7461 5f73 696e 676c   'raw_data_singl
+000047d0: 655f 736f 7572 6365 270a 4070 706e 2e73  e_source'.@ppn.s
+000047e0: 7465 705f 7370 6172 6b5f 7465 6d70 5f76  tep_spark_temp_v
+000047f0: 6965 7728 290a 6465 6620 7261 775f 6461  iew().def raw_da
+00004800: 7461 5f73 696e 676c 655f 736f 7572 6365  ta_single_source
+00004810: 2873 7465 7029 3a0a 2020 7265 7475 726e  (step):.  return
+00004820: 2073 7061 726b 2e72 616e 6765 2831 2c20   spark.range(1, 
+00004830: 3130 290a 0a23 2072 6574 7572 6e73 2064  10)..# returns d
+00004840: 6174 6166 7261 6d65 2c20 616e 6420 6372  ataframe, and cr
+00004850: 6561 7465 7320 7370 6172 6b20 7669 6577  eates spark view
+00004860: 2027 7261 775f 6e69 6365 5f6e 616d 6527   'raw_nice_name'
+00004870: 0a40 7070 6e2e 7374 6570 5f73 7061 726b  .@ppn.step_spark
+00004880: 5f74 656d 705f 7669 6577 286f 7574 7075  _temp_view(outpu
+00004890: 7473 3d22 7261 775f 6e69 6365 5f6e 616d  ts="raw_nice_nam
+000048a0: 6522 290a 6465 6620 7261 775f 6461 7461  e").def raw_data
+000048b0: 5f73 696e 676c 655f 736f 7572 6365 5f77  _single_source_w
+000048c0: 6974 685f 6375 7374 6f6d 5f6e 616d 6528  ith_custom_name(
+000048d0: 7374 6570 293a 0a20 2072 6574 7572 6e20  step):.  return 
+000048e0: 7370 6172 6b2e 7261 6e67 6528 3130 302c  spark.range(100,
+000048f0: 2031 3130 290a 0a23 2072 6574 7572 6e73   110)..# returns
+00004900: 2074 776f 2064 6174 6166 7261 6d65 732c   two dataframes,
+00004910: 2061 6e64 2063 7265 6174 6573 2074 776f   and creates two
+00004920: 2073 7061 726b 2076 6965 7773 2027 7261   spark views 'ra
+00004930: 775f 6461 7461 3127 2c20 2772 6177 5f64  w_data1', 'raw_d
+00004940: 6174 6132 270a 4070 706e 2e73 7465 705f  ata2'.@ppn.step_
+00004950: 7370 6172 6b5f 7465 6d70 5f76 6965 7728  spark_temp_view(
+00004960: 6f75 7470 7574 733d 5b22 7261 775f 6461  outputs=["raw_da
+00004970: 7461 3122 2c20 2272 6177 5f64 6174 6132  ta1", "raw_data2
+00004980: 225d 290a 6465 6620 7261 775f 6461 7461  "]).def raw_data
+00004990: 5f6d 756c 7469 5f73 6f75 7263 6528 7374  _multi_source(st
+000049a0: 6570 293a 0a20 2064 6631 203d 2073 7061  ep):.  df1 = spa
+000049b0: 726b 2e72 616e 6765 2831 3030 302c 2032  rk.range(1000, 2
+000049c0: 3030 3029 0a20 2064 6632 203d 2073 7061  000).  df2 = spa
+000049d0: 726b 2e72 616e 6765 2832 3030 302c 2033  rk.range(2000, 3
+000049e0: 3030 3029 0a0a 2020 7265 7475 726e 205b  000)..  return [
+000049f0: 6466 312c 2064 6632 5d0a 0a23 2077 6169  df1, df2]..# wai
+00004a00: 7473 2066 6f72 2072 6177 2064 6174 6120  ts for raw data 
+00004a10: 736f 7572 6365 7320 746f 2066 696e 6973  sources to finis
+00004a20: 682c 2061 6e64 2063 6f6d 6269 6e65 7320  h, and combines 
+00004a30: 7468 6520 6461 7461 2069 6e74 6f20 6f6e  the data into on
+00004a40: 6520 756e 696f 6e65 6420 7669 6577 2060  e unioned view `
+00004a50: 636f 6d62 696e 655f 6461 7461 600a 2320  combine_data`.# 
+00004a60: 6e6f 7465 2074 6861 7420 6465 7065 6e64  note that depend
+00004a70: 656e 6369 6573 2061 7265 2070 7974 686f  encies are pytho
+00004a80: 6e20 6675 6e63 7469 6f6e 7320 6f72 206e  n functions or n
+00004a90: 616d 6573 206f 6620 6f75 7470 7574 730a  ames of outputs.
+00004aa0: 4070 706e 2e73 7465 705f 7370 6172 6b5f  @ppn.step_spark_
+00004ab0: 7465 6d70 5f76 6965 7728 6465 7065 6e64  temp_view(depend
+00004ac0: 735f 6f6e 3d5b 7261 775f 6461 7461 5f73  s_on=[raw_data_s
+00004ad0: 696e 676c 655f 736f 7572 6365 2c20 7261  ingle_source, ra
+00004ae0: 775f 6461 7461 5f73 696e 676c 655f 736f  w_data_single_so
+00004af0: 7572 6365 5f77 6974 685f 6375 7374 6f6d  urce_with_custom
+00004b00: 5f6e 616d 652c 2027 7261 775f 6461 7461  _name, 'raw_data
+00004b10: 3127 2c20 2772 6177 5f64 6174 6132 275d  1', 'raw_data2']
+00004b20: 290a 6465 6620 636f 6d62 696e 655f 6461  ).def combine_da
+00004b30: 7461 2873 7465 7029 3a0a 2020 6466 203d  ta(step):.  df =
+00004b40: 2074 6162 6c65 2827 7261 775f 6461 7461   table('raw_data
+00004b50: 5f73 696e 676c 655f 736f 7572 6365 2729  _single_source')
+00004b60: 205c 0a20 2020 202e 756e 696f 6e28 7461   \.    .union(ta
+00004b70: 626c 6528 2772 6177 5f6e 6963 655f 6e61  ble('raw_nice_na
+00004b80: 6d65 2729 2920 5c0a 2020 2020 2e75 6e69  me')) \.    .uni
+00004b90: 6f6e 2874 6162 6c65 2827 7261 775f 6461  on(table('raw_da
+00004ba0: 7461 3127 2929 205c 0a20 2020 202e 756e  ta1')) \.    .un
+00004bb0: 696f 6e28 7461 626c 6528 2772 6177 5f64  ion(table('raw_d
+00004bc0: 6174 6132 2729 290a 0a20 2072 6574 7572  ata2'))..  retur
+00004bd0: 6e20 6466 0a0a 2320 7370 6c69 7473 2074  n df..# splits t
+00004be0: 6865 2063 6f6d 6269 6e65 645f 6461 7461  he combined_data
+00004bf0: 2069 6e74 6f20 276f 6464 2720 616e 6420   into 'odd' and 
+00004c00: 2765 7665 6e27 2076 6965 7773 0a40 7070  'even' views.@pp
+00004c10: 6e2e 7374 6570 5f73 7061 726b 5f74 656d  n.step_spark_tem
+00004c20: 705f 7669 6577 2864 6570 656e 6473 5f6f  p_view(depends_o
+00004c30: 6e3d 636f 6d62 696e 655f 6461 7461 2c20  n=combine_data, 
+00004c40: 6f75 7470 7574 733d 5b27 6f64 6427 2c20  outputs=['odd', 
+00004c50: 2765 7665 6e27 5d29 0a64 6566 2073 706c  'even']).def spl
+00004c60: 6974 5f64 6174 6128 7374 6570 293a 0a20  it_data(step):. 
+00004c70: 2064 665f 6f64 6420 3d20 7461 626c 6528   df_odd = table(
+00004c80: 2763 6f6d 6269 6e65 5f64 6174 6127 292e  'combine_data').
+00004c90: 6669 6c74 6572 2827 6964 2025 2032 203d  filter('id % 2 =
+00004ca0: 3d20 3127 290a 2020 6466 5f65 7665 6e20  = 1').  df_even 
+00004cb0: 3d20 7461 626c 6528 2763 6f6d 6269 6e65  = table('combine
+00004cc0: 5f64 6174 6127 292e 6669 6c74 6572 2827  _data').filter('
+00004cd0: 6964 2025 2032 203d 3d20 3027 290a 0a20  id % 2 == 0').. 
+00004ce0: 2072 6574 7572 6e20 5b20 6466 5f6f 6464   return [ df_odd
+00004cf0: 2c20 6466 5f65 7665 6e20 5d0a 0a23 2065  , df_even ]..# e
+00004d00: 7865 6375 7465 7320 7069 7065 6c69 6e65  xecutes pipeline
+00004d10: 2075 7369 6e67 2063 6f6e 6375 7272 656e   using concurren
+00004d20: 7420 7468 7265 6164 732c 206f 6e65 2070  t threads, one p
+00004d30: 6572 2065 6163 6820 7374 6570 2c20 666f  er each step, fo
+00004d40: 6c6c 6f77 696e 6720 7468 6520 6465 7065  llowing the depe
+00004d50: 6e64 656e 6379 2044 4147 0a23 2070 6970  ndency DAG.# pip
+00004d60: 656c 696e 6520 6973 2061 206e 6f72 6d61  eline is a norma
+00004d70: 6c20 7079 7468 6f6e 2063 616c 6c61 626c  l python callabl
+00004d80: 6520 6f62 6a65 6374 2c20 6173 2069 6620  e object, as if 
+00004d90: 6974 2077 6173 2061 2066 756e 6374 696f  it was a functio
+00004da0: 6e2c 2069 7420 7265 7475 726e 7320 6120  n, it returns a 
+00004db0: 6c69 7374 206f 6620 616c 6c20 7374 6570  list of all step
+00004dc0: 730a 7069 7065 6c69 6e65 5f72 6573 756c  s.pipeline_resul
+00004dd0: 7473 203d 2070 706e 286d 6178 5f63 6f6e  ts = ppn(max_con
+00004de0: 6375 7272 656e 745f 7374 6570 733d 3130  current_steps=10
+00004df0: 290a 0a70 7269 6e74 2827 7069 7065 6c69  )..print('pipeli
+00004e00: 6e65 2072 6573 756c 7473 3a27 290a 7072  ne results:').pr
+00004e10: 696e 7428 7069 7065 6c69 6e65 5f72 6573  int(pipeline_res
+00004e20: 756c 7473 290a 0a23 7368 6f77 2073 6f6d  ults)..#show som
+00004e30: 6520 6669 6e61 6c20 7661 6c75 6573 0a70  e final values.p
+00004e40: 7269 6e74 2827 6576 656e 206e 756d 6265  rint('even numbe
+00004e50: 7273 3a27 290a 7072 696e 7428 7461 626c  rs:').print(tabl
+00004e60: 6528 2765 7665 6e27 292e 6c69 6d69 7428  e('even').limit(
+00004e70: 3130 292e 636f 6c6c 6563 7428 2929 0a70  10).collect()).p
+00004e80: 7269 6e74 2827 6f64 6420 6e75 6d62 6572  rint('odd number
+00004e90: 733a 2729 0a70 7269 6e74 2874 6162 6c65  s:').print(table
+00004ea0: 2827 6f64 6427 292e 6c69 6d69 7428 3130  ('odd').limit(10
+00004eb0: 292e 636f 6c6c 6563 7428 2929 0a0a 2367  ).collect())..#g
+00004ec0: 6574 2073 6b69 7070 6564 2073 7465 7073  et skipped steps
+00004ed0: 0a61 7373 6572 7420 6c69 7374 2870 706e  .assert list(ppn
+00004ee0: 2e73 6b69 7070 6564 5f73 7465 7073 2920  .skipped_steps) 
+00004ef0: 3d3d 205b 5d0a 0a23 6765 7420 6572 726f  == []..#get erro
+00004f00: 7265 6420 7374 6570 7320 2879 6f75 2077  red steps (you w
+00004f10: 6f75 6c64 206e 6565 6420 746f 2027 6164  ould need to 'ad
+00004f20: 6a75 7374 2720 636f 6465 206f 6620 6f6e  just' code of on
+00004f30: 206f 6620 7468 6520 7374 6570 7320 746f   of the steps to
+00004f40: 206d 616b 6520 6974 2066 6169 6c20 746f   make it fail to
+00004f50: 2073 6565 2073 6f6d 6574 6869 6e67 2068   see something h
+00004f60: 6572 6529 0a61 7373 6572 7420 6c69 7374  ere).assert list
+00004f70: 2870 706e 2e65 7272 6f72 5f73 7465 7073  (ppn.error_steps
+00004f80: 2920 3d3d 205b 5d0a 0a23 6765 7420 7375  ) == []..#get su
+00004f90: 6363 6573 7366 756c 6c20 7374 6570 730a  ccessfull steps.
+00004fa0: 6173 7365 7274 2073 6574 2870 706e 2e73  assert set(ppn.s
+00004fb0: 7563 6365 7373 5f73 7465 7073 2e76 616c  uccess_steps.val
+00004fc0: 7565 7328 2929 203d 3d20 7365 7428 5b0a  ues()) == set([.
+00004fd0: 2020 7261 775f 6461 7461 5f73 696e 676c    raw_data_singl
+00004fe0: 655f 736f 7572 6365 5f77 6974 685f 6375  e_source_with_cu
+00004ff0: 7374 6f6d 5f6e 616d 652c 0a20 2072 6177  stom_name,.  raw
+00005000: 5f64 6174 615f 6d75 6c74 695f 736f 7572  _data_multi_sour
+00005010: 6365 2c0a 2020 7370 6c69 745f 6461 7461  ce,.  split_data
+00005020: 2c0a 2020 636f 6d62 696e 655f 6461 7461  ,.  combine_data
+00005030: 2c0a 2020 7261 775f 6461 7461 5f73 696e  ,.  raw_data_sin
+00005040: 676c 655f 736f 7572 6365 0a5d 290a 0a3e  gle_source.])..>
+00005050: 3e20 5761 6974 696e 6720 666f 7220 616c  > Waiting for al
+00005060: 6c20 7461 736b 7320 746f 2066 696e 6973  l tasks to finis
+00005070: 682e 2e2e 0a3e 3e20 2020 7374 6172 7469  h....>>   starti
+00005080: 6e67 3a20 4e6f 6465 2872 6177 5f64 6174  ng: Node(raw_dat
+00005090: 615f 7369 6e67 6c65 5f73 6f75 7263 653a  a_single_source:
+000050a0: 207b 2773 7461 7465 273a 2027 5255 4e4e   {'state': 'RUNN
+000050b0: 494e 4727 2c20 2772 6573 756c 7427 3a20  ING', 'result': 
+000050c0: 4e6f 6e65 2c20 2765 7863 6570 7469 6f6e  None, 'exception
+000050d0: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
+000050e0: 7465 6427 3a20 4661 6c73 657d 2029 0a3e  ted': False} ).>
+000050f0: 3e20 2020 7374 6172 7469 6e67 3a20 4e6f  >   starting: No
+00005100: 6465 2872 6177 5f64 6174 615f 7369 6e67  de(raw_data_sing
+00005110: 6c65 5f73 6f75 7263 655f 7769 7468 5f63  le_source_with_c
+00005120: 7573 746f 6d5f 6e61 6d65 3a20 7b27 7374  ustom_name: {'st
+00005130: 6174 6527 3a20 2752 554e 4e49 4e47 272c  ate': 'RUNNING',
+00005140: 2027 7265 7375 6c74 273a 204e 6f6e 652c   'result': None,
+00005150: 2027 6578 6365 7074 696f 6e27 3a20 4e6f   'exception': No
+00005160: 6e65 2c20 2763 6f6d 706c 6574 6564 273a  ne, 'completed':
+00005170: 2046 616c 7365 7d20 290a 3e3e 2020 2073   False} ).>>   s
+00005180: 7461 7274 696e 673a 204e 6f64 6528 7261  tarting: Node(ra
+00005190: 775f 6461 7461 5f6d 756c 7469 5f73 6f75  w_data_multi_sou
+000051a0: 7263 653a 207b 2773 7461 7465 273a 2027  rce: {'state': '
+000051b0: 5255 4e4e 494e 4727 2c20 2772 6573 756c  RUNNING', 'resul
+000051c0: 7427 3a20 4e6f 6e65 2c20 2765 7863 6570  t': None, 'excep
+000051d0: 7469 6f6e 273a 204e 6f6e 652c 2027 636f  tion': None, 'co
+000051e0: 6d70 6c65 7465 6427 3a20 4661 6c73 657d  mpleted': False}
+000051f0: 2029 0a3e 3e20 2020 6669 6e69 7368 6564   ).>>   finished
+00005200: 3a20 4e6f 6465 2872 6177 5f64 6174 615f  : Node(raw_data_
+00005210: 7369 6e67 6c65 5f73 6f75 7263 653a 207b  single_source: {
+00005220: 2773 7461 7465 273a 2027 5355 4343 4553  'state': 'SUCCES
+00005230: 5327 2c20 2772 6573 756c 7427 3a20 5b44  S', 'result': [D
+00005240: 6174 6146 7261 6d65 5b69 643a 2062 6967  ataFrame[id: big
+00005250: 696e 745d 5d2c 2027 6578 6365 7074 696f  int]], 'exceptio
+00005260: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
+00005270: 6574 6564 273a 2054 7275 657d 2029 2028  eted': True} ) (
+00005280: 7374 696c 6c20 7275 6e6e 696e 673a 2032  still running: 2
+00005290: 290a 3e3e 2020 2066 696e 6973 6865 643a  ).>>   finished:
+000052a0: 204e 6f64 6528 7261 775f 6461 7461 5f73   Node(raw_data_s
+000052b0: 696e 676c 655f 736f 7572 6365 5f77 6974  ingle_source_wit
+000052c0: 685f 6375 7374 6f6d 5f6e 616d 653a 207b  h_custom_name: {
+000052d0: 2773 7461 7465 273a 2027 5355 4343 4553  'state': 'SUCCES
+000052e0: 5327 2c20 2772 6573 756c 7427 3a20 5b44  S', 'result': [D
+000052f0: 6174 6146 7261 6d65 5b69 643a 2062 6967  ataFrame[id: big
+00005300: 696e 745d 5d2c 2027 6578 6365 7074 696f  int]], 'exceptio
+00005310: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
+00005320: 6574 6564 273a 2054 7275 657d 2029 2028  eted': True} ) (
+00005330: 7374 696c 6c20 7275 6e6e 696e 673a 2031  still running: 1
+00005340: 290a 3e3e 2020 2073 7461 7274 696e 673a  ).>>   starting:
+00005350: 204e 6f64 6528 636f 6d62 696e 655f 6461   Node(combine_da
+00005360: 7461 3a20 7b27 7374 6174 6527 3a20 2752  ta: {'state': 'R
+00005370: 554e 4e49 4e47 272c 2027 7265 7375 6c74  UNNING', 'result
+00005380: 273a 204e 6f6e 652c 2027 6578 6365 7074  ': None, 'except
+00005390: 696f 6e27 3a20 4e6f 6e65 2c20 2763 6f6d  ion': None, 'com
+000053a0: 706c 6574 6564 273a 2046 616c 7365 7d20  pleted': False} 
+000053b0: 290a 3e3e 2020 2066 696e 6973 6865 643a  ).>>   finished:
+000053c0: 204e 6f64 6528 7261 775f 6461 7461 5f6d   Node(raw_data_m
+000053d0: 756c 7469 5f73 6f75 7263 653a 207b 2773  ulti_source: {'s
+000053e0: 7461 7465 273a 2027 5355 4343 4553 5327  tate': 'SUCCESS'
+000053f0: 2c20 2772 6573 756c 7427 3a20 5b44 6174  , 'result': [Dat
+00005400: 6146 7261 6d65 5b69 643a 2062 6967 696e  aFrame[id: bigin
+00005410: 745d 2c20 4461 7461 4672 616d 655b 6964  t], DataFrame[id
+00005420: 3a20 6269 6769 6e74 5d5d 2c20 2765 7863  : bigint]], 'exc
+00005430: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
+00005440: 636f 6d70 6c65 7465 6427 3a20 5472 7565  completed': True
+00005450: 7d20 2920 2873 7469 6c6c 2072 756e 6e69  } ) (still runni
+00005460: 6e67 3a20 3129 0a3e 3e20 2020 7374 6172  ng: 1).>>   star
+00005470: 7469 6e67 3a20 4e6f 6465 2873 706c 6974  ting: Node(split
+00005480: 5f64 6174 613a 207b 2773 7461 7465 273a  _data: {'state':
+00005490: 2027 5255 4e4e 494e 4727 2c20 2772 6573   'RUNNING', 'res
+000054a0: 756c 7427 3a20 4e6f 6e65 2c20 2765 7863  ult': None, 'exc
+000054b0: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
+000054c0: 636f 6d70 6c65 7465 6427 3a20 4661 6c73  completed': Fals
+000054d0: 657d 2029 0a3e 3e20 2020 6669 6e69 7368  e} ).>>   finish
+000054e0: 6564 3a20 4e6f 6465 2863 6f6d 6269 6e65  ed: Node(combine
+000054f0: 5f64 6174 613a 207b 2773 7461 7465 273a  _data: {'state':
+00005500: 2027 5355 4343 4553 5327 2c20 2772 6573   'SUCCESS', 'res
+00005510: 756c 7427 3a20 5b44 6174 6146 7261 6d65  ult': [DataFrame
+00005520: 5b69 643a 2062 6967 696e 745d 5d2c 2027  [id: bigint]], '
+00005530: 6578 6365 7074 696f 6e27 3a20 4e6f 6e65  exception': None
+00005540: 2c20 2763 6f6d 706c 6574 6564 273a 2054  , 'completed': T
+00005550: 7275 657d 2029 2028 7374 696c 6c20 7275  rue} ) (still ru
+00005560: 6e6e 696e 673a 2031 290a 3e3e 2020 2066  nning: 1).>>   f
+00005570: 696e 6973 6865 643a 204e 6f64 6528 7370  inished: Node(sp
+00005580: 6c69 745f 6461 7461 3a20 7b27 7374 6174  lit_data: {'stat
+00005590: 6527 3a20 2753 5543 4345 5353 272c 2027  e': 'SUCCESS', '
+000055a0: 7265 7375 6c74 273a 205b 4461 7461 4672  result': [DataFr
+000055b0: 616d 655b 6964 3a20 6269 6769 6e74 5d2c  ame[id: bigint],
+000055c0: 2044 6174 6146 7261 6d65 5b69 643a 2062   DataFrame[id: b
+000055d0: 6967 696e 745d 5d2c 2027 6578 6365 7074  igint]], 'except
+000055e0: 696f 6e27 3a20 4e6f 6e65 2c20 2763 6f6d  ion': None, 'com
+000055f0: 706c 6574 6564 273a 2054 7275 657d 2029  pleted': True} )
+00005600: 2028 7374 696c 6c20 7275 6e6e 696e 673a   (still running:
+00005610: 2030 290a 3e3e 2041 6c6c 2074 6173 6b73   0).>> All tasks
+00005620: 2066 696e 6973 6865 642c 2073 6875 7474   finished, shutt
+00005630: 696e 6720 646f 776e 0a3e 3e20 7069 7065  ing down.>> pipe
+00005640: 6c69 6e65 2072 6573 756c 7473 3a0a 3e3e  line results:.>>
+00005650: 205b 7261 775f 6461 7461 5f73 696e 676c   [raw_data_singl
+00005660: 655f 736f 7572 6365 2c20 7261 775f 6461  e_source, raw_da
+00005670: 7461 5f73 696e 676c 655f 736f 7572 6365  ta_single_source
+00005680: 5f77 6974 685f 6375 7374 6f6d 5f6e 616d  _with_custom_nam
+00005690: 652c 2072 6177 5f64 6174 615f 6d75 6c74  e, raw_data_mult
+000056a0: 695f 736f 7572 6365 2c20 636f 6d62 696e  i_source, combin
+000056b0: 655f 6461 7461 2c20 7370 6c69 745f 6461  e_data, split_da
+000056c0: 7461 5d0a 3e3e 2065 7665 6e20 6e75 6d62  ta].>> even numb
+000056d0: 6572 733a 0a3e 3e20 5b52 6f77 2869 643d  ers:.>> [Row(id=
+000056e0: 3229 2c20 526f 7728 6964 3d34 292c 2052  2), Row(id=4), R
+000056f0: 6f77 2869 643d 3629 2c20 526f 7728 6964  ow(id=6), Row(id
+00005700: 3d38 292c 2052 6f77 2869 643d 3130 3029  =8), Row(id=100)
+00005710: 2c20 526f 7728 6964 3d31 3032 292c 2052  , Row(id=102), R
+00005720: 6f77 2869 643d 3130 3429 2c20 526f 7728  ow(id=104), Row(
+00005730: 6964 3d31 3036 292c 2052 6f77 2869 643d  id=106), Row(id=
+00005740: 3130 3829 2c20 526f 7728 6964 3d31 3030  108), Row(id=100
+00005750: 3029 5d0a 3e3e 206f 6464 206e 756d 6265  0)].>> odd numbe
+00005760: 7273 3a0a 3e3e 205b 526f 7728 6964 3d31  rs:.>> [Row(id=1
+00005770: 292c 2052 6f77 2869 643d 3329 2c20 526f  ), Row(id=3), Ro
+00005780: 7728 6964 3d35 292c 2052 6f77 2869 643d  w(id=5), Row(id=
+00005790: 3729 2c20 526f 7728 6964 3d39 292c 2052  7), Row(id=9), R
+000057a0: 6f77 2869 643d 3130 3129 2c20 526f 7728  ow(id=101), Row(
+000057b0: 6964 3d31 3033 292c 2052 6f77 2869 643d  id=103), Row(id=
+000057c0: 3130 3529 2c20 526f 7728 6964 3d31 3037  105), Row(id=107
+000057d0: 292c 2052 6f77 2869 643d 3130 3929 5d0a  ), Row(id=109)].
+000057e0: 6060 600a 0a70 6970 656c 696e 6520 7374  ```..pipeline st
+000057f0: 6570 7320 6172 6520 7265 7275 6e61 626c  eps are rerunabl
+00005800: 6520 6173 2061 6e79 206f 7264 696e 6172  e as any ordinar
+00005810: 7920 6675 6e63 7469 6f6e 3a0a 0a60 6060  y function:..```
+00005820: 7079 7468 6f6e 0a23 2074 6f20 7265 7275  python.# to reru
+00005830: 6e20 6769 7665 6e20 7374 6570 2c20 6a75  n given step, ju
+00005840: 7374 2065 7865 6375 7465 2069 7420 6173  st execute it as
+00005850: 2069 6620 6974 2077 6173 2061 2070 7572   if it was a pur
+00005860: 6520 6675 6e63 7469 6f6e 0a23 2072 6574  e function.# ret
+00005870: 7572 6e20 6973 2061 6c61 7761 7973 2061  urn is alaways a
+00005880: 206c 6973 7420 6f66 2064 6174 6166 7261   list of datafra
+00005890: 6d73 2074 6861 7420 6769 7665 6e20 4070  ms that given @p
+000058a0: 706e 2e73 7465 7020 7265 7475 726e 730a  pn.step returns.
+000058b0: 2320 6e6f 7465 3a20 7468 6520 7370 6172  # note: the spar
+000058c0: 6b20 7669 6577 2027 7261 775f 6461 7461  k view 'raw_data
+000058d0: 5f73 696e 676c 655f 736f 7572 6365 2720  _single_source' 
+000058e0: 7769 6c6c 2062 6520 7570 6461 7465 6420  will be updated 
+000058f0: 7768 656e 2074 6869 7320 6675 6e63 7469  when this functi
+00005900: 6f6e 2066 696e 6973 6865 7320 2861 7320  on finishes (as 
+00005910: 7065 7220 6465 6669 6e74 696f 6e20 696e  per defintion in
+00005920: 2040 7070 6e2e 7374 6570 2061 626f 7665   @ppn.step above
+00005930: 290a 7261 775f 6461 7461 5f73 696e 676c  ).raw_data_singl
+00005940: 655f 736f 7572 6365 2829 0a60 6060 0a0a  e_source().```..
+00005950: 2323 2320 5370 6172 6b20 5549 2053 7461  ### Spark UI Sta
+00005960: 6765 2064 6573 6372 6970 7469 6f6e 730a  ge descriptions.
+00005970: 0a57 6865 6e20 7275 6e6e 696e 6720 636f  .When running co
+00005980: 6465 2075 7369 6e67 2070 7973 7061 726b  de using pyspark
+00005990: 2c20 7370 6172 6b20 7569 2067 6574 7320  , spark ui gets 
+000059a0: 7665 7279 2063 726f 7764 6564 2e20 6053  very crowded. `S
+000059b0: 7061 726b 5549 4c6f 6767 6572 6020 636f  parkUILogger` co
+000059c0: 6e74 6578 7420 6d61 6e61 6765 7220 616e  ntext manager an
+000059d0: 6420 6465 636f 7261 746f 7220 6173 7369  d decorator assi
+000059e0: 6e67 7320 6875 6d61 6e20 7265 6164 6162  ngs human readab
+000059f0: 6c65 206e 616d 6573 2074 6f20 7370 6172  le names to spar
+00005a00: 6b20 7374 6167 6573 2e0a 0a60 6060 7079  k stages...```py
+00005a10: 7468 6f6e 0a66 726f 6d20 6264 7120 696d  thon.from bdq im
+00005a20: 706f 7274 2053 7061 726b 5549 4c6f 6767  port SparkUILogg
+00005a30: 6572 0a0a 2320 7573 6167 6520 6f66 2064  er..# usage of d
+00005a40: 6563 6f72 6174 6f72 730a 2320 7370 6172  ecorators.# spar
+00005a50: 6b20 7569 2073 7461 6765 7320 7769 6c6c  k ui stages will
+00005a60: 2068 6176 6520 6465 7363 7269 7074 696f   have descriptio
+00005a70: 6e20 6f66 2027 7879 7a27 0a40 5370 6172  n of 'xyz'.@Spar
+00005a80: 6b55 494c 6f67 6765 722e 7461 6728 6465  kUILogger.tag(de
+00005a90: 7363 3d27 7879 7a27 290a 6465 6620 736f  sc='xyz').def so
+00005aa0: 6d65 5f66 756e 6374 696f 6e32 286e 756d  me_function2(num
+00005ab0: 6265 7229 3a0a 0a20 2072 6574 7572 6e20  ber):..  return 
+00005ac0: 7370 6172 6b2e 7261 6e67 6528 6e75 6d62  spark.range(numb
+00005ad0: 6572 292e 636f 756e 7428 290a 0a23 2073  er).count()..# s
+00005ae0: 7061 726b 2075 6920 7374 6167 6573 2077  park ui stages w
+00005af0: 696c 6c20 6861 7665 2064 6573 6372 6970  ill have descrip
+00005b00: 7469 6f6e 206f 6620 2761 6c70 6861 5f66  tion of 'alpha_f
+00005b10: 756e 6374 696f 6e32 2720 2861 7574 6f6d  unction2' (autom
+00005b20: 6174 6963 616c 6c79 2064 6572 6976 6564  atically derived
+00005b30: 2066 726f 6d20 6675 6e63 7469 6f6e 206e   from function n
+00005b40: 616d 6529 0a40 5370 6172 6b55 494c 6f67  ame).@SparkUILog
+00005b50: 6765 722e 7461 670a 6465 6620 616c 7068  ger.tag.def alph
+00005b60: 615f 6675 6e63 7469 6f6e 3228 6e75 6d62  a_function2(numb
+00005b70: 6572 293a 0a20 2023 2031 7374 2061 6e64  er):.  # 1st and
+00005b80: 2032 6e64 2073 6f6d 655f 6675 6e63 7469   2nd some_functi
+00005b90: 6f6e 3228 2920 6361 6c6c 7320 7368 6f75  on2() calls shou
+00005ba0: 6c64 2062 6520 7669 7369 626c 6520 696e  ld be visible in
+00005bb0: 2073 7061 726b 2075 6920 6173 2027 7879   spark ui as 'xy
+00005bc0: 7a27 0a20 2023 2074 6865 2033 7264 2070  z'.  # the 3rd p
+00005bd0: 6172 7420 6f66 2072 6573 756c 7420 7368  art of result sh
+00005be0: 6f75 6c64 2062 6520 7669 7369 626c 6520  ould be visible 
+00005bf0: 6173 2027 616c 7068 615f 6675 6e63 7469  as 'alpha_functi
+00005c00: 6f6e 320a 2020 7265 7475 726e 2073 6f6d  on2.  return som
+00005c10: 655f 6675 6e63 7469 6f6e 3228 6e75 6d62  e_function2(numb
+00005c20: 6572 2a32 2920 2b20 736f 6d65 5f66 756e  er*2) + some_fun
+00005c30: 6374 696f 6e32 286e 756d 6265 722a 3329  ction2(number*3)
+00005c40: 202b 2073 7061 726b 2e72 616e 6765 286e   + spark.range(n
+00005c50: 756d 6265 722f 3130 292e 636f 756e 7428  umber/10).count(
+00005c60: 290a 0a23 2075 7361 6765 206f 6620 636f  )..# usage of co
+00005c70: 6e74 6578 7420 6d61 6e61 6765 7273 0a23  ntext managers.#
+00005c80: 2077 696c 6c20 6265 2076 6973 6962 6c65   will be visible
+00005c90: 2069 6e20 7370 6172 6b20 7569 2061 7320   in spark ui as 
+00005ca0: 2766 6972 7374 2d63 6f75 6e74 270a 7769  'first-count'.wi
+00005cb0: 7468 2053 7061 726b 5549 4c6f 6767 6572  th SparkUILogger
+00005cc0: 2827 6669 7273 742d 636f 756e 7427 293a  ('first-count'):
+00005cd0: 0a20 2073 7061 726b 2e72 616e 6765 2831  .  spark.range(1
+00005ce0: 3029 2e63 6f75 6e74 2829 0a0a 2320 7769  0).count()..# wi
+00005cf0: 6c6c 2062 6520 7669 7369 626c 6520 696e  ll be visible in
+00005d00: 2073 7061 726b 2075 6920 6173 2027 326e   spark ui as '2n
+00005d10: 642d 636f 756e 7427 0a77 6974 6820 5370  d-count'.with Sp
+00005d20: 6172 6b55 494c 6f67 6765 7228 2732 6e64  arkUILogger('2nd
+00005d30: 2d63 6f75 6e74 2729 3a0a 2020 7370 6172  -count'):.  spar
+00005d40: 6b2e 7261 6e67 6528 3230 292e 636f 756e  k.range(20).coun
+00005d50: 7428 290a 0a73 6f6d 655f 6675 6e63 7469  t()..some_functi
+00005d60: 6f6e 3228 3130 3030 290a 616c 7068 615f  on2(1000).alpha_
+00005d70: 6675 6e63 7469 6f6e 3228 3230 3030 290a  function2(2000).
+00005d80: 6060 600a                                ```.
```

### Comparing `bdq-0.0.5/bdq/dataframe.py` & `bdq-0.1.0/bdq/dataframe.py`

 * *Files 1% similar despite different names*

```diff
@@ -11,16 +11,17 @@
 ]
 
 import sys
 import pyspark.sql.functions as F
 import pyspark.sql.types as T
 from pyspark.sql import DataFrame, Window
 from . import get_column_names_combinations, DAG
+from typing import List
 
-def compare_dataframes(df1:DataFrame, df2:DataFrame, key_columns:list[str], cache_results=False) -> DataFrame:
+def compare_dataframes(df1:DataFrame, df2:DataFrame, key_columns:List[str], cache_results=False) -> DataFrame:
   df1 = df1.alias('df1')
   df2 = df2.alias('df2')
 
   df3 = df1.join(df2, key_columns, "full_outer")
   df1_only_records = df3.filter(f"df2.{key_columns[0]} is null").select('df1.*')
   df2_only_records = df3.filter(f"df1.{key_columns[0]} is null").select('df2.*')
 
@@ -189,15 +190,15 @@
   
   return {
     'record_count': record_count
     ,'failed_records': checks_df.select(F.sum('cnt')).first()[0] or 0
     ,'failed_df': df
   }
 
-def validate_primary_key_candidate_combinations(df:DataFrame, combinations: list[list[str]], max_workers:int, verbose=False):
+def validate_primary_key_candidate_combinations(df:DataFrame, combinations: List[List[str]], max_workers:int, verbose=False):
   graph = DAG()
 
   validate_nodes = {}
 
   solutions = []
 
   for c in combinations:
```

### Comparing `bdq-0.0.5/bdq/functions.py` & `bdq-0.1.0/bdq/functions.py`

 * *Files identical despite different names*

### Comparing `bdq-0.0.5/bdq/schema.py` & `bdq-0.1.0/bdq/schema.py`

 * *Files identical despite different names*

### Comparing `bdq-0.0.5/bdq.egg-info/PKG-INFO` & `bdq-0.1.0/bdq.egg-info/PKG-INFO`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 00000000: 4d65 7461 6461 7461 2d56 6572 7369 6f6e  Metadata-Version
 00000010: 3a20 322e 310a 4e61 6d65 3a20 6264 710a  : 2.1.Name: bdq.
-00000020: 5665 7273 696f 6e3a 2030 2e30 2e35 0a53  Version: 0.0.5.S
+00000020: 5665 7273 696f 6e3a 2030 2e31 2e30 0a53  Version: 0.1.0.S
 00000030: 756d 6d61 7279 3a20 4269 6720 4461 7461  ummary: Big Data
 00000040: 2051 7561 6c69 7479 2c20 6120 7365 7420   Quality, a set 
 00000050: 6f66 2074 6f6f 6c73 2f66 756e 6374 696f  of tools/functio
 00000060: 6e20 7468 6174 2068 656c 7020 796f 7520  n that help you 
 00000070: 6576 6572 7920 6461 7920 6173 7365 7274  every day assert
 00000080: 2071 7561 6c69 7479 206f 6620 6461 7461   quality of data
 00000090: 7365 7473 2079 6f75 2068 6176 6520 7072  sets you have pr
@@ -32,1350 +32,1466 @@
 000001f0: 5379 7374 656d 203a 3a20 4f53 2049 6e64  System :: OS Ind
 00000200: 6570 656e 6465 6e74 0a52 6571 7569 7265  ependent.Require
 00000210: 732d 5079 7468 6f6e 3a20 3e3d 332e 380a  s-Python: >=3.8.
 00000220: 4465 7363 7269 7074 696f 6e2d 436f 6e74  Description-Cont
 00000230: 656e 742d 5479 7065 3a20 7465 7874 2f6d  ent-Type: text/m
 00000240: 6172 6b64 6f77 6e0a 4c69 6365 6e73 652d  arkdown.License-
 00000250: 4669 6c65 3a20 4c49 4345 4e53 450a 0a23  File: LICENSE..#
-00000260: 2057 6861 7420 6973 2062 6471 3f0a 4244   What is bdq?.BD
-00000270: 5120 7374 616e 6473 2066 6f72 2042 6967  Q stands for Big
-00000280: 2044 6174 6120 5175 616c 6974 792c 2061   Data Quality, a
-00000290: 2073 6574 206f 6620 746f 6f6c 732f 6675   set of tools/fu
-000002a0: 6e63 7469 6f6e 2074 6861 7420 6865 6c70  nction that help
-000002b0: 2079 6f75 2065 7665 7279 2064 6179 2061   you every day a
-000002c0: 7373 6572 7420 7175 616c 6974 7920 6f66  ssert quality of
-000002d0: 2064 6174 6173 6574 7320 796f 7520 6861   datasets you ha
-000002e0: 7665 2070 726f 6365 7373 6564 206f 7220  ve processed or 
-000002f0: 696e 6765 7374 6564 2e20 4c69 6272 6172  ingested. Librar
-00000300: 7920 6c65 7665 7261 6765 7320 706f 7765  y leverages powe
-00000310: 7220 6f66 2073 7061 726b 2c20 6865 6e63  r of spark, henc
-00000320: 6520 6974 2070 726f 6365 7373 6573 2079  e it processes y
-00000330: 6f75 7220 7175 616c 6974 7920 6368 6563  our quality chec
-00000340: 6b73 2061 7420 7363 616c 6520 6f66 6665  ks at scale offe
-00000350: 7265 6420 6279 2073 7061 726b 2061 6e64  red by spark and
-00000360: 2064 6174 6162 7269 636b 732e 0a0a 2323   databricks...##
-00000370: 2043 6f6d 7061 7269 6e67 2064 6174 6166   Comparing dataf
-00000380: 7261 6d65 2073 6368 656d 6173 0a60 6060  rame schemas.```
-00000390: 7079 7468 6f6e 0a69 6d70 6f72 7420 6264  python.import bd
-000003a0: 710a 6672 6f6d 2064 6174 6574 696d 6520  q.from datetime 
-000003b0: 696d 706f 7274 2064 6174 6574 696d 650a  import datetime.
-000003c0: 696d 706f 7274 2070 7973 7061 726b 2e73  import pyspark.s
-000003d0: 716c 2e66 756e 6374 696f 6e73 2061 7320  ql.functions as 
-000003e0: 460a 0a64 6632 203d 2073 7061 726b 2e63  F..df2 = spark.c
-000003f0: 7265 6174 6544 6174 6146 7261 6d65 285b  reateDataFrame([
-00000400: 0a5b 2031 2c20 312c 2022 4772 7a65 676f  .[ 1, 1, "Grzego
-00000410: 727a 222c 2064 6174 6574 696d 6528 3230  rz", datetime(20
-00000420: 3138 2c20 312c 2031 292c 2064 6174 6574  18, 1, 1), datet
-00000430: 696d 6528 3230 3138 2c20 312c 2031 2c20  ime(2018, 1, 1, 
-00000440: 3132 2c20 3334 2c20 3536 292c 2032 362e  12, 34, 56), 26.
-00000450: 392c 2031 3233 3233 3432 3334 3334 352c  9, 123234234345,
-00000460: 2054 7275 655d 2c0a 5b20 332c 2031 2c20   True],.[ 3, 1, 
-00000470: 224d 696b 6522 2c20 2020 2020 6461 7465  "Mike",     date
-00000480: 7469 6d65 2832 3031 392c 2031 2c20 3129  time(2019, 1, 1)
-00000490: 2c20 6461 7465 7469 6d65 2832 3031 382c  , datetime(2018,
-000004a0: 2033 2c20 312c 2031 322c 2033 342c 2035   3, 1, 12, 34, 5
-000004b0: 3629 2c20 3436 2e37 2c20 3536 3637 3838  6), 46.7, 566788
-000004c0: 3839 3839 2c20 4661 6c73 655d 2c0a 5b20  8989, False],.[ 
-000004d0: 322c 2032 2c20 2254 696d 6d79 222c 2020  2, 2, "Timmy",  
-000004e0: 2020 6461 7465 7469 6d65 2832 3031 382c    datetime(2018,
-000004f0: 2031 2c20 3129 2c20 6461 7465 7469 6d65   1, 1), datetime
-00000500: 2832 3031 382c 2032 2c20 312c 2031 322c  (2018, 2, 1, 12,
-00000510: 2033 342c 2035 3629 2c20 3336 2e37 2c20   34, 56), 36.7, 
-00000520: 3837 3534 3835 3738 3435 2c20 5472 7565  8754857845, True
-00000530: 5d0a 5d2c 2073 6368 656d 6129 0a0a 6466  ].], schema)..df
-00000540: 325f 6368 616e 6765 6420 3d20 6466 3220  2_changed = df2 
-00000550: 5c0a 2020 2e64 726f 7028 2766 6972 7374  \.  .drop('first
-00000560: 5f6c 6f67 696e 5f64 7427 2920 5c0a 2020  _login_dt') \.  
-00000570: 2e77 6974 6843 6f6c 756d 6e28 276e 6577  .withColumn('new
-00000580: 5f64 6174 6127 2c20 462e 6c69 7428 4e6f  _data', F.lit(No
-00000590: 6e65 292e 6361 7374 2827 6461 7465 2729  ne).cast('date')
-000005a0: 2920 5c0a 2020 2e77 6974 6843 6f6c 756d  ) \.  .withColum
-000005b0: 6e28 276c 696b 6573 272c 2046 2e63 6f6c  n('likes', F.col
-000005c0: 2827 6c69 6b65 7327 292e 6361 7374 2827  ('likes').cast('
-000005d0: 696e 7427 2929 0a0a 6173 7365 7274 2062  int'))..assert b
-000005e0: 6471 2e63 6f6d 7061 7265 5f73 6368 656d  dq.compare_schem
-000005f0: 6173 2864 6632 2e73 6368 656d 612c 2064  as(df2.schema, d
-00000600: 6632 5f63 6861 6e67 6564 2e73 6368 656d  f2_changed.schem
-00000610: 6129 203d 3d20 7b0a 2020 2761 6464 6564  a) == {.  'added
-00000620: 273a 207b 2766 6972 7374 5f6c 6f67 696e  ': {'first_login
-00000630: 5f64 7427 7d2c 200a 2020 2772 656d 6f76  _dt'}, .  'remov
-00000640: 6564 273a 207b 276e 6577 5f64 6174 6127  ed': {'new_data'
-00000650: 7d2c 200a 2020 2763 6861 6e67 6564 273a  }, .  'changed':
-00000660: 207b 0a20 2020 2027 6c69 6b65 7327 3a20   {.    'likes': 
-00000670: 7b27 6265 666f 7265 273a 2027 6269 6769  {'before': 'bigi
-00000680: 6e74 272c 2027 6166 7465 7227 3a20 2769  nt', 'after': 'i
-00000690: 6e74 277d 0a20 207d 2c0a 2020 276e 6f74  nt'}.  },.  'not
-000006a0: 5f63 6861 6e67 6564 273a 207b 0a20 2020  _changed': {.   
-000006b0: 2027 6e61 6d65 272c 2027 6964 3127 2c20   'name', 'id1', 
-000006c0: 276c 6173 745f 6c6f 6769 6e5f 7473 272c  'last_login_ts',
-000006d0: 2027 6964 3227 2c20 2763 7265 6469 7473   'id2', 'credits
-000006e0: 272c 2027 6163 7469 7665 270a 2020 7d0a  ', 'active'.  }.
-000006f0: 7d0a 6060 600a 0a23 2320 436f 6d70 6172  }.```..## Compar
-00000700: 696e 6720 6461 7461 6672 616d 6527 7320  ing dataframe's 
-00000710: 6461 7461 0a0a 6060 6070 7974 686f 6e0a  data..```python.
-00000720: 696d 706f 7274 2062 6471 0a0a 6466 3120  import bdq..df1 
-00000730: 3d20 7370 6172 6b2e 6372 6561 7465 4461  = spark.createDa
-00000740: 7461 4672 616d 6528 5b0a 5b20 312c 2031  taFrame([.[ 1, 1
-00000750: 2c20 2247 727a 6567 6f72 7a22 2c20 6461  , "Grzegorz", da
-00000760: 7465 7469 6d65 2832 3031 372c 2031 2c20  tetime(2017, 1, 
-00000770: 3129 2c20 6461 7465 7469 6d65 2832 3031  1), datetime(201
-00000780: 382c 2031 2c20 312c 2031 322c 2033 342c  8, 1, 1, 12, 34,
-00000790: 2035 3629 2c20 3236 2e37 2c20 3132 3332   56), 26.7, 1232
-000007a0: 3334 3233 3433 3435 2c20 5472 7565 5d2c  34234345, True],
-000007b0: 0a5b 2032 2c20 312c 2022 5469 6d22 2c20  .[ 2, 1, "Tim", 
-000007c0: 2020 2020 2064 6174 6574 696d 6528 3230       datetime(20
-000007d0: 3138 2c20 312c 2031 292c 2064 6174 6574  18, 1, 1), datet
-000007e0: 696d 6528 3230 3138 2c20 322c 2031 2c20  ime(2018, 2, 1, 
-000007f0: 3132 2c20 3334 2c20 3536 292c 2033 362e  12, 34, 56), 36.
-00000800: 372c 2035 3435 3435 2c20 2020 2020 2054  7, 54545,      T
-00000810: 7275 655d 2c0a 5b20 332c 2031 2c20 224d  rue],.[ 3, 1, "M
-00000820: 696b 6522 2c20 2020 2020 6461 7465 7469  ike",     dateti
-00000830: 6d65 2832 3031 392c 2031 2c20 3129 2c20  me(2019, 1, 1), 
-00000840: 6461 7465 7469 6d65 2832 3031 382c 2033  datetime(2018, 3
-00000850: 2c20 312c 2031 322c 2033 342c 2035 3629  , 1, 12, 34, 56)
-00000860: 2c20 3436 2e37 2c20 3536 3637 3838 3839  , 46.7, 56678889
-00000870: 3839 2c20 4661 6c73 655d 0a5d 2c20 7363  89, False].], sc
-00000880: 6865 6d61 290a 0a64 6632 203d 2073 7061  hema)..df2 = spa
-00000890: 726b 2e63 7265 6174 6544 6174 6146 7261  rk.createDataFra
-000008a0: 6d65 285b 0a5b 2031 2c20 312c 2022 4772  me([.[ 1, 1, "Gr
-000008b0: 7a65 676f 727a 222c 2064 6174 6574 696d  zegorz", datetim
-000008c0: 6528 3230 3138 2c20 312c 2031 292c 2064  e(2018, 1, 1), d
-000008d0: 6174 6574 696d 6528 3230 3138 2c20 312c  atetime(2018, 1,
-000008e0: 2031 2c20 3132 2c20 3334 2c20 3536 292c   1, 12, 34, 56),
-000008f0: 2032 362e 392c 2031 3233 3233 3432 3334   26.9, 123234234
-00000900: 3334 352c 2054 7275 655d 2c0a 5b20 332c  345, True],.[ 3,
-00000910: 2031 2c20 224d 696b 6522 2c20 2020 2020   1, "Mike",     
-00000920: 6461 7465 7469 6d65 2832 3031 392c 2031  datetime(2019, 1
-00000930: 2c20 3129 2c20 6461 7465 7469 6d65 2832  , 1), datetime(2
-00000940: 3031 382c 2033 2c20 312c 2031 322c 2033  018, 3, 1, 12, 3
-00000950: 342c 2035 3629 2c20 3436 2e37 2c20 3536  4, 56), 46.7, 56
-00000960: 3637 3838 3839 3839 2c20 4661 6c73 655d  67888989, False]
-00000970: 2c0a 5b20 322c 2032 2c20 2254 696d 6d79  ,.[ 2, 2, "Timmy
-00000980: 222c 2020 2020 6461 7465 7469 6d65 2832  ",    datetime(2
-00000990: 3031 382c 2031 2c20 3129 2c20 6461 7465  018, 1, 1), date
-000009a0: 7469 6d65 2832 3031 382c 2032 2c20 312c  time(2018, 2, 1,
-000009b0: 2031 322c 2033 342c 2035 3629 2c20 3336   12, 34, 56), 36
-000009c0: 2e37 2c20 3837 3534 3835 3738 3435 2c20  .7, 8754857845, 
-000009d0: 5472 7565 5d0a 5d2c 2073 6368 656d 6129  True].], schema)
-000009e0: 0a0a 2372 6574 7572 6e73 2064 6963 7473  ..#returns dicts
-000009f0: 2077 6974 6820 6164 6465 642c 2072 656d   with added, rem
-00000a00: 6f76 6564 2c20 6368 616e 6765 6420 616e  oved, changed an
-00000a10: 6420 6e6f 7420 6368 616e 6765 6420 6461  d not changed da
-00000a20: 7461 6672 616d 6573 2c20 616e 6420 7265  taframes, and re
-00000a30: 636f 7264 2063 6f75 6e74 730a 6466 5f64  cord counts.df_d
-00000a40: 6966 6620 3d20 6264 712e 636f 6d70 6172  iff = bdq.compar
-00000a50: 655f 6461 7461 6672 616d 6573 2864 6631  e_dataframes(df1
-00000a60: 2c20 6466 322c 205b 2769 6431 272c 2027  , df2, ['id1', '
-00000a70: 6964 3227 5d2c 2054 7275 6529 0a0a 2373  id2'], True)..#s
-00000a80: 686f 7720 616c 6c20 696e 666f 2061 626f  how all info abo
-00000a90: 7574 2063 6f6d 7061 7265 2072 6573 756c  ut compare resul
-00000aa0: 7473 0a62 6471 2e64 6973 706c 6179 5f63  ts.bdq.display_c
-00000ab0: 6f6d 7061 7265 5f64 6174 6166 7261 6d65  ompare_dataframe
-00000ac0: 735f 7265 7375 6c74 7328 6466 5f64 6966  s_results(df_dif
-00000ad0: 6629 0a0a 3e3e 2041 6464 6564 2072 6563  f)..>> Added rec
-00000ae0: 6f72 6473 2063 6f75 6e74 3a20 310a 3e3e  ords count: 1.>>
-00000af0: 202b 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2d2b   +---+---+-----+
-00000b00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
-00000b10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000b20: 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  --+-------+-----
-00000b30: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e  -----+------+.>>
-00000b40: 207c 6964 317c 6964 327c 6e61 6d65 207c   |id1|id2|name |
-00000b50: 6669 7273 745f 6c6f 6769 6e5f 6474 7c6c  first_login_dt|l
-00000b60: 6173 745f 6c6f 6769 6e5f 7473 2020 2020  ast_login_ts    
-00000b70: 2020 7c63 7265 6469 7473 7c6c 696b 6573    |credits|likes
-00000b80: 2020 2020 207c 6163 7469 7665 7c0a 3e3e       |active|.>>
-00000b90: 202b 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2d2b   +---+---+-----+
-00000ba0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
-00000bb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000bc0: 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  --+-------+-----
-00000bd0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e  -----+------+.>>
-00000be0: 207c 3220 207c 3220 207c 5469 6d6d 797c   |2  |2  |Timmy|
-00000bf0: 3230 3138 2d30 312d 3031 2020 2020 7c32  2018-01-01    |2
-00000c00: 3031 382d 3032 2d30 3120 3132 3a33 343a  018-02-01 12:34:
-00000c10: 3536 7c33 362e 3720 2020 7c38 3735 3438  56|36.7   |87548
-00000c20: 3537 3834 357c 7472 7565 2020 7c0a 3e3e  57845|true  |.>>
-00000c30: 202b 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2d2b   +---+---+-----+
-00000c40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
-00000c50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000c60: 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  --+-------+-----
-00000c70: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e  -----+------+.>>
-00000c80: 200a 3e3e 2052 656d 6f76 6564 2072 6563   .>> Removed rec
-00000c90: 6f72 6473 2063 6f75 6e74 3a20 310a 3e3e  ords count: 1.>>
-00000ca0: 202b 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2b2d   +---+---+----+-
-00000cb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
-00000cc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000cd0: 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2b  -+-------+-----+
-00000ce0: 2d2d 2d2d 2d2d 2b0a 3e3e 207c 6964 317c  ------+.>> |id1|
-00000cf0: 6964 327c 6e61 6d65 7c66 6972 7374 5f6c  id2|name|first_l
-00000d00: 6f67 696e 5f64 747c 6c61 7374 5f6c 6f67  ogin_dt|last_log
-00000d10: 696e 5f74 7320 2020 2020 207c 6372 6564  in_ts      |cred
-00000d20: 6974 737c 6c69 6b65 737c 6163 7469 7665  its|likes|active
-00000d30: 7c0a 3e3e 202b 2d2d 2d2b 2d2d 2d2b 2d2d  |.>> +---+---+--
-00000d40: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
-00000d50: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
-00000d60: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d  -----+-------+--
-00000d70: 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a 3e3e 207c  ---+------+.>> |
-00000d80: 3220 207c 3120 207c 5469 6d20 7c32 3031  2  |1  |Tim |201
-00000d90: 382d 3031 2d30 3120 2020 207c 3230 3138  8-01-01    |2018
-00000da0: 2d30 322d 3031 2031 323a 3334 3a35 367c  -02-01 12:34:56|
-00000db0: 3336 2e37 2020 207c 3534 3534 357c 7472  36.7   |54545|tr
-00000dc0: 7565 2020 7c0a 3e3e 202b 2d2d 2d2b 2d2d  ue  |.>> +---+--
-00000dd0: 2d2b 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  -+----+---------
-00000de0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
-00000df0: 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  ---------+------
-00000e00: 2d2b 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2b0a  -+-----+------+.
-00000e10: 3e3e 200a 3e3e 2043 6861 6e67 6564 2072  >> .>> Changed r
-00000e20: 6563 6f72 6473 2063 6f75 6e74 3a20 310a  ecords count: 1.
-00000e30: 3e3e 202b 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d  >> +---+---+----
-00000e40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000e50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000e60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000e70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000e80: 2d2b 0a3e 3e20 7c69 6431 7c69 6432 7c63  -+.>> |id1|id2|c
-00000e90: 6861 6e67 6564 2020 2020 2020 2020 2020  hanged          
-00000ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000ed0: 2020 2020 7c0a 3e3e 202b 2d2d 2d2b 2d2d      |.>> +---+--
-00000ee0: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
-00000ef0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000f00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000f10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000f20: 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c31 2020  -------+.>> |1  
-00000f30: 7c31 2020 7c7b 6669 7273 745f 6c6f 6769  |1  |{first_logi
-00000f40: 6e5f 6474 202d 3e20 7b32 3031 372d 3031  n_dt -> {2017-01
-00000f50: 2d30 312c 2032 3031 382d 3031 2d30 317d  -01, 2018-01-01}
-00000f60: 2c20 6372 6564 6974 7320 2d3e 207b 3236  , credits -> {26
-00000f70: 2e37 2c20 3236 2e39 7d7d 7c0a 3e3e 202b  .7, 26.9}}|.>> +
-00000f80: 2d2d 2d2b 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  ---+---+--------
-00000f90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000fa0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000fb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000fc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a0a  -------------+..
-00000fd0: 4e6f 7420 6368 616e 6765 6420 7265 636f  Not changed reco
-00000fe0: 7264 7320 636f 756e 743a 2031 0a60 6060  rds count: 1.```
-00000ff0: 0a0a 2323 2053 7572 726f 6761 7465 206b  ..## Surrogate k
-00001000: 6579 2067 656e 6572 6174 696f 6e0a 7769  ey generation.wi
-00001010: 7468 2073 7570 706f 7274 206f 6620 6f70  th support of op
-00001020: 7469 6f6e 616c 2075 7070 6572 6361 7369  tional uppercasi
-00001030: 6e67 2061 6e64 2074 7269 6d6d 696e 6720  ng and trimming 
-00001040: 6f66 206b 6579 2063 6f6c 756d 6e73 0a0a  of key columns..
-00001050: 6060 6070 7974 686f 6e0a 6672 6f6d 2064  ```python.from d
-00001060: 6174 6574 696d 6520 696d 706f 7274 2064  atetime import d
-00001070: 6174 6574 696d 650a 6672 6f6d 2062 6471  atetime.from bdq
-00001080: 2e66 756e 6374 696f 6e73 2069 6d70 6f72  .functions impor
-00001090: 7420 7375 7272 6f67 6174 655f 6b65 795f  t surrogate_key_
-000010a0: 6861 7368 2c20 7375 7272 6f67 6174 655f  hash, surrogate_
-000010b0: 6b65 795f 7374 7269 6e67 0a0a 7363 6865  key_string..sche
-000010c0: 6d61 203d 2022 6964 313a 6c6f 6e67 2c69  ma = "id1:long,i
-000010d0: 6432 3a6c 6f6e 672c 6e61 6d65 3a73 7472  d2:long,name:str
-000010e0: 696e 672c 6c69 6b65 733a 696e 7422 0a0a  ing,likes:int"..
-000010f0: 6466 3120 3d20 7370 6172 6b2e 6372 6561  df1 = spark.crea
-00001100: 7465 4461 7461 4672 616d 6528 5b0a 2020  teDataFrame([.  
-00001110: 5b20 312c 2031 2c20 2247 727a 6547 6f72  [ 1, 1, "GrzeGor
-00001120: 7a22 2c20 3120 5d2c 0a20 205b 2031 2c20  z", 1 ],.  [ 1, 
-00001130: 312c 2022 4772 7a65 676f 727a 222c 2020  1, "Grzegorz",  
-00001140: 3120 5d2c 0a20 205b 2031 2c20 312c 2022  1 ],.  [ 1, 1, "
-00001150: 4772 7a65 676f 727a 2020 2020 2020 222c  Grzegorz      ",
-00001160: 2020 3120 5d2c 0a20 205b 2031 2c20 4e6f    1 ],.  [ 1, No
-00001170: 6e65 2c20 2247 727a 6567 6f72 7a22 2c20  ne, "Grzegorz", 
-00001180: 315d 2c0a 2020 5b20 312c 204e 6f6e 652c  1],.  [ 1, None,
-00001190: 204e 6f6e 652c 2031 5d2c 0a20 205b 2032   None, 1],.  [ 2
-000011a0: 2c20 312c 2022 5469 6d22 2c20 3120 5d2c  , 1, "Tim", 1 ],
-000011b0: 0a20 205b 2033 2c20 312c 2022 4d69 6b65  .  [ 3, 1, "Mike
-000011c0: 222c 2031 205d 0a5d 2c20 7363 6865 6d61  ", 1 ].], schema
-000011d0: 290a 0a73 6b5f 6466 203d 2064 6631 2e73  )..sk_df = df1.s
-000011e0: 656c 6563 7428 0a20 2027 2a27 2c20 0a20  elect(.  '*', . 
-000011f0: 2073 7572 726f 6761 7465 5f6b 6579 5f68   surrogate_key_h
-00001200: 6173 6828 5b27 6964 3127 2c20 2769 6432  ash(['id1', 'id2
-00001210: 272c 2027 6e61 6d65 275d 2c20 7274 7269  ', 'name'], rtri
-00001220: 6d3d 5472 7565 292e 616c 6961 7328 2768  m=True).alias('h
-00001230: 6173 6827 292c 0a20 2073 7572 726f 6761  ash'),.  surroga
-00001240: 7465 5f6b 6579 5f73 7472 696e 6728 5b27  te_key_string(['
-00001250: 6964 3127 2c20 2769 6432 272c 2027 6e61  id1', 'id2', 'na
-00001260: 6d65 275d 2c20 7274 7269 6d3d 5472 7565  me'], rtrim=True
-00001270: 292e 616c 6961 7328 2768 6173 685f 696e  ).alias('hash_in
-00001280: 7075 7427 290a 290a 0a3e 3e20 2b2d 2d2d  put').)..>> +---
-00001290: 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  +----+----------
-000012a0: 2d2d 2d2d 2b2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----+-----+-----
-000012b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000012c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000012d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000012e0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
-000012f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001300: 2d2d 2d2d 2b0a 3e3e 207c 6964 317c 6964  ----+.>> |id1|id
-00001310: 3220 7c6e 616d 6520 2020 2020 2020 2020  2 |name         
-00001320: 207c 6c69 6b65 737c 6861 7368 2020 2020   |likes|hash    
-00001330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001360: 2020 2020 207c 6861 7368 5f69 6e70 7574       |hash_input
-00001370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001380: 207c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2b   |.>> +---+----+
-00001390: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
-000013a0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
-000013b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000013c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000013d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000013e0: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
-000013f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a  --------------+.
-00001400: 3e3e 207c 3120 207c 3120 2020 7c47 727a  >> |1  |1   |Grz
-00001410: 6547 6f72 7a20 2020 2020 207c 3120 2020  eGorz      |1   
-00001420: 207c 5b36 4620 3231 2039 3920 3939 2034   |[6F 21 99 99 4
-00001430: 4320 4632 2039 3320 3536 2032 4520 3743  C F2 93 56 2E 7C
-00001440: 2043 3320 3239 2046 3920 3641 2034 3220   C3 29 F9 6A 42 
-00001450: 3246 2036 4420 3632 2045 4320 3442 5d7c  2F 6D 62 EC 4B]|
-00001460: 5b31 2c20 312c 2047 525a 4547 4f52 5a5d  [1, 1, GRZEGORZ]
-00001470: 2020 2020 2020 2020 2020 207c 0a3e 3e20             |.>> 
-00001480: 7c31 2020 7c31 2020 207c 4772 7a65 676f  |1  |1   |Grzego
-00001490: 727a 2020 2020 2020 7c31 2020 2020 7c5b  rz      |1    |[
-000014a0: 3646 2032 3120 3939 2039 3920 3443 2046  6F 21 99 99 4C F
-000014b0: 3220 3933 2035 3620 3245 2037 4320 4333  2 93 56 2E 7C C3
-000014c0: 2032 3920 4639 2036 4120 3432 2032 4620   29 F9 6A 42 2F 
-000014d0: 3644 2036 3220 4543 2034 425d 7c5b 312c  6D 62 EC 4B]|[1,
-000014e0: 2031 2c20 4752 5a45 474f 525a 5d20 2020   1, GRZEGORZ]   
-000014f0: 2020 2020 2020 2020 7c0a 3e3e 207c 3120          |.>> |1 
-00001500: 207c 3120 2020 7c47 727a 6567 6f72 7a20   |1   |Grzegorz 
-00001510: 2020 2020 207c 3120 2020 207c 5b36 4620       |1    |[6F 
-00001520: 3231 2039 3920 3939 2034 4320 4632 2039  21 99 99 4C F2 9
-00001530: 3320 3536 2032 4520 3743 2043 3320 3239  3 56 2E 7C C3 29
-00001540: 2046 3920 3641 2034 3220 3246 2036 4420   F9 6A 42 2F 6D 
-00001550: 3632 2045 4320 3442 5d7c 5b31 2c20 312c  62 EC 4B]|[1, 1,
-00001560: 2047 525a 4547 4f52 5a5d 2020 2020 2020   GRZEGORZ]      
-00001570: 2020 2020 207c 0a3e 3e20 7c31 2020 7c6e       |.>> |1  |n
-00001580: 756c 6c7c 4772 7a65 676f 727a 2020 2020  ull|Grzegorz    
-00001590: 2020 7c31 2020 2020 7c5b 3445 2039 4520    |1    |[4E 9E 
-000015a0: 3341 2032 4220 4338 2033 3720 3930 2041  3A 2B C8 37 90 A
-000015b0: 3020 3641 2032 3620 3941 2046 4520 3741  0 6A 26 9A FE 7A
-000015c0: 2037 3820 3842 2043 4120 3939 2033 3420   78 8B CA 99 34 
-000015d0: 3638 2031 435d 7c5b 312c 2040 7e3c 6e75  68 1C]|[1, @~<nu
-000015e0: 6c6c 3e7e 402c 2047 525a 4547 4f52 5a5d  ll>~@, GRZEGORZ]
-000015f0: 2020 7c0a 3e3e 207c 3120 207c 6e75 6c6c    |.>> |1  |null
-00001600: 7c6e 756c 6c20 2020 2020 2020 2020 207c  |null          |
-00001610: 3120 2020 207c 5b34 3420 4646 2038 3820  1    |[44 FF 88 
-00001620: 3245 2032 4120 3238 2033 4220 4545 2045  2E 2A 28 3B EE E
-00001630: 4520 3533 2043 3820 3744 2030 4620 3932  E 53 C8 7D 0F 92
-00001640: 2044 3120 3638 2033 4520 4132 2046 3220   D1 68 3E A2 F2 
-00001650: 4535 5d7c 5b31 2c20 407e 3c6e 756c 6c3e  E5]|[1, @~<null>
-00001660: 7e40 2c20 407e 3c6e 756c 6c3e 7e40 5d7c  ~@, @~<null>~@]|
-00001670: 0a3e 3e20 7c32 2020 7c31 2020 207c 5469  .>> |2  |1   |Ti
-00001680: 6d20 2020 2020 2020 2020 2020 7c31 2020  m           |1  
-00001690: 2020 7c5b 4138 2037 4120 4230 2032 3920    |[A8 7A B0 29 
-000016a0: 3934 2039 4620 3543 2044 3120 3738 2044  94 9F 5C D1 78 D
-000016b0: 3420 3238 2038 3920 3842 2046 3120 3735  4 28 89 8B F1 75
-000016c0: 2043 4420 4143 2037 3020 4236 2036 315d   CD AC 70 B6 61]
-000016d0: 7c5b 322c 2031 2c20 5449 4d5d 2020 2020  |[2, 1, TIM]    
-000016e0: 2020 2020 2020 2020 2020 2020 7c0a 3e3e              |.>>
-000016f0: 207c 3320 207c 3120 2020 7c4d 696b 6520   |3  |1   |Mike 
-00001700: 2020 2020 2020 2020 207c 3120 2020 207c           |1    |
-00001710: 5b39 4420 3643 2037 3620 4335 2031 3720  [9D 6C 76 C5 17 
-00001720: 4430 2034 3420 3436 2034 3720 3141 2037  D0 44 46 47 1A 7
-00001730: 3120 4544 2034 4120 3038 2037 3520 3834  1 ED 4A 08 75 84
-00001740: 2031 4420 3543 2034 3520 3039 5d7c 5b33   1D 5C 45 09]|[3
-00001750: 2c20 312c 204d 494b 455d 2020 2020 2020  , 1, MIKE]      
-00001760: 2020 2020 2020 2020 207c 0a3e 3e20 2b2d           |.>> +-
-00001770: 2d2d 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  --+----+--------
-00001780: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2b2d 2d2d  ------+-----+---
-00001790: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000017a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000017b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000017c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
-000017d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000017e0: 2d2d 2d2d 2d2d 2b0a 6060 600a 0a23 2320  ------+.```..## 
-000017f0: 504b 2026 2046 4b20 696e 7465 7267 7269  PK & FK intergri
-00001800: 7479 2063 6865 636b 730a 7769 7468 2073  ty checks.with s
-00001810: 7570 706f 7274 206f 6620 7368 6f77 696e  upport of showin
-00001820: 6720 7361 6d70 6c65 2064 6174 6120 6672  g sample data fr
-00001830: 6f6d 2066 6163 7420 7461 626c 6520 7468  om fact table th
-00001840: 6174 2064 6964 206e 6f74 2073 6174 6973  at did not satis
-00001850: 6679 2069 6e74 6567 7269 7479 0a0a 6060  fy integrity..``
-00001860: 6070 7974 686f 6e0a 6672 6f6d 2062 6471  `python.from bdq
-00001870: 2069 6d70 6f72 7420 6661 6374 5f64 696d   import fact_dim
-00001880: 5f62 726f 6b65 6e5f 7265 6c61 7469 6f6e  _broken_relation
-00001890: 7368 6970 0a66 726f 6d20 6264 712e 6675  ship.from bdq.fu
-000018a0: 6e63 7469 6f6e 7320 696d 706f 7274 2073  nctions import s
-000018b0: 7572 726f 6761 7465 5f6b 6579 5f68 6173  urrogate_key_has
-000018c0: 682c 2073 7572 726f 6761 7465 5f6b 6579  h, surrogate_key
-000018d0: 5f73 7472 696e 670a 0a66 6163 745f 6466  _string..fact_df
-000018e0: 203d 2073 7061 726b 2e63 7265 6174 6544   = spark.createD
-000018f0: 6174 6146 7261 6d65 285b 0a20 2020 205b  ataFrame([.    [
-00001900: 2022 4772 7a65 676f 727a 222c 2022 4954   "Grzegorz", "IT
-00001910: 222c 2022 4555 2220 5d2c 0a20 2020 205b  ", "EU" ],.    [
-00001920: 2022 4d61 726b 222c 2022 4954 222c 2022   "Mark", "IT", "
-00001930: 4555 2220 5d2c 0a20 2020 205b 2022 4a75  EU" ],.    [ "Ju
-00001940: 7374 696e 222c 2022 4954 2020 222c 2022  stin", "IT  ", "
-00001950: 4555 2020 2020 2220 5d2c 0a20 2020 205b  EU    " ],.    [
-00001960: 2022 416c 6963 6531 222c 2022 4954 222c   "Alice1", "IT",
-00001970: 2022 5553 4122 205d 2c0a 2020 2020 5b20   "USA" ],.    [ 
-00001980: 2241 6c69 6365 3222 2c20 2249 5422 2c20  "Alice2", "IT", 
-00001990: 2255 5341 2220 5d2c 0a20 2020 205b 2022  "USA" ],.    [ "
-000019a0: 416c 6963 6533 222c 2022 4954 222c 2022  Alice3", "IT", "
-000019b0: 5553 4122 205d 2c0a 2020 2020 5b20 2241  USA" ],.    [ "A
-000019c0: 6c69 6365 3422 2c20 2249 5422 2c20 2255  lice4", "IT", "U
-000019d0: 5341 2220 5d2c 0a20 2020 205b 2022 416c  SA" ],.    [ "Al
-000019e0: 6963 6535 222c 2022 4954 222c 2022 5553  ice5", "IT", "US
-000019f0: 4122 205d 2c0a 2020 2020 5b20 2242 6f62  A" ],.    [ "Bob
-00001a00: 222c 2022 5361 6c65 7322 2c20 2255 5341  ", "Sales", "USA
-00001a10: 2220 5d2c 0a20 2020 205b 2022 426f 6232  " ],.    [ "Bob2
-00001a20: 222c 2022 5361 6c65 7322 2c20 2255 5341  ", "Sales", "USA
-00001a30: 2220 5d2c 0a20 2020 205b 2022 426f 6233  " ],.    [ "Bob3
-00001a40: 222c 2022 5361 6c65 7322 2c20 2255 5341  ", "Sales", "USA
-00001a50: 2220 5d0a 2020 5d2c 2022 4e61 6d65 3a73  " ].  ], "Name:s
-00001a60: 7472 696e 672c 4465 7074 3a73 7472 696e  tring,Dept:strin
-00001a70: 672c 436f 756e 7472 793a 7374 7269 6e67  g,Country:string
-00001a80: 2229 205c 0a20 202e 7769 7468 436f 6c75  ") \.  .withColu
-00001a90: 6d6e 2822 6465 7074 5f66 6b22 2c20 7375  mn("dept_fk", su
-00001aa0: 7272 6f67 6174 655f 6b65 795f 6861 7368  rrogate_key_hash
-00001ab0: 285b 2244 6570 7422 2c20 2243 6f75 6e74  (["Dept", "Count
-00001ac0: 7279 225d 2c20 7274 7269 6d3d 5472 7565  ry"], rtrim=True
-00001ad0: 2929 0a0a 6469 6d5f 6466 203d 2073 7061  ))..dim_df = spa
-00001ae0: 726b 2e63 7265 6174 6544 6174 6146 7261  rk.createDataFra
-00001af0: 6d65 285b 0a20 2020 205b 2249 5422 2c20  me([.    ["IT", 
-00001b00: 2245 5522 2c20 2245 7572 6f70 6561 6e20  "EU", "European 
-00001b10: 4954 2064 6570 6172 746d 656e 7422 5d2c  IT department"],
-00001b20: 0a20 2020 205b 2253 616c 6573 222c 2022  .    ["Sales", "
-00001b30: 5553 4122 2c20 2255 5341 2053 616c 6573  USA", "USA Sales
-00001b40: 2064 6570 742e 225d 0a20 205d 2c20 2264   dept."].  ], "d
-00001b50: 6570 6172 746d 656e 743a 7374 7269 6e67  epartment:string
-00001b60: 2c63 6e74 7279 3a73 7472 696e 672c 636f  ,cntry:string,co
-00001b70: 6d6d 656e 743a 7374 7269 6e67 2229 205c  mment:string") \
-00001b80: 0a20 202e 7769 7468 436f 6c75 6d6e 2822  .  .withColumn("
-00001b90: 6465 7074 5f70 6b22 2c20 7375 7272 6f67  dept_pk", surrog
-00001ba0: 6174 655f 6b65 795f 6861 7368 285b 2264  ate_key_hash(["d
-00001bb0: 6570 6172 746d 656e 7422 2c20 2263 6e74  epartment", "cnt
-00001bc0: 7279 225d 2c20 7274 7269 6d3d 5472 7565  ry"], rtrim=True
-00001bd0: 2929 0a0a 2364 6972 6563 7420 636f 6c75  ))..#direct colu
-00001be0: 6d6e 2063 6f6d 7061 7269 736f 6e2c 2068  mn comparison, h
-00001bf0: 656e 6365 2075 7070 6572 2c20 6c6f 7765  ence upper, lowe
-00001c00: 722c 2065 7874 7261 2073 7061 6365 7320  r, extra spaces 
-00001c10: 6166 6665 6374 2074 6865 2072 6573 756c  affect the resul
-00001c20: 7473 0a62 726f 6b65 6e5f 6466 203d 2066  ts.broken_df = f
-00001c30: 6163 745f 6469 6d5f 6272 6f6b 656e 5f72  act_dim_broken_r
-00001c40: 656c 6174 696f 6e73 6869 7028 0a20 2066  elationship(.  f
-00001c50: 6163 745f 6466 3d66 6163 745f 6466 2c0a  act_df=fact_df,.
-00001c60: 2020 666b 5f63 6f6c 756d 6e73 3d5b 2244    fk_columns=["D
-00001c70: 6570 7422 2c20 2243 6f75 6e74 7279 225d  ept", "Country"]
-00001c80: 2c0a 2020 6469 6d5f 6466 3d64 696d 5f64  ,.  dim_df=dim_d
-00001c90: 662c 0a20 2070 6b5f 636f 6c75 6d6e 733d  f,.  pk_columns=
-00001ca0: 5b22 6465 7061 7274 6d65 6e74 222c 2022  ["department", "
-00001cb0: 636e 7472 7922 5d2c 0a20 2073 616d 706c  cntry"],.  sampl
-00001cc0: 655f 6272 6f6b 656e 5f72 6563 6f72 6473  e_broken_records
-00001cd0: 3d32 0a29 0a0a 3e3e 202b 2d2d 2d2d 2b2d  =2.)..>> +----+-
-00001ce0: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  ------+---------
-00001cf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001d00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001d10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001d20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001d30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e 3e20  -----------+.>> 
-00001d40: 7c44 6570 747c 436f 756e 7472 797c 7361  |Dept|Country|sa
-00001d50: 6d70 6c65 5f72 6563 6f72 6473 2020 2020  mple_records    
-00001d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001da0: 2020 7c0a 3e3e 202b 2d2d 2d2d 2b2d 2d2d    |.>> +----+---
-00001db0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
-00001dc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001dd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001de0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001df0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001e00: 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c49  ---------+.>> |I
-00001e10: 5420 207c 5553 4120 2020 207c 5b7b 4954  T  |USA    |[{IT
-00001e20: 2c20 5553 412c 2041 6c69 6365 312c 20ef  , USA, Alice1, .
-00001e30: bfbd efbf bd78 7a34 7110 5fef bfbd efbf  .....xz4q._.....
-00001e40: bd11 5c72 61ef bfbd 2def bfbd 16ef bfbd  ..\ra...-.......
-00001e50: 567a 7d2c 207b 4954 2c20 5553 412c 2041  Vz}, {IT, USA, A
-00001e60: 6c69 6365 322c 20ef bfbd efbf bd78 7a34  lice2, ......xz4
-00001e70: 7110 5fef bfbd efbf bd11 5c72 61ef bfbd  q._.......\ra...
-00001e80: 2def bfbd 16ef bfbd 567a 7d5d 7c0a 3e3e  -.......Vz}]|.>>
-00001e90: 207c 4954 2020 7c45 5520 2020 2020 7c5b   |IT  |EU     |[
-00001ea0: 7b49 5420 202c 2045 5520 2020 202c 204a  {IT  , EU    , J
-00001eb0: 7573 7469 6e2c 20ef bfbd efbf bd48 2756  ustin, ......H'V
-00001ec0: 34ef bfbd 5c72 592c 67ef bfbd 49ef bfbd  4...\rY,g...I...
-00001ed0: efbf bd12 efbf bdef bfbd efbf bd7d 5d20  .............}] 
-00001ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001f00: 2020 2020 207c 0a3e 3e20 2b2d 2d2d 2d2b       |.>> +----+
-00001f10: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  -------+--------
-00001f20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001f30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001f40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001f50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001f60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 0a23  ------------+..#
-00001f70: 2075 7369 6e67 2073 7572 726f 6761 7465   using surrogate
-00001f80: 206b 6579 7320 7769 6c6c 2079 6965 6c64   keys will yield
-00001f90: 2062 6574 7465 7220 7265 7375 6c74 732c   better results,
-00001fa0: 2062 6563 6175 7365 2065 7874 7261 2073   because extra s
-00001fb0: 7061 6365 7320 6172 6520 7472 696d 6d65  paces are trimme
-00001fc0: 640a 6272 6f6b 656e 5f73 6b5f 6466 203d  d.broken_sk_df =
-00001fd0: 2066 6163 745f 6469 6d5f 6272 6f6b 656e   fact_dim_broken
-00001fe0: 5f72 656c 6174 696f 6e73 6869 7028 0a20  _relationship(. 
-00001ff0: 2066 6163 745f 6466 2c20 5b22 6465 7074   fact_df, ["dept
-00002000: 5f66 6b22 5d2c 0a20 2064 696d 5f64 662c  _fk"],.  dim_df,
-00002010: 205b 2264 6570 745f 706b 225d 2c0a 2020   ["dept_pk"],.  
-00002020: 7361 6d70 6c65 5f62 726f 6b65 6e5f 7265  sample_broken_re
-00002030: 636f 7264 733d 320a 290a 0a3e 3e20 2b2d  cords=2.)..>> +-
-00002040: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  ---+-------+----
-00002050: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002060: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002070: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002080: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002090: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000020a0: 2b0a 3e3e 207c 4465 7074 7c43 6f75 6e74  +.>> |Dept|Count
-000020b0: 7279 7c73 616d 706c 655f 7265 636f 7264  ry|sample_record
-000020c0: 7320 2020 2020 2020 2020 2020 2020 2020  s               
-000020d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002100: 2020 2020 2020 207c 0a3e 3e20 2b2d 2d2d         |.>> +---
-00002110: 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  -+-------+------
-00002120: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002130: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002140: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002150: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002160: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a  --------------+.
-00002170: 3e3e 207c 4954 2020 7c55 5341 2020 2020  >> |IT  |USA    
-00002180: 7c5b 7b49 542c 2055 5341 2c20 416c 6963  |[{IT, USA, Alic
-00002190: 6531 2c20 efbf bdef bfbd 787a 3471 105f  e1, ......xz4q._
-000021a0: efbf bdef bfbd 115c 7261 efbf bd2d efbf  .......\ra...-..
-000021b0: bd16 efbf bd56 7a7d 2c20 7b49 542c 2055  .....Vz}, {IT, U
-000021c0: 5341 2c20 416c 6963 6532 2c20 efbf bdef  SA, Alice2, ....
-000021d0: bfbd 787a 3471 105f efbf bdef bfbd 115c  ..xz4q._.......\
-000021e0: 7261 efbf bd2d efbf bd16 efbf bd56 7a7d  ra...-.......Vz}
-000021f0: 5d7c 0a3e 3e20 2b2d 2d2d 2d2b 2d2d 2d2d  ]|.>> +----+----
-00002200: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
-00002210: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002220: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002230: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002240: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002250: 2d2d 2d2d 2d2d 2d2d 2b0a 6060 600a 0a23  --------+.```..#
-00002260: 2320 4765 7420 6c61 7465 7374 2072 6563  # Get latest rec
-00002270: 6f72 6473 200a 7769 7468 206f 7074 696f  ords .with optio
-00002280: 6e61 6c20 7072 696d 6172 7920 6b65 7920  nal primary key 
-00002290: 636f 6e66 6c69 6374 2072 6573 6f6c 7574  conflict resolut
-000022a0: 696f 6e2c 2077 6865 7265 2074 6865 7265  ion, where there
-000022b0: 2061 7265 206d 756c 7469 706c 6520 7265   are multiple re
-000022c0: 636f 7264 7320 6265 696e 6720 6361 6e64  cords being cand
-000022d0: 6964 6174 6520 666f 7220 6c61 7465 7374  idate for latest
-000022e0: 2072 6563 6f72 642c 2062 7574 2074 6865   record, but the
-000022f0: 7920 6861 7665 2064 6966 6665 7265 6e74  y have different
-00002300: 2061 7474 7269 6275 6574 7320 616e 6420   attribuets and 
-00002310: 7468 6572 6520 6973 206e 6f20 7761 7920  there is no way 
-00002320: 6f66 2064 6574 6572 6d69 6e69 6e67 2077  of determining w
-00002330: 6869 6368 206f 6e65 2069 7320 7468 6520  hich one is the 
-00002340: 6c61 7465 7374 2e0a 0a60 6060 7079 7468  latest...```pyth
-00002350: 6f6e 0a66 726f 6d20 6461 7465 7469 6d65  on.from datetime
-00002360: 2069 6d70 6f72 7420 6461 7465 7469 6d65   import datetime
-00002370: 2061 7320 6474 0a66 726f 6d20 6264 7120   as dt.from bdq 
-00002380: 696d 706f 7274 2067 6574 5f6c 6174 6573  import get_lates
-00002390: 745f 7265 636f 7264 732c 2067 6574 5f6c  t_records, get_l
-000023a0: 6174 6573 745f 7265 636f 7264 735f 7769  atest_records_wi
-000023b0: 7468 5f70 6b5f 636f 6e66 6963 745f 6465  th_pk_confict_de
-000023c0: 7465 6374 696f 6e5f 666c 6167 0a0a 696e  tection_flag..in
-000023d0: 6372 656d 656e 745f 6461 7461 203d 2020  crement_data =  
-000023e0: 5b0a 2020 2831 2c20 6474 2832 3030 302c  [.  (1, dt(2000,
-000023f0: 2031 2c20 312c 2030 2c20 302c 2030 292c   1, 1, 0, 0, 0),
-00002400: 2022 3130 3031 2229 0a20 202c 2831 2c20   "1001").  ,(1, 
-00002410: 6474 2832 3030 302c 2031 2c20 312c 2032  dt(2000, 1, 1, 2
-00002420: 2c20 302c 2030 292c 2022 3130 3032 2229  , 0, 0), "1002")
-00002430: 0a20 202c 2832 2c20 6474 2832 3030 302c  .  ,(2, dt(2000,
-00002440: 2031 2c20 312c 2030 2c20 302c 2030 292c   1, 1, 0, 0, 0),
-00002450: 2022 3230 3031 2229 2023 6361 7262 6f6e   "2001") #carbon
-00002460: 2063 6f70 7920 6475 706c 6963 6174 650a   copy duplicate.
-00002470: 2020 2c28 322c 2064 7428 3230 3030 2c20    ,(2, dt(2000, 
-00002480: 312c 2031 2c20 302c 2030 2c20 3029 2c20  1, 1, 0, 0, 0), 
-00002490: 2232 3030 3122 2920 2363 6172 626f 6e20  "2001") #carbon 
-000024a0: 636f 7079 2064 7570 6c69 6361 7465 0a20  copy duplicate. 
-000024b0: 202c 2833 2c20 6474 2832 3030 302c 2031   ,(3, dt(2000, 1
-000024c0: 2c20 312c 2030 2c20 302c 2030 292c 2022  , 1, 0, 0, 0), "
-000024d0: 3330 3031 2229 0a20 202c 2833 2c20 6474  3001").  ,(3, dt
-000024e0: 2832 3030 302c 2031 2c20 312c 2032 2c20  (2000, 1, 1, 2, 
-000024f0: 302c 2030 292c 2022 3330 3032 2331 2229  0, 0), "3002#1")
-00002500: 2023 706b 2063 6f6e 666c 6963 742c 2074   #pk conflict, t
-00002510: 776f 2065 6e74 7269 6573 2077 6974 6820  wo entries with 
-00002520: 7468 6520 7361 6d65 2074 6563 686e 6963  the same technic
-00002530: 616c 2066 6965 6c64 732c 2062 7574 2064  al fields, but d
-00002540: 6966 6665 7265 6e74 2061 7472 6962 7574  ifferent atribut
-00002550: 6573 2c20 7768 6963 6820 6f6e 6520 746f  es, which one to
-00002560: 2063 686f 7365 3f0a 2020 2c28 332c 2064   chose?.  ,(3, d
-00002570: 7428 3230 3030 2c20 312c 2031 2c20 322c  t(2000, 1, 1, 2,
-00002580: 2030 2c20 3029 2c20 2233 3030 3223 3222   0, 0), "3002#2"
-00002590: 2920 2370 6b20 636f 6e66 6c69 6374 0a5d  ) #pk conflict.]
-000025a0: 0a0a 6466 203d 2073 7061 726b 2e63 7265  ..df = spark.cre
-000025b0: 6174 6544 6174 6146 7261 6d65 2869 6e63  ateDataFrame(inc
-000025c0: 7265 6d65 6e74 5f64 6174 612c 2022 706b  rement_data, "pk
-000025d0: 3a69 6e74 2c63 6861 6e67 655f 7473 3a74  :int,change_ts:t
-000025e0: 696d 6573 7461 6d70 2c61 7474 723a 7374  imestamp,attr:st
-000025f0: 7269 6e67 2229 0a64 662e 7368 6f77 2874  ring").df.show(t
-00002600: 7275 6e63 6174 653d 5472 7565 290a 0a3e  runcate=True)..>
-00002610: 3e20 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  > +---+---------
-00002620: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
-00002630: 2d2b 0a3e 3e20 7c20 706b 7c20 2020 2020  -+.>> | pk|     
-00002640: 2020 2020 2063 6861 6e67 655f 7473 7c20       change_ts| 
-00002650: 2061 7474 727c 0a3e 3e20 2b2d 2d2d 2b2d   attr|.>> +---+-
+00000260: 2057 6861 7420 6973 2062 6471 3f0a 0a42   What is bdq?..B
+00000270: 4451 2073 7461 6e64 7320 666f 7220 4269  DQ stands for Bi
+00000280: 6720 4461 7461 2051 7561 6c69 7479 2c20  g Data Quality, 
+00000290: 6120 7365 7420 6f66 2074 6f6f 6c73 2f66  a set of tools/f
+000002a0: 756e 6374 696f 6e20 7468 6174 2068 656c  unction that hel
+000002b0: 7020 796f 7520 6576 6572 7920 6461 7920  p you every day 
+000002c0: 6173 7365 7274 2071 7561 6c69 7479 206f  assert quality o
+000002d0: 6620 6461 7461 7365 7473 2079 6f75 2068  f datasets you h
+000002e0: 6176 6520 7072 6f63 6573 7365 6420 6f72  ave processed or
+000002f0: 2069 6e67 6573 7465 642e 204c 6962 7261   ingested. Libra
+00000300: 7279 206c 6576 6572 6167 6573 2070 6f77  ry leverages pow
+00000310: 6572 206f 6620 7370 6172 6b2c 2068 656e  er of spark, hen
+00000320: 6365 2069 7420 7072 6f63 6573 7365 7320  ce it processes 
+00000330: 796f 7572 2071 7561 6c69 7479 2063 6865  your quality che
+00000340: 636b 7320 6174 2073 6361 6c65 206f 6666  cks at scale off
+00000350: 6572 6564 2062 7920 7370 6172 6b20 616e  ered by spark an
+00000360: 6420 6461 7461 6272 6963 6b73 2e0a 0a4c  d databricks...L
+00000370: 6962 7261 7279 206f 7665 7220 7469 6d65  ibrary over time
+00000380: 2065 766f 6c76 6564 2069 6e74 6f20 4441   evolved into DA
+00000390: 4720 6578 6563 7574 6f72 206f 6620 6172  G executor of ar
+000003a0: 6269 7472 6172 7920 7079 7468 6f6e 2f70  bitrary python/p
+000003b0: 7973 7061 726b 2066 756e 6374 696f 6e73  yspark functions
+000003c0: 2e20 5468 6973 2061 6c6c 6f77 7320 746f  . This allows to
+000003d0: 2073 6361 6c65 2065 7865 6375 7469 6f6e   scale execution
+000003e0: 2077 6974 6820 6465 7065 6e64 656e 6379   with dependency
+000003f0: 2074 7261 636b 696e 6720 746f 206e 6578   tracking to nex
+00000400: 7420 6c65 7665 6c2e 0a0a 2323 2048 6f77  t level...## How
+00000410: 2074 6f20 696e 7374 616c 6c3f 0a0a 4f6e   to install?..On
+00000420: 2064 6174 6162 7269 636b 7320 7275 6e20   databricks run 
+00000430: 6025 7069 7020 696e 7374 616c 6c20 6264  `%pip install bd
+00000440: 713d 3d78 2e79 2e7a 602e 204d 616b 6520  q==x.y.z`. Make 
+00000450: 7375 7265 2079 6f75 2074 6167 2076 6572  sure you tag ver
+00000460: 7369 6f6e 206e 756d 6265 7220 796f 7520  sion number you 
+00000470: 6172 6520 636f 6e66 6f72 7461 626c 6520  are confortable 
+00000480: 7769 7468 2074 6f20 656e 7375 7265 2041  with to ensure A
+00000490: 5049 2073 7461 6269 6c69 7479 2e0a 0a54  PI stability...T
+000004a0: 6869 7320 7061 636b 6167 6520 6973 2063  his package is c
+000004b0: 7572 7265 6e74 6c79 2069 6e20 4558 5045  urrently in EXPE
+000004c0: 5249 4d45 4e54 414c 2073 7461 6765 2061  RIMENTAL stage a
+000004d0: 6e64 206e 6577 6572 2072 656c 6573 6573  nd newer releses
+000004e0: 206d 6967 6874 2063 6861 6e67 6520 4150   might change AP
+000004f0: 4973 2028 6675 6e63 7469 6f6e 206e 616d  Is (function nam
+00000500: 6573 2c20 7061 7261 6d65 7465 7273 2c20  es, parameters, 
+00000510: 6574 632e 2e29 2e0a 0a23 2320 5375 7070  etc..)...## Supp
+00000520: 6f72 7465 6420 7370 6172 6b2f 6461 7461  orted spark/data
+00000530: 6272 6963 6b73 2076 6572 7369 6f6e 730a  bricks versions.
+00000540: 0a44 6576 656c 6f70 6d65 6e74 2061 6e64  .Development and
+00000550: 2074 6573 7469 6e67 2068 6173 2062 6565   testing has bee
+00000560: 6e20 7065 7266 6f72 6d65 6420 6f6e 2031  n performed on 1
+00000570: 322e 3220 4c54 5320 6461 7461 6272 6963  2.2 LTS databric
+00000580: 6b73 2072 756e 7469 6d65 2e20 4461 7461  ks runtime. Data
+00000590: 6272 6963 6b73 2072 756e 7469 6d65 2031  bricks runtime 1
+000005a0: 302e 3420 4c54 5320 7368 6f75 6c64 2061  0.4 LTS should a
+000005b0: 6c73 6f20 776f 726b 2077 6974 6820 6578  lso work with ex
+000005c0: 6365 7074 696f 6e20 6f66 2060 5370 6172  ception of `Spar
+000005d0: 6b50 6970 656c 696e 652e 7374 6570 5f73  kPipeline.step_s
+000005e0: 7061 726b 5f66 6f72 5f65 6163 685f 6261  park_for_each_ba
+000005f0: 7463 6860 2061 6e64 2060 5370 6172 6b50  tch` and `SparkP
+00000600: 6970 656c 696e 652e 7370 6172 6b5f 6d65  ipeline.spark_me
+00000610: 7472 6963 6020 7768 6963 6820 7265 7175  tric` which requ
+00000620: 6972 6520 3132 2e32 204c 5453 2072 756e  ire 12.2 LTS run
+00000630: 7469 6d65 2074 6f20 776f 726b 2e0a 0a23  time to work...#
+00000640: 2320 5665 7262 6f73 6520 6f75 7470 7574  # Verbose output
+00000650: 0a0a 6264 7120 7574 696c 697a 6573 2070  ..bdq utilizes p
+00000660: 7974 686f 6e20 606c 6f67 6769 6e67 6020  ython `logging` 
+00000670: 6d6f 6475 6c65 2c20 6865 6e63 6520 666f  module, hence fo
+00000680: 7220 7468 6520 6265 7374 206c 6f67 6769  r the best loggi
+00000690: 6e67 2065 7870 6572 6965 6e63 6520 636f  ng experience co
+000006a0: 6e66 6967 7572 6520 6c6f 6767 6572 2c20  nfigure logger, 
+000006b0: 6578 616d 706c 6520 7365 7475 703a 0a0a  example setup:..
+000006c0: 6060 6070 7974 686f 6e0a 696d 706f 7274  ```python.import
+000006d0: 206c 6f67 6769 6e67 0a69 6d70 6f72 7420   logging.import 
+000006e0: 7379 730a 0a23 2070 7934 6a20 6973 2076  sys..# py4j is v
+000006f0: 6572 7920 6368 6174 7479 2c20 6e6f 206e  ery chatty, no n
+00000700: 6565 6420 746f 2064 6561 6c20 7769 7468  eed to deal with
+00000710: 2069 7420 756e 6c65 7373 2069 7427 7320   it unless it's 
+00000720: 6372 6974 6963 616c 0a6c 6f67 6769 6e67  critical.logging
+00000730: 2e67 6574 4c6f 6767 6572 2827 7079 346a  .getLogger('py4j
+00000740: 2729 2e73 6574 4c65 7665 6c28 6c6f 6767  ').setLevel(logg
+00000750: 696e 672e 4352 4954 4943 414c 290a 0a23  ing.CRITICAL)..#
+00000760: 2072 756e 2065 7665 7279 7468 696e 6720   run everything 
+00000770: 656c 7365 206f 6e20 4445 4255 4720 6279  else on DEBUG by
+00000780: 2064 6566 6175 6c74 0a23 2044 4542 5547   default.# DEBUG
+00000790: 2070 7269 6e74 7320 6120 6c6f 7420 6f66   prints a lot of
+000007a0: 2075 7365 6675 6c6c 2069 6e66 6f2c 2049   usefull info, I
+000007b0: 4e46 4f20 6973 2067 6f6f 6420 696e 2067  NFO is good in g
+000007c0: 656e 6572 616c 2075 7365 2063 6173 6573  eneral use cases
+000007d0: 0a6c 6f67 6769 6e67 2e62 6173 6963 436f  .logging.basicCo
+000007e0: 6e66 6967 280a 2020 7374 7265 616d 3d73  nfig(.  stream=s
+000007f0: 7973 2e73 7464 6572 722c 0a20 206c 6576  ys.stderr,.  lev
+00000800: 656c 3d6c 6f67 6769 6e67 2e44 4542 5547  el=logging.DEBUG
+00000810: 2c20 0a20 2066 6f72 6d61 743d 2725 2861  , .  format='%(a
+00000820: 7363 7469 6d65 2973 2025 286c 6576 656c  sctime)s %(level
+00000830: 6e61 6d65 2973 2025 2874 6872 6561 644e  name)s %(threadN
+00000840: 616d 6529 7320 5b25 286e 616d 6529 735d  ame)s [%(name)s]
+00000850: 2025 286d 6573 7361 6765 2973 270a 290a   %(message)s'.).
+00000860: 6060 600a 0a23 2323 2045 7861 6d70 6c65  ```..### Example
+00000870: 730a 0a53 6565 2065 7861 6d70 6c65 7320  s..See examples 
+00000880: 6265 6c6c 6f77 2066 6f72 2073 686f 7274  bellow for short
+00000890: 206c 6973 7469 6e67 206f 6620 6d61 6a6f   listing of majo
+000008a0: 7220 6675 6e63 7469 6f6e 616c 6974 6965  r functionalitie
+000008b0: 732e 2053 6565 2060 7465 7374 7360 2066  s. See `tests` f
+000008c0: 6f6c 6465 7220 666f 7220 6465 7461 696c  older for detail
+000008d0: 6564 2065 7861 6d70 6c65 732e 2054 6573  ed examples. Tes
+000008e0: 7473 2061 7265 206d 6561 6e74 2074 6f20  ts are meant to 
+000008f0: 646f 7562 6c65 2061 7320 7265 616c 2075  double as real u
+00000900: 7365 2063 6173 6573 2068 656e 6365 2074  se cases hence t
+00000910: 6865 7920 7365 7276 6520 6173 2064 6f63  hey serve as doc
+00000920: 756d 656e 7461 7469 6f6e 206f 6620 6578  umentation of ex
+00000930: 616d 706c 6573 2066 6f72 206e 6f77 2e0a  amples for now..
+00000940: 0a23 2320 436f 6d70 6172 696e 6720 6461  .## Comparing da
+00000950: 7461 6672 616d 6520 7363 6865 6d61 730a  taframe schemas.
+00000960: 0a60 6060 7079 7468 6f6e 0a69 6d70 6f72  .```python.impor
+00000970: 7420 6264 710a 6672 6f6d 2064 6174 6574  t bdq.from datet
+00000980: 696d 6520 696d 706f 7274 2064 6174 6574  ime import datet
+00000990: 696d 650a 696d 706f 7274 2070 7973 7061  ime.import pyspa
+000009a0: 726b 2e73 716c 2e66 756e 6374 696f 6e73  rk.sql.functions
+000009b0: 2061 7320 460a 0a64 6632 203d 2073 7061   as F..df2 = spa
+000009c0: 726b 2e63 7265 6174 6544 6174 6146 7261  rk.createDataFra
+000009d0: 6d65 285b 0a5b 2031 2c20 312c 2022 4772  me([.[ 1, 1, "Gr
+000009e0: 7a65 676f 727a 222c 2064 6174 6574 696d  zegorz", datetim
+000009f0: 6528 3230 3138 2c20 312c 2031 292c 2064  e(2018, 1, 1), d
+00000a00: 6174 6574 696d 6528 3230 3138 2c20 312c  atetime(2018, 1,
+00000a10: 2031 2c20 3132 2c20 3334 2c20 3536 292c   1, 12, 34, 56),
+00000a20: 2032 362e 392c 2031 3233 3233 3432 3334   26.9, 123234234
+00000a30: 3334 352c 2054 7275 655d 2c0a 5b20 332c  345, True],.[ 3,
+00000a40: 2031 2c20 224d 696b 6522 2c20 2020 2020   1, "Mike",     
+00000a50: 6461 7465 7469 6d65 2832 3031 392c 2031  datetime(2019, 1
+00000a60: 2c20 3129 2c20 6461 7465 7469 6d65 2832  , 1), datetime(2
+00000a70: 3031 382c 2033 2c20 312c 2031 322c 2033  018, 3, 1, 12, 3
+00000a80: 342c 2035 3629 2c20 3436 2e37 2c20 3536  4, 56), 46.7, 56
+00000a90: 3637 3838 3839 3839 2c20 4661 6c73 655d  67888989, False]
+00000aa0: 2c0a 5b20 322c 2032 2c20 2254 696d 6d79  ,.[ 2, 2, "Timmy
+00000ab0: 222c 2020 2020 6461 7465 7469 6d65 2832  ",    datetime(2
+00000ac0: 3031 382c 2031 2c20 3129 2c20 6461 7465  018, 1, 1), date
+00000ad0: 7469 6d65 2832 3031 382c 2032 2c20 312c  time(2018, 2, 1,
+00000ae0: 2031 322c 2033 342c 2035 3629 2c20 3336   12, 34, 56), 36
+00000af0: 2e37 2c20 3837 3534 3835 3738 3435 2c20  .7, 8754857845, 
+00000b00: 5472 7565 5d0a 5d2c 2073 6368 656d 6129  True].], schema)
+00000b10: 0a0a 6466 325f 6368 616e 6765 6420 3d20  ..df2_changed = 
+00000b20: 6466 3220 5c0a 2020 2e64 726f 7028 2766  df2 \.  .drop('f
+00000b30: 6972 7374 5f6c 6f67 696e 5f64 7427 2920  irst_login_dt') 
+00000b40: 5c0a 2020 2e77 6974 6843 6f6c 756d 6e28  \.  .withColumn(
+00000b50: 276e 6577 5f64 6174 6127 2c20 462e 6c69  'new_data', F.li
+00000b60: 7428 4e6f 6e65 292e 6361 7374 2827 6461  t(None).cast('da
+00000b70: 7465 2729 2920 5c0a 2020 2e77 6974 6843  te')) \.  .withC
+00000b80: 6f6c 756d 6e28 276c 696b 6573 272c 2046  olumn('likes', F
+00000b90: 2e63 6f6c 2827 6c69 6b65 7327 292e 6361  .col('likes').ca
+00000ba0: 7374 2827 696e 7427 2929 0a0a 6173 7365  st('int'))..asse
+00000bb0: 7274 2062 6471 2e63 6f6d 7061 7265 5f73  rt bdq.compare_s
+00000bc0: 6368 656d 6173 2864 6632 2e73 6368 656d  chemas(df2.schem
+00000bd0: 612c 2064 6632 5f63 6861 6e67 6564 2e73  a, df2_changed.s
+00000be0: 6368 656d 6129 203d 3d20 7b0a 2020 2761  chema) == {.  'a
+00000bf0: 6464 6564 273a 207b 2766 6972 7374 5f6c  dded': {'first_l
+00000c00: 6f67 696e 5f64 7427 7d2c 200a 2020 2772  ogin_dt'}, .  'r
+00000c10: 656d 6f76 6564 273a 207b 276e 6577 5f64  emoved': {'new_d
+00000c20: 6174 6127 7d2c 200a 2020 2763 6861 6e67  ata'}, .  'chang
+00000c30: 6564 273a 207b 0a20 2020 2027 6c69 6b65  ed': {.    'like
+00000c40: 7327 3a20 7b27 6265 666f 7265 273a 2027  s': {'before': '
+00000c50: 6269 6769 6e74 272c 2027 6166 7465 7227  bigint', 'after'
+00000c60: 3a20 2769 6e74 277d 0a20 207d 2c0a 2020  : 'int'}.  },.  
+00000c70: 276e 6f74 5f63 6861 6e67 6564 273a 207b  'not_changed': {
+00000c80: 0a20 2020 2027 6e61 6d65 272c 2027 6964  .    'name', 'id
+00000c90: 3127 2c20 276c 6173 745f 6c6f 6769 6e5f  1', 'last_login_
+00000ca0: 7473 272c 2027 6964 3227 2c20 2763 7265  ts', 'id2', 'cre
+00000cb0: 6469 7473 272c 2027 6163 7469 7665 270a  dits', 'active'.
+00000cc0: 2020 7d0a 7d0a 6060 600a 0a23 2323 2043    }.}.```..### C
+00000cd0: 6f6d 7061 7269 6e67 2064 6174 6166 7261  omparing datafra
+00000ce0: 6d65 2773 2064 6174 610a 0a60 6060 7079  me's data..```py
+00000cf0: 7468 6f6e 0a69 6d70 6f72 7420 6264 710a  thon.import bdq.
+00000d00: 0a64 6631 203d 2073 7061 726b 2e63 7265  .df1 = spark.cre
+00000d10: 6174 6544 6174 6146 7261 6d65 285b 0a5b  ateDataFrame([.[
+00000d20: 2031 2c20 312c 2022 4772 7a65 676f 727a   1, 1, "Grzegorz
+00000d30: 222c 2064 6174 6574 696d 6528 3230 3137  ", datetime(2017
+00000d40: 2c20 312c 2031 292c 2064 6174 6574 696d  , 1, 1), datetim
+00000d50: 6528 3230 3138 2c20 312c 2031 2c20 3132  e(2018, 1, 1, 12
+00000d60: 2c20 3334 2c20 3536 292c 2032 362e 372c  , 34, 56), 26.7,
+00000d70: 2031 3233 3233 3432 3334 3334 352c 2054   123234234345, T
+00000d80: 7275 655d 2c0a 5b20 322c 2031 2c20 2254  rue],.[ 2, 1, "T
+00000d90: 696d 222c 2020 2020 2020 6461 7465 7469  im",      dateti
+00000da0: 6d65 2832 3031 382c 2031 2c20 3129 2c20  me(2018, 1, 1), 
+00000db0: 6461 7465 7469 6d65 2832 3031 382c 2032  datetime(2018, 2
+00000dc0: 2c20 312c 2031 322c 2033 342c 2035 3629  , 1, 12, 34, 56)
+00000dd0: 2c20 3336 2e37 2c20 3534 3534 352c 2020  , 36.7, 54545,  
+00000de0: 2020 2020 5472 7565 5d2c 0a5b 2033 2c20      True],.[ 3, 
+00000df0: 312c 2022 4d69 6b65 222c 2020 2020 2064  1, "Mike",     d
+00000e00: 6174 6574 696d 6528 3230 3139 2c20 312c  atetime(2019, 1,
+00000e10: 2031 292c 2064 6174 6574 696d 6528 3230   1), datetime(20
+00000e20: 3138 2c20 332c 2031 2c20 3132 2c20 3334  18, 3, 1, 12, 34
+00000e30: 2c20 3536 292c 2034 362e 372c 2035 3636  , 56), 46.7, 566
+00000e40: 3738 3838 3938 392c 2046 616c 7365 5d0a  7888989, False].
+00000e50: 5d2c 2073 6368 656d 6129 0a0a 6466 3220  ], schema)..df2 
+00000e60: 3d20 7370 6172 6b2e 6372 6561 7465 4461  = spark.createDa
+00000e70: 7461 4672 616d 6528 5b0a 5b20 312c 2031  taFrame([.[ 1, 1
+00000e80: 2c20 2247 727a 6567 6f72 7a22 2c20 6461  , "Grzegorz", da
+00000e90: 7465 7469 6d65 2832 3031 382c 2031 2c20  tetime(2018, 1, 
+00000ea0: 3129 2c20 6461 7465 7469 6d65 2832 3031  1), datetime(201
+00000eb0: 382c 2031 2c20 312c 2031 322c 2033 342c  8, 1, 1, 12, 34,
+00000ec0: 2035 3629 2c20 3236 2e39 2c20 3132 3332   56), 26.9, 1232
+00000ed0: 3334 3233 3433 3435 2c20 5472 7565 5d2c  34234345, True],
+00000ee0: 0a5b 2033 2c20 312c 2022 4d69 6b65 222c  .[ 3, 1, "Mike",
+00000ef0: 2020 2020 2064 6174 6574 696d 6528 3230       datetime(20
+00000f00: 3139 2c20 312c 2031 292c 2064 6174 6574  19, 1, 1), datet
+00000f10: 696d 6528 3230 3138 2c20 332c 2031 2c20  ime(2018, 3, 1, 
+00000f20: 3132 2c20 3334 2c20 3536 292c 2034 362e  12, 34, 56), 46.
+00000f30: 372c 2035 3636 3738 3838 3938 392c 2046  7, 5667888989, F
+00000f40: 616c 7365 5d2c 0a5b 2032 2c20 322c 2022  alse],.[ 2, 2, "
+00000f50: 5469 6d6d 7922 2c20 2020 2064 6174 6574  Timmy",    datet
+00000f60: 696d 6528 3230 3138 2c20 312c 2031 292c  ime(2018, 1, 1),
+00000f70: 2064 6174 6574 696d 6528 3230 3138 2c20   datetime(2018, 
+00000f80: 322c 2031 2c20 3132 2c20 3334 2c20 3536  2, 1, 12, 34, 56
+00000f90: 292c 2033 362e 372c 2038 3735 3438 3537  ), 36.7, 8754857
+00000fa0: 3834 352c 2054 7275 655d 0a5d 2c20 7363  845, True].], sc
+00000fb0: 6865 6d61 290a 0a23 7265 7475 726e 7320  hema)..#returns 
+00000fc0: 6469 6374 7320 7769 7468 2061 6464 6564  dicts with added
+00000fd0: 2c20 7265 6d6f 7665 642c 2063 6861 6e67  , removed, chang
+00000fe0: 6564 2061 6e64 206e 6f74 2063 6861 6e67  ed and not chang
+00000ff0: 6564 2064 6174 6166 7261 6d65 732c 2061  ed dataframes, a
+00001000: 6e64 2072 6563 6f72 6420 636f 756e 7473  nd record counts
+00001010: 0a64 665f 6469 6666 203d 2062 6471 2e63  .df_diff = bdq.c
+00001020: 6f6d 7061 7265 5f64 6174 6166 7261 6d65  ompare_dataframe
+00001030: 7328 6466 312c 2064 6632 2c20 5b27 6964  s(df1, df2, ['id
+00001040: 3127 2c20 2769 6432 275d 2c20 5472 7565  1', 'id2'], True
+00001050: 290a 0a23 7368 6f77 2061 6c6c 2069 6e66  )..#show all inf
+00001060: 6f20 6162 6f75 7420 636f 6d70 6172 6520  o about compare 
+00001070: 7265 7375 6c74 730a 6264 712e 6469 7370  results.bdq.disp
+00001080: 6c61 795f 636f 6d70 6172 655f 6461 7461  lay_compare_data
+00001090: 6672 616d 6573 5f72 6573 756c 7473 2864  frames_results(d
+000010a0: 665f 6469 6666 290a 0a3e 3e20 4164 6465  f_diff)..>> Adde
+000010b0: 6420 7265 636f 7264 7320 636f 756e 743a  d records count:
+000010c0: 2031 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d   1.>> +---+---+-
+000010d0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+000010e0: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+000010f0: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b  -------+-------+
+00001100: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00001110: 2d2b 0a3e 3e20 7c69 6431 7c69 6432 7c6e  -+.>> |id1|id2|n
+00001120: 616d 6520 7c66 6972 7374 5f6c 6f67 696e  ame |first_login
+00001130: 5f64 747c 6c61 7374 5f6c 6f67 696e 5f74  _dt|last_login_t
+00001140: 7320 2020 2020 207c 6372 6564 6974 737c  s      |credits|
+00001150: 6c69 6b65 7320 2020 2020 7c61 6374 6976  likes     |activ
+00001160: 657c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d  e|.>> +---+---+-
+00001170: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+00001180: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+00001190: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b  -------+-------+
+000011a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000011b0: 2d2b 0a3e 3e20 7c32 2020 7c32 2020 7c54  -+.>> |2  |2  |T
+000011c0: 696d 6d79 7c32 3031 382d 3031 2d30 3120  immy|2018-01-01 
+000011d0: 2020 207c 3230 3138 2d30 322d 3031 2031     |2018-02-01 1
+000011e0: 323a 3334 3a35 367c 3336 2e37 2020 207c  2:34:56|36.7   |
+000011f0: 3837 3534 3835 3738 3435 7c74 7275 6520  8754857845|true 
+00001200: 207c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d   |.>> +---+---+-
+00001210: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+00001220: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+00001230: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b  -------+-------+
+00001240: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00001250: 2d2b 0a3e 3e20 0a3e 3e20 5265 6d6f 7665  -+.>> .>> Remove
+00001260: 6420 7265 636f 7264 7320 636f 756e 743a  d records count:
+00001270: 2031 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d   1.>> +---+---+-
+00001280: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+00001290: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
+000012a0: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d  ------+-------+-
+000012b0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e 3e20  ----+------+.>> 
+000012c0: 7c69 6431 7c69 6432 7c6e 616d 657c 6669  |id1|id2|name|fi
+000012d0: 7273 745f 6c6f 6769 6e5f 6474 7c6c 6173  rst_login_dt|las
+000012e0: 745f 6c6f 6769 6e5f 7473 2020 2020 2020  t_login_ts      
+000012f0: 7c63 7265 6469 7473 7c6c 696b 6573 7c61  |credits|likes|a
+00001300: 6374 6976 657c 0a3e 3e20 2b2d 2d2d 2b2d  ctive|.>> +---+-
+00001310: 2d2d 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  --+----+--------
+00001320: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  ------+---------
+00001330: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00001340: 2d2d 2b2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b  --+-----+------+
+00001350: 0a3e 3e20 7c32 2020 7c31 2020 7c54 696d  .>> |2  |1  |Tim
+00001360: 207c 3230 3138 2d30 312d 3031 2020 2020   |2018-01-01    
+00001370: 7c32 3031 382d 3032 2d30 3120 3132 3a33  |2018-02-01 12:3
+00001380: 343a 3536 7c33 362e 3720 2020 7c35 3435  4:56|36.7   |545
+00001390: 3435 7c74 7275 6520 207c 0a3e 3e20 2b2d  45|true  |.>> +-
+000013a0: 2d2d 2b2d 2d2d 2b2d 2d2d 2d2b 2d2d 2d2d  --+---+----+----
+000013b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000013c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
+000013d0: 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2b2d 2d2d  ------+-----+---
+000013e0: 2d2d 2d2b 0a3e 3e20 0a3e 3e20 4368 616e  ---+.>> .>> Chan
+000013f0: 6765 6420 7265 636f 7264 7320 636f 756e  ged records coun
+00001400: 743a 2031 0a3e 3e20 2b2d 2d2d 2b2d 2d2d  t: 1.>> +---+---
+00001410: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---------------
+00001420: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001430: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001440: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001450: 2d2d 2d2d 2d2d 2b0a 3e3e 207c 6964 317c  ------+.>> |id1|
+00001460: 6964 327c 6368 616e 6765 6420 2020 2020  id2|changed     
+00001470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000014a0: 2020 2020 2020 2020 207c 0a3e 3e20 2b2d           |.>> +-
+000014b0: 2d2d 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  --+---+---------
+000014c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000014d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000014e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000014f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 3e3e  ------------+.>>
+00001500: 207c 3120 207c 3120 207c 7b66 6972 7374   |1  |1  |{first
+00001510: 5f6c 6f67 696e 5f64 7420 2d3e 207b 3230  _login_dt -> {20
+00001520: 3137 2d30 312d 3031 2c20 3230 3138 2d30  17-01-01, 2018-0
+00001530: 312d 3031 7d2c 2063 7265 6469 7473 202d  1-01}, credits -
+00001540: 3e20 7b32 362e 372c 2032 362e 397d 7d7c  > {26.7, 26.9}}|
+00001550: 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2b2d 2d2d  .>> +---+---+---
+00001560: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001570: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001580: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001590: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000015a0: 2d2d 2b0a 0a4e 6f74 2063 6861 6e67 6564  --+..Not changed
+000015b0: 2072 6563 6f72 6473 2063 6f75 6e74 3a20   records count: 
+000015c0: 310a 6060 600a 0a23 2323 2053 7572 726f  1.```..### Surro
+000015d0: 6761 7465 206b 6579 2067 656e 6572 6174  gate key generat
+000015e0: 696f 6e0a 0a77 6974 6820 7375 7070 6f72  ion..with suppor
+000015f0: 7420 6f66 206f 7074 696f 6e61 6c20 7570  t of optional up
+00001600: 7065 7263 6173 696e 6720 616e 6420 7472  percasing and tr
+00001610: 696d 6d69 6e67 206f 6620 6b65 7920 636f  imming of key co
+00001620: 6c75 6d6e 730a 0a60 6060 7079 7468 6f6e  lumns..```python
+00001630: 0a66 726f 6d20 6461 7465 7469 6d65 2069  .from datetime i
+00001640: 6d70 6f72 7420 6461 7465 7469 6d65 0a66  mport datetime.f
+00001650: 726f 6d20 6264 712e 6675 6e63 7469 6f6e  rom bdq.function
+00001660: 7320 696d 706f 7274 2073 7572 726f 6761  s import surroga
+00001670: 7465 5f6b 6579 5f68 6173 682c 2073 7572  te_key_hash, sur
+00001680: 726f 6761 7465 5f6b 6579 5f73 7472 696e  rogate_key_strin
+00001690: 670a 0a73 6368 656d 6120 3d20 2269 6431  g..schema = "id1
+000016a0: 3a6c 6f6e 672c 6964 323a 6c6f 6e67 2c6e  :long,id2:long,n
+000016b0: 616d 653a 7374 7269 6e67 2c6c 696b 6573  ame:string,likes
+000016c0: 3a69 6e74 220a 0a64 6631 203d 2073 7061  :int"..df1 = spa
+000016d0: 726b 2e63 7265 6174 6544 6174 6146 7261  rk.createDataFra
+000016e0: 6d65 285b 0a20 205b 2031 2c20 312c 2022  me([.  [ 1, 1, "
+000016f0: 4772 7a65 476f 727a 222c 2031 205d 2c0a  GrzeGorz", 1 ],.
+00001700: 2020 5b20 312c 2031 2c20 2247 727a 6567    [ 1, 1, "Grzeg
+00001710: 6f72 7a22 2c20 2031 205d 2c0a 2020 5b20  orz",  1 ],.  [ 
+00001720: 312c 2031 2c20 2247 727a 6567 6f72 7a20  1, 1, "Grzegorz 
+00001730: 2020 2020 2022 2c20 2031 205d 2c0a 2020       ",  1 ],.  
+00001740: 5b20 312c 204e 6f6e 652c 2022 4772 7a65  [ 1, None, "Grze
+00001750: 676f 727a 222c 2031 5d2c 0a20 205b 2031  gorz", 1],.  [ 1
+00001760: 2c20 4e6f 6e65 2c20 4e6f 6e65 2c20 315d  , None, None, 1]
+00001770: 2c0a 2020 5b20 322c 2031 2c20 2254 696d  ,.  [ 2, 1, "Tim
+00001780: 222c 2031 205d 2c0a 2020 5b20 332c 2031  ", 1 ],.  [ 3, 1
+00001790: 2c20 224d 696b 6522 2c20 3120 5d0a 5d2c  , "Mike", 1 ].],
+000017a0: 2073 6368 656d 6129 0a0a 736b 5f64 6620   schema)..sk_df 
+000017b0: 3d20 6466 312e 7365 6c65 6374 280a 2020  = df1.select(.  
+000017c0: 272a 272c 200a 2020 7375 7272 6f67 6174  '*', .  surrogat
+000017d0: 655f 6b65 795f 6861 7368 285b 2769 6431  e_key_hash(['id1
+000017e0: 272c 2027 6964 3227 2c20 276e 616d 6527  ', 'id2', 'name'
+000017f0: 5d2c 2072 7472 696d 3d54 7275 6529 2e61  ], rtrim=True).a
+00001800: 6c69 6173 2827 6861 7368 2729 2c0a 2020  lias('hash'),.  
+00001810: 7375 7272 6f67 6174 655f 6b65 795f 7374  surrogate_key_st
+00001820: 7269 6e67 285b 2769 6431 272c 2027 6964  ring(['id1', 'id
+00001830: 3227 2c20 276e 616d 6527 5d2c 2072 7472  2', 'name'], rtr
+00001840: 696d 3d54 7275 6529 2e61 6c69 6173 2827  im=True).alias('
+00001850: 6861 7368 5f69 6e70 7574 2729 0a29 0a0a  hash_input').)..
+00001860: 3e3e 202b 2d2d 2d2b 2d2d 2d2d 2b2d 2d2d  >> +---+----+---
+00001870: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00001880: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
+00001890: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000018a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000018b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+000018c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000018d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e 3e20  -----------+.>> 
+000018e0: 7c69 6431 7c69 6432 207c 6e61 6d65 2020  |id1|id2 |name  
+000018f0: 2020 2020 2020 2020 7c6c 696b 6573 7c68          |likes|h
+00001900: 6173 6820 2020 2020 2020 2020 2020 2020  ash             
+00001910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001930: 2020 2020 2020 2020 2020 2020 7c68 6173              |has
+00001940: 685f 696e 7075 7420 2020 2020 2020 2020  h_input         
+00001950: 2020 2020 2020 2020 7c0a 3e3e 202b 2d2d          |.>> +--
+00001960: 2d2b 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  -+----+---------
+00001970: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2b 2d2d 2d2d  -----+-----+----
+00001980: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001990: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000019a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000019b0: 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  ---------+------
+000019c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000019d0: 2d2d 2d2d 2d2b 0a3e 3e20 7c31 2020 7c31  -----+.>> |1  |1
+000019e0: 2020 207c 4772 7a65 476f 727a 2020 2020     |GrzeGorz    
+000019f0: 2020 7c31 2020 2020 7c5b 3646 2032 3120    |1    |[6F 21 
+00001a00: 3939 2039 3920 3443 2046 3220 3933 2035  99 99 4C F2 93 5
+00001a10: 3620 3245 2037 4320 4333 2032 3920 4639  6 2E 7C C3 29 F9
+00001a20: 2036 4120 3432 2032 4620 3644 2036 3220   6A 42 2F 6D 62 
+00001a30: 4543 2034 425d 7c5b 312c 2031 2c20 4752  EC 4B]|[1, 1, GR
+00001a40: 5a45 474f 525a 5d20 2020 2020 2020 2020  ZEGORZ]         
+00001a50: 2020 7c0a 3e3e 207c 3120 207c 3120 2020    |.>> |1  |1   
+00001a60: 7c47 727a 6567 6f72 7a20 2020 2020 207c  |Grzegorz      |
+00001a70: 3120 2020 207c 5b36 4620 3231 2039 3920  1    |[6F 21 99 
+00001a80: 3939 2034 4320 4632 2039 3320 3536 2032  99 4C F2 93 56 2
+00001a90: 4520 3743 2043 3320 3239 2046 3920 3641  E 7C C3 29 F9 6A
+00001aa0: 2034 3220 3246 2036 4420 3632 2045 4320   42 2F 6D 62 EC 
+00001ab0: 3442 5d7c 5b31 2c20 312c 2047 525a 4547  4B]|[1, 1, GRZEG
+00001ac0: 4f52 5a5d 2020 2020 2020 2020 2020 207c  ORZ]           |
+00001ad0: 0a3e 3e20 7c31 2020 7c31 2020 207c 4772  .>> |1  |1   |Gr
+00001ae0: 7a65 676f 727a 2020 2020 2020 7c31 2020  zegorz      |1  
+00001af0: 2020 7c5b 3646 2032 3120 3939 2039 3920    |[6F 21 99 99 
+00001b00: 3443 2046 3220 3933 2035 3620 3245 2037  4C F2 93 56 2E 7
+00001b10: 4320 4333 2032 3920 4639 2036 4120 3432  C C3 29 F9 6A 42
+00001b20: 2032 4620 3644 2036 3220 4543 2034 425d   2F 6D 62 EC 4B]
+00001b30: 7c5b 312c 2031 2c20 4752 5a45 474f 525a  |[1, 1, GRZEGORZ
+00001b40: 5d20 2020 2020 2020 2020 2020 7c0a 3e3e  ]           |.>>
+00001b50: 207c 3120 207c 6e75 6c6c 7c47 727a 6567   |1  |null|Grzeg
+00001b60: 6f72 7a20 2020 2020 207c 3120 2020 207c  orz      |1    |
+00001b70: 5b34 4520 3945 2033 4120 3242 2043 3820  [4E 9E 3A 2B C8 
+00001b80: 3337 2039 3020 4130 2036 4120 3236 2039  37 90 A0 6A 26 9
+00001b90: 4120 4645 2037 4120 3738 2038 4220 4341  A FE 7A 78 8B CA
+00001ba0: 2039 3920 3334 2036 3820 3143 5d7c 5b31   99 34 68 1C]|[1
+00001bb0: 2c20 407e 3c6e 756c 6c3e 7e40 2c20 4752  , @~<null>~@, GR
+00001bc0: 5a45 474f 525a 5d20 207c 0a3e 3e20 7c31  ZEGORZ]  |.>> |1
+00001bd0: 2020 7c6e 756c 6c7c 6e75 6c6c 2020 2020    |null|null    
+00001be0: 2020 2020 2020 7c31 2020 2020 7c5b 3434        |1    |[44
+00001bf0: 2046 4620 3838 2032 4520 3241 2032 3820   FF 88 2E 2A 28 
+00001c00: 3342 2045 4520 4545 2035 3320 4338 2037  3B EE EE 53 C8 7
+00001c10: 4420 3046 2039 3220 4431 2036 3820 3345  D 0F 92 D1 68 3E
+00001c20: 2041 3220 4632 2045 355d 7c5b 312c 2040   A2 F2 E5]|[1, @
+00001c30: 7e3c 6e75 6c6c 3e7e 402c 2040 7e3c 6e75  ~<null>~@, @~<nu
+00001c40: 6c6c 3e7e 405d 7c0a 3e3e 207c 3220 207c  ll>~@]|.>> |2  |
+00001c50: 3120 2020 7c54 696d 2020 2020 2020 2020  1   |Tim        
+00001c60: 2020 207c 3120 2020 207c 5b41 3820 3741     |1    |[A8 7A
+00001c70: 2042 3020 3239 2039 3420 3946 2035 4320   B0 29 94 9F 5C 
+00001c80: 4431 2037 3820 4434 2032 3820 3839 2038  D1 78 D4 28 89 8
+00001c90: 4220 4631 2037 3520 4344 2041 4320 3730  B F1 75 CD AC 70
+00001ca0: 2042 3620 3631 5d7c 5b32 2c20 312c 2054   B6 61]|[2, 1, T
+00001cb0: 494d 5d20 2020 2020 2020 2020 2020 2020  IM]             
+00001cc0: 2020 207c 0a3e 3e20 7c33 2020 7c31 2020     |.>> |3  |1  
+00001cd0: 207c 4d69 6b65 2020 2020 2020 2020 2020   |Mike          
+00001ce0: 7c31 2020 2020 7c5b 3944 2036 4320 3736  |1    |[9D 6C 76
+00001cf0: 2043 3520 3137 2044 3020 3434 2034 3620   C5 17 D0 44 46 
+00001d00: 3437 2031 4120 3731 2045 4420 3441 2030  47 1A 71 ED 4A 0
+00001d10: 3820 3735 2038 3420 3144 2035 4320 3435  8 75 84 1D 5C 45
+00001d20: 2030 395d 7c5b 332c 2031 2c20 4d49 4b45   09]|[3, 1, MIKE
+00001d30: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
+00001d40: 7c0a 3e3e 202b 2d2d 2d2b 2d2d 2d2d 2b2d  |.>> +---+----+-
+00001d50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00001d60: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+00001d70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001d80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001d90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001da0: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
+00001db0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a60  -------------+.`
+00001dc0: 6060 0a0a 2323 2320 504b 2026 2046 4b20  ``..### PK & FK 
+00001dd0: 696e 7465 7267 7269 7479 2063 6865 636b  intergrity check
+00001de0: 730a 0a77 6974 6820 7375 7070 6f72 7420  s..with support 
+00001df0: 6f66 2073 686f 7769 6e67 2073 616d 706c  of showing sampl
+00001e00: 6520 6461 7461 2066 726f 6d20 6661 6374  e data from fact
+00001e10: 2074 6162 6c65 2074 6861 7420 6469 6420   table that did 
+00001e20: 6e6f 7420 7361 7469 7366 7920 696e 7465  not satisfy inte
+00001e30: 6772 6974 790a 0a60 6060 7079 7468 6f6e  grity..```python
+00001e40: 0a66 726f 6d20 6264 7120 696d 706f 7274  .from bdq import
+00001e50: 2066 6163 745f 6469 6d5f 6272 6f6b 656e   fact_dim_broken
+00001e60: 5f72 656c 6174 696f 6e73 6869 700a 6672  _relationship.fr
+00001e70: 6f6d 2062 6471 2e66 756e 6374 696f 6e73  om bdq.functions
+00001e80: 2069 6d70 6f72 7420 7375 7272 6f67 6174   import surrogat
+00001e90: 655f 6b65 795f 6861 7368 2c20 7375 7272  e_key_hash, surr
+00001ea0: 6f67 6174 655f 6b65 795f 7374 7269 6e67  ogate_key_string
+00001eb0: 0a0a 6661 6374 5f64 6620 3d20 7370 6172  ..fact_df = spar
+00001ec0: 6b2e 6372 6561 7465 4461 7461 4672 616d  k.createDataFram
+00001ed0: 6528 5b0a 2020 2020 5b20 2247 727a 6567  e([.    [ "Grzeg
+00001ee0: 6f72 7a22 2c20 2249 5422 2c20 2245 5522  orz", "IT", "EU"
+00001ef0: 205d 2c0a 2020 2020 5b20 224d 6172 6b22   ],.    [ "Mark"
+00001f00: 2c20 2249 5422 2c20 2245 5522 205d 2c0a  , "IT", "EU" ],.
+00001f10: 2020 2020 5b20 224a 7573 7469 6e22 2c20      [ "Justin", 
+00001f20: 2249 5420 2022 2c20 2245 5520 2020 2022  "IT  ", "EU    "
+00001f30: 205d 2c0a 2020 2020 5b20 2241 6c69 6365   ],.    [ "Alice
+00001f40: 3122 2c20 2249 5422 2c20 2255 5341 2220  1", "IT", "USA" 
+00001f50: 5d2c 0a20 2020 205b 2022 416c 6963 6532  ],.    [ "Alice2
+00001f60: 222c 2022 4954 222c 2022 5553 4122 205d  ", "IT", "USA" ]
+00001f70: 2c0a 2020 2020 5b20 2241 6c69 6365 3322  ,.    [ "Alice3"
+00001f80: 2c20 2249 5422 2c20 2255 5341 2220 5d2c  , "IT", "USA" ],
+00001f90: 0a20 2020 205b 2022 416c 6963 6534 222c  .    [ "Alice4",
+00001fa0: 2022 4954 222c 2022 5553 4122 205d 2c0a   "IT", "USA" ],.
+00001fb0: 2020 2020 5b20 2241 6c69 6365 3522 2c20      [ "Alice5", 
+00001fc0: 2249 5422 2c20 2255 5341 2220 5d2c 0a20  "IT", "USA" ],. 
+00001fd0: 2020 205b 2022 426f 6222 2c20 2253 616c     [ "Bob", "Sal
+00001fe0: 6573 222c 2022 5553 4122 205d 2c0a 2020  es", "USA" ],.  
+00001ff0: 2020 5b20 2242 6f62 3222 2c20 2253 616c    [ "Bob2", "Sal
+00002000: 6573 222c 2022 5553 4122 205d 2c0a 2020  es", "USA" ],.  
+00002010: 2020 5b20 2242 6f62 3322 2c20 2253 616c    [ "Bob3", "Sal
+00002020: 6573 222c 2022 5553 4122 205d 0a20 205d  es", "USA" ].  ]
+00002030: 2c20 224e 616d 653a 7374 7269 6e67 2c44  , "Name:string,D
+00002040: 6570 743a 7374 7269 6e67 2c43 6f75 6e74  ept:string,Count
+00002050: 7279 3a73 7472 696e 6722 2920 5c0a 2020  ry:string") \.  
+00002060: 2e77 6974 6843 6f6c 756d 6e28 2264 6570  .withColumn("dep
+00002070: 745f 666b 222c 2073 7572 726f 6761 7465  t_fk", surrogate
+00002080: 5f6b 6579 5f68 6173 6828 5b22 4465 7074  _key_hash(["Dept
+00002090: 222c 2022 436f 756e 7472 7922 5d2c 2072  ", "Country"], r
+000020a0: 7472 696d 3d54 7275 6529 290a 0a64 696d  trim=True))..dim
+000020b0: 5f64 6620 3d20 7370 6172 6b2e 6372 6561  _df = spark.crea
+000020c0: 7465 4461 7461 4672 616d 6528 5b0a 2020  teDataFrame([.  
+000020d0: 2020 5b22 4954 222c 2022 4555 222c 2022    ["IT", "EU", "
+000020e0: 4575 726f 7065 616e 2049 5420 6465 7061  European IT depa
+000020f0: 7274 6d65 6e74 225d 2c0a 2020 2020 5b22  rtment"],.    ["
+00002100: 5361 6c65 7322 2c20 2255 5341 222c 2022  Sales", "USA", "
+00002110: 5553 4120 5361 6c65 7320 6465 7074 2e22  USA Sales dept."
+00002120: 5d0a 2020 5d2c 2022 6465 7061 7274 6d65  ].  ], "departme
+00002130: 6e74 3a73 7472 696e 672c 636e 7472 793a  nt:string,cntry:
+00002140: 7374 7269 6e67 2c63 6f6d 6d65 6e74 3a73  string,comment:s
+00002150: 7472 696e 6722 2920 5c0a 2020 2e77 6974  tring") \.  .wit
+00002160: 6843 6f6c 756d 6e28 2264 6570 745f 706b  hColumn("dept_pk
+00002170: 222c 2073 7572 726f 6761 7465 5f6b 6579  ", surrogate_key
+00002180: 5f68 6173 6828 5b22 6465 7061 7274 6d65  _hash(["departme
+00002190: 6e74 222c 2022 636e 7472 7922 5d2c 2072  nt", "cntry"], r
+000021a0: 7472 696d 3d54 7275 6529 290a 0a23 6469  trim=True))..#di
+000021b0: 7265 6374 2063 6f6c 756d 6e20 636f 6d70  rect column comp
+000021c0: 6172 6973 6f6e 2c20 6865 6e63 6520 7570  arison, hence up
+000021d0: 7065 722c 206c 6f77 6572 2c20 6578 7472  per, lower, extr
+000021e0: 6120 7370 6163 6573 2061 6666 6563 7420  a spaces affect 
+000021f0: 7468 6520 7265 7375 6c74 730a 6272 6f6b  the results.brok
+00002200: 656e 5f64 6620 3d20 6661 6374 5f64 696d  en_df = fact_dim
+00002210: 5f62 726f 6b65 6e5f 7265 6c61 7469 6f6e  _broken_relation
+00002220: 7368 6970 280a 2020 6661 6374 5f64 663d  ship(.  fact_df=
+00002230: 6661 6374 5f64 662c 0a20 2066 6b5f 636f  fact_df,.  fk_co
+00002240: 6c75 6d6e 733d 5b22 4465 7074 222c 2022  lumns=["Dept", "
+00002250: 436f 756e 7472 7922 5d2c 0a20 2064 696d  Country"],.  dim
+00002260: 5f64 663d 6469 6d5f 6466 2c0a 2020 706b  _df=dim_df,.  pk
+00002270: 5f63 6f6c 756d 6e73 3d5b 2264 6570 6172  _columns=["depar
+00002280: 746d 656e 7422 2c20 2263 6e74 7279 225d  tment", "cntry"]
+00002290: 2c0a 2020 7361 6d70 6c65 5f62 726f 6b65  ,.  sample_broke
+000022a0: 6e5f 7265 636f 7264 733d 320a 290a 0a3e  n_records=2.)..>
+000022b0: 3e20 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b  > +----+-------+
+000022c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000022d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000022e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000022f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002300: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002310: 2d2d 2d2d 2b0a 3e3e 207c 4465 7074 7c43  ----+.>> |Dept|C
+00002320: 6f75 6e74 7279 7c73 616d 706c 655f 7265  ountry|sample_re
+00002330: 636f 7264 7320 2020 2020 2020 2020 2020  cords           
+00002340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002370: 2020 2020 2020 2020 2020 207c 0a3e 3e20             |.>> 
+00002380: 2b2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2b 2d2d  +----+-------+--
+00002390: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000023e0: 2d2d 2b0a 3e3e 207c 4954 2020 7c55 5341  --+.>> |IT  |USA
+000023f0: 2020 2020 7c5b 7b49 542c 2055 5341 2c20      |[{IT, USA, 
+00002400: 416c 6963 6531 2c20 efbf bdef bfbd 787a  Alice1, ......xz
+00002410: 3471 105f efbf bdef bfbd 115c 7261 efbf  4q._.......\ra..
+00002420: bd2d efbf bd16 efbf bd56 7a7d 2c20 7b49  .-.......Vz}, {I
+00002430: 542c 2055 5341 2c20 416c 6963 6532 2c20  T, USA, Alice2, 
+00002440: efbf bdef bfbd 787a 3471 105f efbf bdef  ......xz4q._....
+00002450: bfbd 115c 7261 efbf bd2d efbf bd16 efbf  ...\ra...-......
+00002460: bd56 7a7d 5d7c 0a3e 3e20 7c49 5420 207c  .Vz}]|.>> |IT  |
+00002470: 4555 2020 2020 207c 5b7b 4954 2020 2c20  EU     |[{IT  , 
+00002480: 4555 2020 2020 2c20 4a75 7374 696e 2c20  EU    , Justin, 
+00002490: efbf bdef bfbd 4827 5634 efbf bd5c 7259  ......H'V4...\rY
+000024a0: 2c67 efbf bd49 efbf bdef bfbd 12ef bfbd  ,g...I..........
+000024b0: efbf bdef bfbd 7d5d 2020 2020 2020 2020  ......}]        
+000024c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000024d0: 2020 2020 2020 2020 2020 2020 2020 7c0a                |.
+000024e0: 3e3e 202b 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  >> +----+-------
+000024f0: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---------------
+00002500: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002510: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002520: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002530: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002540: 2d2d 2d2d 2d2b 0a0a 2320 7573 696e 6720  -----+..# using 
+00002550: 7375 7272 6f67 6174 6520 6b65 7973 2077  surrogate keys w
+00002560: 696c 6c20 7969 656c 6420 6265 7474 6572  ill yield better
+00002570: 2072 6573 756c 7473 2c20 6265 6361 7573   results, becaus
+00002580: 6520 6578 7472 6120 7370 6163 6573 2061  e extra spaces a
+00002590: 7265 2074 7269 6d6d 6564 0a62 726f 6b65  re trimmed.broke
+000025a0: 6e5f 736b 5f64 6620 3d20 6661 6374 5f64  n_sk_df = fact_d
+000025b0: 696d 5f62 726f 6b65 6e5f 7265 6c61 7469  im_broken_relati
+000025c0: 6f6e 7368 6970 280a 2020 6661 6374 5f64  onship(.  fact_d
+000025d0: 662c 205b 2264 6570 745f 666b 225d 2c0a  f, ["dept_fk"],.
+000025e0: 2020 6469 6d5f 6466 2c20 5b22 6465 7074    dim_df, ["dept
+000025f0: 5f70 6b22 5d2c 0a20 2073 616d 706c 655f  _pk"],.  sample_
+00002600: 6272 6f6b 656e 5f72 6563 6f72 6473 3d32  broken_records=2
+00002610: 0a29 0a0a 3e3e 202b 2d2d 2d2d 2b2d 2d2d  .)..>> +----+---
+00002620: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----+-----------
+00002630: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002640: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002650: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
 00002660: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002670: 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e 3e20 7c20  --+------+.>> | 
-00002680: 2031 7c32 3030 302d 3031 2d30 3120 3030   1|2000-01-01 00
-00002690: 3a30 303a 3030 7c20 2031 3030 317c 0a3e  :00:00|  1001|.>
-000026a0: 3e20 7c20 2031 7c32 3030 302d 3031 2d30  > |  1|2000-01-0
-000026b0: 3120 3032 3a30 303a 3030 7c20 2031 3030  1 02:00:00|  100
-000026c0: 327c 0a3e 3e20 7c20 2032 7c32 3030 302d  2|.>> |  2|2000-
-000026d0: 3031 2d30 3120 3030 3a30 303a 3030 7c20  01-01 00:00:00| 
-000026e0: 2032 3030 317c 0a3e 3e20 7c20 2032 7c32   2001|.>> |  2|2
-000026f0: 3030 302d 3031 2d30 3120 3030 3a30 303a  000-01-01 00:00:
-00002700: 3030 7c20 2032 3030 317c 0a3e 3e20 7c20  00|  2001|.>> | 
-00002710: 2033 7c32 3030 302d 3031 2d30 3120 3030   3|2000-01-01 00
-00002720: 3a30 303a 3030 7c20 2033 3030 317c 0a3e  :00:00|  3001|.>
-00002730: 3e20 7c20 2033 7c32 3030 302d 3031 2d30  > |  3|2000-01-0
-00002740: 3120 3032 3a30 303a 3030 7c33 3030 3223  1 02:00:00|3002#
-00002750: 317c 0a3e 3e20 7c20 2033 7c32 3030 302d  1|.>> |  3|2000-
-00002760: 3031 2d30 3120 3032 3a30 303a 3030 7c33  01-01 02:00:00|3
-00002770: 3030 3223 327c 0a3e 3e20 2b2d 2d2d 2b2d  002#2|.>> +---+-
-00002780: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002790: 2d2d 2b2d 2d2d 2d2d 2d2b 0a0a 7072 696d  --+------+..prim
-000027a0: 6172 795f 6b65 795f 636f 6c75 6d6e 7320  ary_key_columns 
-000027b0: 3d20 5b27 706b 275d 0a6f 7264 6572 5f62  = ['pk'].order_b
-000027c0: 795f 636f 6c75 6d6e 7320 3d20 5b27 6368  y_columns = ['ch
-000027d0: 616e 6765 5f74 7327 5d0a 0a23 2077 696c  ange_ts']..# wil
-000027e0: 6c20 7261 6e64 6f6d 6c79 2063 686f 7365  l randomly chose
-000027f0: 206f 6e65 2070 6b20 696e 2063 6173 6520   one pk in case 
-00002800: 6f66 2063 6f6e 666c 6963 742c 2077 6974  of conflict, wit
-00002810: 686f 7574 2061 6e79 206e 6f74 6966 6963  hout any notific
-00002820: 6174 696f 6e20 6162 6f75 7420 636f 6e66  ation about conf
-00002830: 6c69 6374 730a 7369 6d70 6c65 5f67 6574  licts.simple_get
-00002840: 5f6c 6174 6573 745f 6466 203d 2067 6574  _latest_df = get
-00002850: 5f6c 6174 6573 745f 7265 636f 7264 7328  _latest_records(
-00002860: 6466 2c20 7072 696d 6172 795f 6b65 795f  df, primary_key_
-00002870: 636f 6c75 6d6e 732c 206f 7264 6572 5f62  columns, order_b
-00002880: 795f 636f 6c75 6d6e 7329 0a73 696d 706c  y_columns).simpl
-00002890: 655f 6765 745f 6c61 7465 7374 5f64 662e  e_get_latest_df.
-000028a0: 7368 6f77 2874 7275 6e63 6174 653d 5472  show(truncate=Tr
-000028b0: 7565 290a 0a3e 3e20 2b2d 2d2d 2b2d 2d2d  ue)..>> +---+---
-000028c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000028d0: 2b2d 2d2d 2d2d 2d2b 0a3e 3e20 7c20 706b  +------+.>> | pk
-000028e0: 7c20 2020 2020 2020 2020 2063 6861 6e67  |          chang
-000028f0: 655f 7473 7c20 2061 7474 727c 0a3e 3e20  e_ts|  attr|.>> 
-00002900: 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---+-----------
-00002910: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b  --------+------+
-00002920: 0a3e 3e20 7c20 2031 7c32 3030 302d 3031  .>> |  1|2000-01
-00002930: 2d30 3120 3032 3a30 303a 3030 7c20 2031  -01 02:00:00|  1
-00002940: 3030 327c 0a3e 3e20 7c20 2032 7c32 3030  002|.>> |  2|200
-00002950: 302d 3031 2d30 3120 3030 3a30 303a 3030  0-01-01 00:00:00
-00002960: 7c20 2032 3030 317c 0a3e 3e20 7c20 2033  |  2001|.>> |  3
-00002970: 7c32 3030 302d 3031 2d30 3120 3032 3a30  |2000-01-01 02:0
-00002980: 303a 3030 7c33 3030 3223 317c 0a3e 3e20  0:00|3002#1|.>> 
-00002990: 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---+-----------
-000029a0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b  --------+------+
-000029b0: 0a0a 2320 7769 6c6c 2066 6c61 6720 7265  ..# will flag re
-000029c0: 636f 7264 7320 7768 6963 6820 6361 7573  cords which caus
-000029d0: 6520 636f 6e66 6c69 6374 7320 616e 6420  e conflicts and 
-000029e0: 6361 6e6e 6f74 2062 6520 7265 736f 6c76  cannot be resolv
-000029f0: 6564 0a23 2062 6164 2072 6563 6f72 6473  ed.# bad records
-00002a00: 206e 6565 6420 746f 2062 6520 7175 6172   need to be quar
-00002a10: 616e 7469 6e65 6420 616e 6420 6861 6e64  antined and hand
-00002a20: 6c65 6420 696e 2073 7065 6369 616c 2070  led in special p
-00002a30: 726f 6365 7373 0a63 6f6e 666c 6963 745f  rocess.conflict_
-00002a40: 6765 745f 6c61 7465 7374 5f64 6620 3d20  get_latest_df = 
-00002a50: 6765 745f 6c61 7465 7374 5f72 6563 6f72  get_latest_recor
-00002a60: 6473 5f77 6974 685f 706b 5f63 6f6e 6669  ds_with_pk_confi
-00002a70: 6374 5f64 6574 6563 7469 6f6e 5f66 6c61  ct_detection_fla
-00002a80: 6728 6466 2c20 7072 696d 6172 795f 6b65  g(df, primary_ke
-00002a90: 795f 636f 6c75 6d6e 732c 206f 7264 6572  y_columns, order
-00002aa0: 5f62 795f 636f 6c75 6d6e 7329 0a63 6f6e  _by_columns).con
-00002ab0: 666c 6963 745f 6765 745f 6c61 7465 7374  flict_get_latest
-00002ac0: 5f64 662e 7368 6f77 2874 7275 6e63 6174  _df.show(truncat
-00002ad0: 653d 5472 7565 290a 0a3e 3e20 2b2d 2d2d  e=True)..>> +---
-00002ae0: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---------------
-00002af0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b 2d2d 2d2d  ----+------+----
-00002b00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e  -------------+.>
-00002b10: 3e20 7c20 706b 7c20 2020 2020 2020 2020  > | pk|         
-00002b20: 2063 6861 6e67 655f 7473 7c20 2061 7474   change_ts|  att
-00002b30: 727c 5f5f 6861 735f 706b 5f63 6f6e 666c  r|__has_pk_confl
-00002b40: 6963 747c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d  ict|.>> +---+---
-00002b50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00002b60: 2b2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  +------+--------
-00002b70: 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c20  ---------+.>> | 
-00002b80: 2031 7c32 3030 302d 3031 2d30 3120 3032   1|2000-01-01 02
-00002b90: 3a30 303a 3030 7c20 2031 3030 327c 2020  :00:00|  1002|  
-00002ba0: 2020 2020 2020 2020 2020 6661 6c73 657c            false|
-00002bb0: 0a3e 3e20 7c20 2032 7c32 3030 302d 3031  .>> |  2|2000-01
-00002bc0: 2d30 3120 3030 3a30 303a 3030 7c20 2032  -01 00:00:00|  2
-00002bd0: 3030 317c 2020 2020 2020 2020 2020 2020  001|            
-00002be0: 6661 6c73 657c 0a3e 3e20 7c20 2033 7c32  false|.>> |  3|2
-00002bf0: 3030 302d 3031 2d30 3120 3032 3a30 303a  000-01-01 02:00:
-00002c00: 3030 7c33 3030 3223 327c 2020 2020 2020  00|3002#2|      
-00002c10: 2020 2020 2020 2074 7275 657c 0a3e 3e20         true|.>> 
-00002c20: 7c20 2033 7c32 3030 302d 3031 2d30 3120  |  3|2000-01-01 
-00002c30: 3032 3a30 303a 3030 7c33 3030 3223 317c  02:00:00|3002#1|
-00002c40: 2020 2020 2020 2020 2020 2020 2074 7275               tru
-00002c50: 657c 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2d  e|.>> +---+-----
-00002c60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
-00002c70: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
-00002c80: 2d2d 2d2d 2d2d 2d2b 0a0a 6060 600a 0a23  -------+..```..#
-00002c90: 2320 4669 6e64 2063 6f6d 706f 7369 7465  # Find composite
-00002ca0: 2070 7269 6d61 7279 206b 6579 2063 616e   primary key can
-00002cb0: 6469 6461 7465 730a 4769 7665 6e20 6c69  didates.Given li
-00002cc0: 7374 206f 6620 706f 7373 6962 6c65 2063  st of possible c
-00002cd0: 6f6c 756d 6e73 2c20 636f 6e73 7472 7563  olumns, construc
-00002ce0: 7473 2074 6865 206c 6973 7473 206f 6620  ts the lists of 
-00002cf0: 616c 6c20 706f 7373 6962 6c65 2063 6f6d  all possible com
-00002d00: 6269 6e61 7469 6f6e 7320 6f66 2063 6f6d  binations of com
-00002d10: 706f 7369 7465 2070 7269 6d61 7279 206b  posite primary k
-00002d20: 6579 732c 2061 6e64 2065 7865 6375 7465  eys, and execute
-00002d30: 7320 636f 6e63 7572 7265 6e74 6c79 2074  s concurrently t
-00002d40: 6f20 6465 7465 726d 696e 6520 6966 2067  o determine if g
-00002d50: 6976 656e 2073 6574 206f 6620 636f 6c75  iven set of colu
-00002d60: 6d6e 7320 6973 2061 2076 616c 6964 2070  mns is a valid p
-00002d70: 7269 6d61 7279 206b 6579 2e20 5573 6573  rimary key. Uses
-00002d80: 206d 696e 696d 756d 2070 6f73 7369 626c   minimum possibl
-00002d90: 6520 616d 6f75 6e74 206f 6620 7175 6572  e amount of quer
-00002da0: 6965 7320 6167 6169 6e73 7420 7370 6172  ies against spar
-00002db0: 6b20 6279 2073 6b69 7070 696e 6720 7661  k by skipping va
-00002dc0: 6c69 6461 7469 6f6e 2070 6174 6873 2074  lidation paths t
-00002dd0: 6861 7420 6172 6520 6261 7365 6420 6f6e  hat are based on
-00002de0: 2061 6c72 6561 6479 2076 616c 6964 6174   already validat
-00002df0: 6564 2070 7269 6d61 7279 206b 6579 2063  ed primary key c
-00002e00: 6f6d 6269 6e61 7469 6f6e 732e 0a0a 6060  ombinations...``
-00002e10: 6070 7974 686f 6e0a 696d 706f 7274 2062  `python.import b
-00002e20: 6471 0a69 6d70 6f72 7420 7079 7370 6172  dq.import pyspar
-00002e30: 6b2e 7371 6c2e 6675 6e63 7469 6f6e 7320  k.sql.functions 
-00002e40: 6173 2046 0a0a 6466 203d 2073 7061 726b  as F..df = spark
-00002e50: 2e72 616e 6765 2830 2c20 3130 3029 205c  .range(0, 100) \
-00002e60: 0a20 202e 7769 7468 436f 6c75 6d6e 2827  .  .withColumn('
-00002e70: 7479 7065 272c 2046 2e65 7870 7228 2728  type', F.expr('(
-00002e80: 6964 202f 2031 3029 3a3a 696e 7420 2b20  id / 10)::int + 
-00002e90: 3127 2929 205c 0a20 202e 7769 7468 436f  1')) \.  .withCo
-00002ea0: 6c75 6d6e 2827 7265 6d69 6e64 6572 272c  lumn('reminder',
-00002eb0: 2046 2e65 7870 7228 2769 6420 2520 3130   F.expr('id % 10
-00002ec0: 2729 2920 5c0a 2020 2e77 6974 6843 6f6c  ')) \.  .withCol
-00002ed0: 756d 6e28 2773 7461 7469 6327 2c20 462e  umn('static', F.
-00002ee0: 6c69 7428 2741 2729 2920 5c0a 2020 2e77  lit('A')) \.  .w
-00002ef0: 6974 6843 6f6c 756d 6e28 2772 6f75 6e64  ithColumn('round
-00002f00: 5f72 6f62 696e 272c 2046 2e65 7870 7228  _robin', F.expr(
-00002f10: 2769 6420 2520 3227 2929 0a0a 6469 7370  'id % 2'))..disp
-00002f20: 6c61 7928 6466 290a 0a61 6c6c 5f63 6f6d  lay(df)..all_com
-00002f30: 6269 6e61 7469 6f6e 7320 3d20 6c69 7374  binations = list
-00002f40: 2862 6471 2e67 6574 5f63 6f6c 756d 6e5f  (bdq.get_column_
-00002f50: 6e61 6d65 735f 636f 6d62 696e 6174 696f  names_combinatio
-00002f60: 6e73 2864 662e 636f 6c75 6d6e 7329 290a  ns(df.columns)).
-00002f70: 0a62 6471 2e76 616c 6964 6174 655f 7072  .bdq.validate_pr
-00002f80: 696d 6172 795f 6b65 795f 6361 6e64 6964  imary_key_candid
-00002f90: 6174 655f 636f 6d62 696e 6174 696f 6e73  ate_combinations
-00002fa0: 2864 662c 2061 6c6c 5f63 6f6d 6269 6e61  (df, all_combina
-00002fb0: 7469 6f6e 732c 206d 6178 5f77 6f72 6b65  tions, max_worke
-00002fc0: 7273 3d31 302c 2076 6572 626f 7365 3d54  rs=10, verbose=T
-00002fd0: 7275 6529 0a3e 3e20 5b28 2769 6427 2c29  rue).>> [('id',)
-00002fe0: 2c20 2827 7479 7065 272c 2027 7265 6d69  , ('type', 'remi
-00002ff0: 6e64 6572 2729 5d0a 6060 600a 0a23 2320  nder')].```..## 
-00003000: 4578 6563 7574 6520 4441 4720 6861 7669  Execute DAG havi
-00003010: 6e67 206e 6f64 6573 2061 7320 7079 7468  ng nodes as pyth
-00003020: 6f6e 2066 756e 6374 696f 6e73 0a60 6060  on functions.```
-00003030: 7079 7468 6f6e 0a69 6d70 6f72 7420 6264  python.import bd
-00003040: 710a 696d 706f 7274 2074 696d 650a 696d  q.import time.im
-00003050: 706f 7274 2070 7974 6573 740a 0a23 6372  port pytest..#cr
-00003060: 6561 7465 2067 7261 7068 0a67 7261 7068  eate graph.graph
-00003070: 203d 2062 6471 2e44 4147 2829 0a0a 2364   = bdq.DAG()..#d
-00003080: 6566 696e 6520 6e6f 6465 730a 4067 7261  efine nodes.@gra
-00003090: 7068 2e6e 6f64 6528 290a 6465 6620 6128  ph.node().def a(
-000030a0: 293a 0a20 2074 696d 652e 736c 6565 7028  ):.  time.sleep(
-000030b0: 3229 0a20 2072 6574 7572 6e20 350a 0a40  2).  return 5..@
-000030c0: 6772 6170 682e 6e6f 6465 2829 0a64 6566  graph.node().def
-000030d0: 2062 2829 3a0a 2020 7469 6d65 2e73 6c65   b():.  time.sle
-000030e0: 6570 2833 290a 2020 7265 7475 726e 2022  ep(3).  return "
-000030f0: 6265 6565 7022 0a0a 236e 6f64 6573 2063  beeep"..#nodes c
-00003100: 616e 2064 6570 656e 6420 6f6e 206f 7468  an depend on oth
-00003110: 6572 206e 6f64 6573 0a40 6772 6170 682e  er nodes.@graph.
-00003120: 6e6f 6465 2864 6570 656e 6473 5f6f 6e3d  node(depends_on=
-00003130: 5b62 5d29 0a64 6566 2063 2829 3a0a 2020  [b]).def c():.  
-00003140: 7469 6d65 2e73 6c65 6570 2835 290a 2020  time.sleep(5).  
-00003150: 7265 7475 726e 2038 0a0a 2361 6e79 2061  return 8..#any a
-00003160: 6d6f 756e 7420 6f66 2064 6570 656e 6465  mount of depende
-00003170: 6e63 6965 7320 6973 2061 6c6c 6f77 6564  ncies is allowed
-00003180: 0a40 6772 6170 682e 6e6f 6465 2864 6570  .@graph.node(dep
-00003190: 656e 6473 5f6f 6e3d 5b62 2c20 632c 2061  ends_on=[b, c, a
-000031a0: 5d29 0a64 6566 2064 2829 3a0a 2020 7469  ]).def d():.  ti
-000031b0: 6d65 2e73 6c65 6570 2837 290a 2020 2362  me.sleep(7).  #b
-000031c0: 6565 7020 6173 206d 616e 7920 7469 6d65  eep as many time
-000031d0: 7320 6173 2061 6273 6f6c 7574 6520 6469  s as absolute di
-000031e0: 6666 6572 656e 6365 2062 6574 7765 656e  fference between
-000031f0: 2027 6327 2061 6e64 2027 6127 0a20 2072   'c' and 'a'.  r
-00003200: 6574 7572 6e20 2267 206d 616e 2073 6179  eturn "g man say
-00003210: 3a20 2220 2b20 622e 7265 7375 6c74 202a  : " + b.result *
-00003220: 2061 6273 2863 2e72 6573 756c 7420 2d20   abs(c.result - 
-00003230: 612e 7265 7375 6c74 290a 0a40 6772 6170  a.result)..@grap
-00003240: 682e 6e6f 6465 2864 6570 656e 6473 5f6f  h.node(depends_o
-00003250: 6e3d 5b61 5d29 0a64 6566 2065 2829 3a0a  n=[a]).def e():.
-00003260: 2020 7469 6d65 2e73 6c65 6570 2833 290a    time.sleep(3).
-00003270: 2020 2379 6f75 2063 616e 2072 6566 6572    #you can refer
-00003280: 2074 6f20 7061 7265 6e74 206e 6f64 6573   to parent nodes
-00003290: 2c20 746f 2067 6574 2069 6e66 6f72 6d61  , to get informa
-000032a0: 7469 6f6e 2061 626f 7574 2074 6865 6972  tion about their
-000032b0: 2072 6573 756c 7473 0a20 2072 6169 7365   results.  raise
-000032c0: 2056 616c 7565 4572 726f 7228 6622 6f6d   ValueError(f"om
-000032d0: 672c 2063 7261 7368 2120 7b61 2e72 6573  g, crash! {a.res
-000032e0: 756c 747d 2229 0a0a 4067 7261 7068 2e6e  ult}")..@graph.n
-000032f0: 6f64 6528 6465 7065 6e64 735f 6f6e 3d5b  ode(depends_on=[
-00003300: 655d 290a 6465 6620 6628 293a 0a20 2070  e]).def f():.  p
-00003310: 7269 6e74 2822 7468 6973 2077 696c 6c20  rint("this will 
-00003320: 6e65 7665 7220 6578 6563 7574 6522 290a  never execute").
-00003330: 2020 7265 7475 726e 2022 7468 6973 2077    return "this w
-00003340: 696c 6c20 6e65 7665 7220 6578 6563 7574  ill never execut
-00003350: 6522 0a0a 4067 7261 7068 2e6e 6f64 6528  e"..@graph.node(
-00003360: 6465 7065 6e64 735f 6f6e 3d5b 615d 290a  depends_on=[a]).
-00003370: 6465 6620 6728 293a 0a20 2074 696d 652e  def g():.  time.
-00003380: 736c 6565 7028 3329 0a20 2023 7765 2064  sleep(3).  #we d
-00003390: 6f20 6e6f 7420 7761 6e74 2074 6f20 6578  o not want to ex
-000033a0: 6563 7574 6520 6368 696c 6472 656e 206e  ecute children n
-000033b0: 6f64 6573 2061 6e79 6d6f 7265 0a20 2023  odes anymore.  #
-000033c0: 7265 7475 726e 2067 7261 7068 2e42 5245  return graph.BRE
-000033d0: 414b 2074 6869 7320 7769 6c6c 2063 6175  AK this will cau
-000033e0: 7365 2074 6861 7420 616c 6c20 6368 696c  se that all chil
-000033f0: 6472 656e 2f73 7563 6365 7373 6f72 7320  dren/successors 
-00003400: 696e 2067 7261 7068 2077 696c 6c20 6265  in graph will be
-00003410: 2073 6b69 7070 6564 2077 6974 686f 7574   skipped without
-00003420: 2065 7272 726f 720a 2020 7265 7475 726e   errror.  return
-00003430: 2067 7261 7068 2e42 5245 414b 0a0a 4067   graph.BREAK..@g
-00003440: 7261 7068 2e6e 6f64 6528 6465 7065 6e64  raph.node(depend
-00003450: 735f 6f6e 3d5b 675d 290a 6465 6620 6928  s_on=[g]).def i(
-00003460: 293a 0a20 2070 7269 6e74 2822 7468 6973  ):.  print("this
-00003470: 2077 696c 6c20 6e65 7665 7220 6578 6563   will never exec
-00003480: 7574 6520 746f 6f22 290a 2020 7265 7475  ute too").  retu
-00003490: 726e 2022 7468 6973 2077 696c 6c20 6e65  rn "this will ne
-000034a0: 7665 7220 6578 6563 7574 6520 746f 6f22  ver execute too"
-000034b0: 0a0a 2320 6966 2079 6f75 2068 6176 6520  ..# if you have 
-000034c0: 6970 7964 6167 7265 6433 2069 6e73 7461  ipydagred3 insta
-000034d0: 6c6c 6564 2c20 796f 7520 6361 6e20 7365  lled, you can se
-000034e0: 6520 696e 2072 6561 6c20 7469 6d65 2073  e in real time s
-000034f0: 7461 7465 2063 6861 6e67 6573 206f 6620  tate changes of 
-00003500: 6561 6368 206f 6620 7468 6520 6e6f 6465  each of the node
-00003510: 730a 6469 7370 6c61 7928 6772 6170 682e  s.display(graph.
-00003520: 7669 7375 616c 697a 6528 2929 0a0a 2365  visualize())..#e
-00003530: 7865 6375 7465 2044 4147 0a67 7261 7068  xecute DAG.graph
-00003540: 2e65 7865 6375 7465 286d 6178 5f77 6f72  .execute(max_wor
-00003550: 6b65 7273 3d31 3029 0a0a 2369 7465 7261  kers=10)..#itera
-00003560: 7465 206f 7665 7220 7265 7375 6c74 730a  te over results.
-00003570: 7072 696e 7428 2249 7465 7261 7465 206f  print("Iterate o
-00003580: 7665 7220 7265 7375 6c74 732e 2e2e 2229  ver results...")
-00003590: 0a66 6f72 206e 6f64 6520 696e 2067 7261  .for node in gra
-000035a0: 7068 2e6e 6f64 6573 3a0a 2020 7072 696e  ph.nodes:.  prin
-000035b0: 7428 6e6f 6465 290a 0a3e 3e20 5761 6974  t(node)..>> Wait
-000035c0: 696e 6720 666f 7220 616c 6c20 7461 736b  ing for all task
-000035d0: 7320 746f 2066 696e 6973 682e 2e2e 0a3e  s to finish....>
-000035e0: 3e20 2020 7374 6172 7469 6e67 3a20 4e6f  >   starting: No
-000035f0: 6465 283c 6675 6e63 7469 6f6e 2061 2061  de(<function a a
-00003600: 7420 3078 3766 3530 6634 6239 6565 3530  t 0x7f50f4b9ee50
-00003610: 3e3a 207b 2773 7461 7465 273a 2027 5255  >: {'state': 'RU
-00003620: 4e4e 494e 4727 2c20 2772 6573 756c 7427  NNING', 'result'
-00003630: 3a20 4e6f 6e65 2c20 2765 7863 6570 7469  : None, 'excepti
-00003640: 6f6e 273a 204e 6f6e 652c 2027 636f 6d70  on': None, 'comp
-00003650: 6c65 7465 6427 3a20 4661 6c73 657d 2029  leted': False} )
-00003660: 0a3e 3e20 2020 7374 6172 7469 6e67 3a20  .>>   starting: 
-00003670: 4e6f 6465 283c 6675 6e63 7469 6f6e 2062  Node(<function b
-00003680: 2061 7420 3078 3766 3530 6634 6235 3330   at 0x7f50f4b530
-00003690: 3430 3e3a 207b 2773 7461 7465 273a 2027  40>: {'state': '
-000036a0: 5255 4e4e 494e 4727 2c20 2772 6573 756c  RUNNING', 'resul
-000036b0: 7427 3a20 4e6f 6e65 2c20 2765 7863 6570  t': None, 'excep
-000036c0: 7469 6f6e 273a 204e 6f6e 652c 2027 636f  tion': None, 'co
-000036d0: 6d70 6c65 7465 6427 3a20 4661 6c73 657d  mpleted': False}
-000036e0: 2029 0a3e 3e20 2020 7374 6172 7469 6e67   ).>>   starting
-000036f0: 3a20 4e6f 6465 283c 6675 6e63 7469 6f6e  : Node(<function
-00003700: 2065 2061 7420 3078 3766 3530 6634 6235   e at 0x7f50f4b5
-00003710: 3362 3830 3e3a 207b 2773 7461 7465 273a  3b80>: {'state':
-00003720: 2027 5255 4e4e 494e 4727 2c20 2772 6573   'RUNNING', 'res
-00003730: 756c 7427 3a20 4e6f 6e65 2c20 2765 7863  ult': None, 'exc
-00003740: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
-00003750: 636f 6d70 6c65 7465 6427 3a20 4661 6c73  completed': Fals
-00003760: 657d 2029 0a3e 3e20 2020 7374 6172 7469  e} ).>>   starti
-00003770: 6e67 3a20 4e6f 6465 283c 6675 6e63 7469  ng: Node(<functi
-00003780: 6f6e 2067 2061 7420 3078 3766 3530 6634  on g at 0x7f50f4
-00003790: 6235 3335 6530 3e3a 207b 2773 7461 7465  b535e0>: {'state
-000037a0: 273a 2027 5255 4e4e 494e 4727 2c20 2772  ': 'RUNNING', 'r
-000037b0: 6573 756c 7427 3a20 4e6f 6e65 2c20 2765  esult': None, 'e
-000037c0: 7863 6570 7469 6f6e 273a 204e 6f6e 652c  xception': None,
-000037d0: 2027 636f 6d70 6c65 7465 6427 3a20 4661   'completed': Fa
-000037e0: 6c73 657d 2029 0a3e 3e20 2020 6669 6e69  lse} ).>>   fini
-000037f0: 7368 6564 3a20 4e6f 6465 283c 6675 6e63  shed: Node(<func
-00003800: 7469 6f6e 2061 2061 7420 3078 3766 3530  tion a at 0x7f50
-00003810: 6634 6239 6565 3530 3e3a 207b 2773 7461  f4b9ee50>: {'sta
-00003820: 7465 273a 2027 5355 4343 4553 5327 2c20  te': 'SUCCESS', 
-00003830: 2772 6573 756c 7427 3a20 352c 2027 6578  'result': 5, 'ex
-00003840: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
-00003850: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
-00003860: 657d 2029 2028 7374 696c 6c20 7275 6e6e  e} ) (still runn
-00003870: 696e 673a 2033 290a 3e3e 2020 2073 7461  ing: 3).>>   sta
-00003880: 7274 696e 673a 204e 6f64 6528 3c66 756e  rting: Node(<fun
-00003890: 6374 696f 6e20 6320 6174 2030 7837 6635  ction c at 0x7f5
-000038a0: 3066 3462 3533 3463 303e 3a20 7b27 7374  0f4b534c0>: {'st
-000038b0: 6174 6527 3a20 2752 554e 4e49 4e47 272c  ate': 'RUNNING',
-000038c0: 2027 7265 7375 6c74 273a 204e 6f6e 652c   'result': None,
-000038d0: 2027 6578 6365 7074 696f 6e27 3a20 4e6f   'exception': No
-000038e0: 6e65 2c20 2763 6f6d 706c 6574 6564 273a  ne, 'completed':
-000038f0: 2046 616c 7365 7d20 290a 3e3e 2020 2066   False} ).>>   f
-00003900: 696e 6973 6865 643a 204e 6f64 6528 3c66  inished: Node(<f
-00003910: 756e 6374 696f 6e20 6220 6174 2030 7837  unction b at 0x7
-00003920: 6635 3066 3462 3533 3034 303e 3a20 7b27  f50f4b53040>: {'
-00003930: 7374 6174 6527 3a20 2753 5543 4345 5353  state': 'SUCCESS
-00003940: 272c 2027 7265 7375 6c74 273a 2027 6265  ', 'result': 'be
-00003950: 6565 7027 2c20 2765 7863 6570 7469 6f6e  eep', 'exception
-00003960: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
-00003970: 7465 6427 3a20 5472 7565 7d20 2920 2873  ted': True} ) (s
-00003980: 7469 6c6c 2072 756e 6e69 6e67 3a20 3329  till running: 3)
-00003990: 0a3e 3e20 2020 6572 726f 723a 204e 6f64  .>>   error: Nod
-000039a0: 6528 3c66 756e 6374 696f 6e20 6520 6174  e(<function e at
-000039b0: 2030 7837 6635 3066 3462 3533 6238 303e   0x7f50f4b53b80>
-000039c0: 3a20 7b27 7374 6174 6527 3a20 2745 5252  : {'state': 'ERR
-000039d0: 4f52 272c 2027 7265 7375 6c74 273a 204e  OR', 'result': N
-000039e0: 6f6e 652c 2027 6578 6365 7074 696f 6e27  one, 'exception'
-000039f0: 3a20 5661 6c75 6545 7272 6f72 2827 6f6d  : ValueError('om
-00003a00: 672c 2063 7261 7368 2120 3527 292c 2027  g, crash! 5'), '
-00003a10: 636f 6d70 6c65 7465 6427 3a20 5472 7565  completed': True
-00003a20: 7d20 293a 206f 6d67 2c20 6372 6173 6821  } ): omg, crash!
-00003a30: 2035 2028 7374 696c 6c20 7275 6e6e 696e   5 (still runnin
-00003a40: 673a 2032 290a 3e3e 2020 2066 696e 6973  g: 2).>>   finis
-00003a50: 6865 643a 204e 6f64 6528 3c66 756e 6374  hed: Node(<funct
-00003a60: 696f 6e20 6720 6174 2030 7837 6635 3066  ion g at 0x7f50f
-00003a70: 3462 3533 3565 303e 3a20 7b27 7374 6174  4b535e0>: {'stat
-00003a80: 6527 3a20 2753 4b49 5050 4544 272c 2027  e': 'SKIPPED', '
-00003a90: 7265 7375 6c74 273a 203c 7468 7265 6164  result': <thread
-00003aa0: 696e 672e 4576 656e 7420 6f62 6a65 6374  ing.Event object
-00003ab0: 2061 7420 3078 3766 3530 6563 3136 6339   at 0x7f50ec16c9
-00003ac0: 6430 3e2c 2027 6578 6365 7074 696f 6e27  d0>, 'exception'
-00003ad0: 3a20 4e6f 6e65 2c20 2763 6f6d 706c 6574  : None, 'complet
-00003ae0: 6564 273a 2054 7275 657d 2029 2028 7374  ed': True} ) (st
-00003af0: 696c 6c20 7275 6e6e 696e 673a 2031 290a  ill running: 1).
-00003b00: 3e3e 2020 2073 7461 7274 696e 673a 204e  >>   starting: N
-00003b10: 6f64 6528 3c66 756e 6374 696f 6e20 6420  ode(<function d 
-00003b20: 6174 2030 7837 6635 3066 3462 3533 6136  at 0x7f50f4b53a6
-00003b30: 303e 3a20 7b27 7374 6174 6527 3a20 2752  0>: {'state': 'R
-00003b40: 554e 4e49 4e47 272c 2027 7265 7375 6c74  UNNING', 'result
-00003b50: 273a 204e 6f6e 652c 2027 6578 6365 7074  ': None, 'except
-00003b60: 696f 6e27 3a20 4e6f 6e65 2c20 2763 6f6d  ion': None, 'com
-00003b70: 706c 6574 6564 273a 2046 616c 7365 7d20  pleted': False} 
-00003b80: 290a 3e3e 2020 2066 696e 6973 6865 643a  ).>>   finished:
-00003b90: 204e 6f64 6528 3c66 756e 6374 696f 6e20   Node(<function 
-00003ba0: 6320 6174 2030 7837 6635 3066 3462 3533  c at 0x7f50f4b53
-00003bb0: 3463 303e 3a20 7b27 7374 6174 6527 3a20  4c0>: {'state': 
-00003bc0: 2753 5543 4345 5353 272c 2027 7265 7375  'SUCCESS', 'resu
-00003bd0: 6c74 273a 2038 2c20 2765 7863 6570 7469  lt': 8, 'excepti
-00003be0: 6f6e 273a 204e 6f6e 652c 2027 636f 6d70  on': None, 'comp
-00003bf0: 6c65 7465 6427 3a20 5472 7565 7d20 2920  leted': True} ) 
-00003c00: 2873 7469 6c6c 2072 756e 6e69 6e67 3a20  (still running: 
-00003c10: 3129 0a3e 3e20 2020 6669 6e69 7368 6564  1).>>   finished
-00003c20: 3a20 4e6f 6465 283c 6675 6e63 7469 6f6e  : Node(<function
-00003c30: 2064 2061 7420 3078 3766 3530 6634 6235   d at 0x7f50f4b5
-00003c40: 3361 3630 3e3a 207b 2773 7461 7465 273a  3a60>: {'state':
-00003c50: 2027 5355 4343 4553 5327 2c20 2772 6573   'SUCCESS', 'res
-00003c60: 756c 7427 3a20 2767 206d 616e 2073 6179  ult': 'g man say
-00003c70: 3a20 6265 6565 7062 6565 6570 6265 6565  : beeepbeeepbeee
-00003c80: 7027 2c20 2765 7863 6570 7469 6f6e 273a  p', 'exception':
-00003c90: 204e 6f6e 652c 2027 636f 6d70 6c65 7465   None, 'complete
-00003ca0: 6427 3a20 5472 7565 7d20 2920 2873 7469  d': True} ) (sti
-00003cb0: 6c6c 2072 756e 6e69 6e67 3a20 3029 0a3e  ll running: 0).>
-00003cc0: 3e20 416c 6c20 7461 736b 7320 6669 6e69  > All tasks fini
-00003cd0: 7368 6564 2c20 7368 7574 7469 6e67 2064  shed, shutting d
-00003ce0: 6f77 6e0a 3e3e 0a3e 3e20 4974 6572 6174  own.>>.>> Iterat
-00003cf0: 6520 6f76 6572 2072 6573 756c 7473 2e2e  e over results..
-00003d00: 2e0a 3e3e 204e 6f64 6528 3c66 756e 6374  ..>> Node(<funct
-00003d10: 696f 6e20 6120 6174 2030 7837 6635 3066  ion a at 0x7f50f
-00003d20: 3462 3965 6535 303e 3a20 7b27 7374 6174  4b9ee50>: {'stat
-00003d30: 6527 3a20 2753 5543 4345 5353 272c 2027  e': 'SUCCESS', '
-00003d40: 7265 7375 6c74 273a 2035 2c20 2765 7863  result': 5, 'exc
-00003d50: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
-00003d60: 636f 6d70 6c65 7465 6427 3a20 5472 7565  completed': True
-00003d70: 7d20 290a 3e3e 204e 6f64 6528 3c66 756e  } ).>> Node(<fun
-00003d80: 6374 696f 6e20 6220 6174 2030 7837 6635  ction b at 0x7f5
-00003d90: 3066 3462 3533 3034 303e 3a20 7b27 7374  0f4b53040>: {'st
-00003da0: 6174 6527 3a20 2753 5543 4345 5353 272c  ate': 'SUCCESS',
-00003db0: 2027 7265 7375 6c74 273a 2027 6265 6565   'result': 'beee
-00003dc0: 7027 2c20 2765 7863 6570 7469 6f6e 273a  p', 'exception':
-00003dd0: 204e 6f6e 652c 2027 636f 6d70 6c65 7465   None, 'complete
-00003de0: 6427 3a20 5472 7565 7d20 290a 3e3e 204e  d': True} ).>> N
-00003df0: 6f64 6528 3c66 756e 6374 696f 6e20 6320  ode(<function c 
-00003e00: 6174 2030 7837 6635 3066 3462 3533 3463  at 0x7f50f4b534c
-00003e10: 303e 3a20 7b27 7374 6174 6527 3a20 2753  0>: {'state': 'S
-00003e20: 5543 4345 5353 272c 2027 7265 7375 6c74  UCCESS', 'result
-00003e30: 273a 2038 2c20 2765 7863 6570 7469 6f6e  ': 8, 'exception
-00003e40: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
-00003e50: 7465 6427 3a20 5472 7565 7d20 290a 3e3e  ted': True} ).>>
-00003e60: 204e 6f64 6528 3c66 756e 6374 696f 6e20   Node(<function 
-00003e70: 6420 6174 2030 7837 6635 3066 3462 3533  d at 0x7f50f4b53
-00003e80: 6136 303e 3a20 7b27 7374 6174 6527 3a20  a60>: {'state': 
-00003e90: 2753 5543 4345 5353 272c 2027 7265 7375  'SUCCESS', 'resu
-00003ea0: 6c74 273a 2027 6720 6d61 6e20 7361 793a  lt': 'g man say:
-00003eb0: 2062 6565 6570 6265 6565 7062 6565 6570   beeepbeeepbeeep
-00003ec0: 272c 2027 6578 6365 7074 696f 6e27 3a20  ', 'exception': 
-00003ed0: 4e6f 6e65 2c20 2763 6f6d 706c 6574 6564  None, 'completed
-00003ee0: 273a 2054 7275 657d 2029 0a3e 3e20 4e6f  ': True} ).>> No
-00003ef0: 6465 283c 6675 6e63 7469 6f6e 2065 2061  de(<function e a
-00003f00: 7420 3078 3766 3530 6634 6235 3362 3830  t 0x7f50f4b53b80
-00003f10: 3e3a 207b 2773 7461 7465 273a 2027 4552  >: {'state': 'ER
-00003f20: 524f 5227 2c20 2772 6573 756c 7427 3a20  ROR', 'result': 
-00003f30: 4e6f 6e65 2c20 2765 7863 6570 7469 6f6e  None, 'exception
-00003f40: 273a 2056 616c 7565 4572 726f 7228 276f  ': ValueError('o
-00003f50: 6d67 2c20 6372 6173 6821 2035 2729 2c20  mg, crash! 5'), 
-00003f60: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
-00003f70: 657d 2029 0a3e 3e20 4e6f 6465 283c 6675  e} ).>> Node(<fu
-00003f80: 6e63 7469 6f6e 2066 2061 7420 3078 3766  nction f at 0x7f
-00003f90: 3530 6634 6235 3330 6430 3e3a 207b 2773  50f4b530d0>: {'s
-00003fa0: 7461 7465 273a 2027 534b 4950 5045 4427  tate': 'SKIPPED'
-00003fb0: 2c20 2772 6573 756c 7427 3a20 4e6f 6e65  , 'result': None
-00003fc0: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
-00003fd0: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
-00003fe0: 3a20 4661 6c73 657d 2029 0a3e 3e20 4e6f  : False} ).>> No
-00003ff0: 6465 283c 6675 6e63 7469 6f6e 2067 2061  de(<function g a
-00004000: 7420 3078 3766 3530 6634 6235 3335 6530  t 0x7f50f4b535e0
-00004010: 3e3a 207b 2773 7461 7465 273a 2027 534b  >: {'state': 'SK
-00004020: 4950 5045 4427 2c20 2772 6573 756c 7427  IPPED', 'result'
-00004030: 3a20 3c74 6872 6561 6469 6e67 2e45 7665  : <threading.Eve
-00004040: 6e74 206f 626a 6563 7420 6174 2030 7837  nt object at 0x7
-00004050: 6635 3065 6331 3663 3964 303e 2c20 2765  f50ec16c9d0>, 'e
-00004060: 7863 6570 7469 6f6e 273a 204e 6f6e 652c  xception': None,
-00004070: 2027 636f 6d70 6c65 7465 6427 3a20 5472   'completed': Tr
-00004080: 7565 7d20 290a 3e3e 204e 6f64 6528 3c66  ue} ).>> Node(<f
-00004090: 756e 6374 696f 6e20 6920 6174 2030 7837  unction i at 0x7
-000040a0: 6635 3066 3462 3533 3238 303e 3a20 7b27  f50f4b53280>: {'
-000040b0: 7374 6174 6527 3a20 2753 4b49 5050 4544  state': 'SKIPPED
-000040c0: 272c 2027 7265 7375 6c74 273a 204e 6f6e  ', 'result': Non
-000040d0: 652c 2027 6578 6365 7074 696f 6e27 3a20  e, 'exception': 
-000040e0: 4e6f 6e65 2c20 2763 6f6d 706c 6574 6564  None, 'completed
-000040f0: 273a 2046 616c 7365 7d20 290a 6060 600a  ': False} ).```.
-00004100: 0a23 2320 4578 6563 7574 6520 7370 6172  .## Execute spar
-00004110: 6b20 7069 7065 6c69 6e65 206f 6620 6d75  k pipeline of mu
-00004120: 6c74 6970 6c65 2073 7465 7073 0a75 7369  ltiple steps.usi
-00004130: 6e67 2044 4147 2063 6f6d 706f 6e65 6e74  ng DAG component
-00004140: 2074 6f20 6861 6e64 6c65 2070 6172 616c   to handle paral
-00004150: 6c65 6c20 6578 6563 7574 696f 6e0a 6060  lel execution.``
-00004160: 6070 7974 686f 6e0a 696d 706f 7274 2062  `python.import b
-00004170: 6471 0a66 726f 6d20 6264 7120 696d 706f  dq.from bdq impo
-00004180: 7274 2073 7061 726b 2c20 7461 626c 650a  rt spark, table.
-00004190: 0a70 706e 203d 2062 6471 2e53 7061 726b  .ppn = bdq.Spark
-000041a0: 5069 7065 6c69 6e65 2873 7061 726b 2c20  Pipeline(spark, 
-000041b0: 2272 6574 6169 6c22 290a 0a23 2072 6574  "retail")..# ret
-000041c0: 7572 6e73 2064 6174 6166 7261 6d65 2c20  urns dataframe, 
-000041d0: 616e 6420 6372 6561 7465 7320 7370 6172  and creates spar
-000041e0: 6b20 7669 6577 2027 7261 775f 6461 7461  k view 'raw_data
-000041f0: 5f73 696e 676c 655f 736f 7572 6365 270a  _single_source'.
-00004200: 4070 706e 2e73 7465 7028 290a 6465 6620  @ppn.step().def 
-00004210: 7261 775f 6461 7461 5f73 696e 676c 655f  raw_data_single_
-00004220: 736f 7572 6365 2870 293a 0a20 2072 6574  source(p):.  ret
-00004230: 7572 6e20 7370 6172 6b2e 7261 6e67 6528  urn spark.range(
-00004240: 312c 2031 3029 0a0a 2320 7265 7475 726e  1, 10)..# return
-00004250: 7320 6461 7461 6672 616d 652c 2061 6e64  s dataframe, and
-00004260: 2063 7265 6174 6573 2073 7061 726b 2076   creates spark v
-00004270: 6965 7720 2772 6177 5f6e 6963 655f 6e61  iew 'raw_nice_na
-00004280: 6d65 270a 4070 706e 2e73 7465 7028 7265  me'.@ppn.step(re
-00004290: 7475 726e 733d 5b22 7261 775f 6e69 6365  turns=["raw_nice
-000042a0: 5f6e 616d 6522 5d29 0a64 6566 2072 6177  _name"]).def raw
-000042b0: 5f64 6174 615f 7369 6e67 6c65 5f73 6f75  _data_single_sou
-000042c0: 7263 655f 7769 7468 5f63 7573 746f 6d5f  rce_with_custom_
-000042d0: 6e61 6d65 2870 293a 0a20 2072 6574 7572  name(p):.  retur
-000042e0: 6e20 7370 6172 6b2e 7261 6e67 6528 3130  n spark.range(10
-000042f0: 302c 2031 3130 290a 0a23 2072 6574 7572  0, 110)..# retur
-00004300: 6e73 2074 776f 2064 6174 6166 7261 6d65  ns two dataframe
-00004310: 732c 2061 6e64 2063 7265 6174 6573 2074  s, and creates t
-00004320: 776f 2073 7061 726b 2076 6965 7773 2027  wo spark views '
-00004330: 7261 775f 6461 7461 3127 2c20 2772 6177  raw_data1', 'raw
-00004340: 5f64 6174 6132 270a 4070 706e 2e73 7465  _data2'.@ppn.ste
-00004350: 7028 7265 7475 726e 733d 5b22 7261 775f  p(returns=["raw_
-00004360: 6461 7461 3122 2c20 2272 6177 5f64 6174  data1", "raw_dat
-00004370: 6132 225d 290a 6465 6620 7261 775f 6461  a2"]).def raw_da
-00004380: 7461 5f6d 756c 7469 5f73 6f75 7263 6528  ta_multi_source(
-00004390: 7029 3a0a 2020 6466 3120 3d20 7370 6172  p):.  df1 = spar
-000043a0: 6b2e 7261 6e67 6528 3130 3030 2c20 3230  k.range(1000, 20
-000043b0: 3030 290a 2020 6466 3220 3d20 7370 6172  00).  df2 = spar
-000043c0: 6b2e 7261 6e67 6528 3230 3030 2c20 3330  k.range(2000, 30
-000043d0: 3030 290a 0a20 2072 6574 7572 6e20 5b64  00)..  return [d
-000043e0: 6631 2c20 6466 325d 0a0a 2320 7761 6974  f1, df2]..# wait
-000043f0: 7320 666f 7220 7261 7720 6461 7461 2073  s for raw data s
-00004400: 6f75 7263 6573 2074 6f20 6669 6e69 7368  ources to finish
-00004410: 2c20 616e 6420 636f 6d62 696e 6573 2074  , and combines t
-00004420: 6865 2064 6174 6120 696e 746f 206f 6e65  he data into one
-00004430: 2075 6e69 6f6e 6564 2076 6965 7720 6063   unioned view `c
-00004440: 6f6d 6269 6e65 5f64 6174 6160 0a23 206e  ombine_data`.# n
-00004450: 6f74 6520 7468 6174 2064 6570 656e 6465  ote that depende
-00004460: 6e63 6965 7320 6172 6520 7079 7468 6f6e  ncies are python
-00004470: 2066 756e 6374 696f 6e73 2c20 6e6f 7420   functions, not 
-00004480: 6e61 6d65 7320 6f66 2076 6965 7773 2028  names of views (
-00004490: 544f 444f 3a20 746f 2068 616e 646c 6520  TODO: to handle 
-000044a0: 7669 6577 206e 616d 6573 2061 7320 7765  view names as we
-000044b0: 6c6c 290a 4070 706e 2e73 7465 7028 6465  ll).@ppn.step(de
-000044c0: 7065 6e64 735f 6f6e 3d5b 7261 775f 6461  pends_on=[raw_da
-000044d0: 7461 5f73 696e 676c 655f 736f 7572 6365  ta_single_source
-000044e0: 2c20 7261 775f 6461 7461 5f73 696e 676c  , raw_data_singl
-000044f0: 655f 736f 7572 6365 5f77 6974 685f 6375  e_source_with_cu
-00004500: 7374 6f6d 5f6e 616d 652c 2072 6177 5f64  stom_name, raw_d
-00004510: 6174 615f 6d75 6c74 695f 736f 7572 6365  ata_multi_source
-00004520: 5d29 0a64 6566 2063 6f6d 6269 6e65 5f64  ]).def combine_d
-00004530: 6174 6128 7029 3a0a 2020 6466 203d 2074  ata(p):.  df = t
-00004540: 6162 6c65 2827 7261 775f 6461 7461 5f73  able('raw_data_s
-00004550: 696e 676c 655f 736f 7572 6365 2729 205c  ingle_source') \
-00004560: 0a20 2020 202e 756e 696f 6e28 7461 626c  .    .union(tabl
-00004570: 6528 2772 6177 5f6e 6963 655f 6e61 6d65  e('raw_nice_name
-00004580: 2729 2920 5c0a 2020 2020 2e75 6e69 6f6e  ')) \.    .union
-00004590: 2874 6162 6c65 2827 7261 775f 6461 7461  (table('raw_data
-000045a0: 3127 2929 205c 0a20 2020 202e 756e 696f  1')) \.    .unio
-000045b0: 6e28 7461 626c 6528 2772 6177 5f64 6174  n(table('raw_dat
-000045c0: 6132 2729 290a 0a20 2072 6574 7572 6e20  a2'))..  return 
-000045d0: 6466 0a0a 2320 7370 6c69 7473 2074 6865  df..# splits the
-000045e0: 2063 6f6d 6269 6e65 645f 6461 7461 2069   combined_data i
-000045f0: 6e74 6f20 276f 6464 2720 616e 6420 2765  nto 'odd' and 'e
-00004600: 7665 6e27 2076 6965 7773 0a40 7070 6e2e  ven' views.@ppn.
-00004610: 7374 6570 2864 6570 656e 6473 5f6f 6e3d  step(depends_on=
-00004620: 5b63 6f6d 6269 6e65 5f64 6174 615d 2c20  [combine_data], 
-00004630: 7265 7475 726e 733d 5b27 6f64 6427 2c20  returns=['odd', 
-00004640: 2765 7665 6e27 5d29 0a64 6566 2073 706c  'even']).def spl
-00004650: 6974 5f64 6174 6128 7029 3a0a 2020 6466  it_data(p):.  df
-00004660: 5f6f 6464 203d 2074 6162 6c65 2827 636f  _odd = table('co
-00004670: 6d62 696e 655f 6461 7461 2729 2e66 696c  mbine_data').fil
-00004680: 7465 7228 2769 6420 2520 3220 3d3d 2031  ter('id % 2 == 1
-00004690: 2729 0a20 2064 665f 6576 656e 203d 2074  ').  df_even = t
-000046a0: 6162 6c65 2827 636f 6d62 696e 655f 6461  able('combine_da
-000046b0: 7461 2729 2e66 696c 7465 7228 2769 6420  ta').filter('id 
-000046c0: 2520 3220 3d3d 2030 2729 0a0a 2020 7265  % 2 == 0')..  re
-000046d0: 7475 726e 205b 2064 665f 6f64 642c 2064  turn [ df_odd, d
-000046e0: 665f 6576 656e 205d 0a0a 2320 6966 2079  f_even ]..# if y
-000046f0: 6f75 2068 6176 6520 6970 7964 6167 7265  ou have ipydagre
-00004700: 6433 2069 6e73 7461 6c6c 6564 2c20 796f  d3 installed, yo
-00004710: 7520 6361 6e20 7365 6520 696e 2072 6561  u can see in rea
-00004720: 6c20 7469 6d65 2073 7461 7465 2063 6861  l time state cha
-00004730: 6e67 6573 206f 6620 6561 6368 206f 6620  nges of each of 
-00004740: 7468 6520 7374 6570 730a 6469 7370 6c61  the steps.displa
-00004750: 7928 7070 6e2e 7669 7375 616c 697a 6528  y(ppn.visualize(
-00004760: 2929 0a0a 2320 6578 6563 7574 6573 2070  ))..# executes p
-00004770: 6970 656c 696e 6520 7573 696e 6720 636f  ipeline using co
-00004780: 6e63 7572 7265 6e74 2074 6872 6561 6473  ncurrent threads
-00004790: 2c20 6f6e 6520 7065 7220 6561 6368 2073  , one per each s
-000047a0: 7465 702c 2066 6f6c 6c6f 7769 6e67 2074  tep, following t
-000047b0: 6865 2064 6570 656e 6465 6e63 7920 4441  he dependency DA
-000047c0: 470a 2320 7069 7065 6c69 6e65 2069 7320  G.# pipeline is 
-000047d0: 6120 6e6f 726d 616c 2070 7974 686f 6e20  a normal python 
-000047e0: 6361 6c6c 6162 6c65 206f 626a 6563 742c  callable object,
-000047f0: 2061 7320 6966 2069 7420 7761 7320 6120   as if it was a 
-00004800: 6675 6e63 7469 6f6e 2c20 6974 2072 6574  function, it ret
-00004810: 7572 6e73 2061 206c 6973 7420 6f66 2061  urns a list of a
-00004820: 6c6c 2073 7465 7073 0a70 6970 656c 696e  ll steps.pipelin
-00004830: 655f 7265 7375 6c74 7320 3d20 7070 6e28  e_results = ppn(
-00004840: 6d61 785f 636f 6e63 7572 7265 6e74 5f73  max_concurrent_s
-00004850: 7465 7073 3d31 3029 0a0a 7072 696e 7428  teps=10)..print(
-00004860: 2770 6970 656c 696e 6520 7265 7375 6c74  'pipeline result
-00004870: 733a 2729 0a70 7269 6e74 2870 6970 656c  s:').print(pipel
-00004880: 696e 655f 7265 7375 6c74 7329 0a0a 2373  ine_results)..#s
-00004890: 686f 7720 736f 6d65 2066 696e 616c 2076  how some final v
-000048a0: 616c 7565 730a 7072 696e 7428 2765 7665  alues.print('eve
-000048b0: 6e20 6e75 6d62 6572 733a 2729 0a70 7269  n numbers:').pri
-000048c0: 6e74 2874 6162 6c65 2827 6576 656e 2729  nt(table('even')
-000048d0: 2e6c 696d 6974 2831 3029 2e63 6f6c 6c65  .limit(10).colle
-000048e0: 6374 2829 290a 7072 696e 7428 276f 6464  ct()).print('odd
-000048f0: 206e 756d 6265 7273 3a27 290a 7072 696e   numbers:').prin
-00004900: 7428 7461 626c 6528 276f 6464 2729 2e6c  t(table('odd').l
-00004910: 696d 6974 2831 3029 2e63 6f6c 6c65 6374  imit(10).collect
-00004920: 2829 290a 0a3e 3e20 5761 6974 696e 6720  ())..>> Waiting 
-00004930: 666f 7220 616c 6c20 7461 736b 7320 746f  for all tasks to
-00004940: 2066 696e 6973 682e 2e2e 0a3e 3e20 2020   finish....>>   
-00004950: 7374 6172 7469 6e67 3a20 4e6f 6465 2872  starting: Node(r
-00004960: 6177 5f64 6174 615f 7369 6e67 6c65 5f73  aw_data_single_s
-00004970: 6f75 7263 653a 207b 2773 7461 7465 273a  ource: {'state':
-00004980: 2027 5255 4e4e 494e 4727 2c20 2772 6573   'RUNNING', 'res
-00004990: 756c 7427 3a20 4e6f 6e65 2c20 2765 7863  ult': None, 'exc
-000049a0: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
-000049b0: 636f 6d70 6c65 7465 6427 3a20 4661 6c73  completed': Fals
-000049c0: 657d 2029 0a3e 3e20 2020 7374 6172 7469  e} ).>>   starti
-000049d0: 6e67 3a20 4e6f 6465 2872 6177 5f64 6174  ng: Node(raw_dat
-000049e0: 615f 7369 6e67 6c65 5f73 6f75 7263 655f  a_single_source_
-000049f0: 7769 7468 5f63 7573 746f 6d5f 6e61 6d65  with_custom_name
-00004a00: 3a20 7b27 7374 6174 6527 3a20 2752 554e  : {'state': 'RUN
-00004a10: 4e49 4e47 272c 2027 7265 7375 6c74 273a  NING', 'result':
-00004a20: 204e 6f6e 652c 2027 6578 6365 7074 696f   None, 'exceptio
-00004a30: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
-00004a40: 6574 6564 273a 2046 616c 7365 7d20 290a  eted': False} ).
-00004a50: 3e3e 2020 2073 7461 7274 696e 673a 204e  >>   starting: N
-00004a60: 6f64 6528 7261 775f 6461 7461 5f6d 756c  ode(raw_data_mul
-00004a70: 7469 5f73 6f75 7263 653a 207b 2773 7461  ti_source: {'sta
-00004a80: 7465 273a 2027 5255 4e4e 494e 4727 2c20  te': 'RUNNING', 
-00004a90: 2772 6573 756c 7427 3a20 4e6f 6e65 2c20  'result': None, 
-00004aa0: 2765 7863 6570 7469 6f6e 273a 204e 6f6e  'exception': Non
-00004ab0: 652c 2027 636f 6d70 6c65 7465 6427 3a20  e, 'completed': 
-00004ac0: 4661 6c73 657d 2029 0a3e 3e20 2020 6669  False} ).>>   fi
-00004ad0: 6e69 7368 6564 3a20 4e6f 6465 2872 6177  nished: Node(raw
-00004ae0: 5f64 6174 615f 7369 6e67 6c65 5f73 6f75  _data_single_sou
-00004af0: 7263 653a 207b 2773 7461 7465 273a 2027  rce: {'state': '
-00004b00: 5355 4343 4553 5327 2c20 2772 6573 756c  SUCCESS', 'resul
-00004b10: 7427 3a20 5b44 6174 6146 7261 6d65 5b69  t': [DataFrame[i
-00004b20: 643a 2062 6967 696e 745d 5d2c 2027 6578  d: bigint]], 'ex
-00004b30: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
-00004b40: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
-00004b50: 657d 2029 2028 7374 696c 6c20 7275 6e6e  e} ) (still runn
-00004b60: 696e 673a 2032 290a 3e3e 2020 2066 696e  ing: 2).>>   fin
-00004b70: 6973 6865 643a 204e 6f64 6528 7261 775f  ished: Node(raw_
-00004b80: 6461 7461 5f73 696e 676c 655f 736f 7572  data_single_sour
-00004b90: 6365 5f77 6974 685f 6375 7374 6f6d 5f6e  ce_with_custom_n
-00004ba0: 616d 653a 207b 2773 7461 7465 273a 2027  ame: {'state': '
-00004bb0: 5355 4343 4553 5327 2c20 2772 6573 756c  SUCCESS', 'resul
-00004bc0: 7427 3a20 5b44 6174 6146 7261 6d65 5b69  t': [DataFrame[i
-00004bd0: 643a 2062 6967 696e 745d 5d2c 2027 6578  d: bigint]], 'ex
-00004be0: 6365 7074 696f 6e27 3a20 4e6f 6e65 2c20  ception': None, 
-00004bf0: 2763 6f6d 706c 6574 6564 273a 2054 7275  'completed': Tru
-00004c00: 657d 2029 2028 7374 696c 6c20 7275 6e6e  e} ) (still runn
-00004c10: 696e 673a 2031 290a 3e3e 2020 2073 7461  ing: 1).>>   sta
-00004c20: 7274 696e 673a 204e 6f64 6528 636f 6d62  rting: Node(comb
-00004c30: 696e 655f 6461 7461 3a20 7b27 7374 6174  ine_data: {'stat
-00004c40: 6527 3a20 2752 554e 4e49 4e47 272c 2027  e': 'RUNNING', '
-00004c50: 7265 7375 6c74 273a 204e 6f6e 652c 2027  result': None, '
-00004c60: 6578 6365 7074 696f 6e27 3a20 4e6f 6e65  exception': None
-00004c70: 2c20 2763 6f6d 706c 6574 6564 273a 2046  , 'completed': F
-00004c80: 616c 7365 7d20 290a 3e3e 2020 2066 696e  alse} ).>>   fin
-00004c90: 6973 6865 643a 204e 6f64 6528 7261 775f  ished: Node(raw_
-00004ca0: 6461 7461 5f6d 756c 7469 5f73 6f75 7263  data_multi_sourc
-00004cb0: 653a 207b 2773 7461 7465 273a 2027 5355  e: {'state': 'SU
-00004cc0: 4343 4553 5327 2c20 2772 6573 756c 7427  CCESS', 'result'
-00004cd0: 3a20 5b44 6174 6146 7261 6d65 5b69 643a  : [DataFrame[id:
-00004ce0: 2062 6967 696e 745d 2c20 4461 7461 4672   bigint], DataFr
-00004cf0: 616d 655b 6964 3a20 6269 6769 6e74 5d5d  ame[id: bigint]]
-00004d00: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
-00004d10: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
-00004d20: 3a20 5472 7565 7d20 2920 2873 7469 6c6c  : True} ) (still
-00004d30: 2072 756e 6e69 6e67 3a20 3129 0a3e 3e20   running: 1).>> 
-00004d40: 2020 7374 6172 7469 6e67 3a20 4e6f 6465    starting: Node
-00004d50: 2873 706c 6974 5f64 6174 613a 207b 2773  (split_data: {'s
-00004d60: 7461 7465 273a 2027 5255 4e4e 494e 4727  tate': 'RUNNING'
-00004d70: 2c20 2772 6573 756c 7427 3a20 4e6f 6e65  , 'result': None
-00004d80: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
-00004d90: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
-00004da0: 3a20 4661 6c73 657d 2029 0a3e 3e20 2020  : False} ).>>   
-00004db0: 6669 6e69 7368 6564 3a20 4e6f 6465 2863  finished: Node(c
-00004dc0: 6f6d 6269 6e65 5f64 6174 613a 207b 2773  ombine_data: {'s
-00004dd0: 7461 7465 273a 2027 5355 4343 4553 5327  tate': 'SUCCESS'
-00004de0: 2c20 2772 6573 756c 7427 3a20 5b44 6174  , 'result': [Dat
-00004df0: 6146 7261 6d65 5b69 643a 2062 6967 696e  aFrame[id: bigin
-00004e00: 745d 5d2c 2027 6578 6365 7074 696f 6e27  t]], 'exception'
-00004e10: 3a20 4e6f 6e65 2c20 2763 6f6d 706c 6574  : None, 'complet
-00004e20: 6564 273a 2054 7275 657d 2029 2028 7374  ed': True} ) (st
-00004e30: 696c 6c20 7275 6e6e 696e 673a 2031 290a  ill running: 1).
-00004e40: 3e3e 2020 2066 696e 6973 6865 643a 204e  >>   finished: N
-00004e50: 6f64 6528 7370 6c69 745f 6461 7461 3a20  ode(split_data: 
-00004e60: 7b27 7374 6174 6527 3a20 2753 5543 4345  {'state': 'SUCCE
-00004e70: 5353 272c 2027 7265 7375 6c74 273a 205b  SS', 'result': [
-00004e80: 4461 7461 4672 616d 655b 6964 3a20 6269  DataFrame[id: bi
-00004e90: 6769 6e74 5d2c 2044 6174 6146 7261 6d65  gint], DataFrame
-00004ea0: 5b69 643a 2062 6967 696e 745d 5d2c 2027  [id: bigint]], '
-00004eb0: 6578 6365 7074 696f 6e27 3a20 4e6f 6e65  exception': None
-00004ec0: 2c20 2763 6f6d 706c 6574 6564 273a 2054  , 'completed': T
-00004ed0: 7275 657d 2029 2028 7374 696c 6c20 7275  rue} ) (still ru
-00004ee0: 6e6e 696e 673a 2030 290a 3e3e 2041 6c6c  nning: 0).>> All
-00004ef0: 2074 6173 6b73 2066 696e 6973 6865 642c   tasks finished,
-00004f00: 2073 6875 7474 696e 6720 646f 776e 0a3e   shutting down.>
-00004f10: 3e20 7069 7065 6c69 6e65 2072 6573 756c  > pipeline resul
-00004f20: 7473 3a0a 3e3e 205b 7261 775f 6461 7461  ts:.>> [raw_data
-00004f30: 5f73 696e 676c 655f 736f 7572 6365 2c20  _single_source, 
-00004f40: 7261 775f 6461 7461 5f73 696e 676c 655f  raw_data_single_
-00004f50: 736f 7572 6365 5f77 6974 685f 6375 7374  source_with_cust
-00004f60: 6f6d 5f6e 616d 652c 2072 6177 5f64 6174  om_name, raw_dat
-00004f70: 615f 6d75 6c74 695f 736f 7572 6365 2c20  a_multi_source, 
-00004f80: 636f 6d62 696e 655f 6461 7461 2c20 7370  combine_data, sp
-00004f90: 6c69 745f 6461 7461 5d0a 3e3e 2065 7665  lit_data].>> eve
-00004fa0: 6e20 6e75 6d62 6572 733a 0a3e 3e20 5b52  n numbers:.>> [R
-00004fb0: 6f77 2869 643d 3229 2c20 526f 7728 6964  ow(id=2), Row(id
-00004fc0: 3d34 292c 2052 6f77 2869 643d 3629 2c20  =4), Row(id=6), 
-00004fd0: 526f 7728 6964 3d38 292c 2052 6f77 2869  Row(id=8), Row(i
-00004fe0: 643d 3130 3029 2c20 526f 7728 6964 3d31  d=100), Row(id=1
-00004ff0: 3032 292c 2052 6f77 2869 643d 3130 3429  02), Row(id=104)
-00005000: 2c20 526f 7728 6964 3d31 3036 292c 2052  , Row(id=106), R
-00005010: 6f77 2869 643d 3130 3829 2c20 526f 7728  ow(id=108), Row(
-00005020: 6964 3d31 3030 3029 5d0a 3e3e 206f 6464  id=1000)].>> odd
-00005030: 206e 756d 6265 7273 3a0a 3e3e 205b 526f   numbers:.>> [Ro
-00005040: 7728 6964 3d31 292c 2052 6f77 2869 643d  w(id=1), Row(id=
-00005050: 3329 2c20 526f 7728 6964 3d35 292c 2052  3), Row(id=5), R
-00005060: 6f77 2869 643d 3729 2c20 526f 7728 6964  ow(id=7), Row(id
-00005070: 3d39 292c 2052 6f77 2869 643d 3130 3129  =9), Row(id=101)
-00005080: 2c20 526f 7728 6964 3d31 3033 292c 2052  , Row(id=103), R
-00005090: 6f77 2869 643d 3130 3529 2c20 526f 7728  ow(id=105), Row(
-000050a0: 6964 3d31 3037 292c 2052 6f77 2869 643d  id=107), Row(id=
-000050b0: 3130 3929 5d0a 6060 600a 0a70 6970 656c  109)].```..pipel
-000050c0: 696e 6520 7374 6570 7320 6172 6520 7265  ine steps are re
-000050d0: 7275 6e61 626c 6520 6173 2061 6e79 206f  runable as any o
-000050e0: 7264 696e 6172 7920 6675 6e63 7469 6f6e  rdinary function
-000050f0: 3a0a 6060 6070 7974 686f 6e0a 2320 746f  :.```python.# to
-00005100: 2072 6572 756e 2067 6976 656e 2073 7465   rerun given ste
-00005110: 702c 206a 7573 7420 6578 6563 7574 6520  p, just execute 
-00005120: 6974 2061 7320 6966 2069 7420 7761 7320  it as if it was 
-00005130: 6120 7075 7265 2066 756e 6374 696f 6e0a  a pure function.
-00005140: 2320 7265 7475 726e 2069 7320 616c 6177  # return is alaw
-00005150: 6179 7320 6120 6c69 7374 206f 6620 6461  ays a list of da
-00005160: 7461 6672 616d 7320 7468 6174 2067 6976  taframs that giv
-00005170: 656e 2040 7070 6e2e 7374 6570 2072 6574  en @ppn.step ret
-00005180: 7572 6e73 0a23 206e 6f74 653a 2074 6865  urns.# note: the
-00005190: 2073 7061 726b 2076 6965 7720 2772 6177   spark view 'raw
-000051a0: 5f64 6174 615f 7369 6e67 6c65 5f73 6f75  _data_single_sou
-000051b0: 7263 6527 2077 696c 6c20 6265 2075 7064  rce' will be upd
-000051c0: 6174 6564 2077 6865 6e20 7468 6973 2066  ated when this f
-000051d0: 756e 6374 696f 6e20 6669 6e69 7368 6573  unction finishes
-000051e0: 2028 6173 2070 6572 2064 6566 696e 7469   (as per definti
-000051f0: 6f6e 2069 6e20 4070 706e 2e73 7465 7020  on in @ppn.step 
-00005200: 6162 6f76 6529 0a72 6177 5f64 6174 615f  above).raw_data_
-00005210: 7369 6e67 6c65 5f73 6f75 7263 6528 290a  single_source().
-00005220: 6060 600a 0a23 2320 5370 6172 6b20 5549  ```..## Spark UI
-00005230: 2053 7461 6765 2064 6573 6372 6970 7469   Stage descripti
-00005240: 6f6e 730a 5768 656e 2072 756e 6e69 6e67  ons.When running
-00005250: 2063 6f64 6520 7573 696e 6720 7079 7370   code using pysp
-00005260: 6172 6b2c 2073 7061 726b 2075 6920 6765  ark, spark ui ge
-00005270: 7473 2076 6572 7920 6372 6f77 6465 642e  ts very crowded.
-00005280: 2060 5370 6172 6b55 494c 6f67 6765 7260   `SparkUILogger`
-00005290: 2063 6f6e 7465 7874 206d 616e 6167 6572   context manager
-000052a0: 2061 6e64 2064 6563 6f72 6174 6f72 2061   and decorator a
-000052b0: 7373 696e 6773 2068 756d 616e 2072 6561  ssings human rea
-000052c0: 6461 626c 6520 6e61 6d65 7320 746f 2073  dable names to s
-000052d0: 7061 726b 2073 7461 6765 732e 0a0a 6060  park stages...``
-000052e0: 6070 7974 686f 6e0a 6672 6f6d 2062 6471  `python.from bdq
-000052f0: 0a0a 2320 7573 6167 6520 6f66 2064 6563  ..# usage of dec
-00005300: 6f72 6174 6f72 730a 2320 7370 6172 6b20  orators.# spark 
-00005310: 7569 2073 7461 6765 7320 7769 6c6c 2068  ui stages will h
-00005320: 6176 6520 6465 7363 7269 7074 696f 6e20  ave description 
-00005330: 6f66 2027 7879 7a27 0a40 5370 6172 6b55  of 'xyz'.@SparkU
-00005340: 494c 6f67 6765 722e 7461 6728 6465 7363  ILogger.tag(desc
-00005350: 3d27 7879 7a27 290a 6465 6620 736f 6d65  ='xyz').def some
-00005360: 5f66 756e 6374 696f 6e32 286e 756d 6265  _function2(numbe
-00005370: 7229 3a0a 0a20 2072 6574 7572 6e20 7370  r):..  return sp
-00005380: 6172 6b2e 7261 6e67 6528 6e75 6d62 6572  ark.range(number
-00005390: 292e 636f 756e 7428 290a 0a23 2073 7061  ).count()..# spa
-000053a0: 726b 2075 6920 7374 6167 6573 2077 696c  rk ui stages wil
-000053b0: 6c20 6861 7665 2064 6573 6372 6970 7469  l have descripti
-000053c0: 6f6e 206f 6620 2761 6c70 6861 5f66 756e  on of 'alpha_fun
-000053d0: 6374 696f 6e32 2720 2861 7574 6f6d 6174  ction2' (automat
-000053e0: 6963 616c 6c79 2064 6572 6976 6564 2066  ically derived f
-000053f0: 726f 6d20 6675 6e63 7469 6f6e 206e 616d  rom function nam
-00005400: 6529 0a40 5370 6172 6b55 494c 6f67 6765  e).@SparkUILogge
-00005410: 722e 7461 670a 6465 6620 616c 7068 615f  r.tag.def alpha_
-00005420: 6675 6e63 7469 6f6e 3228 6e75 6d62 6572  function2(number
-00005430: 293a 0a20 2023 2031 7374 2061 6e64 2032  ):.  # 1st and 2
-00005440: 6e64 2073 6f6d 655f 6675 6e63 7469 6f6e  nd some_function
-00005450: 3228 2920 6361 6c6c 7320 7368 6f75 6c64  2() calls should
-00005460: 2062 6520 7669 7369 626c 6520 696e 2073   be visible in s
-00005470: 7061 726b 2075 6920 6173 2027 7879 7a27  park ui as 'xyz'
-00005480: 0a20 2023 2074 6865 2033 7264 2070 6172  .  # the 3rd par
-00005490: 7420 6f66 2072 6573 756c 7420 7368 6f75  t of result shou
-000054a0: 6c64 2062 6520 7669 7369 626c 6520 6173  ld be visible as
-000054b0: 2027 616c 7068 615f 6675 6e63 7469 6f6e   'alpha_function
-000054c0: 320a 2020 7265 7475 726e 2073 6f6d 655f  2.  return some_
-000054d0: 6675 6e63 7469 6f6e 3228 6e75 6d62 6572  function2(number
-000054e0: 2a32 2920 2b20 736f 6d65 5f66 756e 6374  *2) + some_funct
-000054f0: 696f 6e32 286e 756d 6265 722a 3329 202b  ion2(number*3) +
-00005500: 2073 7061 726b 2e72 616e 6765 286e 756d   spark.range(num
-00005510: 6265 722f 3130 292e 636f 756e 7428 290a  ber/10).count().
-00005520: 0a23 2075 7361 6765 206f 6620 636f 6e74  .# usage of cont
-00005530: 6578 7420 6d61 6e61 6765 7273 0a23 2077  ext managers.# w
-00005540: 696c 6c20 6265 2076 6973 6962 6c65 2069  ill be visible i
-00005550: 6e20 7370 6172 6b20 7569 2061 7320 2766  n spark ui as 'f
-00005560: 6972 7374 2d63 6f75 6e74 270a 7769 7468  irst-count'.with
-00005570: 2053 7061 726b 5549 4c6f 6767 6572 2827   SparkUILogger('
-00005580: 6669 7273 742d 636f 756e 7427 293a 0a20  first-count'):. 
-00005590: 2073 7061 726b 2e72 616e 6765 2831 3029   spark.range(10)
-000055a0: 2e63 6f75 6e74 2829 0a0a 2320 7769 6c6c  .count()..# will
-000055b0: 2062 6520 7669 7369 626c 6520 696e 2073   be visible in s
-000055c0: 7061 726b 2075 6920 6173 2027 326e 642d  park ui as '2nd-
-000055d0: 636f 756e 7427 0a77 6974 6820 5370 6172  count'.with Spar
-000055e0: 6b55 494c 6f67 6765 7228 2732 6e64 2d63  kUILogger('2nd-c
-000055f0: 6f75 6e74 2729 3a0a 2020 7370 6172 6b2e  ount'):.  spark.
-00005600: 7261 6e67 6528 3230 292e 636f 756e 7428  range(20).count(
-00005610: 290a 0a73 6f6d 655f 6675 6e63 7469 6f6e  )..some_function
-00005620: 3228 3130 3030 290a 616c 7068 615f 6675  2(1000).alpha_fu
-00005630: 6e63 7469 6f6e 3228 3230 3030 290a 6060  nction2(2000).``
-00005640: 600a                                     `.
+00002670: 2d2d 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c44  ---------+.>> |D
+00002680: 6570 747c 436f 756e 7472 797c 7361 6d70  ept|Country|samp
+00002690: 6c65 5f72 6563 6f72 6473 2020 2020 2020  le_records      
+000026a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026e0: 7c0a 3e3e 202b 2d2d 2d2d 2b2d 2d2d 2d2d  |.>> +----+-----
+000026f0: 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  --+-------------
+00002700: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002710: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002720: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002730: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002740: 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c49 5420  -------+.>> |IT 
+00002750: 207c 5553 4120 2020 207c 5b7b 4954 2c20   |USA    |[{IT, 
+00002760: 5553 412c 2041 6c69 6365 312c 20ef bfbd  USA, Alice1, ...
+00002770: efbf bd78 7a34 7110 5fef bfbd efbf bd11  ...xz4q._.......
+00002780: 5c72 61ef bfbd 2def bfbd 16ef bfbd 567a  \ra...-.......Vz
+00002790: 7d2c 207b 4954 2c20 5553 412c 2041 6c69  }, {IT, USA, Ali
+000027a0: 6365 322c 20ef bfbd efbf bd78 7a34 7110  ce2, ......xz4q.
+000027b0: 5fef bfbd efbf bd11 5c72 61ef bfbd 2def  _.......\ra...-.
+000027c0: bfbd 16ef bfbd 567a 7d5d 7c0a 3e3e 202b  ......Vz}]|.>> +
+000027d0: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d 2b2d 2d2d  ----+-------+---
+000027e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000027f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002800: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002810: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002820: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002830: 2d2b 0a60 6060 0a0a 2323 2320 4765 7420  -+.```..### Get 
+00002840: 6c61 7465 7374 2072 6563 6f72 6473 0a0a  latest records..
+00002850: 7769 7468 206f 7074 696f 6e61 6c20 7072  with optional pr
+00002860: 696d 6172 7920 6b65 7920 636f 6e66 6c69  imary key confli
+00002870: 6374 2072 6573 6f6c 7574 696f 6e2c 2077  ct resolution, w
+00002880: 6865 7265 2074 6865 7265 2061 7265 206d  here there are m
+00002890: 756c 7469 706c 6520 7265 636f 7264 7320  ultiple records 
+000028a0: 6265 696e 6720 6361 6e64 6964 6174 6520  being candidate 
+000028b0: 666f 7220 6c61 7465 7374 2072 6563 6f72  for latest recor
+000028c0: 642c 2062 7574 2074 6865 7920 6861 7665  d, but they have
+000028d0: 2064 6966 6665 7265 6e74 2061 7474 7269   different attri
+000028e0: 6275 6574 7320 616e 6420 7468 6572 6520  buets and there 
+000028f0: 6973 206e 6f20 7761 7920 6f66 2064 6574  is no way of det
+00002900: 6572 6d69 6e69 6e67 2077 6869 6368 206f  ermining which o
+00002910: 6e65 2069 7320 7468 6520 6c61 7465 7374  ne is the latest
+00002920: 2e0a 0a60 6060 7079 7468 6f6e 0a66 726f  ...```python.fro
+00002930: 6d20 6461 7465 7469 6d65 2069 6d70 6f72  m datetime impor
+00002940: 7420 6461 7465 7469 6d65 2061 7320 6474  t datetime as dt
+00002950: 0a66 726f 6d20 6264 7120 696d 706f 7274  .from bdq import
+00002960: 2067 6574 5f6c 6174 6573 745f 7265 636f   get_latest_reco
+00002970: 7264 732c 2067 6574 5f6c 6174 6573 745f  rds, get_latest_
+00002980: 7265 636f 7264 735f 7769 7468 5f70 6b5f  records_with_pk_
+00002990: 636f 6e66 6963 745f 6465 7465 6374 696f  confict_detectio
+000029a0: 6e5f 666c 6167 0a0a 696e 6372 656d 656e  n_flag..incremen
+000029b0: 745f 6461 7461 203d 2020 5b0a 2020 2831  t_data =  [.  (1
+000029c0: 2c20 6474 2832 3030 302c 2031 2c20 312c  , dt(2000, 1, 1,
+000029d0: 2030 2c20 302c 2030 292c 2022 3130 3031   0, 0, 0), "1001
+000029e0: 2229 0a20 202c 2831 2c20 6474 2832 3030  ").  ,(1, dt(200
+000029f0: 302c 2031 2c20 312c 2032 2c20 302c 2030  0, 1, 1, 2, 0, 0
+00002a00: 292c 2022 3130 3032 2229 0a20 202c 2832  ), "1002").  ,(2
+00002a10: 2c20 6474 2832 3030 302c 2031 2c20 312c  , dt(2000, 1, 1,
+00002a20: 2030 2c20 302c 2030 292c 2022 3230 3031   0, 0, 0), "2001
+00002a30: 2229 2023 6361 7262 6f6e 2063 6f70 7920  ") #carbon copy 
+00002a40: 6475 706c 6963 6174 650a 2020 2c28 322c  duplicate.  ,(2,
+00002a50: 2064 7428 3230 3030 2c20 312c 2031 2c20   dt(2000, 1, 1, 
+00002a60: 302c 2030 2c20 3029 2c20 2232 3030 3122  0, 0, 0), "2001"
+00002a70: 2920 2363 6172 626f 6e20 636f 7079 2064  ) #carbon copy d
+00002a80: 7570 6c69 6361 7465 0a20 202c 2833 2c20  uplicate.  ,(3, 
+00002a90: 6474 2832 3030 302c 2031 2c20 312c 2030  dt(2000, 1, 1, 0
+00002aa0: 2c20 302c 2030 292c 2022 3330 3031 2229  , 0, 0), "3001")
+00002ab0: 0a20 202c 2833 2c20 6474 2832 3030 302c  .  ,(3, dt(2000,
+00002ac0: 2031 2c20 312c 2032 2c20 302c 2030 292c   1, 1, 2, 0, 0),
+00002ad0: 2022 3330 3032 2331 2229 2023 706b 2063   "3002#1") #pk c
+00002ae0: 6f6e 666c 6963 742c 2074 776f 2065 6e74  onflict, two ent
+00002af0: 7269 6573 2077 6974 6820 7468 6520 7361  ries with the sa
+00002b00: 6d65 2074 6563 686e 6963 616c 2066 6965  me technical fie
+00002b10: 6c64 732c 2062 7574 2064 6966 6665 7265  lds, but differe
+00002b20: 6e74 2061 7472 6962 7574 6573 2c20 7768  nt atributes, wh
+00002b30: 6963 6820 6f6e 6520 746f 2063 686f 7365  ich one to chose
+00002b40: 3f0a 2020 2c28 332c 2064 7428 3230 3030  ?.  ,(3, dt(2000
+00002b50: 2c20 312c 2031 2c20 322c 2030 2c20 3029  , 1, 1, 2, 0, 0)
+00002b60: 2c20 2233 3030 3223 3222 2920 2370 6b20  , "3002#2") #pk 
+00002b70: 636f 6e66 6c69 6374 0a5d 0a0a 6466 203d  conflict.]..df =
+00002b80: 2073 7061 726b 2e63 7265 6174 6544 6174   spark.createDat
+00002b90: 6146 7261 6d65 2869 6e63 7265 6d65 6e74  aFrame(increment
+00002ba0: 5f64 6174 612c 2022 706b 3a69 6e74 2c63  _data, "pk:int,c
+00002bb0: 6861 6e67 655f 7473 3a74 696d 6573 7461  hange_ts:timesta
+00002bc0: 6d70 2c61 7474 723a 7374 7269 6e67 2229  mp,attr:string")
+00002bd0: 0a64 662e 7368 6f77 2874 7275 6e63 6174  .df.show(truncat
+00002be0: 653d 5472 7565 290a 0a3e 3e20 2b2d 2d2d  e=True)..>> +---
+00002bf0: 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---------------
+00002c00: 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e 3e20  ----+------+.>> 
+00002c10: 7c20 706b 7c20 2020 2020 2020 2020 2063  | pk|          c
+00002c20: 6861 6e67 655f 7473 7c20 2061 7474 727c  hange_ts|  attr|
+00002c30: 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d  .>> +---+-------
+00002c40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d  ------------+---
+00002c50: 2d2d 2d2b 0a3e 3e20 7c20 2031 7c32 3030  ---+.>> |  1|200
+00002c60: 302d 3031 2d30 3120 3030 3a30 303a 3030  0-01-01 00:00:00
+00002c70: 7c20 2031 3030 317c 0a3e 3e20 7c20 2031  |  1001|.>> |  1
+00002c80: 7c32 3030 302d 3031 2d30 3120 3032 3a30  |2000-01-01 02:0
+00002c90: 303a 3030 7c20 2031 3030 327c 0a3e 3e20  0:00|  1002|.>> 
+00002ca0: 7c20 2032 7c32 3030 302d 3031 2d30 3120  |  2|2000-01-01 
+00002cb0: 3030 3a30 303a 3030 7c20 2032 3030 317c  00:00:00|  2001|
+00002cc0: 0a3e 3e20 7c20 2032 7c32 3030 302d 3031  .>> |  2|2000-01
+00002cd0: 2d30 3120 3030 3a30 303a 3030 7c20 2032  -01 00:00:00|  2
+00002ce0: 3030 317c 0a3e 3e20 7c20 2033 7c32 3030  001|.>> |  3|200
+00002cf0: 302d 3031 2d30 3120 3030 3a30 303a 3030  0-01-01 00:00:00
+00002d00: 7c20 2033 3030 317c 0a3e 3e20 7c20 2033  |  3001|.>> |  3
+00002d10: 7c32 3030 302d 3031 2d30 3120 3032 3a30  |2000-01-01 02:0
+00002d20: 303a 3030 7c33 3030 3223 317c 0a3e 3e20  0:00|3002#1|.>> 
+00002d30: 7c20 2033 7c32 3030 302d 3031 2d30 3120  |  3|2000-01-01 
+00002d40: 3032 3a30 303a 3030 7c33 3030 3223 327c  02:00:00|3002#2|
+00002d50: 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d  .>> +---+-------
+00002d60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d  ------------+---
+00002d70: 2d2d 2d2b 0a0a 7072 696d 6172 795f 6b65  ---+..primary_ke
+00002d80: 795f 636f 6c75 6d6e 7320 3d20 5b27 706b  y_columns = ['pk
+00002d90: 275d 0a6f 7264 6572 5f62 795f 636f 6c75  '].order_by_colu
+00002da0: 6d6e 7320 3d20 5b27 6368 616e 6765 5f74  mns = ['change_t
+00002db0: 7327 5d0a 0a23 2077 696c 6c20 7261 6e64  s']..# will rand
+00002dc0: 6f6d 6c79 2063 686f 7365 206f 6e65 2070  omly chose one p
+00002dd0: 6b20 696e 2063 6173 6520 6f66 2063 6f6e  k in case of con
+00002de0: 666c 6963 742c 2077 6974 686f 7574 2061  flict, without a
+00002df0: 6e79 206e 6f74 6966 6963 6174 696f 6e20  ny notification 
+00002e00: 6162 6f75 7420 636f 6e66 6c69 6374 730a  about conflicts.
+00002e10: 7369 6d70 6c65 5f67 6574 5f6c 6174 6573  simple_get_lates
+00002e20: 745f 6466 203d 2067 6574 5f6c 6174 6573  t_df = get_lates
+00002e30: 745f 7265 636f 7264 7328 6466 2c20 7072  t_records(df, pr
+00002e40: 696d 6172 795f 6b65 795f 636f 6c75 6d6e  imary_key_column
+00002e50: 732c 206f 7264 6572 5f62 795f 636f 6c75  s, order_by_colu
+00002e60: 6d6e 7329 0a73 696d 706c 655f 6765 745f  mns).simple_get_
+00002e70: 6c61 7465 7374 5f64 662e 7368 6f77 2874  latest_df.show(t
+00002e80: 7275 6e63 6174 653d 5472 7565 290a 0a3e  runcate=True)..>
+00002e90: 3e20 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  > +---+---------
+00002ea0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00002eb0: 2d2b 0a3e 3e20 7c20 706b 7c20 2020 2020  -+.>> | pk|     
+00002ec0: 2020 2020 2063 6861 6e67 655f 7473 7c20       change_ts| 
+00002ed0: 2061 7474 727c 0a3e 3e20 2b2d 2d2d 2b2d   attr|.>> +---+-
+00002ee0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002ef0: 2d2d 2b2d 2d2d 2d2d 2d2b 0a3e 3e20 7c20  --+------+.>> | 
+00002f00: 2031 7c32 3030 302d 3031 2d30 3120 3032   1|2000-01-01 02
+00002f10: 3a30 303a 3030 7c20 2031 3030 327c 0a3e  :00:00|  1002|.>
+00002f20: 3e20 7c20 2032 7c32 3030 302d 3031 2d30  > |  2|2000-01-0
+00002f30: 3120 3030 3a30 303a 3030 7c20 2032 3030  1 00:00:00|  200
+00002f40: 317c 0a3e 3e20 7c20 2033 7c32 3030 302d  1|.>> |  3|2000-
+00002f50: 3031 2d30 3120 3032 3a30 303a 3030 7c33  01-01 02:00:00|3
+00002f60: 3030 3223 317c 0a3e 3e20 2b2d 2d2d 2b2d  002#1|.>> +---+-
+00002f70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002f80: 2d2d 2b2d 2d2d 2d2d 2d2b 0a0a 2320 7769  --+------+..# wi
+00002f90: 6c6c 2066 6c61 6720 7265 636f 7264 7320  ll flag records 
+00002fa0: 7768 6963 6820 6361 7573 6520 636f 6e66  which cause conf
+00002fb0: 6c69 6374 7320 616e 6420 6361 6e6e 6f74  licts and cannot
+00002fc0: 2062 6520 7265 736f 6c76 6564 0a23 2062   be resolved.# b
+00002fd0: 6164 2072 6563 6f72 6473 206e 6565 6420  ad records need 
+00002fe0: 746f 2062 6520 7175 6172 616e 7469 6e65  to be quarantine
+00002ff0: 6420 616e 6420 6861 6e64 6c65 6420 696e  d and handled in
+00003000: 2073 7065 6369 616c 2070 726f 6365 7373   special process
+00003010: 0a63 6f6e 666c 6963 745f 6765 745f 6c61  .conflict_get_la
+00003020: 7465 7374 5f64 6620 3d20 6765 745f 6c61  test_df = get_la
+00003030: 7465 7374 5f72 6563 6f72 6473 5f77 6974  test_records_wit
+00003040: 685f 706b 5f63 6f6e 6669 6374 5f64 6574  h_pk_confict_det
+00003050: 6563 7469 6f6e 5f66 6c61 6728 6466 2c20  ection_flag(df, 
+00003060: 7072 696d 6172 795f 6b65 795f 636f 6c75  primary_key_colu
+00003070: 6d6e 732c 206f 7264 6572 5f62 795f 636f  mns, order_by_co
+00003080: 6c75 6d6e 7329 0a63 6f6e 666c 6963 745f  lumns).conflict_
+00003090: 6765 745f 6c61 7465 7374 5f64 662e 7368  get_latest_df.sh
+000030a0: 6f77 2874 7275 6e63 6174 653d 5472 7565  ow(truncate=True
+000030b0: 290a 0a3e 3e20 2b2d 2d2d 2b2d 2d2d 2d2d  )..>> +---+-----
+000030c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d  --------------+-
+000030d0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+000030e0: 2d2d 2d2d 2d2d 2d2b 0a3e 3e20 7c20 706b  -------+.>> | pk
+000030f0: 7c20 2020 2020 2020 2020 2063 6861 6e67  |          chang
+00003100: 655f 7473 7c20 2061 7474 727c 5f5f 6861  e_ts|  attr|__ha
+00003110: 735f 706b 5f63 6f6e 666c 6963 747c 0a3e  s_pk_conflict|.>
+00003120: 3e20 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d  > +---+---------
+00003130: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00003140: 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  -+--------------
+00003150: 2d2d 2d2b 0a3e 3e20 7c20 2031 7c32 3030  ---+.>> |  1|200
+00003160: 302d 3031 2d30 3120 3032 3a30 303a 3030  0-01-01 02:00:00
+00003170: 7c20 2031 3030 327c 2020 2020 2020 2020  |  1002|        
+00003180: 2020 2020 6661 6c73 657c 0a3e 3e20 7c20      false|.>> | 
+00003190: 2032 7c32 3030 302d 3031 2d30 3120 3030   2|2000-01-01 00
+000031a0: 3a30 303a 3030 7c20 2032 3030 317c 2020  :00:00|  2001|  
+000031b0: 2020 2020 2020 2020 2020 6661 6c73 657c            false|
+000031c0: 0a3e 3e20 7c20 2033 7c32 3030 302d 3031  .>> |  3|2000-01
+000031d0: 2d30 3120 3032 3a30 303a 3030 7c33 3030  -01 02:00:00|300
+000031e0: 3223 327c 2020 2020 2020 2020 2020 2020  2#2|            
+000031f0: 2074 7275 657c 0a3e 3e20 7c20 2033 7c32   true|.>> |  3|2
+00003200: 3030 302d 3031 2d30 3120 3032 3a30 303a  000-01-01 02:00:
+00003210: 3030 7c33 3030 3223 317c 2020 2020 2020  00|3002#1|      
+00003220: 2020 2020 2020 2074 7275 657c 0a3e 3e20         true|.>> 
+00003230: 2b2d 2d2d 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d  +---+-----------
+00003240: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2b  --------+------+
+00003250: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00003260: 2d2b 0a0a 6060 600a 0a23 2323 2046 696e  -+..```..### Fin
+00003270: 6420 636f 6d70 6f73 6974 6520 7072 696d  d composite prim
+00003280: 6172 7920 6b65 7920 6361 6e64 6964 6174  ary key candidat
+00003290: 6573 0a0a 4769 7665 6e20 6c69 7374 206f  es..Given list o
+000032a0: 6620 706f 7373 6962 6c65 2063 6f6c 756d  f possible colum
+000032b0: 6e73 2c20 636f 6e73 7472 7563 7473 2074  ns, constructs t
+000032c0: 6865 206c 6973 7473 206f 6620 616c 6c20  he lists of all 
+000032d0: 706f 7373 6962 6c65 2063 6f6d 6269 6e61  possible combina
+000032e0: 7469 6f6e 7320 6f66 2063 6f6d 706f 7369  tions of composi
+000032f0: 7465 2070 7269 6d61 7279 206b 6579 732c  te primary keys,
+00003300: 2061 6e64 2065 7865 6375 7465 7320 636f   and executes co
+00003310: 6e63 7572 7265 6e74 6c79 2074 6f20 6465  ncurrently to de
+00003320: 7465 726d 696e 6520 6966 2067 6976 656e  termine if given
+00003330: 2073 6574 206f 6620 636f 6c75 6d6e 7320   set of columns 
+00003340: 6973 2061 2076 616c 6964 2070 7269 6d61  is a valid prima
+00003350: 7279 206b 6579 2e20 5573 6573 206d 696e  ry key. Uses min
+00003360: 696d 756d 2070 6f73 7369 626c 6520 616d  imum possible am
+00003370: 6f75 6e74 206f 6620 7175 6572 6965 7320  ount of queries 
+00003380: 6167 6169 6e73 7420 7370 6172 6b20 6279  against spark by
+00003390: 2073 6b69 7070 696e 6720 7661 6c69 6461   skipping valida
+000033a0: 7469 6f6e 2070 6174 6873 2074 6861 7420  tion paths that 
+000033b0: 6172 6520 6261 7365 6420 6f6e 2061 6c72  are based on alr
+000033c0: 6561 6479 2076 616c 6964 6174 6564 2070  eady validated p
+000033d0: 7269 6d61 7279 206b 6579 2063 6f6d 6269  rimary key combi
+000033e0: 6e61 7469 6f6e 732e 0a0a 6060 6070 7974  nations...```pyt
+000033f0: 686f 6e0a 696d 706f 7274 2062 6471 0a69  hon.import bdq.i
+00003400: 6d70 6f72 7420 7079 7370 6172 6b2e 7371  mport pyspark.sq
+00003410: 6c2e 6675 6e63 7469 6f6e 7320 6173 2046  l.functions as F
+00003420: 0a0a 6466 203d 2073 7061 726b 2e72 616e  ..df = spark.ran
+00003430: 6765 2830 2c20 3130 3029 205c 0a20 202e  ge(0, 100) \.  .
+00003440: 7769 7468 436f 6c75 6d6e 2827 7479 7065  withColumn('type
+00003450: 272c 2046 2e65 7870 7228 2728 6964 202f  ', F.expr('(id /
+00003460: 2031 3029 3a3a 696e 7420 2b20 3127 2929   10)::int + 1'))
+00003470: 205c 0a20 202e 7769 7468 436f 6c75 6d6e   \.  .withColumn
+00003480: 2827 7265 6d69 6e64 6572 272c 2046 2e65  ('reminder', F.e
+00003490: 7870 7228 2769 6420 2520 3130 2729 2920  xpr('id % 10')) 
+000034a0: 5c0a 2020 2e77 6974 6843 6f6c 756d 6e28  \.  .withColumn(
+000034b0: 2773 7461 7469 6327 2c20 462e 6c69 7428  'static', F.lit(
+000034c0: 2741 2729 2920 5c0a 2020 2e77 6974 6843  'A')) \.  .withC
+000034d0: 6f6c 756d 6e28 2772 6f75 6e64 5f72 6f62  olumn('round_rob
+000034e0: 696e 272c 2046 2e65 7870 7228 2769 6420  in', F.expr('id 
+000034f0: 2520 3227 2929 0a0a 6469 7370 6c61 7928  % 2'))..display(
+00003500: 6466 290a 0a61 6c6c 5f63 6f6d 6269 6e61  df)..all_combina
+00003510: 7469 6f6e 7320 3d20 6c69 7374 2862 6471  tions = list(bdq
+00003520: 2e67 6574 5f63 6f6c 756d 6e5f 6e61 6d65  .get_column_name
+00003530: 735f 636f 6d62 696e 6174 696f 6e73 2864  s_combinations(d
+00003540: 662e 636f 6c75 6d6e 7329 290a 0a62 6471  f.columns))..bdq
+00003550: 2e76 616c 6964 6174 655f 7072 696d 6172  .validate_primar
+00003560: 795f 6b65 795f 6361 6e64 6964 6174 655f  y_key_candidate_
+00003570: 636f 6d62 696e 6174 696f 6e73 2864 662c  combinations(df,
+00003580: 2061 6c6c 5f63 6f6d 6269 6e61 7469 6f6e   all_combination
+00003590: 732c 206d 6178 5f77 6f72 6b65 7273 3d31  s, max_workers=1
+000035a0: 302c 2076 6572 626f 7365 3d54 7275 6529  0, verbose=True)
+000035b0: 0a3e 3e20 5b28 2769 6427 2c29 2c20 2827  .>> [('id',), ('
+000035c0: 7479 7065 272c 2027 7265 6d69 6e64 6572  type', 'reminder
+000035d0: 2729 5d0a 6060 600a 0a23 2323 2045 7865  ')].```..### Exe
+000035e0: 6375 7465 2044 4147 2068 6176 696e 6720  cute DAG having 
+000035f0: 6e6f 6465 7320 6173 2070 7974 686f 6e20  nodes as python 
+00003600: 6675 6e63 7469 6f6e 730a 0a60 6060 7079  functions..```py
+00003610: 7468 6f6e 0a69 6d70 6f72 7420 6264 710a  thon.import bdq.
+00003620: 696d 706f 7274 2074 696d 650a 696d 706f  import time.impo
+00003630: 7274 2070 7974 6573 740a 0a23 6372 6561  rt pytest..#crea
+00003640: 7465 2067 7261 7068 0a67 7261 7068 203d  te graph.graph =
+00003650: 2062 6471 2e44 4147 2829 0a0a 2364 6566   bdq.DAG()..#def
+00003660: 696e 6520 6e6f 6465 730a 4067 7261 7068  ine nodes.@graph
+00003670: 2e6e 6f64 6528 290a 6465 6620 6128 293a  .node().def a():
+00003680: 0a20 2074 696d 652e 736c 6565 7028 3229  .  time.sleep(2)
+00003690: 0a20 2072 6574 7572 6e20 350a 0a40 6772  .  return 5..@gr
+000036a0: 6170 682e 6e6f 6465 2829 0a64 6566 2062  aph.node().def b
+000036b0: 2829 3a0a 2020 7469 6d65 2e73 6c65 6570  ():.  time.sleep
+000036c0: 2833 290a 2020 7265 7475 726e 2022 6265  (3).  return "be
+000036d0: 6565 7022 0a0a 236e 6f64 6573 2063 616e  eep"..#nodes can
+000036e0: 2064 6570 656e 6420 6f6e 206f 7468 6572   depend on other
+000036f0: 206e 6f64 6573 0a40 6772 6170 682e 6e6f   nodes.@graph.no
+00003700: 6465 2864 6570 656e 6473 5f6f 6e3d 5b62  de(depends_on=[b
+00003710: 5d29 0a64 6566 2063 2829 3a0a 2020 7469  ]).def c():.  ti
+00003720: 6d65 2e73 6c65 6570 2835 290a 2020 7265  me.sleep(5).  re
+00003730: 7475 726e 2038 0a0a 2361 6e79 2061 6d6f  turn 8..#any amo
+00003740: 756e 7420 6f66 2064 6570 656e 6465 6e63  unt of dependenc
+00003750: 6965 7320 6973 2061 6c6c 6f77 6564 0a40  ies is allowed.@
+00003760: 6772 6170 682e 6e6f 6465 2864 6570 656e  graph.node(depen
+00003770: 6473 5f6f 6e3d 5b62 2c20 632c 2061 5d29  ds_on=[b, c, a])
+00003780: 0a64 6566 2064 2829 3a0a 2020 7469 6d65  .def d():.  time
+00003790: 2e73 6c65 6570 2837 290a 2020 2362 6565  .sleep(7).  #bee
+000037a0: 7020 6173 206d 616e 7920 7469 6d65 7320  p as many times 
+000037b0: 6173 2061 6273 6f6c 7574 6520 6469 6666  as absolute diff
+000037c0: 6572 656e 6365 2062 6574 7765 656e 2027  erence between '
+000037d0: 6327 2061 6e64 2027 6127 0a20 2072 6574  c' and 'a'.  ret
+000037e0: 7572 6e20 2267 206d 616e 2073 6179 3a20  urn "g man say: 
+000037f0: 2220 2b20 622e 7265 7375 6c74 202a 2061  " + b.result * a
+00003800: 6273 2863 2e72 6573 756c 7420 2d20 612e  bs(c.result - a.
+00003810: 7265 7375 6c74 290a 0a40 6772 6170 682e  result)..@graph.
+00003820: 6e6f 6465 2864 6570 656e 6473 5f6f 6e3d  node(depends_on=
+00003830: 5b61 5d29 0a64 6566 2065 2829 3a0a 2020  [a]).def e():.  
+00003840: 7469 6d65 2e73 6c65 6570 2833 290a 2020  time.sleep(3).  
+00003850: 2379 6f75 2063 616e 2072 6566 6572 2074  #you can refer t
+00003860: 6f20 7061 7265 6e74 206e 6f64 6573 2c20  o parent nodes, 
+00003870: 746f 2067 6574 2069 6e66 6f72 6d61 7469  to get informati
+00003880: 6f6e 2061 626f 7574 2074 6865 6972 2072  on about their r
+00003890: 6573 756c 7473 0a20 2072 6169 7365 2056  esults.  raise V
+000038a0: 616c 7565 4572 726f 7228 6622 6f6d 672c  alueError(f"omg,
+000038b0: 2063 7261 7368 2120 7b61 2e72 6573 756c   crash! {a.resul
+000038c0: 747d 2229 0a0a 4067 7261 7068 2e6e 6f64  t}")..@graph.nod
+000038d0: 6528 6465 7065 6e64 735f 6f6e 3d5b 655d  e(depends_on=[e]
+000038e0: 290a 6465 6620 6628 293a 0a20 2070 7269  ).def f():.  pri
+000038f0: 6e74 2822 7468 6973 2077 696c 6c20 6e65  nt("this will ne
+00003900: 7665 7220 6578 6563 7574 6522 290a 2020  ver execute").  
+00003910: 7265 7475 726e 2022 7468 6973 2077 696c  return "this wil
+00003920: 6c20 6e65 7665 7220 6578 6563 7574 6522  l never execute"
+00003930: 0a0a 4067 7261 7068 2e6e 6f64 6528 6465  ..@graph.node(de
+00003940: 7065 6e64 735f 6f6e 3d5b 615d 290a 6465  pends_on=[a]).de
+00003950: 6620 6728 293a 0a20 2074 696d 652e 736c  f g():.  time.sl
+00003960: 6565 7028 3329 0a20 2023 7765 2064 6f20  eep(3).  #we do 
+00003970: 6e6f 7420 7761 6e74 2074 6f20 6578 6563  not want to exec
+00003980: 7574 6520 6368 696c 6472 656e 206e 6f64  ute children nod
+00003990: 6573 2061 6e79 6d6f 7265 0a20 2023 7265  es anymore.  #re
+000039a0: 7475 726e 2067 7261 7068 2e42 5245 414b  turn graph.BREAK
+000039b0: 2074 6869 7320 7769 6c6c 2063 6175 7365   this will cause
+000039c0: 2074 6861 7420 616c 6c20 6368 696c 6472   that all childr
+000039d0: 656e 2f73 7563 6365 7373 6f72 7320 696e  en/successors in
+000039e0: 2067 7261 7068 2077 696c 6c20 6265 2073   graph will be s
+000039f0: 6b69 7070 6564 2077 6974 686f 7574 2065  kipped without e
+00003a00: 7272 726f 720a 2020 7265 7475 726e 2067  rrror.  return g
+00003a10: 7261 7068 2e42 5245 414b 0a0a 4067 7261  raph.BREAK..@gra
+00003a20: 7068 2e6e 6f64 6528 6465 7065 6e64 735f  ph.node(depends_
+00003a30: 6f6e 3d5b 675d 290a 6465 6620 6928 293a  on=[g]).def i():
+00003a40: 0a20 2070 7269 6e74 2822 7468 6973 2077  .  print("this w
+00003a50: 696c 6c20 6e65 7665 7220 6578 6563 7574  ill never execut
+00003a60: 6520 746f 6f22 290a 2020 7265 7475 726e  e too").  return
+00003a70: 2022 7468 6973 2077 696c 6c20 6e65 7665   "this will neve
+00003a80: 7220 6578 6563 7574 6520 746f 6f22 0a0a  r execute too"..
+00003a90: 2320 6966 2079 6f75 2068 6176 6520 6970  # if you have ip
+00003aa0: 7964 6167 7265 6433 2069 6e73 7461 6c6c  ydagred3 install
+00003ab0: 6564 2c20 796f 7520 6361 6e20 7365 6520  ed, you can see 
+00003ac0: 696e 2072 6561 6c20 7469 6d65 2073 7461  in real time sta
+00003ad0: 7465 2063 6861 6e67 6573 206f 6620 6561  te changes of ea
+00003ae0: 6368 206f 6620 7468 6520 6e6f 6465 730a  ch of the nodes.
+00003af0: 6469 7370 6c61 7928 6772 6170 682e 7669  display(graph.vi
+00003b00: 7375 616c 697a 6528 2929 0a0a 2365 7865  sualize())..#exe
+00003b10: 6375 7465 2044 4147 0a67 7261 7068 2e65  cute DAG.graph.e
+00003b20: 7865 6375 7465 286d 6178 5f77 6f72 6b65  xecute(max_worke
+00003b30: 7273 3d31 3029 0a0a 2369 7465 7261 7465  rs=10)..#iterate
+00003b40: 206f 7665 7220 7265 7375 6c74 730a 7072   over results.pr
+00003b50: 696e 7428 2249 7465 7261 7465 206f 7665  int("Iterate ove
+00003b60: 7220 7265 7375 6c74 732e 2e2e 2229 0a66  r results...").f
+00003b70: 6f72 206e 6f64 6520 696e 2067 7261 7068  or node in graph
+00003b80: 2e6e 6f64 6573 3a0a 2020 7072 696e 7428  .nodes:.  print(
+00003b90: 6e6f 6465 290a 0a3e 3e20 5761 6974 696e  node)..>> Waitin
+00003ba0: 6720 666f 7220 616c 6c20 7461 736b 7320  g for all tasks 
+00003bb0: 746f 2066 696e 6973 682e 2e2e 0a3e 3e20  to finish....>> 
+00003bc0: 2020 7374 6172 7469 6e67 3a20 4e6f 6465    starting: Node
+00003bd0: 283c 6675 6e63 7469 6f6e 2061 2061 7420  (<function a at 
+00003be0: 3078 3766 3530 6634 6239 6565 3530 3e3a  0x7f50f4b9ee50>:
+00003bf0: 207b 2773 7461 7465 273a 2027 5255 4e4e   {'state': 'RUNN
+00003c00: 494e 4727 2c20 2772 6573 756c 7427 3a20  ING', 'result': 
+00003c10: 4e6f 6e65 2c20 2765 7863 6570 7469 6f6e  None, 'exception
+00003c20: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
+00003c30: 7465 6427 3a20 4661 6c73 657d 2029 0a3e  ted': False} ).>
+00003c40: 3e20 2020 7374 6172 7469 6e67 3a20 4e6f  >   starting: No
+00003c50: 6465 283c 6675 6e63 7469 6f6e 2062 2061  de(<function b a
+00003c60: 7420 3078 3766 3530 6634 6235 3330 3430  t 0x7f50f4b53040
+00003c70: 3e3a 207b 2773 7461 7465 273a 2027 5255  >: {'state': 'RU
+00003c80: 4e4e 494e 4727 2c20 2772 6573 756c 7427  NNING', 'result'
+00003c90: 3a20 4e6f 6e65 2c20 2765 7863 6570 7469  : None, 'excepti
+00003ca0: 6f6e 273a 204e 6f6e 652c 2027 636f 6d70  on': None, 'comp
+00003cb0: 6c65 7465 6427 3a20 4661 6c73 657d 2029  leted': False} )
+00003cc0: 0a3e 3e20 2020 7374 6172 7469 6e67 3a20  .>>   starting: 
+00003cd0: 4e6f 6465 283c 6675 6e63 7469 6f6e 2065  Node(<function e
+00003ce0: 2061 7420 3078 3766 3530 6634 6235 3362   at 0x7f50f4b53b
+00003cf0: 3830 3e3a 207b 2773 7461 7465 273a 2027  80>: {'state': '
+00003d00: 5255 4e4e 494e 4727 2c20 2772 6573 756c  RUNNING', 'resul
+00003d10: 7427 3a20 4e6f 6e65 2c20 2765 7863 6570  t': None, 'excep
+00003d20: 7469 6f6e 273a 204e 6f6e 652c 2027 636f  tion': None, 'co
+00003d30: 6d70 6c65 7465 6427 3a20 4661 6c73 657d  mpleted': False}
+00003d40: 2029 0a3e 3e20 2020 7374 6172 7469 6e67   ).>>   starting
+00003d50: 3a20 4e6f 6465 283c 6675 6e63 7469 6f6e  : Node(<function
+00003d60: 2067 2061 7420 3078 3766 3530 6634 6235   g at 0x7f50f4b5
+00003d70: 3335 6530 3e3a 207b 2773 7461 7465 273a  35e0>: {'state':
+00003d80: 2027 5255 4e4e 494e 4727 2c20 2772 6573   'RUNNING', 'res
+00003d90: 756c 7427 3a20 4e6f 6e65 2c20 2765 7863  ult': None, 'exc
+00003da0: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
+00003db0: 636f 6d70 6c65 7465 6427 3a20 4661 6c73  completed': Fals
+00003dc0: 657d 2029 0a3e 3e20 2020 6669 6e69 7368  e} ).>>   finish
+00003dd0: 6564 3a20 4e6f 6465 283c 6675 6e63 7469  ed: Node(<functi
+00003de0: 6f6e 2061 2061 7420 3078 3766 3530 6634  on a at 0x7f50f4
+00003df0: 6239 6565 3530 3e3a 207b 2773 7461 7465  b9ee50>: {'state
+00003e00: 273a 2027 5355 4343 4553 5327 2c20 2772  ': 'SUCCESS', 'r
+00003e10: 6573 756c 7427 3a20 352c 2027 6578 6365  esult': 5, 'exce
+00003e20: 7074 696f 6e27 3a20 4e6f 6e65 2c20 2763  ption': None, 'c
+00003e30: 6f6d 706c 6574 6564 273a 2054 7275 657d  ompleted': True}
+00003e40: 2029 2028 7374 696c 6c20 7275 6e6e 696e   ) (still runnin
+00003e50: 673a 2033 290a 3e3e 2020 2073 7461 7274  g: 3).>>   start
+00003e60: 696e 673a 204e 6f64 6528 3c66 756e 6374  ing: Node(<funct
+00003e70: 696f 6e20 6320 6174 2030 7837 6635 3066  ion c at 0x7f50f
+00003e80: 3462 3533 3463 303e 3a20 7b27 7374 6174  4b534c0>: {'stat
+00003e90: 6527 3a20 2752 554e 4e49 4e47 272c 2027  e': 'RUNNING', '
+00003ea0: 7265 7375 6c74 273a 204e 6f6e 652c 2027  result': None, '
+00003eb0: 6578 6365 7074 696f 6e27 3a20 4e6f 6e65  exception': None
+00003ec0: 2c20 2763 6f6d 706c 6574 6564 273a 2046  , 'completed': F
+00003ed0: 616c 7365 7d20 290a 3e3e 2020 2066 696e  alse} ).>>   fin
+00003ee0: 6973 6865 643a 204e 6f64 6528 3c66 756e  ished: Node(<fun
+00003ef0: 6374 696f 6e20 6220 6174 2030 7837 6635  ction b at 0x7f5
+00003f00: 3066 3462 3533 3034 303e 3a20 7b27 7374  0f4b53040>: {'st
+00003f10: 6174 6527 3a20 2753 5543 4345 5353 272c  ate': 'SUCCESS',
+00003f20: 2027 7265 7375 6c74 273a 2027 6265 6565   'result': 'beee
+00003f30: 7027 2c20 2765 7863 6570 7469 6f6e 273a  p', 'exception':
+00003f40: 204e 6f6e 652c 2027 636f 6d70 6c65 7465   None, 'complete
+00003f50: 6427 3a20 5472 7565 7d20 2920 2873 7469  d': True} ) (sti
+00003f60: 6c6c 2072 756e 6e69 6e67 3a20 3329 0a3e  ll running: 3).>
+00003f70: 3e20 2020 6572 726f 723a 204e 6f64 6528  >   error: Node(
+00003f80: 3c66 756e 6374 696f 6e20 6520 6174 2030  <function e at 0
+00003f90: 7837 6635 3066 3462 3533 6238 303e 3a20  x7f50f4b53b80>: 
+00003fa0: 7b27 7374 6174 6527 3a20 2745 5252 4f52  {'state': 'ERROR
+00003fb0: 272c 2027 7265 7375 6c74 273a 204e 6f6e  ', 'result': Non
+00003fc0: 652c 2027 6578 6365 7074 696f 6e27 3a20  e, 'exception': 
+00003fd0: 5661 6c75 6545 7272 6f72 2827 6f6d 672c  ValueError('omg,
+00003fe0: 2063 7261 7368 2120 3527 292c 2027 636f   crash! 5'), 'co
+00003ff0: 6d70 6c65 7465 6427 3a20 5472 7565 7d20  mpleted': True} 
+00004000: 293a 206f 6d67 2c20 6372 6173 6821 2035  ): omg, crash! 5
+00004010: 2028 7374 696c 6c20 7275 6e6e 696e 673a   (still running:
+00004020: 2032 290a 3e3e 2020 2066 696e 6973 6865   2).>>   finishe
+00004030: 643a 204e 6f64 6528 3c66 756e 6374 696f  d: Node(<functio
+00004040: 6e20 6720 6174 2030 7837 6635 3066 3462  n g at 0x7f50f4b
+00004050: 3533 3565 303e 3a20 7b27 7374 6174 6527  535e0>: {'state'
+00004060: 3a20 2753 4b49 5050 4544 272c 2027 7265  : 'SKIPPED', 're
+00004070: 7375 6c74 273a 203c 7468 7265 6164 696e  sult': <threadin
+00004080: 672e 4576 656e 7420 6f62 6a65 6374 2061  g.Event object a
+00004090: 7420 3078 3766 3530 6563 3136 6339 6430  t 0x7f50ec16c9d0
+000040a0: 3e2c 2027 6578 6365 7074 696f 6e27 3a20  >, 'exception': 
+000040b0: 4e6f 6e65 2c20 2763 6f6d 706c 6574 6564  None, 'completed
+000040c0: 273a 2054 7275 657d 2029 2028 7374 696c  ': True} ) (stil
+000040d0: 6c20 7275 6e6e 696e 673a 2031 290a 3e3e  l running: 1).>>
+000040e0: 2020 2073 7461 7274 696e 673a 204e 6f64     starting: Nod
+000040f0: 6528 3c66 756e 6374 696f 6e20 6420 6174  e(<function d at
+00004100: 2030 7837 6635 3066 3462 3533 6136 303e   0x7f50f4b53a60>
+00004110: 3a20 7b27 7374 6174 6527 3a20 2752 554e  : {'state': 'RUN
+00004120: 4e49 4e47 272c 2027 7265 7375 6c74 273a  NING', 'result':
+00004130: 204e 6f6e 652c 2027 6578 6365 7074 696f   None, 'exceptio
+00004140: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
+00004150: 6574 6564 273a 2046 616c 7365 7d20 290a  eted': False} ).
+00004160: 3e3e 2020 2066 696e 6973 6865 643a 204e  >>   finished: N
+00004170: 6f64 6528 3c66 756e 6374 696f 6e20 6320  ode(<function c 
+00004180: 6174 2030 7837 6635 3066 3462 3533 3463  at 0x7f50f4b534c
+00004190: 303e 3a20 7b27 7374 6174 6527 3a20 2753  0>: {'state': 'S
+000041a0: 5543 4345 5353 272c 2027 7265 7375 6c74  UCCESS', 'result
+000041b0: 273a 2038 2c20 2765 7863 6570 7469 6f6e  ': 8, 'exception
+000041c0: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
+000041d0: 7465 6427 3a20 5472 7565 7d20 2920 2873  ted': True} ) (s
+000041e0: 7469 6c6c 2072 756e 6e69 6e67 3a20 3129  till running: 1)
+000041f0: 0a3e 3e20 2020 6669 6e69 7368 6564 3a20  .>>   finished: 
+00004200: 4e6f 6465 283c 6675 6e63 7469 6f6e 2064  Node(<function d
+00004210: 2061 7420 3078 3766 3530 6634 6235 3361   at 0x7f50f4b53a
+00004220: 3630 3e3a 207b 2773 7461 7465 273a 2027  60>: {'state': '
+00004230: 5355 4343 4553 5327 2c20 2772 6573 756c  SUCCESS', 'resul
+00004240: 7427 3a20 2767 206d 616e 2073 6179 3a20  t': 'g man say: 
+00004250: 6265 6565 7062 6565 6570 6265 6565 7027  beeepbeeepbeeep'
+00004260: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
+00004270: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
+00004280: 3a20 5472 7565 7d20 2920 2873 7469 6c6c  : True} ) (still
+00004290: 2072 756e 6e69 6e67 3a20 3029 0a3e 3e20   running: 0).>> 
+000042a0: 416c 6c20 7461 736b 7320 6669 6e69 7368  All tasks finish
+000042b0: 6564 2c20 7368 7574 7469 6e67 2064 6f77  ed, shutting dow
+000042c0: 6e0a 3e3e 0a3e 3e20 4974 6572 6174 6520  n.>>.>> Iterate 
+000042d0: 6f76 6572 2072 6573 756c 7473 2e2e 2e0a  over results....
+000042e0: 3e3e 204e 6f64 6528 3c66 756e 6374 696f  >> Node(<functio
+000042f0: 6e20 6120 6174 2030 7837 6635 3066 3462  n a at 0x7f50f4b
+00004300: 3965 6535 303e 3a20 7b27 7374 6174 6527  9ee50>: {'state'
+00004310: 3a20 2753 5543 4345 5353 272c 2027 7265  : 'SUCCESS', 're
+00004320: 7375 6c74 273a 2035 2c20 2765 7863 6570  sult': 5, 'excep
+00004330: 7469 6f6e 273a 204e 6f6e 652c 2027 636f  tion': None, 'co
+00004340: 6d70 6c65 7465 6427 3a20 5472 7565 7d20  mpleted': True} 
+00004350: 290a 3e3e 204e 6f64 6528 3c66 756e 6374  ).>> Node(<funct
+00004360: 696f 6e20 6220 6174 2030 7837 6635 3066  ion b at 0x7f50f
+00004370: 3462 3533 3034 303e 3a20 7b27 7374 6174  4b53040>: {'stat
+00004380: 6527 3a20 2753 5543 4345 5353 272c 2027  e': 'SUCCESS', '
+00004390: 7265 7375 6c74 273a 2027 6265 6565 7027  result': 'beeep'
+000043a0: 2c20 2765 7863 6570 7469 6f6e 273a 204e  , 'exception': N
+000043b0: 6f6e 652c 2027 636f 6d70 6c65 7465 6427  one, 'completed'
+000043c0: 3a20 5472 7565 7d20 290a 3e3e 204e 6f64  : True} ).>> Nod
+000043d0: 6528 3c66 756e 6374 696f 6e20 6320 6174  e(<function c at
+000043e0: 2030 7837 6635 3066 3462 3533 3463 303e   0x7f50f4b534c0>
+000043f0: 3a20 7b27 7374 6174 6527 3a20 2753 5543  : {'state': 'SUC
+00004400: 4345 5353 272c 2027 7265 7375 6c74 273a  CESS', 'result':
+00004410: 2038 2c20 2765 7863 6570 7469 6f6e 273a   8, 'exception':
+00004420: 204e 6f6e 652c 2027 636f 6d70 6c65 7465   None, 'complete
+00004430: 6427 3a20 5472 7565 7d20 290a 3e3e 204e  d': True} ).>> N
+00004440: 6f64 6528 3c66 756e 6374 696f 6e20 6420  ode(<function d 
+00004450: 6174 2030 7837 6635 3066 3462 3533 6136  at 0x7f50f4b53a6
+00004460: 303e 3a20 7b27 7374 6174 6527 3a20 2753  0>: {'state': 'S
+00004470: 5543 4345 5353 272c 2027 7265 7375 6c74  UCCESS', 'result
+00004480: 273a 2027 6720 6d61 6e20 7361 793a 2062  ': 'g man say: b
+00004490: 6565 6570 6265 6565 7062 6565 6570 272c  eeepbeeepbeeep',
+000044a0: 2027 6578 6365 7074 696f 6e27 3a20 4e6f   'exception': No
+000044b0: 6e65 2c20 2763 6f6d 706c 6574 6564 273a  ne, 'completed':
+000044c0: 2054 7275 657d 2029 0a3e 3e20 4e6f 6465   True} ).>> Node
+000044d0: 283c 6675 6e63 7469 6f6e 2065 2061 7420  (<function e at 
+000044e0: 3078 3766 3530 6634 6235 3362 3830 3e3a  0x7f50f4b53b80>:
+000044f0: 207b 2773 7461 7465 273a 2027 4552 524f   {'state': 'ERRO
+00004500: 5227 2c20 2772 6573 756c 7427 3a20 4e6f  R', 'result': No
+00004510: 6e65 2c20 2765 7863 6570 7469 6f6e 273a  ne, 'exception':
+00004520: 2056 616c 7565 4572 726f 7228 276f 6d67   ValueError('omg
+00004530: 2c20 6372 6173 6821 2035 2729 2c20 2763  , crash! 5'), 'c
+00004540: 6f6d 706c 6574 6564 273a 2054 7275 657d  ompleted': True}
+00004550: 2029 0a3e 3e20 4e6f 6465 283c 6675 6e63   ).>> Node(<func
+00004560: 7469 6f6e 2066 2061 7420 3078 3766 3530  tion f at 0x7f50
+00004570: 6634 6235 3330 6430 3e3a 207b 2773 7461  f4b530d0>: {'sta
+00004580: 7465 273a 2027 534b 4950 5045 4427 2c20  te': 'SKIPPED', 
+00004590: 2772 6573 756c 7427 3a20 4e6f 6e65 2c20  'result': None, 
+000045a0: 2765 7863 6570 7469 6f6e 273a 204e 6f6e  'exception': Non
+000045b0: 652c 2027 636f 6d70 6c65 7465 6427 3a20  e, 'completed': 
+000045c0: 4661 6c73 657d 2029 0a3e 3e20 4e6f 6465  False} ).>> Node
+000045d0: 283c 6675 6e63 7469 6f6e 2067 2061 7420  (<function g at 
+000045e0: 3078 3766 3530 6634 6235 3335 6530 3e3a  0x7f50f4b535e0>:
+000045f0: 207b 2773 7461 7465 273a 2027 534b 4950   {'state': 'SKIP
+00004600: 5045 4427 2c20 2772 6573 756c 7427 3a20  PED', 'result': 
+00004610: 3c74 6872 6561 6469 6e67 2e45 7665 6e74  <threading.Event
+00004620: 206f 626a 6563 7420 6174 2030 7837 6635   object at 0x7f5
+00004630: 3065 6331 3663 3964 303e 2c20 2765 7863  0ec16c9d0>, 'exc
+00004640: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
+00004650: 636f 6d70 6c65 7465 6427 3a20 5472 7565  completed': True
+00004660: 7d20 290a 3e3e 204e 6f64 6528 3c66 756e  } ).>> Node(<fun
+00004670: 6374 696f 6e20 6920 6174 2030 7837 6635  ction i at 0x7f5
+00004680: 3066 3462 3533 3238 303e 3a20 7b27 7374  0f4b53280>: {'st
+00004690: 6174 6527 3a20 2753 4b49 5050 4544 272c  ate': 'SKIPPED',
+000046a0: 2027 7265 7375 6c74 273a 204e 6f6e 652c   'result': None,
+000046b0: 2027 6578 6365 7074 696f 6e27 3a20 4e6f   'exception': No
+000046c0: 6e65 2c20 2763 6f6d 706c 6574 6564 273a  ne, 'completed':
+000046d0: 2046 616c 7365 7d20 290a 6060 600a 0a23   False} ).```..#
+000046e0: 2323 2045 7865 6375 7465 2073 7061 726b  ## Execute spark
+000046f0: 2070 6970 656c 696e 6520 6f66 206d 756c   pipeline of mul
+00004700: 7469 706c 6520 7374 6570 730a 0a75 7369  tiple steps..usi
+00004710: 6e67 2044 4147 2063 6f6d 706f 6e65 6e74  ng DAG component
+00004720: 2074 6f20 6861 6e64 6c65 2070 6172 616c   to handle paral
+00004730: 6c65 6c20 6578 6563 7574 696f 6e0a 0a60  lel execution..`
+00004740: 6060 7079 7468 6f6e 0a69 6d70 6f72 7420  ``python.import 
+00004750: 6264 710a 6672 6f6d 2062 6471 2069 6d70  bdq.from bdq imp
+00004760: 6f72 7420 7370 6172 6b2c 2074 6162 6c65  ort spark, table
+00004770: 0a0a 7070 6e20 3d20 6264 712e 5370 6172  ..ppn = bdq.Spar
+00004780: 6b50 6970 656c 696e 6528 2273 616d 706c  kPipeline("sampl
+00004790: 6522 290a 0a23 2072 6574 7572 6e73 2064  e")..# returns d
+000047a0: 6174 6166 7261 6d65 2c20 616e 6420 6372  ataframe, and cr
+000047b0: 6561 7465 7320 7370 6172 6b20 7669 6577  eates spark view
+000047c0: 2027 7261 775f 6461 7461 5f73 696e 676c   'raw_data_singl
+000047d0: 655f 736f 7572 6365 270a 4070 706e 2e73  e_source'.@ppn.s
+000047e0: 7465 705f 7370 6172 6b5f 7465 6d70 5f76  tep_spark_temp_v
+000047f0: 6965 7728 290a 6465 6620 7261 775f 6461  iew().def raw_da
+00004800: 7461 5f73 696e 676c 655f 736f 7572 6365  ta_single_source
+00004810: 2873 7465 7029 3a0a 2020 7265 7475 726e  (step):.  return
+00004820: 2073 7061 726b 2e72 616e 6765 2831 2c20   spark.range(1, 
+00004830: 3130 290a 0a23 2072 6574 7572 6e73 2064  10)..# returns d
+00004840: 6174 6166 7261 6d65 2c20 616e 6420 6372  ataframe, and cr
+00004850: 6561 7465 7320 7370 6172 6b20 7669 6577  eates spark view
+00004860: 2027 7261 775f 6e69 6365 5f6e 616d 6527   'raw_nice_name'
+00004870: 0a40 7070 6e2e 7374 6570 5f73 7061 726b  .@ppn.step_spark
+00004880: 5f74 656d 705f 7669 6577 286f 7574 7075  _temp_view(outpu
+00004890: 7473 3d22 7261 775f 6e69 6365 5f6e 616d  ts="raw_nice_nam
+000048a0: 6522 290a 6465 6620 7261 775f 6461 7461  e").def raw_data
+000048b0: 5f73 696e 676c 655f 736f 7572 6365 5f77  _single_source_w
+000048c0: 6974 685f 6375 7374 6f6d 5f6e 616d 6528  ith_custom_name(
+000048d0: 7374 6570 293a 0a20 2072 6574 7572 6e20  step):.  return 
+000048e0: 7370 6172 6b2e 7261 6e67 6528 3130 302c  spark.range(100,
+000048f0: 2031 3130 290a 0a23 2072 6574 7572 6e73   110)..# returns
+00004900: 2074 776f 2064 6174 6166 7261 6d65 732c   two dataframes,
+00004910: 2061 6e64 2063 7265 6174 6573 2074 776f   and creates two
+00004920: 2073 7061 726b 2076 6965 7773 2027 7261   spark views 'ra
+00004930: 775f 6461 7461 3127 2c20 2772 6177 5f64  w_data1', 'raw_d
+00004940: 6174 6132 270a 4070 706e 2e73 7465 705f  ata2'.@ppn.step_
+00004950: 7370 6172 6b5f 7465 6d70 5f76 6965 7728  spark_temp_view(
+00004960: 6f75 7470 7574 733d 5b22 7261 775f 6461  outputs=["raw_da
+00004970: 7461 3122 2c20 2272 6177 5f64 6174 6132  ta1", "raw_data2
+00004980: 225d 290a 6465 6620 7261 775f 6461 7461  "]).def raw_data
+00004990: 5f6d 756c 7469 5f73 6f75 7263 6528 7374  _multi_source(st
+000049a0: 6570 293a 0a20 2064 6631 203d 2073 7061  ep):.  df1 = spa
+000049b0: 726b 2e72 616e 6765 2831 3030 302c 2032  rk.range(1000, 2
+000049c0: 3030 3029 0a20 2064 6632 203d 2073 7061  000).  df2 = spa
+000049d0: 726b 2e72 616e 6765 2832 3030 302c 2033  rk.range(2000, 3
+000049e0: 3030 3029 0a0a 2020 7265 7475 726e 205b  000)..  return [
+000049f0: 6466 312c 2064 6632 5d0a 0a23 2077 6169  df1, df2]..# wai
+00004a00: 7473 2066 6f72 2072 6177 2064 6174 6120  ts for raw data 
+00004a10: 736f 7572 6365 7320 746f 2066 696e 6973  sources to finis
+00004a20: 682c 2061 6e64 2063 6f6d 6269 6e65 7320  h, and combines 
+00004a30: 7468 6520 6461 7461 2069 6e74 6f20 6f6e  the data into on
+00004a40: 6520 756e 696f 6e65 6420 7669 6577 2060  e unioned view `
+00004a50: 636f 6d62 696e 655f 6461 7461 600a 2320  combine_data`.# 
+00004a60: 6e6f 7465 2074 6861 7420 6465 7065 6e64  note that depend
+00004a70: 656e 6369 6573 2061 7265 2070 7974 686f  encies are pytho
+00004a80: 6e20 6675 6e63 7469 6f6e 7320 6f72 206e  n functions or n
+00004a90: 616d 6573 206f 6620 6f75 7470 7574 730a  ames of outputs.
+00004aa0: 4070 706e 2e73 7465 705f 7370 6172 6b5f  @ppn.step_spark_
+00004ab0: 7465 6d70 5f76 6965 7728 6465 7065 6e64  temp_view(depend
+00004ac0: 735f 6f6e 3d5b 7261 775f 6461 7461 5f73  s_on=[raw_data_s
+00004ad0: 696e 676c 655f 736f 7572 6365 2c20 7261  ingle_source, ra
+00004ae0: 775f 6461 7461 5f73 696e 676c 655f 736f  w_data_single_so
+00004af0: 7572 6365 5f77 6974 685f 6375 7374 6f6d  urce_with_custom
+00004b00: 5f6e 616d 652c 2027 7261 775f 6461 7461  _name, 'raw_data
+00004b10: 3127 2c20 2772 6177 5f64 6174 6132 275d  1', 'raw_data2']
+00004b20: 290a 6465 6620 636f 6d62 696e 655f 6461  ).def combine_da
+00004b30: 7461 2873 7465 7029 3a0a 2020 6466 203d  ta(step):.  df =
+00004b40: 2074 6162 6c65 2827 7261 775f 6461 7461   table('raw_data
+00004b50: 5f73 696e 676c 655f 736f 7572 6365 2729  _single_source')
+00004b60: 205c 0a20 2020 202e 756e 696f 6e28 7461   \.    .union(ta
+00004b70: 626c 6528 2772 6177 5f6e 6963 655f 6e61  ble('raw_nice_na
+00004b80: 6d65 2729 2920 5c0a 2020 2020 2e75 6e69  me')) \.    .uni
+00004b90: 6f6e 2874 6162 6c65 2827 7261 775f 6461  on(table('raw_da
+00004ba0: 7461 3127 2929 205c 0a20 2020 202e 756e  ta1')) \.    .un
+00004bb0: 696f 6e28 7461 626c 6528 2772 6177 5f64  ion(table('raw_d
+00004bc0: 6174 6132 2729 290a 0a20 2072 6574 7572  ata2'))..  retur
+00004bd0: 6e20 6466 0a0a 2320 7370 6c69 7473 2074  n df..# splits t
+00004be0: 6865 2063 6f6d 6269 6e65 645f 6461 7461  he combined_data
+00004bf0: 2069 6e74 6f20 276f 6464 2720 616e 6420   into 'odd' and 
+00004c00: 2765 7665 6e27 2076 6965 7773 0a40 7070  'even' views.@pp
+00004c10: 6e2e 7374 6570 5f73 7061 726b 5f74 656d  n.step_spark_tem
+00004c20: 705f 7669 6577 2864 6570 656e 6473 5f6f  p_view(depends_o
+00004c30: 6e3d 636f 6d62 696e 655f 6461 7461 2c20  n=combine_data, 
+00004c40: 6f75 7470 7574 733d 5b27 6f64 6427 2c20  outputs=['odd', 
+00004c50: 2765 7665 6e27 5d29 0a64 6566 2073 706c  'even']).def spl
+00004c60: 6974 5f64 6174 6128 7374 6570 293a 0a20  it_data(step):. 
+00004c70: 2064 665f 6f64 6420 3d20 7461 626c 6528   df_odd = table(
+00004c80: 2763 6f6d 6269 6e65 5f64 6174 6127 292e  'combine_data').
+00004c90: 6669 6c74 6572 2827 6964 2025 2032 203d  filter('id % 2 =
+00004ca0: 3d20 3127 290a 2020 6466 5f65 7665 6e20  = 1').  df_even 
+00004cb0: 3d20 7461 626c 6528 2763 6f6d 6269 6e65  = table('combine
+00004cc0: 5f64 6174 6127 292e 6669 6c74 6572 2827  _data').filter('
+00004cd0: 6964 2025 2032 203d 3d20 3027 290a 0a20  id % 2 == 0').. 
+00004ce0: 2072 6574 7572 6e20 5b20 6466 5f6f 6464   return [ df_odd
+00004cf0: 2c20 6466 5f65 7665 6e20 5d0a 0a23 2065  , df_even ]..# e
+00004d00: 7865 6375 7465 7320 7069 7065 6c69 6e65  xecutes pipeline
+00004d10: 2075 7369 6e67 2063 6f6e 6375 7272 656e   using concurren
+00004d20: 7420 7468 7265 6164 732c 206f 6e65 2070  t threads, one p
+00004d30: 6572 2065 6163 6820 7374 6570 2c20 666f  er each step, fo
+00004d40: 6c6c 6f77 696e 6720 7468 6520 6465 7065  llowing the depe
+00004d50: 6e64 656e 6379 2044 4147 0a23 2070 6970  ndency DAG.# pip
+00004d60: 656c 696e 6520 6973 2061 206e 6f72 6d61  eline is a norma
+00004d70: 6c20 7079 7468 6f6e 2063 616c 6c61 626c  l python callabl
+00004d80: 6520 6f62 6a65 6374 2c20 6173 2069 6620  e object, as if 
+00004d90: 6974 2077 6173 2061 2066 756e 6374 696f  it was a functio
+00004da0: 6e2c 2069 7420 7265 7475 726e 7320 6120  n, it returns a 
+00004db0: 6c69 7374 206f 6620 616c 6c20 7374 6570  list of all step
+00004dc0: 730a 7069 7065 6c69 6e65 5f72 6573 756c  s.pipeline_resul
+00004dd0: 7473 203d 2070 706e 286d 6178 5f63 6f6e  ts = ppn(max_con
+00004de0: 6375 7272 656e 745f 7374 6570 733d 3130  current_steps=10
+00004df0: 290a 0a70 7269 6e74 2827 7069 7065 6c69  )..print('pipeli
+00004e00: 6e65 2072 6573 756c 7473 3a27 290a 7072  ne results:').pr
+00004e10: 696e 7428 7069 7065 6c69 6e65 5f72 6573  int(pipeline_res
+00004e20: 756c 7473 290a 0a23 7368 6f77 2073 6f6d  ults)..#show som
+00004e30: 6520 6669 6e61 6c20 7661 6c75 6573 0a70  e final values.p
+00004e40: 7269 6e74 2827 6576 656e 206e 756d 6265  rint('even numbe
+00004e50: 7273 3a27 290a 7072 696e 7428 7461 626c  rs:').print(tabl
+00004e60: 6528 2765 7665 6e27 292e 6c69 6d69 7428  e('even').limit(
+00004e70: 3130 292e 636f 6c6c 6563 7428 2929 0a70  10).collect()).p
+00004e80: 7269 6e74 2827 6f64 6420 6e75 6d62 6572  rint('odd number
+00004e90: 733a 2729 0a70 7269 6e74 2874 6162 6c65  s:').print(table
+00004ea0: 2827 6f64 6427 292e 6c69 6d69 7428 3130  ('odd').limit(10
+00004eb0: 292e 636f 6c6c 6563 7428 2929 0a0a 2367  ).collect())..#g
+00004ec0: 6574 2073 6b69 7070 6564 2073 7465 7073  et skipped steps
+00004ed0: 0a61 7373 6572 7420 6c69 7374 2870 706e  .assert list(ppn
+00004ee0: 2e73 6b69 7070 6564 5f73 7465 7073 2920  .skipped_steps) 
+00004ef0: 3d3d 205b 5d0a 0a23 6765 7420 6572 726f  == []..#get erro
+00004f00: 7265 6420 7374 6570 7320 2879 6f75 2077  red steps (you w
+00004f10: 6f75 6c64 206e 6565 6420 746f 2027 6164  ould need to 'ad
+00004f20: 6a75 7374 2720 636f 6465 206f 6620 6f6e  just' code of on
+00004f30: 206f 6620 7468 6520 7374 6570 7320 746f   of the steps to
+00004f40: 206d 616b 6520 6974 2066 6169 6c20 746f   make it fail to
+00004f50: 2073 6565 2073 6f6d 6574 6869 6e67 2068   see something h
+00004f60: 6572 6529 0a61 7373 6572 7420 6c69 7374  ere).assert list
+00004f70: 2870 706e 2e65 7272 6f72 5f73 7465 7073  (ppn.error_steps
+00004f80: 2920 3d3d 205b 5d0a 0a23 6765 7420 7375  ) == []..#get su
+00004f90: 6363 6573 7366 756c 6c20 7374 6570 730a  ccessfull steps.
+00004fa0: 6173 7365 7274 2073 6574 2870 706e 2e73  assert set(ppn.s
+00004fb0: 7563 6365 7373 5f73 7465 7073 2e76 616c  uccess_steps.val
+00004fc0: 7565 7328 2929 203d 3d20 7365 7428 5b0a  ues()) == set([.
+00004fd0: 2020 7261 775f 6461 7461 5f73 696e 676c    raw_data_singl
+00004fe0: 655f 736f 7572 6365 5f77 6974 685f 6375  e_source_with_cu
+00004ff0: 7374 6f6d 5f6e 616d 652c 0a20 2072 6177  stom_name,.  raw
+00005000: 5f64 6174 615f 6d75 6c74 695f 736f 7572  _data_multi_sour
+00005010: 6365 2c0a 2020 7370 6c69 745f 6461 7461  ce,.  split_data
+00005020: 2c0a 2020 636f 6d62 696e 655f 6461 7461  ,.  combine_data
+00005030: 2c0a 2020 7261 775f 6461 7461 5f73 696e  ,.  raw_data_sin
+00005040: 676c 655f 736f 7572 6365 0a5d 290a 0a3e  gle_source.])..>
+00005050: 3e20 5761 6974 696e 6720 666f 7220 616c  > Waiting for al
+00005060: 6c20 7461 736b 7320 746f 2066 696e 6973  l tasks to finis
+00005070: 682e 2e2e 0a3e 3e20 2020 7374 6172 7469  h....>>   starti
+00005080: 6e67 3a20 4e6f 6465 2872 6177 5f64 6174  ng: Node(raw_dat
+00005090: 615f 7369 6e67 6c65 5f73 6f75 7263 653a  a_single_source:
+000050a0: 207b 2773 7461 7465 273a 2027 5255 4e4e   {'state': 'RUNN
+000050b0: 494e 4727 2c20 2772 6573 756c 7427 3a20  ING', 'result': 
+000050c0: 4e6f 6e65 2c20 2765 7863 6570 7469 6f6e  None, 'exception
+000050d0: 273a 204e 6f6e 652c 2027 636f 6d70 6c65  ': None, 'comple
+000050e0: 7465 6427 3a20 4661 6c73 657d 2029 0a3e  ted': False} ).>
+000050f0: 3e20 2020 7374 6172 7469 6e67 3a20 4e6f  >   starting: No
+00005100: 6465 2872 6177 5f64 6174 615f 7369 6e67  de(raw_data_sing
+00005110: 6c65 5f73 6f75 7263 655f 7769 7468 5f63  le_source_with_c
+00005120: 7573 746f 6d5f 6e61 6d65 3a20 7b27 7374  ustom_name: {'st
+00005130: 6174 6527 3a20 2752 554e 4e49 4e47 272c  ate': 'RUNNING',
+00005140: 2027 7265 7375 6c74 273a 204e 6f6e 652c   'result': None,
+00005150: 2027 6578 6365 7074 696f 6e27 3a20 4e6f   'exception': No
+00005160: 6e65 2c20 2763 6f6d 706c 6574 6564 273a  ne, 'completed':
+00005170: 2046 616c 7365 7d20 290a 3e3e 2020 2073   False} ).>>   s
+00005180: 7461 7274 696e 673a 204e 6f64 6528 7261  tarting: Node(ra
+00005190: 775f 6461 7461 5f6d 756c 7469 5f73 6f75  w_data_multi_sou
+000051a0: 7263 653a 207b 2773 7461 7465 273a 2027  rce: {'state': '
+000051b0: 5255 4e4e 494e 4727 2c20 2772 6573 756c  RUNNING', 'resul
+000051c0: 7427 3a20 4e6f 6e65 2c20 2765 7863 6570  t': None, 'excep
+000051d0: 7469 6f6e 273a 204e 6f6e 652c 2027 636f  tion': None, 'co
+000051e0: 6d70 6c65 7465 6427 3a20 4661 6c73 657d  mpleted': False}
+000051f0: 2029 0a3e 3e20 2020 6669 6e69 7368 6564   ).>>   finished
+00005200: 3a20 4e6f 6465 2872 6177 5f64 6174 615f  : Node(raw_data_
+00005210: 7369 6e67 6c65 5f73 6f75 7263 653a 207b  single_source: {
+00005220: 2773 7461 7465 273a 2027 5355 4343 4553  'state': 'SUCCES
+00005230: 5327 2c20 2772 6573 756c 7427 3a20 5b44  S', 'result': [D
+00005240: 6174 6146 7261 6d65 5b69 643a 2062 6967  ataFrame[id: big
+00005250: 696e 745d 5d2c 2027 6578 6365 7074 696f  int]], 'exceptio
+00005260: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
+00005270: 6574 6564 273a 2054 7275 657d 2029 2028  eted': True} ) (
+00005280: 7374 696c 6c20 7275 6e6e 696e 673a 2032  still running: 2
+00005290: 290a 3e3e 2020 2066 696e 6973 6865 643a  ).>>   finished:
+000052a0: 204e 6f64 6528 7261 775f 6461 7461 5f73   Node(raw_data_s
+000052b0: 696e 676c 655f 736f 7572 6365 5f77 6974  ingle_source_wit
+000052c0: 685f 6375 7374 6f6d 5f6e 616d 653a 207b  h_custom_name: {
+000052d0: 2773 7461 7465 273a 2027 5355 4343 4553  'state': 'SUCCES
+000052e0: 5327 2c20 2772 6573 756c 7427 3a20 5b44  S', 'result': [D
+000052f0: 6174 6146 7261 6d65 5b69 643a 2062 6967  ataFrame[id: big
+00005300: 696e 745d 5d2c 2027 6578 6365 7074 696f  int]], 'exceptio
+00005310: 6e27 3a20 4e6f 6e65 2c20 2763 6f6d 706c  n': None, 'compl
+00005320: 6574 6564 273a 2054 7275 657d 2029 2028  eted': True} ) (
+00005330: 7374 696c 6c20 7275 6e6e 696e 673a 2031  still running: 1
+00005340: 290a 3e3e 2020 2073 7461 7274 696e 673a  ).>>   starting:
+00005350: 204e 6f64 6528 636f 6d62 696e 655f 6461   Node(combine_da
+00005360: 7461 3a20 7b27 7374 6174 6527 3a20 2752  ta: {'state': 'R
+00005370: 554e 4e49 4e47 272c 2027 7265 7375 6c74  UNNING', 'result
+00005380: 273a 204e 6f6e 652c 2027 6578 6365 7074  ': None, 'except
+00005390: 696f 6e27 3a20 4e6f 6e65 2c20 2763 6f6d  ion': None, 'com
+000053a0: 706c 6574 6564 273a 2046 616c 7365 7d20  pleted': False} 
+000053b0: 290a 3e3e 2020 2066 696e 6973 6865 643a  ).>>   finished:
+000053c0: 204e 6f64 6528 7261 775f 6461 7461 5f6d   Node(raw_data_m
+000053d0: 756c 7469 5f73 6f75 7263 653a 207b 2773  ulti_source: {'s
+000053e0: 7461 7465 273a 2027 5355 4343 4553 5327  tate': 'SUCCESS'
+000053f0: 2c20 2772 6573 756c 7427 3a20 5b44 6174  , 'result': [Dat
+00005400: 6146 7261 6d65 5b69 643a 2062 6967 696e  aFrame[id: bigin
+00005410: 745d 2c20 4461 7461 4672 616d 655b 6964  t], DataFrame[id
+00005420: 3a20 6269 6769 6e74 5d5d 2c20 2765 7863  : bigint]], 'exc
+00005430: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
+00005440: 636f 6d70 6c65 7465 6427 3a20 5472 7565  completed': True
+00005450: 7d20 2920 2873 7469 6c6c 2072 756e 6e69  } ) (still runni
+00005460: 6e67 3a20 3129 0a3e 3e20 2020 7374 6172  ng: 1).>>   star
+00005470: 7469 6e67 3a20 4e6f 6465 2873 706c 6974  ting: Node(split
+00005480: 5f64 6174 613a 207b 2773 7461 7465 273a  _data: {'state':
+00005490: 2027 5255 4e4e 494e 4727 2c20 2772 6573   'RUNNING', 'res
+000054a0: 756c 7427 3a20 4e6f 6e65 2c20 2765 7863  ult': None, 'exc
+000054b0: 6570 7469 6f6e 273a 204e 6f6e 652c 2027  eption': None, '
+000054c0: 636f 6d70 6c65 7465 6427 3a20 4661 6c73  completed': Fals
+000054d0: 657d 2029 0a3e 3e20 2020 6669 6e69 7368  e} ).>>   finish
+000054e0: 6564 3a20 4e6f 6465 2863 6f6d 6269 6e65  ed: Node(combine
+000054f0: 5f64 6174 613a 207b 2773 7461 7465 273a  _data: {'state':
+00005500: 2027 5355 4343 4553 5327 2c20 2772 6573   'SUCCESS', 'res
+00005510: 756c 7427 3a20 5b44 6174 6146 7261 6d65  ult': [DataFrame
+00005520: 5b69 643a 2062 6967 696e 745d 5d2c 2027  [id: bigint]], '
+00005530: 6578 6365 7074 696f 6e27 3a20 4e6f 6e65  exception': None
+00005540: 2c20 2763 6f6d 706c 6574 6564 273a 2054  , 'completed': T
+00005550: 7275 657d 2029 2028 7374 696c 6c20 7275  rue} ) (still ru
+00005560: 6e6e 696e 673a 2031 290a 3e3e 2020 2066  nning: 1).>>   f
+00005570: 696e 6973 6865 643a 204e 6f64 6528 7370  inished: Node(sp
+00005580: 6c69 745f 6461 7461 3a20 7b27 7374 6174  lit_data: {'stat
+00005590: 6527 3a20 2753 5543 4345 5353 272c 2027  e': 'SUCCESS', '
+000055a0: 7265 7375 6c74 273a 205b 4461 7461 4672  result': [DataFr
+000055b0: 616d 655b 6964 3a20 6269 6769 6e74 5d2c  ame[id: bigint],
+000055c0: 2044 6174 6146 7261 6d65 5b69 643a 2062   DataFrame[id: b
+000055d0: 6967 696e 745d 5d2c 2027 6578 6365 7074  igint]], 'except
+000055e0: 696f 6e27 3a20 4e6f 6e65 2c20 2763 6f6d  ion': None, 'com
+000055f0: 706c 6574 6564 273a 2054 7275 657d 2029  pleted': True} )
+00005600: 2028 7374 696c 6c20 7275 6e6e 696e 673a   (still running:
+00005610: 2030 290a 3e3e 2041 6c6c 2074 6173 6b73   0).>> All tasks
+00005620: 2066 696e 6973 6865 642c 2073 6875 7474   finished, shutt
+00005630: 696e 6720 646f 776e 0a3e 3e20 7069 7065  ing down.>> pipe
+00005640: 6c69 6e65 2072 6573 756c 7473 3a0a 3e3e  line results:.>>
+00005650: 205b 7261 775f 6461 7461 5f73 696e 676c   [raw_data_singl
+00005660: 655f 736f 7572 6365 2c20 7261 775f 6461  e_source, raw_da
+00005670: 7461 5f73 696e 676c 655f 736f 7572 6365  ta_single_source
+00005680: 5f77 6974 685f 6375 7374 6f6d 5f6e 616d  _with_custom_nam
+00005690: 652c 2072 6177 5f64 6174 615f 6d75 6c74  e, raw_data_mult
+000056a0: 695f 736f 7572 6365 2c20 636f 6d62 696e  i_source, combin
+000056b0: 655f 6461 7461 2c20 7370 6c69 745f 6461  e_data, split_da
+000056c0: 7461 5d0a 3e3e 2065 7665 6e20 6e75 6d62  ta].>> even numb
+000056d0: 6572 733a 0a3e 3e20 5b52 6f77 2869 643d  ers:.>> [Row(id=
+000056e0: 3229 2c20 526f 7728 6964 3d34 292c 2052  2), Row(id=4), R
+000056f0: 6f77 2869 643d 3629 2c20 526f 7728 6964  ow(id=6), Row(id
+00005700: 3d38 292c 2052 6f77 2869 643d 3130 3029  =8), Row(id=100)
+00005710: 2c20 526f 7728 6964 3d31 3032 292c 2052  , Row(id=102), R
+00005720: 6f77 2869 643d 3130 3429 2c20 526f 7728  ow(id=104), Row(
+00005730: 6964 3d31 3036 292c 2052 6f77 2869 643d  id=106), Row(id=
+00005740: 3130 3829 2c20 526f 7728 6964 3d31 3030  108), Row(id=100
+00005750: 3029 5d0a 3e3e 206f 6464 206e 756d 6265  0)].>> odd numbe
+00005760: 7273 3a0a 3e3e 205b 526f 7728 6964 3d31  rs:.>> [Row(id=1
+00005770: 292c 2052 6f77 2869 643d 3329 2c20 526f  ), Row(id=3), Ro
+00005780: 7728 6964 3d35 292c 2052 6f77 2869 643d  w(id=5), Row(id=
+00005790: 3729 2c20 526f 7728 6964 3d39 292c 2052  7), Row(id=9), R
+000057a0: 6f77 2869 643d 3130 3129 2c20 526f 7728  ow(id=101), Row(
+000057b0: 6964 3d31 3033 292c 2052 6f77 2869 643d  id=103), Row(id=
+000057c0: 3130 3529 2c20 526f 7728 6964 3d31 3037  105), Row(id=107
+000057d0: 292c 2052 6f77 2869 643d 3130 3929 5d0a  ), Row(id=109)].
+000057e0: 6060 600a 0a70 6970 656c 696e 6520 7374  ```..pipeline st
+000057f0: 6570 7320 6172 6520 7265 7275 6e61 626c  eps are rerunabl
+00005800: 6520 6173 2061 6e79 206f 7264 696e 6172  e as any ordinar
+00005810: 7920 6675 6e63 7469 6f6e 3a0a 0a60 6060  y function:..```
+00005820: 7079 7468 6f6e 0a23 2074 6f20 7265 7275  python.# to reru
+00005830: 6e20 6769 7665 6e20 7374 6570 2c20 6a75  n given step, ju
+00005840: 7374 2065 7865 6375 7465 2069 7420 6173  st execute it as
+00005850: 2069 6620 6974 2077 6173 2061 2070 7572   if it was a pur
+00005860: 6520 6675 6e63 7469 6f6e 0a23 2072 6574  e function.# ret
+00005870: 7572 6e20 6973 2061 6c61 7761 7973 2061  urn is alaways a
+00005880: 206c 6973 7420 6f66 2064 6174 6166 7261   list of datafra
+00005890: 6d73 2074 6861 7420 6769 7665 6e20 4070  ms that given @p
+000058a0: 706e 2e73 7465 7020 7265 7475 726e 730a  pn.step returns.
+000058b0: 2320 6e6f 7465 3a20 7468 6520 7370 6172  # note: the spar
+000058c0: 6b20 7669 6577 2027 7261 775f 6461 7461  k view 'raw_data
+000058d0: 5f73 696e 676c 655f 736f 7572 6365 2720  _single_source' 
+000058e0: 7769 6c6c 2062 6520 7570 6461 7465 6420  will be updated 
+000058f0: 7768 656e 2074 6869 7320 6675 6e63 7469  when this functi
+00005900: 6f6e 2066 696e 6973 6865 7320 2861 7320  on finishes (as 
+00005910: 7065 7220 6465 6669 6e74 696f 6e20 696e  per defintion in
+00005920: 2040 7070 6e2e 7374 6570 2061 626f 7665   @ppn.step above
+00005930: 290a 7261 775f 6461 7461 5f73 696e 676c  ).raw_data_singl
+00005940: 655f 736f 7572 6365 2829 0a60 6060 0a0a  e_source().```..
+00005950: 2323 2320 5370 6172 6b20 5549 2053 7461  ### Spark UI Sta
+00005960: 6765 2064 6573 6372 6970 7469 6f6e 730a  ge descriptions.
+00005970: 0a57 6865 6e20 7275 6e6e 696e 6720 636f  .When running co
+00005980: 6465 2075 7369 6e67 2070 7973 7061 726b  de using pyspark
+00005990: 2c20 7370 6172 6b20 7569 2067 6574 7320  , spark ui gets 
+000059a0: 7665 7279 2063 726f 7764 6564 2e20 6053  very crowded. `S
+000059b0: 7061 726b 5549 4c6f 6767 6572 6020 636f  parkUILogger` co
+000059c0: 6e74 6578 7420 6d61 6e61 6765 7220 616e  ntext manager an
+000059d0: 6420 6465 636f 7261 746f 7220 6173 7369  d decorator assi
+000059e0: 6e67 7320 6875 6d61 6e20 7265 6164 6162  ngs human readab
+000059f0: 6c65 206e 616d 6573 2074 6f20 7370 6172  le names to spar
+00005a00: 6b20 7374 6167 6573 2e0a 0a60 6060 7079  k stages...```py
+00005a10: 7468 6f6e 0a66 726f 6d20 6264 7120 696d  thon.from bdq im
+00005a20: 706f 7274 2053 7061 726b 5549 4c6f 6767  port SparkUILogg
+00005a30: 6572 0a0a 2320 7573 6167 6520 6f66 2064  er..# usage of d
+00005a40: 6563 6f72 6174 6f72 730a 2320 7370 6172  ecorators.# spar
+00005a50: 6b20 7569 2073 7461 6765 7320 7769 6c6c  k ui stages will
+00005a60: 2068 6176 6520 6465 7363 7269 7074 696f   have descriptio
+00005a70: 6e20 6f66 2027 7879 7a27 0a40 5370 6172  n of 'xyz'.@Spar
+00005a80: 6b55 494c 6f67 6765 722e 7461 6728 6465  kUILogger.tag(de
+00005a90: 7363 3d27 7879 7a27 290a 6465 6620 736f  sc='xyz').def so
+00005aa0: 6d65 5f66 756e 6374 696f 6e32 286e 756d  me_function2(num
+00005ab0: 6265 7229 3a0a 0a20 2072 6574 7572 6e20  ber):..  return 
+00005ac0: 7370 6172 6b2e 7261 6e67 6528 6e75 6d62  spark.range(numb
+00005ad0: 6572 292e 636f 756e 7428 290a 0a23 2073  er).count()..# s
+00005ae0: 7061 726b 2075 6920 7374 6167 6573 2077  park ui stages w
+00005af0: 696c 6c20 6861 7665 2064 6573 6372 6970  ill have descrip
+00005b00: 7469 6f6e 206f 6620 2761 6c70 6861 5f66  tion of 'alpha_f
+00005b10: 756e 6374 696f 6e32 2720 2861 7574 6f6d  unction2' (autom
+00005b20: 6174 6963 616c 6c79 2064 6572 6976 6564  atically derived
+00005b30: 2066 726f 6d20 6675 6e63 7469 6f6e 206e   from function n
+00005b40: 616d 6529 0a40 5370 6172 6b55 494c 6f67  ame).@SparkUILog
+00005b50: 6765 722e 7461 670a 6465 6620 616c 7068  ger.tag.def alph
+00005b60: 615f 6675 6e63 7469 6f6e 3228 6e75 6d62  a_function2(numb
+00005b70: 6572 293a 0a20 2023 2031 7374 2061 6e64  er):.  # 1st and
+00005b80: 2032 6e64 2073 6f6d 655f 6675 6e63 7469   2nd some_functi
+00005b90: 6f6e 3228 2920 6361 6c6c 7320 7368 6f75  on2() calls shou
+00005ba0: 6c64 2062 6520 7669 7369 626c 6520 696e  ld be visible in
+00005bb0: 2073 7061 726b 2075 6920 6173 2027 7879   spark ui as 'xy
+00005bc0: 7a27 0a20 2023 2074 6865 2033 7264 2070  z'.  # the 3rd p
+00005bd0: 6172 7420 6f66 2072 6573 756c 7420 7368  art of result sh
+00005be0: 6f75 6c64 2062 6520 7669 7369 626c 6520  ould be visible 
+00005bf0: 6173 2027 616c 7068 615f 6675 6e63 7469  as 'alpha_functi
+00005c00: 6f6e 320a 2020 7265 7475 726e 2073 6f6d  on2.  return som
+00005c10: 655f 6675 6e63 7469 6f6e 3228 6e75 6d62  e_function2(numb
+00005c20: 6572 2a32 2920 2b20 736f 6d65 5f66 756e  er*2) + some_fun
+00005c30: 6374 696f 6e32 286e 756d 6265 722a 3329  ction2(number*3)
+00005c40: 202b 2073 7061 726b 2e72 616e 6765 286e   + spark.range(n
+00005c50: 756d 6265 722f 3130 292e 636f 756e 7428  umber/10).count(
+00005c60: 290a 0a23 2075 7361 6765 206f 6620 636f  )..# usage of co
+00005c70: 6e74 6578 7420 6d61 6e61 6765 7273 0a23  ntext managers.#
+00005c80: 2077 696c 6c20 6265 2076 6973 6962 6c65   will be visible
+00005c90: 2069 6e20 7370 6172 6b20 7569 2061 7320   in spark ui as 
+00005ca0: 2766 6972 7374 2d63 6f75 6e74 270a 7769  'first-count'.wi
+00005cb0: 7468 2053 7061 726b 5549 4c6f 6767 6572  th SparkUILogger
+00005cc0: 2827 6669 7273 742d 636f 756e 7427 293a  ('first-count'):
+00005cd0: 0a20 2073 7061 726b 2e72 616e 6765 2831  .  spark.range(1
+00005ce0: 3029 2e63 6f75 6e74 2829 0a0a 2320 7769  0).count()..# wi
+00005cf0: 6c6c 2062 6520 7669 7369 626c 6520 696e  ll be visible in
+00005d00: 2073 7061 726b 2075 6920 6173 2027 326e   spark ui as '2n
+00005d10: 642d 636f 756e 7427 0a77 6974 6820 5370  d-count'.with Sp
+00005d20: 6172 6b55 494c 6f67 6765 7228 2732 6e64  arkUILogger('2nd
+00005d30: 2d63 6f75 6e74 2729 3a0a 2020 7370 6172  -count'):.  spar
+00005d40: 6b2e 7261 6e67 6528 3230 292e 636f 756e  k.range(20).coun
+00005d50: 7428 290a 0a73 6f6d 655f 6675 6e63 7469  t()..some_functi
+00005d60: 6f6e 3228 3130 3030 290a 616c 7068 615f  on2(1000).alpha_
+00005d70: 6675 6e63 7469 6f6e 3228 3230 3030 290a  function2(2000).
+00005d80: 6060 600a                                ```.
```

### Comparing `bdq-0.0.5/pyproject.toml` & `bdq-0.1.0/pyproject.toml`

 * *Files 16% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 [project]
 name = "bdq"
-version = "0.0.5"
+version = "0.1.0"
 authors = [
   { name="Grzegorz Rusin", email="grzegorz.rusin@databricks.com" },
 ]
 description = "Big Data Quality, a set of tools/function that help you every day assert quality of datasets you have processed or ingested"
 readme = "README.md"
 requires-python = ">=3.8"
 classifiers = [
```

